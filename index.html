<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Front Office | BOW Sports Capital Track 201</title>
    <style>
        /* ================================
           THE FRONT OFFICE - UPGRADED SYSTEM
           Room-Specific UI + Advanced Logic
           ================================ */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --navy-dark: #0a1628;
            --navy-base: #132642;
            --navy-light: #1e3a5f;
            --navy-lighter: #2d4a6f;
            
            --gold: #f5a623;
            --gold-light: #ffc107;
            --gold-dark: #d4880e;
            
            --success: #10b981;
            --warning: var(--gold);
            --danger: #ef4444;
            --info: #3b82f6;
            
            --bg: var(--navy-dark);
            --bg-card: var(--navy-base);
            --bg-elevated: var(--navy-light);
            --bg-hover: var(--navy-lighter);
            
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --text-muted: #7a8a9e;
            --border: #2d4a6f;
            --border-light: #3d5a7f;
            
            --font-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-display: 'Georgia', serif;
            --font-mono: 'SF Mono', Monaco, 'Courier New', monospace;
            
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            --space-2xl: 4rem;
            
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.6);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.7);
            --shadow-gold: 0 4px 20px rgba(245, 166, 35, 0.3);
        }
        
        body {
            font-family: var(--font-primary);
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: var(--space-sm);
        }
        
        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInFromRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translateX(-100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes metricPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-5px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-5px); }
        }
        
        .metric-pulse {
            animation: metricPulse 0.6s ease;
        }
        
        @keyframes ballDrop {
            0% { transform: translateY(-100px) scale(0.5); opacity: 0; }
            50% { transform: translateY(10px) scale(1.1); }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes rivalPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 6px 16px rgba(239,68,68,0.4); }
        }
        
        .rival-update {
            animation: rivalPulse 1s ease;
        }
        
        .prospect-card:hover,
        .press-answer:hover,
        .trivia-answer:hover,
        .player-select-card:hover {
            background: rgba(245,166,35,0.2) !important;
            border-color: var(--gold) !important;
            transform: translateX(4px);
            transition: all 0.2s ease;
        }
        
        @keyframes lockAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes shakeNo {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @keyframes cycleTransition {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1.2); }
        }
        
        @keyframes revealText {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(-30px, 30px) scale(0.95); }
            75% { transform: translate(30px, 40px) scale(1.02); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(245, 166, 35, 0.3); }
            50% { box-shadow: 0 0 40px rgba(245, 166, 35, 0.6), 0 0 60px rgba(245, 166, 35, 0.3); }
        }
        
        /* BACKGROUNDS */
        .intro-background,
        .franchise-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }
        
        .gradient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.08;
            animation: float 25s ease-in-out infinite;
        }
        
        .orb-1 {
            width: 600px;
            height: 600px;
            background: var(--gold);
            top: -300px;
            left: -300px;
        }
        
        .orb-2 {
            width: 500px;
            height: 500px;
            background: var(--gold);
            bottom: -250px;
            right: -250px;
            animation-delay: 8s;
        }
        
        .orb-3 {
            width: 700px;
            height: 700px;
            background: var(--gold);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: 15s;
        }
        
        /* SCREENS */
        .screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            min-height: 100vh;
            width: 100%;
            overflow-y: auto;
        }
        
        .screen.active {
            display: flex;
            animation: fadeIn 0.5s ease;
        }
        
        .screen.transitioning-out {
            animation: fadeOut 0.4s ease forwards;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        
        /* BUTTONS */
        button {
            font-family: var(--font-primary);
            cursor: pointer;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-primary {
            background: var(--gold);
            color: var(--navy-dark);
            padding: 1.25rem 3rem;
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: 2px;
            box-shadow: var(--shadow-gold);
        }
        
        .btn-primary:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(245, 166, 35, 0.5);
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 1rem 2rem;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 1px solid var(--border-light);
            border-radius: 2px;
        }
        
        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.03);
            border-color: var(--gold);
            color: var(--gold);
        }
        
        .btn-select {
            width: 100%;
            background: var(--gold);
            color: var(--navy-dark);
            padding: 1.1rem;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border-radius: 2px;
            margin-top: var(--space-lg);
            box-shadow: var(--shadow-gold);
        }
        
        .btn-select:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
        }
        
        .btn-room {
            width: 100%;
            background: transparent;
            color: var(--gold);
            padding: 0.85rem;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-radius: 2px;
            border: 2px solid var(--gold);
            margin-top: var(--space-sm);
        }
        
        .btn-room:hover {
            background: var(--gold);
            color: var(--navy-dark);
        }
        
        .btn-room:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-advance {
            background: var(--gold);
            color: var(--navy-dark);
            padding: 1.25rem 3rem;
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: 2px;
        }
        
        .btn-advance:disabled {
            background: var(--bg-elevated);
            color: var(--text-muted);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Room-specific decision buttons */
        .btn-decision {
            width: 100%;
            background: var(--gold);
            color: var(--navy-dark);
            padding: 1.1rem;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border-radius: 2px;
            margin-top: var(--space-lg);
            box-shadow: var(--shadow-gold);
        }
        
        .btn-decision:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
        }
        
        .btn-decision:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* INTRO SCREEN - (keeping existing) */
        .intro-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }
        
        .intro-content {
            text-align: center;
            max-width: 800px;
            padding: var(--space-2xl);
            animation: fadeInUp 0.8s ease;
        }
        
        .intro-badge {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            background: transparent;
            border: 2px solid var(--gold);
            border-radius: 2px;
            color: var(--gold);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: var(--space-xl);
        }
        
        .main-title {
            font-family: var(--font-display);
            font-size: 6rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            margin-bottom: var(--space-lg);
            line-height: 1.1;
            color: #ffffff;
        }
        
        .title-line {
            display: block;
        }
        
        .title-line:last-child {
            color: var(--gold);
        }
        
        .tagline {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-2xl);
            font-weight: 300;
            font-style: italic;
            line-height: 1.6;
        }
        
        .intro-stats {
            display: flex;
            justify-content: center;
            gap: 4rem;
            margin: var(--space-2xl) 0;
            padding: var(--space-2xl) 0;
            border-top: 1px solid rgba(245, 166, 35, 0.2);
            border-bottom: 1px solid rgba(245, 166, 35, 0.2);
        }
        
        .intro-stat {
            text-align: center;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 4rem;
            font-weight: 300;
            color: var(--gold);
            line-height: 1;
            margin-bottom: 0.75rem;
            font-family: var(--font-display);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 600;
        }
        
        .intro-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-md);
        }
        
        .intro-content .btn-primary,
        .intro-content .btn-ghost {
            min-width: 350px;
        }
        
        /* FRANCHISE SELECTION - (keeping existing structure) */
        .franchise-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-xl) var(--space-md);
            position: relative;
            z-index: 1;
        }
        
        .screen-header {
            text-align: center;
            margin-bottom: var(--space-2xl);
        }
        
        .screen-badge {
            display: inline-block;
            padding: 0.4rem 1rem;
            background: transparent;
            border: 2px solid var(--gold);
            border-radius: 2px;
            color: var(--gold);
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            margin-bottom: var(--space-md);
        }
        
        .screen-title {
            font-size: 3rem;
            font-weight: 400;
            font-family: var(--font-display);
            margin-bottom: var(--space-sm);
        }
        
        .screen-subtitle {
            color: var(--text-secondary);
            font-size: 1.15rem;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .franchise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--space-xl);
        }
        
        .franchise-card {
            background: var(--bg-card);
            border-radius: 2px;
            padding: var(--space-xl);
            border: 1px solid var(--border);
            transition: all 0.4s ease;
            animation: fadeInUp 0.6s ease;
            animation-fill-mode: both;
        }
        
        .franchise-card:nth-child(1) { animation-delay: 0.1s; }
        .franchise-card:nth-child(2) { animation-delay: 0.2s; }
        .franchise-card:nth-child(3) { animation-delay: 0.3s; }
        
        .franchise-card:hover {
            transform: translateY(-4px);
            border-color: var(--gold);
            box-shadow: var(--shadow-gold);
        }
        
        .franchise-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            opacity: 0.8;
        }
        
        .franchise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border);
        }
        
        .franchise-header h3 {
            font-size: 1.5rem;
            margin: 0;
            font-weight: 400;
            font-family: var(--font-display);
        }
        
        .franchise-badge {
            padding: 0.4rem 1rem;
            border-radius: 2px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border: 1px solid;
        }
        
        .pressure-high {
            background: transparent;
            color: var(--danger);
            border-color: var(--danger);
        }
        
        .pressure-medium {
            background: transparent;
            color: var(--gold);
            border-color: var(--gold);
        }
        
        .pressure-low {
            background: transparent;
            color: var(--info);
            border-color: var(--info);
        }
        
        .franchise-situation {
            color: var(--text-secondary);
            margin-bottom: var(--space-lg);
            line-height: 1.8;
            font-size: 0.95rem;
        }
        
        .franchise-metrics {
            margin-bottom: var(--space-lg);
        }
        
        .metric {
            margin-bottom: var(--space-md);
        }
        
        .metric-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .metric-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .metric-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 3px;
            transition: width 0.6s ease;
        }
        
        .metric-fill.elite { background: var(--success); }
        .metric-fill.warning { background: var(--warning); }
        
        .metric-value {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .ownership-mandate {
            background: rgba(245, 166, 35, 0.05);
            padding: var(--space-md);
            border-radius: 2px;
            border-left: 3px solid var(--gold);
            font-size: 0.95rem;
            line-height: 1.8;
        }
        
        .ownership-mandate strong {
            color: var(--gold);
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
        }
        
        /* HUB */
        .hub-container {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--space-lg);
        }
        
        .hub-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xl);
            background: var(--bg-card);
            border-radius: 2px;
            margin-bottom: var(--space-xl);
            border: 1px solid var(--border);
        }
        
        .hub-title h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 400;
            font-family: var(--font-display);
        }
        
        .franchise-name {
            color: var(--gold);
            font-size: 0.95rem;
            margin-top: 0.5rem;
            display: block;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .cycle-indicator {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            padding: 1rem 2rem;
            border: 2px solid var(--gold);
            border-radius: 2px;
        }
        
        .cycle-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .cycle-number {
            font-size: 3rem;
            font-weight: 300;
            color: var(--gold);
            line-height: 1;
            font-family: var(--font-display);
        }
        
        .cycle-total {
            color: var(--text-muted);
            font-size: 1.5rem;
            font-weight: 300;
        }
        
        .hub-main {
            display: grid;
            gap: var(--space-xl);
        }
        
        /* PRESSURE INDICATOR (NEW) */
        .pressure-banner {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-left: 4px solid var(--danger);
            padding: var(--space-md);
            border-radius: 2px;
            margin-bottom: var(--space-lg);
        }
        
        .pressure-banner.pressure-moderate {
            background: rgba(245, 166, 35, 0.1);
            border-color: rgba(245, 166, 35, 0.3);
            border-left-color: var(--gold);
        }
        
        .pressure-banner.pressure-low {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            border-left-color: var(--info);
        }
        
        .pressure-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--danger);
            margin-bottom: 0.5rem;
        }
        
        .pressure-moderate .pressure-title {
            color: var(--gold);
        }
        
        .pressure-low .pressure-title {
            color: var(--info);
        }
        
        .alert-feed {
            background: var(--bg-card);
            border-radius: 2px;
            padding: var(--space-xl);
            border-left: 4px solid var(--gold);
            border-top: 1px solid var(--border);
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }
        
        .alert-feed h3 {
            margin-bottom: var(--space-md);
            font-weight: 400;
            font-family: var(--font-display);
            color: var(--gold);
            font-size: 1.25rem;
        }
        
        .alerts {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .alert {
            background: rgba(245, 166, 35, 0.05);
            padding: var(--space-md);
            border-radius: 2px;
            font-size: 0.95rem;
            line-height: 1.7;
            border-left: 2px solid var(--gold);
        }
        
        .alert.alert-warning {
            background: rgba(239, 68, 68, 0.05);
            border-left-color: var(--danger);
        }
        
        .alert.alert-success {
            background: rgba(16, 185, 129, 0.05);
            border-left-color: var(--success);
        }
        
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--space-xl);
        }
        
        .room-card {
            background: var(--bg-card);
            border-radius: 2px;
            padding: var(--space-xl);
            border: 1px solid var(--border);
            transition: all 0.4s ease;
        }
        
        .room-card:hover {
            border-color: var(--gold);
            transform: translateY(-4px);
            box-shadow: var(--shadow-gold);
        }
        
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border);
        }
        
        .room-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 400;
            font-family: var(--font-display);
        }
        
        .room-status {
            padding: 0.35rem 0.85rem;
            border-radius: 2px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
        }
        
        .room-status.locked {
            color: var(--success);
            border-color: var(--success);
        }
        
        .room-status.disabled {
            color: var(--text-muted);
            border-color: var(--text-muted);
        }
        
        .room-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-md);
            line-height: 1.7;
        }
        
        .room-metrics {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        
        .mini-metric {
            flex: 1;
            background: rgba(245, 166, 35, 0.03);
            padding: var(--space-sm);
            border-radius: 2px;
            border: 1px solid rgba(245, 166, 35, 0.1);
        }
        
        .mini-label {
            display: block;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .mini-value {
            display: block;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--gold);
        }
        
        /* CONSTRAINT WARNING (NEW) */
        .constraint-warning {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-left: 3px solid var(--danger);
            padding: var(--space-sm);
            border-radius: 2px;
            margin-top: var(--space-sm);
            font-size: 0.85rem;
            color: var(--danger);
        }
        
        .hub-actions {
            text-align: center;
            padding: var(--space-lg);
        }
        
        /* ========================================
           ROOM-SPECIFIC STYLES (NEW SYSTEM)
           ======================================== */
        
        /* EVALUATION ROOM - Intelligence Briefing Style */
        .eval-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xl);
        }
        
        .signals-panel {
            background: rgba(59, 130, 246, 0.03);
            padding: var(--space-lg);
            border-radius: 2px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .signals-panel h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--info);
            margin-bottom: var(--space-md);
        }
        
        .signal-item {
            background: rgba(255, 255, 255, 0.02);
            padding: var(--space-sm);
            margin-bottom: var(--space-sm);
            border-radius: 2px;
            border-left: 2px solid var(--info);
        }
        
        .signal-confidence {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 2px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 0.5rem;
        }
        
        .confidence-high {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .confidence-mixed {
            background: rgba(245, 166, 35, 0.15);
            color: var(--gold);
            border: 1px solid rgba(245, 166, 35, 0.3);
        }
        
        .confidence-noisy {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .incomplete-data {
            opacity: 0.6;
            font-style: italic;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* CAP ROOM - Control Panel Style */
        .cap-control-panel {
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid var(--border);
            border-radius: 2px;
            padding: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .cap-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .cap-stat {
            text-align: center;
            padding: var(--space-sm);
            background: var(--bg-elevated);
            border-radius: 2px;
        }
        
        .cap-stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .cap-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--gold);
        }
        
        .irreversible-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-left: 4px solid var(--danger);
            padding: var(--space-md);
            border-radius: 2px;
            margin-top: var(--space-md);
        }
        
        .irreversible-warning strong {
            color: var(--danger);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
        }
        
        .before-after-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--space-md);
            align-items: center;
            padding: var(--space-md);
            background: rgba(255, 255, 255, 0.02);
            border-radius: 2px;
            margin: var(--space-md) 0;
        }
        
        .comparison-arrow {
            color: var(--gold);
            font-size: 2rem;
        }
        
        .comparison-value {
            text-align: center;
        }
        
        .comparison-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .comparison-number {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
        }
        
        /* RELATIONSHIPS ROOM - Dialogue Style */
        .dialogue-frame {
            background: rgba(139, 92, 246, 0.03);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 2px;
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
        }
        
        .dialogue-speaker {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #8b5cf6;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .dialogue-text {
            font-size: 1.05rem;
            line-height: 1.8;
            color: var(--text-primary);
            font-style: italic;
        }
        
        .relationship-temperature {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 1rem;
            border-radius: 2px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--space-sm);
        }
        
        .temp-warm {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .temp-tense {
            background: rgba(245, 166, 35, 0.15);
            color: var(--gold);
            border: 1px solid rgba(245, 166, 35, 0.3);
        }
        
        .temp-cold {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .memory-callout {
            background: rgba(59, 130, 246, 0.05);
            border-left: 3px solid var(--info);
            padding: var(--space-sm);
            margin: var(--space-md) 0;
            font-size: 0.9rem;
            font-style: italic;
            color: var(--text-secondary);
        }
        
        .delayed-consequence {
            background: rgba(245, 166, 35, 0.05);
            border: 1px solid rgba(245, 166, 35, 0.2);
            padding: var(--space-sm);
            border-radius: 2px;
            margin-top: var(--space-sm);
            font-size: 0.85rem;
        }
        
        .delayed-consequence strong {
            color: var(--gold);
        }
        
        /* RISK ROOM - Probability Framing */
        .outcome-distribution {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin: var(--space-lg) 0;
        }
        
        .outcome-scenario {
            background: var(--bg-elevated);
            padding: var(--space-md);
            border-radius: 2px;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .outcome-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: var(--space-sm);
        }
        
        .outcome-label.likely {
            color: var(--success);
        }
        
        .outcome-label.worst {
            color: var(--danger);
        }
        
        .outcome-label.best {
            color: var(--info);
        }
        
        .outcome-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin: var(--space-sm) 0;
        }
        
        .outcome-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .risk-meter {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: var(--space-md);
            margin: var(--space-md) 0;
        }
        
        .risk-meter-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: var(--space-sm);
        }
        
        .risk-meter-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .risk-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--gold), var(--danger));
            transition: width 0.3s ease;
        }
        
        .variance-warning {
            background: rgba(239, 68, 68, 0.05);
            border-left: 3px solid var(--danger);
            padding: var(--space-sm);
            margin-top: var(--space-sm);
            font-size: 0.85rem;
            color: var(--danger);
            font-weight: 600;
        }
        
        /* ROOM MODAL */
        .screen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            overflow-y: auto;
            padding: 2rem 1rem;
        }
        
        .modal-content-wide {
            background: linear-gradient(135deg, var(--navy-dark) 0%, #000814 100%);
            width: 90%;
            max-width: 900px;
            border-radius: 4px;
            border: 1px solid rgba(245, 166, 35, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .room-modal {
            background: var(--bg-card);
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            border-radius: 2px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .room-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xl);
            border-bottom: 1px solid var(--border);
            background: var(--bg-elevated);
        }
        
        .room-modal-title-section h2 {
            margin: 0;
            font-family: var(--font-display);
            font-weight: 400;
            font-size: 1.75rem;
        }
        
        .room-progress {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn-close {
            background: transparent;
            color: var(--text-secondary);
            font-size: 2rem;
            padding: 0.5rem;
            line-height: 1;
            border-radius: 2px;
        }
        
        .btn-close:hover {
            color: var(--gold);
        }
        
        .room-modal-body {
            padding: var(--space-xl);
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }
        
        /* DECISION INTERFACE */
        .decision-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .room-intro {
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: rgba(245, 166, 35, 0.05);
            border-radius: 2px;
            border-left: 3px solid var(--gold);
        }
        
        .room-intro h3 {
            font-family: var(--font-display);
            font-weight: 400;
            color: var(--gold);
            margin-bottom: var(--space-md);
        }
        
        .scenario-reference {
            margin-top: var(--space-md);
            padding: var(--space-md);
            background: rgba(245, 166, 35, 0.05);
            border-radius: 2px;
            border-left: 3px solid var(--gold);
            font-size: 0.95rem;
        }
        
        .decision-prompt {
            margin: var(--space-xl) 0;
            padding: var(--space-xl);
            background: transparent;
            border: 2px solid var(--gold);
            border-radius: 2px;
            text-align: center;
        }
        
        .decision-prompt h4 {
            font-size: 1.75rem;
            margin: 0;
            color: var(--gold);
            font-family: var(--font-display);
            font-weight: 400;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-xl);
            margin: var(--space-2xl) 0;
        }
        
        .option-card {
            background: var(--bg-elevated);
            border-radius: 2px;
            padding: var(--space-xl);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .option-card:hover {
            border-color: var(--gold);
            transform: translateX(8px);
            box-shadow: var(--shadow-gold);
        }
        
        .option-card.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        .option-disabled-reason {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            padding: 0.4rem 0.8rem;
            border-radius: 2px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .option-header h5 {
            font-size: 1.25rem;
            margin: 0 0 0.75rem 0;
            color: var(--gold);
            font-family: var(--font-display);
            font-weight: 400;
        }
        
        .option-rationale {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: var(--space-lg);
            line-height: 1.7;
        }
        
        .option-preview {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin: var(--space-lg) 0;
            padding: var(--space-lg);
            background: rgba(255, 255, 255, 0.02);
            border-radius: 2px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .preview-section {
            font-size: 0.9rem;
            line-height: 1.7;
        }
        
        .preview-section strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            font-weight: 700;
        }
        
        .preview-section p {
            margin: 0;
            color: var(--text-secondary);
        }
        
        .preview-economic {
            background: rgba(245, 166, 35, 0.05);
            padding: var(--space-md);
            border-radius: 2px;
            border-left: 3px solid var(--gold);
        }
        
        .economic-concepts-box {
            margin-top: var(--space-2xl);
            padding: var(--space-xl);
            background: rgba(245, 166, 35, 0.03);
            border-radius: 2px;
            border: 1px solid rgba(245, 166, 35, 0.15);
        }
        
        .economic-concepts-box h4 {
            margin-bottom: var(--space-lg);
            color: var(--gold);
            font-family: var(--font-display);
            font-weight: 400;
            font-size: 1.25rem;
        }
        
        .concepts-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .concept-item {
            display: flex;
            gap: var(--space-md);
            align-items: start;
        }
        
        .concept-term-box {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--gold);
            border-radius: 2px;
            font-weight: 700;
            font-size: 0.75rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .concept-def {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
        }
        
        /* DECISION CONFIRMATION */
        .decision-confirmed {
            text-align: center;
            padding: var(--space-2xl);
            animation: scaleIn 0.5s ease;
        }
        
        .confirmation-icon {
            font-size: 5rem;
            color: var(--gold);
            margin-bottom: var(--space-md);
            animation: lockAnimation 0.6s ease;
        }
        
        .decision-choice {
            font-size: 1.25rem;
            color: var(--gold);
            margin: var(--space-md) 0;
            font-family: var(--font-display);
            animation: revealText 0.6s ease 0.2s both;
        }
        
        .decision-commitment {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-top: var(--space-md);
            animation: revealText 0.6s ease 0.3s both;
        }
        
        .narrative-explanation {
            margin-top: var(--space-lg);
            padding: var(--space-lg);
            background: linear-gradient(135deg, rgba(245, 166, 35, 0.05) 0%, rgba(19, 38, 66, 0.05) 100%);
            border-left: 4px solid var(--gold);
            border-radius: 2px;
            animation: slideInFromLeft 0.6s ease 0.4s both;
        }
        
        .narrative-explanation h4 {
            color: var(--gold);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: var(--space-sm);
        }
        
        .narrative-explanation p {
            line-height: 1.8;
            color: var(--text-secondary);
            font-size: 1.05rem;
        }
        
        .effects-applied {
            margin-top: var(--space-xl);
            padding: var(--space-lg);
            background: var(--bg-elevated);
            border-radius: 2px;
            border: 1px solid var(--border);
            animation: fadeInUp 0.6s ease 0.5s both;
        }
        
        .effects-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        .effect-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm);
            background: rgba(255, 255, 255, 0.02);
            border-radius: 2px;
            font-size: 0.9rem;
        }
        
        /* CYCLE TRANSITION SCREEN */
        .cycle-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--navy-dark) 0%, #000814 100%);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease;
            overflow-y: auto;
            padding: 2rem 1rem;
        }
        
        .cycle-transition-overlay.active {
            display: flex;
        }
        
        .cycle-transition-content {
            text-align: center;
            max-width: 800px;
            width: 100%;
            padding: var(--space-2xl);
            margin: auto;
        }
        
        .cycle-number {
            font-size: 6rem;
            font-family: var(--font-display);
            color: var(--gold);
            font-weight: 700;
            line-height: 1;
            margin-bottom: var(--space-md);
            animation: scaleIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-shadow: 0 0 40px rgba(245, 166, 35, 0.4);
        }
        
        .cycle-title {
            font-size: 2rem;
            font-family: var(--font-display);
            color: var(--text-primary);
            margin-bottom: var(--space-lg);
            animation: revealText 0.8s ease 0.3s both;
        }
        
        .cycle-narrative {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: var(--space-lg);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            animation: revealText 0.8s ease 0.5s both;
        }
        
        .cycle-consequences {
            padding: var(--space-md);
            background: rgba(245, 166, 35, 0.05);
            border: 1px solid rgba(245, 166, 35, 0.2);
            border-radius: 4px;
            margin-top: var(--space-md);
            margin-bottom: var(--space-lg);
            animation: slideInFromRight 0.8s ease 0.7s both;
        }
        
        .cycle-consequences h4 {
            color: var(--gold);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: var(--space-sm);
        }
        
        .cycle-consequences-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        .consequence-item {
            padding: var(--space-sm);
            background: rgba(255, 255, 255, 0.02);
            border-left: 3px solid var(--gold);
            border-radius: 2px;
            text-align: left;
            font-size: 0.95rem;
        }
        
        /* ROOM ENTRY NARRATIVE */
        .room-entry-narrative {
            background: linear-gradient(135deg, rgba(245, 166, 35, 0.08) 0%, rgba(19, 38, 66, 0.08) 100%);
            border: 1px solid rgba(245, 166, 35, 0.2);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            animation: slideInFromLeft 0.6s ease;
        }
        
        .room-entry-narrative::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--gold), transparent);
        }
        
        .room-entry-title {
            font-size: 1.5rem;
            font-family: var(--font-display);
            color: var(--gold);
            margin-bottom: var(--space-md);
            animation: revealText 0.6s ease 0.2s both;
        }
        
        .room-entry-story {
            font-size: 1.05rem;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
            animation: revealText 0.6s ease 0.3s both;
        }
        
        .room-stakes {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 2px;
            margin-top: var(--space-md);
            animation: revealText 0.6s ease 0.4s both;
        }
        
        .room-stakes-label {
            color: var(--danger);
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .room-stakes-text {
            flex: 1;
            color: var(--text-primary);
        }
        
        
        /* DOSSIER */
        .dossier-container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-2xl) var(--space-md);
        }
        
        .dossier-title {
            text-align: center;
            font-size: 3rem;
            font-family: var(--font-display);
            font-weight: 400;
            margin-bottom: var(--space-sm);
        }
        
        .dossier-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: var(--space-2xl);
        }
        
        .dossier-content {
            background: var(--bg-card);
            border-radius: 2px;
            padding: var(--space-2xl);
            margin-bottom: var(--space-2xl);
            border: 1px solid var(--border);
        }
        
        .dossier-section {
            margin-bottom: var(--space-2xl);
        }
        
        .dossier-section h3 {
            font-family: var(--font-display);
            color: var(--gold);
            margin-bottom: var(--space-md);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-top: var(--space-lg);
        }
        
        .metric-card {
            background: var(--bg-elevated);
            padding: var(--space-md);
            border-radius: 2px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: var(--space-sm);
        }
        
        .metric-value-large {
            font-size: 1.5rem;
            font-weight: 700;
            margin: var(--space-sm) 0;
            color: var(--gold);
        }
        
        .metric-number {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .band-display {
            text-align: center;
            padding: var(--space-2xl);
            border-radius: 2px;
            border: 2px solid;
        }
        
        .band-display.band-gold {
            border-color: var(--gold);
        }
        
        .band-icon {
            font-size: 4rem;
            margin-bottom: var(--space-sm);
        }
        
        .band-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
            color: var(--gold);
        }
        
        .band-description {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .certificate-section {
            background: var(--bg-card);
            border-radius: 2px;
            padding: var(--space-2xl);
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .claim-code-box {
            background: var(--bg-elevated);
            padding: var(--space-lg);
            border-radius: 2px;
            margin: var(--space-lg) 0;
            border: 1px solid var(--border);
        }
        
        .claim-code {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gold);
            letter-spacing: 0.05em;
            margin: var(--space-sm) 0;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            border-radius: 2px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h2 {
            margin: 0;
            font-family: var(--font-display);
            font-weight: 400;
        }
        
        .modal-body {
            padding: var(--space-lg);
            max-height: calc(80vh - 100px);
            overflow-y: auto;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
            margin: var(--space-md) 0;
        }
        
        .feature-list li {
            padding: var(--space-sm);
            margin-bottom: var(--space-sm);
            background: var(--bg-elevated);
            border-radius: 2px;
            border-left: 3px solid var(--gold);
        }
        
        .steps-list {
            margin: var(--space-md) 0;
            padding-left: var(--space-lg);
        }
        
        .steps-list li {
            margin-bottom: var(--space-sm);
            color: var(--text-secondary);
        }
        
        .emphasis {
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--gold);
            margin-top: var(--space-lg);
        }
        
        /* UTILITY */
        .hidden {
            display: none !important;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .main-title {
                font-size: 3rem;
            }
            
            .intro-stats {
                flex-direction: column;
                gap: var(--space-md);
            }
            
            .franchise-grid {
                grid-template-columns: 1fr;
            }
            
            .rooms-grid {
                grid-template-columns: 1fr;
            }
            
            .hub-header {
                flex-direction: column;
                gap: var(--space-md);
                text-align: center;
            }
            
            .eval-layout {
                grid-template-columns: 1fr;
            }
            
            .cap-summary {
                grid-template-columns: 1fr;
            }
            
            .outcome-distribution {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login will replace this content if not authenticated -->
    <div id="game-content" style="display: none;">
    <!-- CYCLE TRANSITION OVERLAY -->
    <div id="cycle-transition-overlay" class="cycle-transition-overlay">
        <div class="cycle-transition-content">
            <div class="cycle-number" id="transition-cycle-number">2</div>
            <h2 class="cycle-title" id="transition-cycle-title">The Stakes Rise</h2>
            <p class="cycle-narrative" id="transition-cycle-narrative">
                Your decisions in the previous cycle have set the course. Now their consequences begin to manifest.
                The margin for error shrinks. Every choice compounds.
            </p>
            <div class="cycle-consequences" id="transition-consequences">
                <h4>Consequences From Previous Cycle</h4>
                <div class="cycle-consequences-list" id="transition-consequences-list"></div>
            </div>
            <button class="btn-primary" onclick="continueToCycle()" style="margin-top: 2rem; animation: revealText 0.8s ease 0.9s both;">
                Continue to Cycle <span id="transition-cycle-number-btn">2</span>
            </button>
        </div>
    </div>

    <!-- SCREEN 1: INTRO -->
    <div id="screen-intro" class="screen active">
        <div class="intro-background">
            <div class="gradient-orb orb-1"></div>
            <div class="gradient-orb orb-2"></div>
            <div class="gradient-orb orb-3"></div>
        </div>
        <div class="intro-container">
            <div class="intro-content">
                <div class="intro-badge">Track 201 Capstone</div>
                <h1 class="main-title">
                    <span class="title-line">THE FRONT</span>
                    <span class="title-line">OFFICE</span>
                </h1>
                <p class="tagline">Run the organization. Live with the consequences.</p>
                
                <div class="intro-stats">
                    <div class="intro-stat">
                        <div class="stat-number">4</div>
                        <div class="stat-label">Decision Cycles</div>
                    </div>
                    <div class="intro-stat">
                        <div class="stat-number">12+</div>
                        <div class="stat-label">Major Decisions</div>
                    </div>
                    <div class="intro-stat">
                        <div class="stat-number"></div>
                        <div class="stat-label">Consequences</div>
                    </div>
                </div>
                
                <div class="intro-actions">
                    <button class="btn-primary" id="btn-start">Enter The Front Office</button>
                    <button class="btn-ghost" id="btn-how-it-works">How It Works</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: FRANCHISE SELECTION -->
    <div id="screen-franchise" class="screen">
        <div class="franchise-background">
            <div class="gradient-orb orb-1"></div>
            <div class="gradient-orb orb-2"></div>
        </div>
        <div class="franchise-container">
            <div class="screen-header">
                <div class="screen-badge">Step 1 of 3</div>
                <h2 class="screen-title">Choose Your Franchise</h2>
                <p class="screen-subtitle">Each presents unique strategic challenges. Your choices shape the journey.</p>
            </div>
            
            <div class="franchise-grid">
                <div class="franchise-card">
                    <div class="franchise-icon"></div>
                    <div class="franchise-header">
                        <h3>Win-Now Contender</h3>
                        <span class="franchise-badge pressure-high">High Pressure</span>
                    </div>
                    <div class="franchise-body">
                        <p class="franchise-situation">Championship window closing. Aging superstar on final contract. Tight cap. Every decision matters.</p>
                        
                        <div class="franchise-metrics">
                            <div class="metric">
                                <span class="metric-label">Cap Space</span>
                                <div class="metric-bar">
                                    <div class="metric-fill" style="width: 15%"></div>
                                </div>
                                <span class="metric-value">Limited</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Roster Quality</span>
                                <div class="metric-bar">
                                    <div class="metric-fill elite" style="width: 85%"></div>
                                </div>
                                <span class="metric-value">Elite</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Timeline</span>
                                <div class="metric-bar">
                                    <div class="metric-fill warning" style="width: 30%"></div>
                                </div>
                                <span class="metric-value">2-3 years</span>
                            </div>
                        </div>

                        <div class="ownership-mandate">
                            <strong>Ownership Mandate:</strong>
                            We're all-in. Win now or face consequences.
                        </div>
                    </div>
                    <button class="btn-select" onclick="selectFranchise('contender')">Select Franchise</button>
                </div>

                <div class="franchise-card">
                    <div class="franchise-icon"></div>
                    <div class="franchise-header">
                        <h3>Rising Young Core</h3>
                        <span class="franchise-badge pressure-medium">Medium Pressure</span>
                    </div>
                    <div class="franchise-body">
                        <p class="franchise-situation">Promising talent on rookie deals. Cap flexibility for strategic moves. Uncertain ceiling. Fans want progress.</p>
                        
                        <div class="franchise-metrics">
                            <div class="metric">
                                <span class="metric-label">Cap Space</span>
                                <div class="metric-bar">
                                    <div class="metric-fill" style="width: 75%"></div>
                                </div>
                                <span class="metric-value">Abundant</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Roster Quality</span>
                                <div class="metric-bar">
                                    <div class="metric-fill" style="width: 60%"></div>
                                </div>
                                <span class="metric-value">Good</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Timeline</span>
                                <div class="metric-bar">
                                    <div class="metric-fill" style="width: 70%"></div>
                                </div>
                                <span class="metric-value">3-5 years</span>
                            </div>
                        </div>

                        <div class="ownership-mandate">
                            <strong>Ownership Mandate:</strong>
                            Make smart moves. Show progress. Build something sustainable.
                        </div>
                    </div>
                    <button class="btn-select" onclick="selectFranchise('young')">Select Franchise</button>
                </div>

                <div class="franchise-card">
                    <div class="franchise-icon"></div>
                    <div class="franchise-header">
                        <h3>Messy Middle</h3>
                        <span class="franchise-badge pressure-low">Rebuild Mode</span>
                    </div>
                    <div class="franchise-body">
                        <p class="franchise-situation">Stuck in mediocrity. Bad contract eating cap space. No clear identity. Strategic reset required.</p>
                        
                        <div class="franchise-metrics">
                            <div class="metric">
                                <span class="metric-label">Cap Space</span>
                                <div class="metric-bar">
                                    <div class="metric-fill warning" style="width: 35%"></div>
                                </div>
                                <span class="metric-value">Constrained</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Roster Quality</span>
                                <div class="metric-bar">
                                    <div class="metric-fill warning" style="width: 45%"></div>
                                </div>
                                <span class="metric-value">Below Average</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Timeline</span>
                                <div class="metric-bar">
                                    <div class="metric-fill" style="width: 85%"></div>
                                </div>
                                <span class="metric-value">5+ years</span>
                            </div>
                        </div>

                        <div class="ownership-mandate">
                            <strong>Ownership Mandate:</strong>
                            Fix this mess. Be creative. Restore credibility.
                        </div>
                    </div>
                    <button class="btn-select" onclick="selectFranchise('messy')">Select Franchise</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN 3: THE HUB -->
    <div id="screen-hub" class="screen">
        <div class="hub-container">
            <div class="hub-header">
                <div class="hub-title">
                    <h2>Front Office Command Center</h2>
                    <span class="franchise-name" id="current-franchise-name"></span>
                </div>
                <div class="cycle-indicator">
                    <span class="cycle-label">Cycle</span>
                    <span class="cycle-number" id="current-cycle">1</span>
                    <span class="cycle-total">/ 4</span>
                </div>
            </div>

            <div class="hub-main">
                <!-- Cycle Pressure Indicator -->
                <div id="pressure-indicator"></div>
                
                <!-- Mentor Widget -->
                <div id="mentor-widget" style="display:none;margin-bottom:1.5rem;padding:1.5rem;background:linear-gradient(135deg,rgba(245,166,35,0.15),rgba(218,165,32,0.05));border:2px solid var(--gold);border-radius:8px;">
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                        <div id="mentor-emoji" style="font-size:2.5rem;position:relative;">
                            <div id="mentor-level-badge" style="position:absolute;bottom:-5px;right:-5px;width:24px;height:24px;background:var(--gold);border:2px solid #000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:bold;color:#000;"></div>
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
                                <div>
                                    <div style="font-size:0.75rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;">Your Mentor</div>
                                    <div id="mentor-name" style="font-size:1.1rem;font-weight:bold;color:var(--gold);"></div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:0.75rem;color:var(--text-secondary);">Approval</div>
                                    <div id="mentor-approval-text" style="font-size:1.1rem;font-weight:bold;"></div>
                                </div>
                            </div>
                            <div style="background:rgba(0,0,0,0.3);height:6px;border-radius:3px;overflow:hidden;">
                                <div id="mentor-approval-bar" style="width:50%;height:100%;background:var(--gold);transition:width 0.5s,background 0.5s;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;margin-bottom:1rem;">
                        <button onclick="GMMentors.showMentorProfile()" class="btn-ghost" style="padding:0.6rem;font-size:0.8rem;">
                             Profile
                        </button>
                        <button onclick="GMMentors.showInbox()" class="btn-ghost" style="padding:0.6rem;font-size:0.8rem;position:relative;">
                             Inbox
                            <span id="inbox-badge" style="display:none;position:absolute;top:2px;right:2px;width:8px;height:8px;background:#ef4444;border-radius:50%;"></span>
                        </button>
                        <button onclick="GMMentors.showTimeline()" class="btn-ghost" style="padding:0.6rem;font-size:0.8rem;">
                             Story
                        </button>
                        <button onclick="GMMentors.showAchievements()" class="btn-ghost" style="padding:0.6rem;font-size:0.8rem;">
                             Awards
                        </button>
                    </div>
                    
                    <div id="mentor-challenge-display"></div>
                </div>
                
                <!-- Economic Mastery Tree Widget -->
                <div id="mastery-widget" style="margin-bottom:1.5rem;padding:1.5rem;background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(124,58,237,0.05));border:2px solid #8b5cf6;border-radius:8px;">
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                        <div style="font-size:2.5rem;"></div>
                        <div style="flex:1;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;">Economic Concepts</div>
                            <div style="font-size:1.1rem;font-weight:bold;color:#a78bfa;">Mastery Tree</div>
                        </div>
                        <button onclick="EconomicMasteryTree.showMasteryTree()" class="btn-ghost" style="padding:0.75rem 1rem;">
                             View
                        </button>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem;text-align:center;">
                        <div style="padding:0.75rem;background:rgba(255,255,255,0.05);border-radius:6px;">
                            <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.25rem;">Unlocked</div>
                            <div id="mastery-unlocked" style="font-size:1.3rem;font-weight:bold;color:#8b5cf6;">0/12</div>
                        </div>
                        <div style="padding:0.75rem;background:rgba(139,92,246,0.1);border-radius:6px;">
                            <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.25rem;">Mastered</div>
                            <div id="mastery-mastered" style="font-size:1.3rem;font-weight:bold;color:#a78bfa;">0/12</div>
                        </div>
                        <div style="padding:0.75rem;background:rgba(255,255,255,0.05);border-radius:6px;">
                            <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.25rem;">Progress</div>
                            <div id="mastery-percent" style="font-size:1.3rem;font-weight:bold;color:#8b5cf6;">0%</div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(0,0,0,0.3);height:6px;border-radius:3px;overflow:hidden;margin-top:1rem;">
                        <div id="mastery-progress-bar" style="width:0%;height:100%;background:#8b5cf6;transition:width 0.5s;"></div>
                    </div>
                </div>
                
                <!-- OWNER PRESSURE WIDGET -->
                <div id="owner-widget" style="margin-bottom:1.5rem;padding:1.5rem;background:linear-gradient(135deg,rgba(239,68,68,0.15),rgba(220,38,38,0.05));border:2px solid #ef4444;border-radius:8px;">
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                        <div style="font-size:2.5rem;"></div>
                        <div style="flex:1;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;">Owner</div>
                            <div id="owner-name" style="font-size:1.1rem;font-weight:bold;color:#ef4444;">Select Franchise</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                            <span style="font-size:0.85rem;color:var(--text-secondary);">Pressure</span>
                            <span id="owner-pressure-text" style="font-size:1rem;font-weight:bold;">50%</span>
                        </div>
                        <div style="background:rgba(0,0,0,0.3);height:8px;border-radius:4px;overflow:hidden;">
                            <div id="owner-pressure-bar" style="width:50%;height:100%;background:#ef4444;transition:width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                            <span style="font-size:0.85rem;color:var(--text-secondary);">Patience</span>
                            <span id="owner-patience-text" style="font-size:1rem;font-weight:bold;">100%</span>
                        </div>
                        <div style="background:rgba(0,0,0,0.3);height:8px;border-radius:4px;overflow:hidden;">
                            <div id="owner-patience-bar" style="width:100%;height:100%;background:#22c55e;transition:width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top:1rem;padding:0.75rem;background:rgba(0,0,0,0.3);border-radius:6px;text-align:center;">
                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.25rem;">Expectation</div>
                        <div id="owner-expectation" style="font-size:1rem;font-weight:bold;text-transform:uppercase;color:var(--gold);">COMPETE</div>
                    </div>
                </div>
                
                <!-- MEDIA HEAT WIDGET -->
                <div id="media-widget" style="margin-bottom:1.5rem;padding:1.5rem;background:linear-gradient(135deg,rgba(249,115,22,0.15),rgba(234,88,12,0.05));border:2px solid #f59e0b;border-radius:8px;">
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                        <div style="font-size:2.5rem;"></div>
                        <div style="flex:1;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;">Media</div>
                            <div style="font-size:1.1rem;font-weight:bold;color:#f59e0b;">Hot Seat</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                            <span style="font-size:0.85rem;color:var(--text-secondary);">Heat Level</span>
                            <span id="media-heat-text" style="font-size:1rem;font-weight:bold;text-transform:uppercase;">WARM</span>
                        </div>
                        <div style="background:rgba(0,0,0,0.3);height:8px;border-radius:4px;overflow:hidden;">
                            <div id="media-heat-bar" style="width:50%;height:100%;background:#f59e0b;transition:width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <div id="latest-headline" style="padding:0.75rem;background:rgba(0,0,0,0.3);border-radius:6px;border-left:3px solid #f59e0b;">
                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.25rem;">Latest Headline</div>
                        <div style="font-size:0.9rem;font-style:italic;">Season in progress...</div>
                    </div>
                </div>
                
                <div class="alert-feed">                             View
                        </button>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem;text-align:center;">
                        <div style="padding:0.75rem;background:rgba(255,255,255,0.05);border-radius:6px;">
                            <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.25rem;">Unlocked</div>
                            <div id="mastery-unlocked" style="font-size:1.3rem;font-weight:bold;color:#8b5cf6;">0/12</div>
                        </div>
                        <div style="padding:0.75rem;background:rgba(139,92,246,0.1);border-radius:6px;">
                            <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.25rem;">Mastered</div>
                            <div id="mastery-mastered" style="font-size:1.3rem;font-weight:bold;color:#a78bfa;">0/12</div>
                        </div>
                        <div style="padding:0.75rem;background:rgba(255,255,255,0.05);border-radius:6px;">
                            <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.25rem;">Progress</div>
                            <div id="mastery-percent" style="font-size:1.3rem;font-weight:bold;color:#8b5cf6;">0%</div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(0,0,0,0.3);height:6px;border-radius:3px;overflow:hidden;margin-top:1rem;">
                        <div id="mastery-progress-bar" style="width:0%;height:100%;background:#8b5cf6;transition:width 0.5s;"></div>
                    </div>
                </div>
                
                <div class="alert-feed">
                    <h3>Situation Brief</h3>
                    <div id="alert-container" class="alerts"></div>
                </div>

                <div class="rooms-grid">
                    <div class="room-card">
                        <div class="room-header">
                            <h3>Evaluation & Analytics</h3>
                            <span class="room-status" id="status-eval">Pending</span>
                        </div>
                        <div class="room-body">
                            <p class="room-desc">Intelligence briefing under uncertainty. Judge talent through noisy signals.</p>
                            <div class="room-metrics">
                                <div class="mini-metric">
                                    <span class="mini-label">Roster Quality</span>
                                    <span class="mini-value" id="metric-roster">--</span>
                                </div>
                                <div class="mini-metric">
                                    <span class="mini-label">Info Edge</span>
                                    <span class="mini-value" id="metric-info">--</span>
                                </div>
                            </div>
                            <div id="constraint-eval"></div>
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn-room" onclick="openRoom('eval')" id="btn-eval" style="flex:1;">Enter Room</button>
                            <button class="btn-ghost" onclick="skipRoom('eval')" id="btn-skip-eval" style="padding:0.75rem 1rem;font-size:0.8rem;">Skip</button>
                        </div>
                    </div>

                    <div class="room-card">
                        <div class="room-header">
                            <h3>Cap & Contracts</h3>
                            <span class="room-status" id="status-cap">Pending</span>
                        </div>
                        <div class="room-body">
                            <p class="room-desc">Hard constraint control panel. Irreversible financial commitments.</p>
                            <div class="room-metrics">
                                <div class="mini-metric">
                                    <span class="mini-label">Cap Flexibility</span>
                                    <span class="mini-value" id="metric-cap">--</span>
                                </div>
                                <div class="mini-metric">
                                    <span class="mini-label">Tax Exposure</span>
                                    <span class="mini-value" id="metric-tax">--</span>
                                </div>
                            </div>
                            <div id="constraint-cap"></div>
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn-room" onclick="openRoom('cap')" id="btn-cap" style="flex:1;">Enter Room</button>
                            <button class="btn-ghost" onclick="skipRoom('cap')" id="btn-skip-cap" style="padding:0.75rem 1rem;font-size:0.8rem;">Skip</button>
                        </div>
                    </div>

                    <div class="room-card">
                        <div class="room-header">
                            <h3>Relationships</h3>
                            <span class="room-status" id="status-relationships">Pending</span>
                        </div>
                        <div class="room-body">
                            <p class="room-desc">Repeated-game negotiation. Social capital and reputation matter.</p>
                            <div class="room-metrics">
                                <div class="mini-metric">
                                    <span class="mini-label">Trust Index</span>
                                    <span class="mini-value" id="metric-trust">--</span>
                                </div>
                                <div class="mini-metric">
                                    <span class="mini-label">Reputation</span>
                                    <span class="mini-value" id="metric-rep">--</span>
                                </div>
                            </div>
                            <div id="constraint-relationships"></div>
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn-room" onclick="openRoom('relationships')" id="btn-relationships" style="flex:1;">Enter Room</button>
                            <button class="btn-ghost" onclick="skipRoom('relationships')" id="btn-skip-relationships" style="padding:0.75rem 1rem;font-size:0.8rem;">Skip</button>
                        </div>
                    </div>

                    <div class="room-card">
                        <div class="room-header">
                            <h3>Risk & Portfolio</h3>
                            <span class="room-status" id="status-risk">Pending</span>
                        </div>
                        <div class="room-body">
                            <p class="room-desc">Exposure management. Balance expected value against variance.</p>
                            <div class="room-metrics">
                                <div class="mini-metric">
                                    <span class="mini-label">Risk Exposure</span>
                                    <span class="mini-value" id="metric-risk">--</span>
                                </div>
                                <div class="mini-metric">
                                    <span class="mini-label">Optionality</span>
                                    <span class="mini-value" id="metric-option">--</span>
                                </div>
                            </div>
                            <div id="constraint-risk"></div>
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn-room" onclick="openRoom('risk')" id="btn-risk" style="flex:1;">Enter Room</button>
                            <button class="btn-ghost" onclick="skipRoom('risk')" id="btn-skip-risk" style="padding:0.75rem 1rem;font-size:0.8rem;">Skip</button>
                        </div>
                    </div>
                </div>

                <div class="hub-actions">
                    <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap;">
                        <button 
                            class="btn-ghost" 
                            id="btn-teaching-mode" 
                            onclick="toggleTeachingMode()" 
                            style="padding:0.75rem 1.5rem;background:rgba(255,255,255,0.1);flex:1;max-width:200px;">
                             Teaching: OFF
                        </button>
                        <button 
                            class="btn-ghost" 
                            id="btn-call-mentor" 
                            onclick="showMentorCallModal()" 
                            style="padding:0.75rem 1.5rem;background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(124,58,237,0.1));border:2px solid #8b5cf6;flex:1;max-width:200px;">
                             Call Mentor
                        </button>
                        <button 
                            class="btn-ghost" 
                            id="btn-submit-progress" 
                            onclick="StudentSubmit.showSubmitModal()" 
                            style="padding:0.75rem 1.5rem;background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(22,163,74,0.1));border:2px solid #22c55e;flex:1;max-width:200px;">
                             Submit Progress
                        </button>
                        <button 
                            class="btn-ghost" 
                            onclick="AuthSystem.logout()" 
                            style="padding:0.75rem 1.5rem;background:rgba(239,68,68,0.1);border:2px solid #ef4444;flex:1;max-width:150px;">
                             Logout
                        </button>
                    </div>
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:1rem;">
                        Toggle economics lessons | Get mentor advice | Submit progress | Logout
                    </div>
                    <button class="btn-advance" id="btn-advance-cycle" disabled onclick="advanceCycle()">
                        All Decisions Locked  Advance to Next Cycle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN 4: ROOM MODAL -->
    <div id="screen-room" class="screen-overlay" style="display:none;">
        <div class="room-modal">
            <div class="room-modal-header">
                <div class="room-modal-title-section">
                    <h2 id="room-modal-title">Room Name</h2>
                    <div class="room-progress" id="room-progress">Cycle 1  Room Decision</div>
                </div>
                <button class="btn-close" onclick="closeRoomModal()">&times;</button>
            </div>
            <div class="room-modal-body" id="room-modal-content"></div>
        </div>
    </div>

    <!-- SCREEN: SEASON OUTCOME -->
    <div id="screen-outcome" class="modal-overlay" style="display:none;">
        <div id="outcome-content" class="modal-content-wide"></div>
    </div>

    <!-- SCREEN: RANDOM EVENT -->
    <div id="screen-event" class="modal-overlay" style="display:none;">
        <div id="event-content" class="modal-content-wide"></div>
    </div>

    <!-- SCREEN: TEACHING MOMENT -->
    <div id="screen-teaching" class="modal-overlay" style="display:none;">
        <div id="teaching-content" class="modal-content-wide"></div>
    </div>

    <!-- SCREEN: DRAFT LOTTERY -->
    <div id="screen-lottery" class="modal-overlay" style="display:none;">
        <div class="modal-content-wide" style="max-width:700px;">
            <div id="lottery-content"></div>
        </div>
    </div>

    <!-- SCREEN: TRADE PUZZLE -->
    <div id="screen-trade-puzzle" class="modal-overlay" style="display:none;">
        <div class="modal-content-wide" style="max-width:800px;">
            <div id="trade-puzzle-content"></div>
        </div>
    </div>

    <!-- SCREEN: PRESS CONFERENCE -->
    <div id="screen-press" class="modal-overlay" style="display:none;">
        <div class="modal-content-wide">
            <div id="press-content"></div>
        </div>
    </div>
    
    <!-- SCREEN: REPLAY STORY -->
    <div id="screen-replay" class="modal-overlay" style="display:none;">
        <div class="modal-content-wide">
            <div id="replay-content"></div>
        </div>
    </div>

    <!-- TRIVIA POPUP -->
    <div id="trivia-popup" style="position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,var(--navy-dark),#000814);border:2px solid var(--gold);border-radius:8px;padding:1.5rem;max-width:400px;display:none;z-index:1500;box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <div id="trivia-content"></div>
    </div>
    
    <!-- RIVAL GM TRACKER -->
    <div id="rival-tracker" style="position:fixed;top:80px;right:20px;background:linear-gradient(135deg,#ef4444,#991b1b);border:2px solid #ef4444;border-radius:8px;padding:1rem;max-width:280px;display:none;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
        <div id="rival-content"></div>
    </div>

    <!-- SCREEN 5: DOSSIER -->
    <div id="screen-dossier" class="screen">
        <div class="dossier-container">
            <h1 class="dossier-title">Front Office Dossier</h1>
            <p class="dossier-subtitle">Final Performance Report</p>
            
            <div id="dossier-content" class="dossier-content"></div>

            <div class="certificate-section">
                <h2>Completion Certificate</h2>
                <div class="claim-code-box">
                    <p>Your Claim Code:</p>
                    <div class="claim-code" id="claim-code">T201-FO-GOLD-20260101-1234-ABCD</div>
                    <button class="btn-ghost" onclick="copyClaimCode()">Copy Code</button>
                </div>
                <button class="btn-primary" onclick="window.print()">Print Certificate</button>
            </div>
        </div>
    </div>

    <!-- HOW IT WORKS MODAL -->
    <div id="modal-how" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>How The Front Office Works</h2>
                <button class="btn-close" onclick="closeModal('how')">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Your Mission</h3>
                <p>You are the General Manager of an NBA franchise. Over 4 decision cycles, you'll face real front-office challenges that test your understanding of economic principles.</p>
                
                <ul class="feature-list">
                    <li><strong>Evaluation & Analytics:</strong> Intelligence briefing under uncertainty. Incomplete signals.</li>
                    <li><strong>Cap & Contracts:</strong> Hard constraints. Irreversible commitments.</li>
                    <li><strong>Relationships:</strong> Social capital. Repeated games with memory.</li>
                    <li><strong>Risk & Portfolio:</strong> Variance management. Probability framing.</li>
                </ul>

                <h3>How It Works</h3>
                <ol class="steps-list">
                    <li>Choose a franchise archetype (each has unique challenges)</li>
                    <li>Visit all four rooms in the Front Office each cycle</li>
                    <li>Make decisions that compound over time</li>
                    <li>Early choices restrict or enable later options</li>
                    <li>Lock in your choices and face consequences</li>
                    <li>Receive your final dossier and claim code</li>
                </ol>

                <p class="emphasis">Decisions are irreversible. Context changes. Trade-offs compound.</p>
            </div>
        </div>
    </div>

    <script>

// ULTIMATE STORAGE SYSTEM - GitHub Pages Compatible with Import/Export
(function() {
    'use strict';
    
    window.AuthSystem = {
        currentUser: null,
        isTeacher: false,
        classCode: null,
        
        init: function() {
            try {
                var saved = localStorage.getItem('tfr_user');
                console.log('Checking for saved user:', saved);
                if (saved) {
                    this.currentUser = JSON.parse(saved);
                    this.isTeacher = this.currentUser.role === 'teacher';
                    this.classCode = this.currentUser.classCode;
                    console.log('User loaded:', this.currentUser);
                    return true;
                }
            } catch(e) {
                console.error('Auth init error:', e);
            }
            return false;
        },
        
        showLoginScreen: function() {
            document.body.innerHTML = '<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0a1628,#1e3a5f);"><div style="max-width:600px;width:100%;padding:3rem;background:rgba(255,255,255,0.05);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.5);"><div style="text-align:center;margin-bottom:2rem;"><div style="font-size:4rem;margin-bottom:1rem;"></div><h1 style="font-size:2.5rem;color:#f5a623;margin-bottom:0.5rem;">THE FRONT OFFICE</h1><p style="color:#b8c5d6;font-size:1.1rem;">BOW Sports Capital Track 201</p></div><div id="role-selection" style="margin-bottom:2rem;"><p style="text-align:center;margin-bottom:1rem;color:#b8c5d6;">I am a...</p><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;"><button onclick="AuthSystem.selectRole(\'student\')" style="padding:1.5rem;background:rgba(245,166,35,0.1);border:2px solid #f5a623;border-radius:8px;cursor:pointer;font-size:1.1rem;font-weight:600;color:#fff;"> Student</button><button onclick="AuthSystem.selectRole(\'teacher\')" style="padding:1.5rem;background:rgba(59,130,246,0.1);border:2px solid #3b82f6;border-radius:8px;cursor:pointer;font-size:1.1rem;font-weight:600;color:#fff;"> Teacher</button></div></div><div id="student-login" style="display:none;"><h3 style="color:#fff;margin-bottom:1rem;">Student Login</h3><input id="student-name" placeholder="Your Name" style="width:100%;padding:1rem;margin-bottom:1rem;border-radius:6px;border:2px solid #2d4a6f;background:rgba(0,0,0,0.3);color:#fff;font-size:1rem;"><input id="class-code" placeholder="Class Code (e.g. TFR-ABC123)" style="width:100%;padding:1rem;margin-bottom:1rem;border-radius:6px;border:2px solid #2d4a6f;background:rgba(0,0,0,0.3);color:#fff;font-size:1rem;text-transform:uppercase;"><button onclick="AuthSystem.studentSignIn()" style="width:100%;padding:1rem;background:#f5a623;color:#000;font-weight:bold;border-radius:6px;cursor:pointer;border:none;font-size:1.1rem;">Start Game </button><button onclick="AuthSystem.showRoleSelection()" style="width:100%;padding:0.75rem;margin-top:0.5rem;background:transparent;color:#b8c5d6;border:none;cursor:pointer;"> Back</button></div><div id="teacher-login" style="display:none;"><h3 style="color:#fff;margin-bottom:1rem;">Teacher Access</h3><input id="teacher-name" placeholder="Your Name" style="width:100%;padding:1rem;margin-bottom:1rem;border-radius:6px;border:2px solid #2d4a6f;background:rgba(0,0,0,0.3);color:#fff;font-size:1rem;"><div style="margin-bottom:1rem;"><input type="checkbox" id="use-existing" onchange="AuthSystem.toggleExistingClass()" style="margin-right:0.5rem;"><label for="use-existing" style="color:#b8c5d6;">Use existing class code</label></div><div id="existing-code-input" style="display:none;margin-bottom:1rem;"><input id="existing-class-code" placeholder="Enter existing class code" style="width:100%;padding:1rem;border-radius:6px;border:2px solid #2d4a6f;background:rgba(0,0,0,0.3);color:#fff;font-size:1rem;text-transform:uppercase;"></div><button onclick="AuthSystem.teacherSignIn()" style="width:100%;padding:1rem;background:#3b82f6;color:#fff;font-weight:bold;border-radius:6px;cursor:pointer;border:none;font-size:1.1rem;">Access Dashboard </button><button onclick="AuthSystem.showRoleSelection()" style="width:100%;padding:0.75rem;margin-top:0.5rem;background:transparent;color:#b8c5d6;border:none;cursor:pointer;"> Back</button></div></div></div>';
        },
        
        // Generate student progress code for submission to teacher
        generateProgressCode: function() {
            if (!this.currentUser || this.isTeacher) return null;
            
            var gameState = window.GameState || {};
            
            // Compress decision log (keep essential info)
            var compressedDecisions = [];
            var decLog = gameState.decisionLog || [];
            for (var i = 0; i < Math.min(decLog.length, 20); i++) {
                compressedDecisions.push({
                    c: decLog[i].cycle,
                    r: decLog[i].room,
                    t: (decLog[i].optionText || '').substring(0, 80)
                });
            }
            
            // Compress season outcomes
            var compressedOutcomes = [];
            var outcomes = gameState.seasonOutcomes || [];
            for (var j = 0; j < outcomes.length; j++) {
                compressedOutcomes.push({
                    o: outcomes[j].outcome,
                    r: outcomes[j].record,
                    ch: outcomes[j].championship ? 1 : 0
                });
            }
            
            // Compress press conference history
            var compressedPress = [];
            var pressHistory = gameState.pressConferenceHistory || [];
            for (var p = 0; p < pressHistory.length; p++) {
                var pc = pressHistory[p];
                compressedPress.push({
                    cy: pc.cycle,
                    ans: (pc.answers || []).map(function(a) {
                        return { q: (a.question || '').substring(0, 40), a: (a.answer || '').substring(0, 40) };
                    })
                });
            }
            
            var progressData = {
                v: 3, // version - updated
                n: this.currentUser.name,
                c: this.classCode,
                t: Date.now(),
                // Game progress
                cy: gameState.cycleIndex || 1,
                fr: gameState.franchise || '',
                fn: gameState.franchiseName || '',
                rq: Math.round(gameState.rosterQuality || 0),
                cf: Math.round(gameState.capFlexibility || 0),
                op: Math.round(gameState.optionality || 0),
                ti: Math.round(gameState.trustIndex || 0),
                re: Math.round(gameState.riskExposure || 0),
                mn: Math.round(gameState.mediaNarrative || 0),
                ch: gameState.championships || 0,
                pa: gameState.playoffAppearances || 0,
                opr: Math.round(gameState.ownerPressure || 50),
                opa: Math.round(gameState.ownerPatience || 100),
                cm: (gameState.conceptsLearned || []).length,
                dl: (gameState.decisionLog || []).length,
                // Detailed data
                dec: compressedDecisions,
                so: compressedOutcomes,
                pc: compressedPress,
                fl: (gameState.flags || []).slice(0, 10),
                // Quiz data
                qt: false,
                qs: 0,
                qp: 0,
                qa: []
            };
            
            // Get quiz data from localStorage
            try {
                var quizData = localStorage.getItem('tfr_quiz_' + this.currentUser.name);
                if (quizData) {
                    var qd = JSON.parse(quizData);
                    progressData.qt = true;
                    progressData.qs = qd.score || 0;
                    progressData.qp = qd.percentage || 0;
                    progressData.qa = qd.answers || [];
                }
            } catch(e) {}
            
            // Compress to base64
            var jsonStr = JSON.stringify(progressData);
            var encoded = btoa(unescape(encodeURIComponent(jsonStr)));
            return 'TFO:' + encoded;
        },
        
        // Parse student progress code
        parseProgressCode: function(code) {
            try {
                if (!code.startsWith('TFO:')) return null;
                var encoded = code.substring(4);
                var jsonStr = decodeURIComponent(escape(atob(encoded)));
                return JSON.parse(jsonStr);
            } catch(e) {
                console.error('Failed to parse progress code:', e);
                return null;
            }
        },
        
        // Save quiz results locally for export
        saveQuizResults: function(score, total, answers) {
            if (!this.currentUser) return;
            var quizData = {
                score: score,
                total: total,
                percentage: Math.round((score / total) * 100),
                answers: answers,
                timestamp: Date.now()
            };
            localStorage.setItem('tfr_quiz_' + this.currentUser.name, JSON.stringify(quizData));
        },
        
        toggleExistingClass: function() {
            var checkbox = document.getElementById('use-existing');
            var input = document.getElementById('existing-code-input');
            input.style.display = checkbox.checked ? 'block' : 'none';
        },
        
        selectRole: function(role) {
            document.getElementById('role-selection').style.display = 'none';
            if (role === 'student') {
                document.getElementById('student-login').style.display = 'block';
            } else {
                document.getElementById('teacher-login').style.display = 'block';
            }
        },
        
        showRoleSelection: function() {
            document.getElementById('student-login').style.display = 'none';
            document.getElementById('teacher-login').style.display = 'none';
            document.getElementById('role-selection').style.display = 'block';
        },
        
        studentSignIn: function() {
            var name = document.getElementById('student-name').value.trim();
            var code = document.getElementById('class-code').value.trim().toUpperCase();
            
            if (!name || !code) {
                alert('Please enter both your name and class code!');
                return;
            }
            
            // Save class code to persistent list
            this.addToClassList(code);
            
            // Check if class exists
            var classKey = 'class_' + code;
            var classData = localStorage.getItem(classKey);
            
            console.log('Looking for class:', classKey);
            console.log('Class data found:', classData);
            
            if (!classData) {
                // Class doesn't exist yet - create it for the student
                console.log('Class not found, creating it...');
                var newClassData = {
                    teacher: 'Not set',
                    classCode: code,
                    created: Date.now(),
                    students: []
                };
                localStorage.setItem(classKey, JSON.stringify(newClassData));
                console.log('Class created for student');
            }
            
            this.currentUser = {
                name: name,
                role: 'student',
                classCode: code,
                timestamp: Date.now()
            };
            
            this.isTeacher = false;
            this.classCode = code;
            
            localStorage.setItem('tfr_user', JSON.stringify(this.currentUser));
            console.log('User saved');
            
            this.registerStudent();
            location.reload();
        },
        
        teacherSignIn: function() {
            var name = document.getElementById('teacher-name').value.trim();
            if (!name) {
                alert('Please enter your name!');
                return;
            }
            
            var code;
            var useExisting = document.getElementById('use-existing').checked;
            
            if (useExisting) {
                code = document.getElementById('existing-class-code').value.trim().toUpperCase();
                if (!code) {
                    alert('Please enter the existing class code!');
                    return;
                }
                
                // Check if class exists
                var existingClass = localStorage.getItem('class_' + code);
                if (!existingClass) {
                    alert('Class code "' + code + '" not found! Create a new class instead.');
                    return;
                }
            } else {
                code = 'TFR-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            }
            
            console.log('Teacher accessing class:', code);
            
            this.currentUser = {
                name: name,
                role: 'teacher',
                classCode: code,
                timestamp: Date.now()
            };
            
            this.isTeacher = true;
            this.classCode = code;
            
            localStorage.setItem('tfr_user', JSON.stringify(this.currentUser));
            
            // Save class code to persistent list
            this.addToClassList(code);
            
            // Create or update class
            var classKey = 'class_' + code;
            var existingData = localStorage.getItem(classKey);
            
            if (existingData) {
                console.log('Accessing existing class');
            } else {
                var classData = {
                    teacher: name,
                    classCode: code,
                    created: Date.now(),
                    students: []
                };
                localStorage.setItem(classKey, JSON.stringify(classData));
                console.log('New class created');
            }
            
            window.TeacherDashboard.show();
        },
        
        addToClassList: function(code) {
            var list = localStorage.getItem('tfr_all_classes');
            var classes = list ? JSON.parse(list) : [];
            if (!classes.includes(code)) {
                classes.push(code);
                localStorage.setItem('tfr_all_classes', JSON.stringify(classes));
                console.log('Class code added to persistent list:', code);
            }
        },
        
        registerStudent: function() {
            try {
                var classKey = 'class_' + this.classCode;
                var classDataStr = localStorage.getItem(classKey);
                
                if (!classDataStr) {
                    console.error('Class not found during registration');
                    return;
                }
                
                var classData = JSON.parse(classDataStr);
                
                var exists = false;
                for (var i = 0; i < classData.students.length; i++) {
                    if (classData.students[i].name === this.currentUser.name) {
                        exists = true;
                        console.log('Student already exists');
                        break;
                    }
                }
                
                if (!exists) {
                    var newStudent = {
                        name: this.currentUser.name,
                        startTime: Date.now(),
                        currentCycle: 0,
                        lastActive: Date.now(),
                        rosterQuality: 0,
                        ownerPressure: 0,
                        conceptsMastered: 0,
                        championships: 0,
                        playoffAppearances: 0,
                        quizScore: 0,
                        quizTaken: false,
                        quizAnswers: [],
                        gameCompleted: false,
                        finalRoster: 0,
                        finalPressure: 0
                    };
                    
                    classData.students.push(newStudent);
                    localStorage.setItem(classKey, JSON.stringify(classData));
                    console.log('Student registered:', newStudent);
                }
            } catch(e) {
                console.error('Register error:', e);
            }
        },
        
        updateProgress: function(gameState) {
            if (!this.currentUser || this.isTeacher) {
                return;
            }
            
            try {
                var classKey = 'class_' + this.currentUser.classCode;
                var classDataStr = localStorage.getItem(classKey);
                
                if (!classDataStr) {
                    console.error('Class not found for update');
                    return;
                }
                
                var classData = JSON.parse(classDataStr);
                
                for (var i = 0; i < classData.students.length; i++) {
                    if (classData.students[i].name === this.currentUser.name) {
                        classData.students[i].currentCycle = gameState.cycleIndex;
                        classData.students[i].rosterQuality = Math.round(gameState.rosterQuality);
                        classData.students[i].ownerPressure = Math.round(gameState.ownerPressure);
                        classData.students[i].conceptsMastered = Object.keys(gameState.conceptMastery || {}).length;
                        classData.students[i].championships = gameState.championships || 0;
                        classData.students[i].playoffAppearances = gameState.playoffAppearances || 0;
                        classData.students[i].lastActive = Date.now();
                        
                        // Track if game completed
                        if (gameState.cycleIndex > 4) {
                            classData.students[i].gameCompleted = true;
                            classData.students[i].finalRoster = Math.round(gameState.rosterQuality);
                            classData.students[i].finalPressure = Math.round(gameState.ownerPressure);
                        }
                        
                        console.log('Progress updated:', classData.students[i]);
                        break;
                    }
                }
                
                localStorage.setItem(classKey, JSON.stringify(classData));
                
            } catch(e) {
                console.error('Update error:', e);
            }
        },
        
        submitQuiz: function(score, totalQuestions, answers) {
            if (!this.currentUser || this.isTeacher) {
                return;
            }
            
            try {
                var classKey = 'class_' + this.currentUser.classCode;
                var classData = JSON.parse(localStorage.getItem(classKey) || '{"students":[]}');
                
                for (var i = 0; i < classData.students.length; i++) {
                    if (classData.students[i].name === this.currentUser.name) {
                        classData.students[i].quizScore = score;
                        classData.students[i].quizTotalQuestions = totalQuestions;
                        classData.students[i].quizPercentage = Math.round((score / totalQuestions) * 100);
                        classData.students[i].quizTaken = true;
                        classData.students[i].quizAnswers = answers;
                        classData.students[i].quizSubmittedAt = Date.now();
                        console.log('Quiz submitted:', score + '/' + totalQuestions);
                        break;
                    }
                }
                
                localStorage.setItem(classKey, JSON.stringify(classData));
                
            } catch(e) {
                console.error('Quiz submit error:', e);
            }
        },
        
        logout: function() {
            if (confirm('Are you sure you want to logout? Any unsaved progress will be lost.')) {
                // Clear user data
                localStorage.removeItem('tfr_user');
                this.currentUser = null;
                this.isTeacher = false;
                this.classCode = null;
                
                // Reload page to show login screen
                location.reload();
            }
        }
    };
    
    window.TeacherDashboard = {
        refreshTimer: null,
        
        show: function() {
            var user = window.AuthSystem.currentUser;
            var classKey = 'class_' + user.classCode;
            var classData = JSON.parse(localStorage.getItem(classKey) || '{"students":[]}');
            
            console.log('Dashboard loading for:', classData);
            
            var html = '<div style="min-height:100vh;background:#0a1628;padding:2rem;"><div style="max-width:1600px;margin:auto;">';
            
            // Header
            html += '<div style="padding:1.5rem;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:2rem;">';
            html += '<h1 style="color:#f5a623;margin-bottom:0.5rem;"> Teacher Dashboard</h1>';
            html += '<p style="color:#b8c5d6;">Teacher: <strong>' + user.name + '</strong></p>';
            html += '<div style="margin:1rem 0;padding:1rem;background:rgba(245,166,35,0.15);border:2px dashed #f5a623;border-radius:8px;display:inline-block;">';
            html += '<p style="color:#b8c5d6;margin-bottom:0.5rem;"> CLASS CODE (Share with students):</p>';
            html += '<p style="color:#f5a623;font-size:2.5rem;font-weight:bold;letter-spacing:5px;font-family:monospace;">' + user.classCode + '</p>';
            html += '</div>';
            html += '<div style="margin-top:1rem;">';
            html += '<button onclick="TeacherDashboard.refresh()" style="padding:0.75rem 1.5rem;background:#f5a623;color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-right:0.5rem;"> Refresh</button>';
            html += '<button onclick="TeacherDashboard.showImportModal()" style="padding:0.75rem 1.5rem;background:#8b5cf6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-right:0.5rem;"> Import Student</button>';
            html += '<button onclick="TeacherDashboard.exportCSV()" style="padding:0.75rem 1.5rem;background:#22c55e;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-right:0.5rem;"> Export CSV</button>';
            html += '<button onclick="TeacherDashboard.showAllClasses()" style="padding:0.75rem 1.5rem;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-right:0.5rem;"> All Classes</button>';
            html += '<button onclick="AuthSystem.logout()" style="padding:0.75rem 1.5rem;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Logout</button>';
            html += '</div></div>';
            
            // GitHub Pages Notice
            html += '<div style="padding:1rem;background:rgba(139,92,246,0.15);border:2px solid #8b5cf6;border-radius:8px;margin-bottom:2rem;">';
            html += '<p style="color:#a78bfa;font-weight:600;margin-bottom:0.5rem;"> GitHub Pages Mode</p>';
            html += '<p style="color:#b8c5d6;font-size:0.9rem;">Students must click "Submit Progress" in their game and share their progress code with you. Click "Import Student" above to add their data.</p>';
            html += '</div>';
            
            // Calculate stats
            var total = classData.students.length;
            var completed = 0;
            var quizTaken = 0;
            var avgQuiz = 0;
            var avgCycle = 0;
            var avgRoster = 0;
            var totalChamps = 0;
            
            for (var i = 0; i < total; i++) {
                var s = classData.students[i];
                if (s.gameCompleted) completed++;
                if (s.quizTaken) {
                    quizTaken++;
                    avgQuiz += s.quizPercentage || 0;
                }
                avgCycle += s.currentCycle || 0;
                avgRoster += s.rosterQuality || 0;
                totalChamps += s.championships || 0;
            }
            
            if (total > 0) {
                avgCycle = avgCycle / total;
                avgRoster = avgRoster / total;
            }
            if (quizTaken > 0) {
                avgQuiz = avgQuiz / quizTaken;
            }
            
            // Stats cards
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem;">';
            html += '<div style="padding:1.5rem;background:#132642;border-radius:8px;border-left:4px solid #f5a623;"><div style="font-size:0.85rem;color:#b8c5d6;margin-bottom:0.5rem;">Total Students</div><div style="font-size:2.5rem;font-weight:bold;color:#f5a623;">' + total + '</div></div>';
            html += '<div style="padding:1.5rem;background:#132642;border-radius:8px;border-left:4px solid #22c55e;"><div style="font-size:0.85rem;color:#b8c5d6;margin-bottom:0.5rem;">Completed Game</div><div style="font-size:2.5rem;font-weight:bold;color:#22c55e;">' + completed + '</div></div>';
            html += '<div style="padding:1.5rem;background:#132642;border-radius:8px;border-left:4px solid #8b5cf6;"><div style="font-size:0.85rem;color:#b8c5d6;margin-bottom:0.5rem;">Quiz Taken</div><div style="font-size:2.5rem;font-weight:bold;color:#8b5cf6;">' + quizTaken + '</div></div>';
            html += '<div style="padding:1.5rem;background:#132642;border-radius:8px;border-left:4px solid #06b6d4;"><div style="font-size:0.85rem;color:#b8c5d6;margin-bottom:0.5rem;">Avg Quiz Score</div><div style="font-size:2.5rem;font-weight:bold;color:#06b6d4;">' + Math.round(avgQuiz) + '%</div></div>';
            html += '<div style="padding:1.5rem;background:#132642;border-radius:8px;border-left:4px solid #3b82f6;"><div style="font-size:0.85rem;color:#b8c5d6;margin-bottom:0.5rem;">Avg Cycle</div><div style="font-size:2.5rem;font-weight:bold;color:#3b82f6;">' + avgCycle.toFixed(1) + '</div></div>';
            html += '<div style="padding:1.5rem;background:#132642;border-radius:8px;border-left:4px solid #fbbf24;"><div style="font-size:0.85rem;color:#b8c5d6;margin-bottom:0.5rem;">Championships</div><div style="font-size:2.5rem;font-weight:bold;color:#fbbf24;"> ' + totalChamps + '</div></div>';
            html += '</div>';
            
            // Student table
            html += '<div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:1.5rem;">';
            html += '<h2 style="color:#f5a623;margin-bottom:1rem;">Students (' + total + ')</h2>';
            html += '<div style="overflow-x:auto;">';
            html += '<table style="width:100%;color:#fff;border-collapse:collapse;">';
            html += '<thead><tr style="background:rgba(255,255,255,0.1);">';
            html += '<th style="padding:1rem;text-align:left;border-bottom:2px solid #2d4a6f;">Name</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Cycle</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Quiz</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Roster</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Pressure</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Concepts</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Tier</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Champs</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Status</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Last Active</th>';
            html += '<th style="padding:1rem;border-bottom:2px solid #2d4a6f;">Actions</th>';
            html += '</tr></thead><tbody>';
            
            if (total === 0) {
                html += '<tr><td colspan="11" style="padding:3rem;text-align:center;"><div style="font-size:3rem;margin-bottom:1rem;"></div><p style="color:#b8c5d6;">No students yet</p><p style="color:#7a8a9e;margin-top:0.5rem;">Have students submit their progress codes, then click "Import Student" to add them.</p></td></tr>';
            } else {
                classData.students.sort(function(a, b) {
                    return (b.lastActive || 0) - (a.lastActive || 0);
                });
                
                for (var i = 0; i < classData.students.length; i++) {
                    html += this.renderStudentRow(classData.students[i]);
                }
            }
            
            html += '</tbody></table></div></div>';
            html += '<div style="margin-top:2rem;padding:1rem;background:rgba(245,166,35,0.1);border-radius:8px;text-align:center;">';
            html += '<p style="color:#b8c5d6;"> Works on GitHub Pages! Students submit progress codes  Teachers import them here</p>';
            html += '</div></div></div>';
            
            document.body.innerHTML = html;
            
            if (this.refreshTimer) clearInterval(this.refreshTimer);
            this.refreshTimer = setInterval(function() {
                window.TeacherDashboard.refresh();
            }, 10000);
        },
        
        renderStudentRow: function(s) {
            var timeAgo = this.getTimeAgo(s.lastUpdated ? new Date(s.lastUpdated) : new Date());
            window.studentDataCache[s.name] = s;
            var rosterColor = s.rosterQuality >= 70 ? '#22c55e' : s.rosterQuality >= 50 ? '#f59e0b' : '#ef4444';
            var pressureColor = s.ownerPressure >= 70 ? '#ef4444' : s.ownerPressure >= 50 ? '#f59e0b' : '#22c55e';
            
            var quizDisplay = s.quizTaken ? 
                '<span style="color:' + (s.quizPercentage >= 70 ? '#22c55e' : s.quizPercentage >= 60 ? '#f59e0b' : '#ef4444') + ';font-weight:600;">' + s.quizPercentage + '%</span>' :
                '<span style="color:#7a8a9e;">Not taken</span>';
            
            var status = s.gameCompleted ? '<span style="color:#22c55e;"> Done</span>' : 
                        s.currentCycle > 0 ? '<span style="color:#f59e0b;"> In Progress</span>' :
                        '<span style="color:#7a8a9e;"> Just Started</span>';
            
            var html = '<tr style="border-bottom:1px solid #2d4a6f;">';
            html += '<td style="padding:1rem;font-weight:600;">' + s.name + '</td>';
            html += '<td style="padding:1rem;text-align:center;"><strong>' + (s.currentCycle || 0) + '</strong>/4</td>';
            html += '<td style="padding:1rem;text-align:center;">' + quizDisplay + '</td>';
            html += '<td style="padding:1rem;text-align:center;"><span style="color:' + rosterColor + ';font-weight:600;">' + Math.round(s.rosterQuality || 0) + '%</span></td>';
            html += '<td style="padding:1rem;text-align:center;"><span style="color:' + pressureColor + ';font-weight:600;">' + Math.round(s.ownerPressure || 0) + '%</span></td>';
            html += '<td style="padding:1rem;text-align:center;">' + (s.conceptsMastered || 0) + '</td>';
            var tierDisplay = s.tier || 'Not Set';
            var tierColor = tierDisplay === 'Elite' ? '#fbbf24' : tierDisplay === 'Contender' ? '#22c55e' : tierDisplay === 'Middling' ? '#3b82f6' : tierDisplay === 'Rebuilding' ? '#f59e0b' : '#7a8a9e';
            html += '<td style="padding:1rem;text-align:center;"><span style="color:' + tierColor + ';font-weight:600;">' + tierDisplay + '</span></td>';
            html += '<td style="padding:1rem;text-align:center;">' + (s.championships > 0 ? ' ' + s.championships : '-') + '</td>';
            html += '<td style="padding:1rem;text-align:center;">' + status + '</td>';
            html += '<td style="padding:1rem;text-align:center;color:#7a8a9e;font-size:0.9rem;">' + timeAgo + '</td>';
            html += '<td style="padding:1rem;text-align:center;">';
            if (s.quizTaken) {
                html += '<button onclick="QuizViewer.show(\'' + s.name + '\')" style="padding:0.5rem 1rem;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.85rem;margin:0.25rem;"></button>';
            }
            if (s.pressConferenceAnswers && s.pressConferenceAnswers.length > 0) {
                html += '<button onclick="PressViewer.show(\'' + s.name + '\')" style="padding:0.5rem 1rem;background:#8b5cf6;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.85rem;margin:0.25rem;"></button>';
            }
            html += '</td>';
            html += '</tr>';
            return html;
        },
        
        getTimeAgo: function(date) {
            var sec = Math.floor((new Date() - date) / 1000);
            if (sec < 60) return 'Just now';
            if (sec < 3600) return Math.floor(sec / 60) + 'm ago';
            if (sec < 86400) return Math.floor(sec / 3600) + 'h ago';
            return Math.floor(sec / 86400) + 'd ago';
        },
        
        refresh: function() {
            this.show();
        },
        
        showAllClasses: function() {
            var allClasses = JSON.parse(localStorage.getItem('tfr_all_classes') || '[]');
            var html = '<div style="padding:2rem;max-width:800px;margin:auto;"><h2 style="color:#f5a623;">All Classes</h2>';
            html += '<div style="margin:1rem 0;">';
            
            if (allClasses.length === 0) {
                html += '<p style="color:#b8c5d6;">No classes created yet</p>';
            } else {
                for (var i = 0; i < allClasses.length; i++) {
                    var code = allClasses[i];
                    var classData = JSON.parse(localStorage.getItem('class_' + code) || '{}');
                    html += '<div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:1rem;">';
                    html += '<strong style="color:#f5a623;">' + code + '</strong> - ';
                    html += (classData.students ? classData.students.length : 0) + ' students';
                    html += '</div>';
                }
            }
            
            html += '</div><button onclick="TeacherDashboard.show()" style="padding:1rem;background:#f5a623;color:#000;border:none;border-radius:6px;cursor:pointer;">Back to Dashboard</button></div>';
            document.body.innerHTML = html;
        },
        
        exportCSV: function() {
            var user = window.AuthSystem.currentUser;
            var classData = JSON.parse(localStorage.getItem('class_' + user.classCode) || '{"students":[]}');
            
            var csv = 'Name,Cycle,Quiz Score,Quiz %,Roster Quality,Owner Pressure,Concepts,Tier,Championships,Completed,Last Active\n';
            
            for (var i = 0; i < classData.students.length; i++) {
                var s = classData.students[i];
                csv += '"' + s.name + '",';
                csv += (s.currentCycle || 0) + ',';
                csv += (s.quizTaken ? s.quizScore + '/' + s.quizTotalQuestions : 'Not taken') + ',';
                csv += (s.quizPercentage || 0) + ',';
                csv += Math.round(s.rosterQuality || 0) + ',';
                csv += Math.round(s.ownerPressure || 0) + ',';
                csv += (s.conceptsMastered || 0) + ',';
                csv += (s.tier || 'Not Set') + ',';
                csv += (s.championships || 0) + ',';
                csv += (s.gameCompleted ? 'Yes' : 'No') + ',';
                csv += '"' + new Date(s.lastActive || s.startTime).toLocaleString() + '"\n';
            }
            
            var blob = new Blob([csv], {type: 'text/csv'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'TFR_' + user.classCode + '_Grades_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        },
        
        // Show modal for importing student progress codes
        showImportModal: function() {
            var modalDiv = document.createElement('div');
            modalDiv.id = 'import-modal';
            modalDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;';
            
            modalDiv.innerHTML = '<div style="max-width:600px;width:90%;padding:2rem;background:#132642;border-radius:16px;border:2px solid #f5a623;">' +
                '<h2 style="color:#f5a623;margin-bottom:1rem;"> Import Student Progress</h2>' +
                '<p style="color:#b8c5d6;margin-bottom:1.5rem;">Paste the student\'s progress code below. Students can get this code by clicking "Submit Progress" in their game.</p>' +
                '<textarea id="import-code-input" placeholder="Paste progress code here (starts with TFO:...)" style="width:100%;height:150px;padding:1rem;border-radius:8px;border:2px solid #2d4a6f;background:rgba(0,0,0,0.3);color:#fff;font-family:monospace;font-size:0.9rem;resize:vertical;"></textarea>' +
                '<div id="import-preview" style="margin:1rem 0;padding:1rem;background:rgba(0,0,0,0.3);border-radius:8px;display:none;"></div>' +
                '<div style="display:flex;gap:1rem;margin-top:1rem;">' +
                '<button onclick="TeacherDashboard.previewImport()" style="flex:1;padding:1rem;background:#3b82f6;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;"> Preview</button>' +
                '<button onclick="TeacherDashboard.confirmImport()" id="btn-confirm-import" style="flex:1;padding:1rem;background:#22c55e;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;" disabled> Import</button>' +
                '</div>' +
                '<button onclick="TeacherDashboard.closeImportModal()" style="width:100%;padding:0.75rem;margin-top:1rem;background:transparent;color:#b8c5d6;border:1px solid #2d4a6f;border-radius:8px;cursor:pointer;">Cancel</button>' +
                '</div>';
            
            document.body.appendChild(modalDiv);
        },
        
        closeImportModal: function() {
            var modal = document.getElementById('import-modal');
            if (modal) modal.remove();
        },
        
        previewImport: function() {
            var code = document.getElementById('import-code-input').value.trim();
            var preview = document.getElementById('import-preview');
            var confirmBtn = document.getElementById('btn-confirm-import');
            
            var data = window.AuthSystem.parseProgressCode(code);
            
            if (!data) {
                preview.style.display = 'block';
                preview.innerHTML = '<div style="color:#ef4444;"> Invalid progress code. Make sure you copied the entire code starting with "TFO:"</div>';
                confirmBtn.disabled = true;
                return;
            }
            
            // Validate class code matches
            var user = window.AuthSystem.currentUser;
            if (data.c !== user.classCode) {
                preview.style.display = 'block';
                preview.innerHTML = '<div style="color:#f59e0b;"> Warning: Student\'s class code (' + data.c + ') doesn\'t match your class (' + user.classCode + ')</div>' +
                    '<div style="margin-top:1rem;color:#b8c5d6;">Student: <strong>' + data.n + '</strong></div>';
                confirmBtn.disabled = false;
                return;
            }
            
            preview.style.display = 'block';
            preview.innerHTML = '<div style="color:#22c55e;margin-bottom:1rem;"> Valid progress code!</div>' +
                '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.9rem;">' +
                '<div><strong>Name:</strong> ' + data.n + '</div>' +
                '<div><strong>Cycle:</strong> ' + data.cy + '/4</div>' +
                '<div><strong>Franchise:</strong> ' + (data.fn || 'Not set') + '</div>' +
                '<div><strong>Roster:</strong> ' + data.rq + '%</div>' +
                '<div><strong>Championships:</strong> ' + data.ch + '</div>' +
                '<div><strong>Quiz:</strong> ' + (data.qt ? data.qp + '%' : 'Not taken') + '</div>' +
                '</div>';
            
            confirmBtn.disabled = false;
            window._pendingImport = data;
        },
        
        confirmImport: function() {
            var data = window._pendingImport;
            if (!data) return;
            
            var user = window.AuthSystem.currentUser;
            var classKey = 'class_' + user.classCode;
            var classData = JSON.parse(localStorage.getItem(classKey) || '{"students":[]}');
            
            // Check if student already exists
            var existingIdx = -1;
            for (var i = 0; i < classData.students.length; i++) {
                if (classData.students[i].name === data.n) {
                    existingIdx = i;
                    break;
                }
            }
            
            // Build student record
            var studentRecord = {
                name: data.n,
                classCode: data.c,
                currentCycle: data.cy,
                franchise: data.fr,
                franchiseName: data.fn,
                rosterQuality: data.rq,
                capFlexibility: data.cf,
                optionality: data.op,
                trustIndex: data.ti,
                riskExposure: data.re,
                mediaNarrative: data.mn,
                championships: data.ch,
                playoffAppearances: data.pa,
                ownerPressure: data.opr,
                ownerPatience: data.opa,
                conceptsMastered: data.cm,
                decisionsCount: data.dl,
                quizTaken: data.qt,
                quizScore: data.qs,
                quizPercentage: data.qp,
                quizAnswers: data.qa,
                gameCompleted: data.cy > 4,
                lastActive: data.t,
                startTime: data.t,
                tier: data.rq >= 80 ? 'Elite' : data.rq >= 60 ? 'Contender' : data.rq >= 40 ? 'Middling' : 'Rebuilding'
            };
            
            if (existingIdx >= 0) {
                classData.students[existingIdx] = studentRecord;
            } else {
                classData.students.push(studentRecord);
            }
            
            localStorage.setItem(classKey, JSON.stringify(classData));
            
            this.closeImportModal();
            this.show();
            
            alert(' Successfully imported progress for ' + data.n + '!');
            window._pendingImport = null;
        }
    };
    
    // Student progress submission UI
    window.StudentSubmit = {
        showSubmitModal: function() {
            var code = window.AuthSystem.generateProgressCode();
            if (!code) {
                alert('Error generating progress code. Make sure you are logged in as a student.');
                return;
            }
            
            var modalDiv = document.createElement('div');
            modalDiv.id = 'submit-modal';
            modalDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;overflow-y:auto;padding:1rem;';
            
            modalDiv.innerHTML = '<div style="max-width:650px;width:100%;padding:2rem;background:#132642;border-radius:16px;border:2px solid #22c55e;margin:auto;">' +
                '<div style="text-align:center;margin-bottom:1.5rem;">' +
                '<div style="font-size:4rem;margin-bottom:1rem;"></div>' +
                '<h2 style="color:#22c55e;">Submit Your Work</h2>' +
                '</div>' +
                
                // PDF Download Section
                '<div style="padding:1.5rem;background:linear-gradient(135deg,rgba(245,166,35,0.15),rgba(218,165,32,0.05));border:2px solid #f5a623;border-radius:12px;margin-bottom:1.5rem;">' +
                '<div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">' +
                '<div style="font-size:2.5rem;"></div>' +
                '<div>' +
                '<h3 style="color:#f5a623;margin:0;">Download PDF Report</h3>' +
                '<p style="color:#b8c5d6;font-size:0.85rem;margin:0.25rem 0 0 0;">Complete report with all decisions for grading</p>' +
                '</div>' +
                '</div>' +
                '<button onclick="StudentSubmit.generatePDF()" style="width:100%;padding:1rem;background:#f5a623;color:#000;font-weight:bold;border:none;border-radius:8px;cursor:pointer;font-size:1rem;"> Download PDF Report</button>' +
                '</div>' +
                
                // Progress Code Section  
                '<div style="padding:1rem;background:rgba(0,0,0,0.3);border-radius:8px;margin-bottom:1rem;">' +
                '<p style="color:#b8c5d6;margin-bottom:0.75rem;font-size:0.85rem;">Or copy progress code for your teacher:</p>' +
                '<textarea id="progress-code-output" readonly style="width:100%;height:60px;padding:0.75rem;border-radius:6px;border:2px solid #22c55e;background:rgba(0,0,0,0.3);color:#22c55e;font-family:monospace;font-size:0.75rem;resize:none;">' + code + '</textarea>' +
                '</div>' +
                '<button onclick="StudentSubmit.copyCode()" style="width:100%;padding:0.85rem;background:#22c55e;color:#000;font-weight:bold;border:none;border-radius:8px;cursor:pointer;font-size:0.95rem;"> Copy Progress Code</button>' +
                '<button onclick="StudentSubmit.close()" style="width:100%;padding:0.75rem;margin-top:1rem;background:transparent;color:#b8c5d6;border:1px solid #2d4a6f;border-radius:8px;cursor:pointer;">Close</button>' +
                '</div>';
            
            document.body.appendChild(modalDiv);
        },
        
        copyCode: function() {
            var textarea = document.getElementById('progress-code-output');
            textarea.select();
            document.execCommand('copy');
            
            var btn = textarea.parentElement.nextElementSibling;
            btn.textContent = ' Copied!';
            btn.style.background = '#16a34a';
            
            setTimeout(function() {
                btn.textContent = ' Copy Progress Code';
                btn.style.background = '#22c55e';
            }, 2000);
        },
        
        generatePDF: function() {
            // Load jsPDF from CDN
            if (typeof window.jspdf === 'undefined') {
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = function() { StudentSubmit.createPDF(); };
                script.onerror = function() { alert('Failed to load PDF library. Check your internet connection.'); };
                document.head.appendChild(script);
            } else {
                this.createPDF();
            }
        },
        
        createPDF: function() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var gs = window.GameState || {};
            var user = window.AuthSystem ? window.AuthSystem.currentUser : {};
            
            var y = 15;
            var margin = 15;
            var pageWidth = 210;
            var contentWidth = pageWidth - margin * 2;
            
            function checkPage(need) {
                if (y + need > 280) { doc.addPage(); y = 15; }
            }
            
            function addSection(title) {
                checkPage(20);
                doc.setFillColor(10, 22, 40);
                doc.rect(margin, y, contentWidth, 8, 'F');
                doc.setTextColor(245, 166, 35);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(title, margin + 3, y + 5.5);
                y += 12;
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
            }
            
            // Header
            doc.setFillColor(10, 22, 40);
            doc.rect(0, 0, pageWidth, 35, 'F');
            doc.setTextColor(245, 166, 35);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('THE FRONT OFFICE', pageWidth/2, 15, {align:'center'});
            doc.setFontSize(10);
            doc.setTextColor(180, 180, 180);
            doc.text('BOW Sports Capital Track 201 - Student Report', pageWidth/2, 23, {align:'center'});
            doc.text('Generated: ' + new Date().toLocaleString(), pageWidth/2, 30, {align:'center'});
            
            y = 45;
            
            // Student Info
            addSection('STUDENT INFORMATION');
            doc.text('Name: ' + (user.name || 'Unknown'), margin, y); y += 5;
            doc.text('Class Code: ' + (user.classCode || 'N/A'), margin, y); y += 5;
            doc.text('Franchise: ' + (gs.franchiseName || 'Not Selected') + ' (' + (gs.franchise || 'N/A') + ')', margin, y); y += 5;
            doc.text('Cycles Completed: ' + ((gs.cycleIndex || 1) - 1) + ' / 4', margin, y); y += 8;
            
            // Performance Summary
            addSection('PERFORMANCE SUMMARY');
            var champs = gs.championships || 0;
            var playoffs = gs.playoffAppearances || 0;
            doc.text('Championships Won: ' + champs, margin, y); y += 5;
            doc.text('Playoff Appearances: ' + playoffs, margin, y); y += 5;
            doc.text('Final Roster Quality: ' + Math.round(gs.rosterQuality || 50) + '%', margin, y); y += 5;
            doc.text('Owner Pressure: ' + Math.round(gs.ownerPressure || 50) + '%', margin, y); y += 8;
            
            // All Metrics
            addSection('FINAL METRICS');
            var metrics = [
                ['Roster Quality', gs.rosterQuality],
                ['Cap Flexibility', gs.capFlexibility],
                ['Optionality', gs.optionality],
                ['Trust Index', gs.trustIndex],
                ['Risk Exposure', gs.riskExposure],
                ['Media Narrative', gs.mediaNarrative],
                ['Agent Relations', gs.reputationAgents]
            ];
            for (var m = 0; m < metrics.length; m++) {
                doc.text(metrics[m][0] + ': ' + Math.round(metrics[m][1] || 50) + '/100', margin + (m % 2) * 85, y);
                if (m % 2 === 1) y += 5;
            }
            y += 8;
            
            // Decision History
            addSection('DECISION HISTORY');
            var decisions = gs.decisionLog || [];
            if (decisions.length === 0) {
                doc.setFont('helvetica', 'italic');
                doc.text('No decisions recorded.', margin, y);
                y += 8;
            } else {
                doc.setFontSize(9);
                for (var d = 0; d < decisions.length; d++) {
                    checkPage(15);
                    var dec = decisions[d];
                    doc.setFont('helvetica', 'bold');
                    doc.text('Cycle ' + (dec.cycle || '?') + ' - ' + (dec.room || 'Unknown').toUpperCase(), margin, y);
                    y += 4;
                    doc.setFont('helvetica', 'normal');
                    var lines = doc.splitTextToSize(dec.optionText || 'Decision made', contentWidth);
                    doc.text(lines, margin, y);
                    y += lines.length * 4 + 3;
                }
            }
            
            // Season Outcomes
            var outcomes = gs.seasonOutcomes || [];
            if (outcomes.length > 0) {
                addSection('SEASON RESULTS');
                doc.setFontSize(9);
                for (var o = 0; o < outcomes.length; o++) {
                    checkPage(8);
                    var oc = outcomes[o];
                    var text = 'Cycle ' + (o+1) + ': ' + (oc.outcome || 'Complete') + ' (' + (oc.record || 'N/A') + ')';
                    if (oc.championship || oc.outcome === 'Championship') text += ' - CHAMPIONSHIP!';
                    doc.text(text, margin, y);
                    y += 5;
                }
                y += 5;
            }
            
            // Press Conference History
            var pressHistory = gs.pressConferenceHistory || [];
            if (pressHistory.length > 0) {
                addSection('PRESS CONFERENCE ANSWERS');
                doc.setFontSize(9);
                for (var p = 0; p < pressHistory.length; p++) {
                    checkPage(20);
                    var pc = pressHistory[p];
                    doc.setFont('helvetica', 'bold');
                    doc.text('Cycle ' + pc.cycle + ' Press Conference:', margin, y);
                    y += 5;
                    doc.setFont('helvetica', 'normal');
                    for (var a = 0; a < (pc.answers || []).length; a++) {
                        checkPage(10);
                        var ans = pc.answers[a];
                        doc.text('Q: ' + (ans.question || '').substring(0, 60), margin, y);
                        y += 4;
                        doc.text('A: "' + (ans.answer || '').substring(0, 55) + '"', margin + 3, y);
                        y += 5;
                    }
                    y += 3;
                }
            }
            
            // Strategic Flags
            var flags = gs.flags || [];
            if (flags.length > 0) {
                addSection('STRATEGIC FLAGS');
                doc.setFontSize(9);
                var flagText = flags.map(function(f) { return f.replace(/_/g, ' '); }).join(', ');
                var flagLines = doc.splitTextToSize(flagText, contentWidth);
                doc.text(flagLines, margin, y);
                y += flagLines.length * 4 + 5;
            }
            
            // Claim Code
            checkPage(30);
            var claimCode = gs.generateClaimCode ? gs.generateClaimCode() : 'N/A';
            doc.setFillColor(245, 166, 35);
            doc.roundedRect(margin, y, contentWidth, 20, 3, 3, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('CLAIM CODE', pageWidth/2, y + 6, {align:'center'});
            doc.setFontSize(14);
            doc.text(claimCode, pageWidth/2, y + 14, {align:'center'});
            
            // Footer
            doc.setTextColor(128, 128, 128);
            doc.setFontSize(7);
            doc.text('The Front Office - BOW Sports Capital Track 201 | This report contains the student\'s actual simulation data.', pageWidth/2, 290, {align:'center'});
            
            // Save
            var fileName = 'FrontOffice_' + (user.name || 'Student').replace(/[^a-zA-Z0-9]/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.pdf';
            doc.save(fileName);
        },
        
        close: function() {
            var modal = document.getElementById('submit-modal');
            if (modal) modal.remove();
        }
    };
    
})();

console.log(' Ultimate storage system loaded - Classes persist forever!');



// CLEAN INTEGRATION - No Quote Issues

// Store student data in a temporary global for viewing
window.studentDataCache = {};

window.QuizViewer = {
    show: function(studentName) {
        var studentData = window.studentDataCache[studentName];
        if (!studentData) {
            alert('Student data not found');
            return;
        }
        
        var modal = document.getElementById('screen-replay');
        if (!modal) {
            alert('Modal not found');
            return;
        }
        var content = document.getElementById('replay-content');
        
        var html = '<div style="padding:2rem;max-width:900px;margin:auto;max-height:90vh;overflow-y:auto;">';
        html += '<h2 style="color:#f5a623;margin-bottom:1rem;">Quiz Answers: ' + studentName + '</h2>';
        
        if (!studentData.quizTaken) {
            html += '<div style="padding:2rem;text-align:center;color:#b8c5d6;">';
            html += '<div style="font-size:3rem;margin-bottom:1rem;"></div>';
            html += '<p>Student has not taken the quiz yet.</p>';
            html += '</div>';
        } else {
            html += '<div style="padding:1.5rem;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:2rem;">';
            html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;text-align:center;">';
            html += '<div><div style="color:#b8c5d6;font-size:0.9rem;">Score</div><div style="font-size:2rem;font-weight:bold;color:#f5a623;">' + studentData.quizScore + '/' + studentData.quizTotalQuestions + '</div></div>';
            
            var pctColor = studentData.quizPercentage >= 70 ? '#22c55e' : studentData.quizPercentage >= 60 ? '#f59e0b' : '#ef4444';
            html += '<div><div style="color:#b8c5d6;font-size:0.9rem;">Percentage</div><div style="font-size:2rem;font-weight:bold;color:' + pctColor + ';">' + studentData.quizPercentage + '%</div></div>';
            
            var submitTime = studentData.quizSubmittedAt ? new Date(studentData.quizSubmittedAt).toLocaleString() : 'N/A';
            html += '<div><div style="color:#b8c5d6;font-size:0.9rem;">Submitted</div><div style="font-size:0.9rem;color:#b8c5d6;margin-top:0.5rem;">' + submitTime + '</div></div>';
            html += '</div></div>';
            
            if (studentData.quizAnswers && studentData.quizAnswers.length > 0) {
                html += '<h3 style="margin-bottom:1rem;">Detailed Answers:</h3>';
                
                for (var i = 0; i < studentData.quizAnswers.length; i++) {
                    var ans = studentData.quizAnswers[i];
                    var isCorrect = ans.correct;
                    var borderColor = isCorrect ? '#22c55e' : '#ef4444';
                    
                    html += '<div style="padding:1.5rem;background:rgba(255,255,255,0.03);border-left:4px solid ' + borderColor + ';border-radius:8px;margin-bottom:1rem;">';
                    html += '<div style="display:flex;justify-content:space-between;margin-bottom:0.75rem;">';
                    html += '<div style="font-weight:600;color:#f5a623;">Question ' + (i + 1) + '</div>';
                    
                    var badge = isCorrect ? 
                        '<div style="padding:0.25rem 0.75rem;background:rgba(34,197,94,0.2);border-radius:4px;color:#22c55e;font-size:0.85rem;"> Correct</div>' :
                        '<div style="padding:0.25rem 0.75rem;background:rgba(239,68,68,0.2);border-radius:4px;color:#ef4444;font-size:0.85rem;"> Incorrect</div>';
                    html += badge;
                    html += '</div>';
                    
                    html += '<div style="color:#b8c5d6;margin-bottom:0.75rem;">' + (ans.question || 'Question text not available') + '</div>';
                    html += '<div style="margin-bottom:0.5rem;"><strong>Student Answer:</strong> <span style="color:' + (isCorrect ? '#22c55e' : '#ef4444') + ';">' + (ans.studentAnswer || 'Not answered') + '</span></div>';
                    
                    if (!isCorrect && ans.correctAnswer) {
                        html += '<div><strong style="color:#22c55e;">Correct Answer:</strong> ' + ans.correctAnswer + '</div>';
                    }
                    
                    html += '</div>';
                }
            } else {
                html += '<div style="padding:2rem;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center;color:#7a8a9e;">';
                html += '<p>Quiz answers not recorded in detail.</p>';
                html += '<p style="margin-top:0.5rem;">Score: ' + studentData.quizScore + '/' + studentData.quizTotalQuestions + '</p>';
                html += '</div>';
            }
        }
        
        html += '<button onclick="QuizViewer.close()" style="width:100%;padding:1rem;background:#f5a623;color:#000;font-weight:bold;border-radius:8px;border:none;cursor:pointer;margin-top:2rem;">Close</button>';
        html += '</div>';
        
        content.innerHTML = html;
        modal.style.display = 'flex';
    },
    
    close: function() {
        document.getElementById('screen-replay').style.display = 'none';
        if (window.TeacherDashboard) {
            window.TeacherDashboard.show();
        }
    }
};

window.PressViewer = {
    show: function(studentName) {
        var studentData = window.studentDataCache[studentName];
        if (!studentData) {
            alert('Student data not found');
            return;
        }
        
        var modal = document.getElementById('screen-replay');
        if (!modal) {
            alert('Modal not found');
            return;
        }
        var content = document.getElementById('replay-content');
        
        var html = '<div style="padding:2rem;max-width:900px;margin:auto;max-height:90vh;overflow-y:auto;">';
        html += '<h2 style="color:#f5a623;margin-bottom:1rem;">Press Conference Answers: ' + studentName + '</h2>';
        
        if (!studentData.pressConferenceAnswers || studentData.pressConferenceAnswers.length === 0) {
            html += '<div style="padding:2rem;text-align:center;color:#b8c5d6;">';
            html += '<div style="font-size:3rem;margin-bottom:1rem;"></div>';
            html += '<p>No press conference answers recorded yet.</p>';
            html += '</div>';
        } else {
            for (var c = 0; c < studentData.pressConferenceAnswers.length; c++) {
                var conf = studentData.pressConferenceAnswers[c];
                
                html += '<div style="padding:1.5rem;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:1.5rem;">';
                html += '<h3 style="color:#f5a623;margin-bottom:1rem;">Cycle ' + conf.cycle + ' Press Conference</h3>';
                
                var totalMedia = 0;
                var totalOwner = 0;
                
                for (var i = 0; i < conf.answers.length; i++) {
                    var ans = conf.answers[i];
                    totalMedia += ans.mediaEffect;
                    totalOwner += ans.ownerEffect;
                    
                    var ansColor = (ans.mediaEffect > 5 || ans.ownerEffect > 5) ? '#22c55e' :
                                  (ans.mediaEffect < -10 || ans.ownerEffect < -10) ? '#ef4444' : '#7a8a9e';
                    
                    html += '<div style="padding:1rem;background:rgba(255,255,255,0.03);border-left:4px solid ' + ansColor + ';border-radius:8px;margin-bottom:0.75rem;">';
                    html += '<div style="font-size:0.85rem;color:#7a8a9e;margin-bottom:0.5rem;">Q: ' + ans.question + '</div>';
                    html += '<div style="font-weight:600;color:#fff;margin-bottom:0.5rem;">"' + ans.answer + '"</div>';
                    html += '<div style="font-size:0.85rem;color:#b8c5d6;">Media: ' + (ans.mediaEffect > 0 ? '+' : '') + ans.mediaEffect + ' | Owner: ' + (ans.ownerEffect > 0 ? '+' : '') + ans.ownerEffect + '</div>';
                    html += '</div>';
                }
                
                html += '<div style="margin-top:1rem;padding:1rem;background:rgba(245,166,35,0.1);border-radius:8px;">';
                html += '<strong>Total Impact:</strong> Media ' + (totalMedia > 0 ? '+' : '') + totalMedia + ' | Owner ' + (totalOwner > 0 ? '+' : '') + totalOwner;
                html += '</div></div>';
            }
        }
        
        html += '<button onclick="PressViewer.close()" style="width:100%;padding:1rem;background:#f5a623;color:#000;font-weight:bold;border-radius:8px;border:none;cursor:pointer;margin-top:2rem;">Close</button>';
        html += '</div>';
        
        content.innerHTML = html;
        modal.style.display = 'flex';
    },
    
    close: function() {
        document.getElementById('screen-replay').style.display = 'none';
        if (window.TeacherDashboard) {
            window.TeacherDashboard.show();
        }
    }
};

window.InteractivePressConference = {
    questions: [],
    answers: [],
    currentIndex: 0,
    completedCycles: {}, // Track which cycles have been completed
    
    // Check if press conference for this cycle is already done
    hasCompletedForCycle: function(cycle) {
        return this.completedCycles[cycle] === true;
    },
    
    // Get answers for a specific cycle
    getAnswersForCycle: function(cycle) {
        if (!window.GameState || !window.GameState.pressConferenceHistory) return null;
        return window.GameState.pressConferenceHistory.find(function(pc) {
            return pc.cycle === cycle;
        });
    },
    
    show: function(outcome) {
        var currentCycle = window.GameState ? window.GameState.cycleIndex - 1 : 0;
        
        // Check if already completed for this cycle
        if (this.hasCompletedForCycle(currentCycle)) {
            this.showPriorAnswers(currentCycle);
            return;
        }
        
        this.questions = this.generateQuestions(outcome);
        this.answers = [];
        this.currentIndex = 0;
        this.currentCycle = currentCycle;
        this.showQuestion(0);
    },
    
    // Show prior answers instead of allowing new submission
    showPriorAnswers: function(cycle) {
        var priorAnswers = this.getAnswersForCycle(cycle);
        var modal = document.getElementById('screen-replay');
        var content = document.getElementById('replay-content');
        
        if (!modal || !content) return;
        
        var html = '<div style="padding:2rem;max-width:700px;margin:auto;">';
        html += '<div style="text-align:center;margin-bottom:2rem;">';
        html += '<div style="font-size:4rem;margin-bottom:1rem;"></div>';
        html += '<h2 style="color:#f5a623;">Cycle ' + cycle + ' Press Conference</h2>';
        html += '<p style="color:#22c55e;font-weight:600;"> Already Completed</p>';
        html += '</div>';
        
        if (priorAnswers && priorAnswers.answers) {
            html += '<h3 style="color:#fff;margin-bottom:1rem;">Your Answers:</h3>';
            
            var totalMedia = 0, totalOwner = 0;
            for (var i = 0; i < priorAnswers.answers.length; i++) {
                var ans = priorAnswers.answers[i];
                totalMedia += ans.mediaEffect || 0;
                totalOwner += ans.ownerEffect || 0;
                
                html += '<div style="padding:1rem;background:rgba(255,255,255,0.05);border-left:4px solid #f5a623;border-radius:8px;margin-bottom:1rem;">';
                html += '<div style="font-size:0.9rem;color:#b8c5d6;margin-bottom:0.5rem;">Q: ' + ans.question + '</div>';
                html += '<div style="font-weight:600;color:#fff;">"' + ans.answer + '"</div>';
                html += '<div style="font-size:0.85rem;color:#7a8a9e;margin-top:0.5rem;">Media: ' + (ans.mediaEffect > 0 ? '+' : '') + ans.mediaEffect + ' | Owner: ' + (ans.ownerEffect > 0 ? '+' : '') + ans.ownerEffect + '</div>';
                html += '</div>';
            }
            
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1.5rem;">';
            var mediaColor = totalMedia > 0 ? '#22c55e' : totalMedia < 0 ? '#ef4444' : '#7a8a9e';
            var ownerColor = totalOwner > 0 ? '#22c55e' : totalOwner < 0 ? '#ef4444' : '#7a8a9e';
            html += '<div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center;">';
            html += '<div style="font-size:0.85rem;color:#b8c5d6;">Total Media Impact</div>';
            html += '<div style="font-size:1.5rem;font-weight:bold;color:' + mediaColor + ';">' + (totalMedia > 0 ? '+' : '') + totalMedia + '</div>';
            html += '</div>';
            html += '<div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center;">';
            html += '<div style="font-size:0.85rem;color:#b8c5d6;">Total Owner Impact</div>';
            html += '<div style="font-size:1.5rem;font-weight:bold;color:' + ownerColor + ';">' + (totalOwner > 0 ? '+' : '') + totalOwner + '</div>';
            html += '</div>';
            html += '</div>';
        } else {
            html += '<p style="color:#b8c5d6;text-align:center;">No detailed answers recorded for this cycle.</p>';
        }
        
        html += '<button onclick="InteractivePressConference.close()" style="width:100%;padding:1.25rem;background:#f5a623;color:#000;font-weight:bold;border-radius:8px;border:none;cursor:pointer;margin-top:2rem;">Close</button>';
        html += '</div>';
        
        content.innerHTML = html;
        modal.style.display = 'flex';
    },
    
    generateQuestions: function(outcome) {
        var isGood = outcome && (outcome.outcome === 'Championship' || outcome.outcome === 'Playoffs' || (outcome.outcome && outcome.outcome.includes('Finals')));
        var ownerPressure = window.GameState ? window.GameState.ownerPressure : 50;
        var isHighPressure = ownerPressure > 65;
        
        var questions = [
            {
                question: isGood ? "How does this success feel after all the hard work?" : "What went wrong this season?",
                options: [
                    { text: "We executed our strategy perfectly", media: 10, owner: 5 },
                    { text: "There's always room for improvement", media: 5, owner: 3 },
                    { text: "We got lucky in key moments", media: -5, owner: -5 },
                    { text: "No comment", media: -15, owner: -10 }
                ]
            },
            {
                question: "What's your message to the fans?",
                options: [
                    { text: "Thank you for your support", media: 8, owner: 5 },
                    { text: "Trust the process", media: 2, owner: 3 },
                    { text: "We need patience", media: -5, owner: 5 },
                    { text: "If you don't believe, that's your problem", media: -20, owner: -15 }
                ]
            },
            {
                question: isHighPressure ? "There are rumors of tension with ownership. Care to comment?" : "How is your relationship with ownership?",
                options: [
                    { text: "We're completely aligned", media: 5, owner: 15 },
                    { text: "I don't discuss private conversations", media: -5, owner: 5 },
                    { text: "The owner understands this is a process", media: 0, owner: 10 },
                    { text: "I work for the fans, not ownership", media: 10, owner: -25 }
                ]
            }
        ];
        
        // Add contextual question based on game state
        if (window.GameState && window.GameState.cycleIndex > 2) {
            questions.push({
                question: "Looking back at your tenure, any regrets about earlier decisions?",
                options: [
                    { text: "Every decision was part of the plan", media: 5, owner: 8 },
                    { text: "I'd do a few things differently, yes", media: 8, owner: 0 },
                    { text: "We learn from every choice, good or bad", media: 10, owner: 5 },
                    { text: "I don't believe in looking backward", media: -5, owner: 3 }
                ]
            });
        }
        
        return questions;
    },
    
    showQuestion: function(index) {
        if (index >= this.questions.length) {
            this.showResults();
            return;
        }
        
        var q = this.questions[index];
        var modal = document.getElementById('screen-replay');
        var content = document.getElementById('replay-content');
        
        if (!modal || !content) {
            console.error('Modal elements not found');
            return;
        }
        
        var html = '<div style="padding:2rem;max-width:700px;margin:auto;">';
        html += '<div style="text-align:center;margin-bottom:2rem;">';
        html += '<div style="font-size:4rem;margin-bottom:1rem;"></div>';
        html += '<h2 style="color:#f5a623;">Press Conference - Cycle ' + this.currentCycle + '</h2>';
        html += '<p style="color:#b8c5d6;">Question ' + (index + 1) + ' of ' + this.questions.length + '</p>';
        html += '</div>';
        
        html += '<div style="padding:1.5rem;background:rgba(255,255,255,0.05);border-left:4px solid #f5a623;border-radius:8px;margin-bottom:2rem;">';
        html += '<strong style="color:#f5a623;">Reporter:</strong>';
        html += '<p style="margin-top:0.5rem;font-size:1.1rem;">"' + q.question + '"</p>';
        html += '</div>';
        
        html += '<h3 style="margin-bottom:1rem;color:#fff;">Your Response:</h3>';
        
        for (var i = 0; i < q.options.length; i++) {
            html += '<button onclick="InteractivePressConference.answer(' + index + ',' + i + ')" ';
            html += 'style="width:100%;padding:1.25rem;margin-bottom:0.75rem;text-align:left;';
            html += 'background:rgba(255,255,255,0.05);border:2px solid #2d4a6f;border-radius:8px;';
            html += 'cursor:pointer;color:#fff;font-size:1rem;transition:all 0.2s;" ';
            html += 'onmouseover="this.style.borderColor=\'#f5a623\';this.style.background=\'rgba(245,166,35,0.1)\'" ';
            html += 'onmouseout="this.style.borderColor=\'#2d4a6f\';this.style.background=\'rgba(255,255,255,0.05)\'">';
            html += '"' + q.options[i].text + '"';
            html += '</button>';
        }
        
        html += '<div style="margin-top:2rem;padding:1rem;background:rgba(245,166,35,0.1);border-radius:8px;text-align:center;">';
        html += '<p style="color:#f5a623;font-size:0.9rem;"> Your answers will affect media and owner perception</p>';
        html += '</div></div>';
        
        content.innerHTML = html;
        modal.style.display = 'flex';
    },
    
    answer: function(qIndex, aIndex) {
        var q = this.questions[qIndex];
        var a = q.options[aIndex];
        
        this.answers.push({
            question: q.question,
            answer: a.text,
            mediaEffect: a.media,
            ownerEffect: a.owner
        });
        
        // Apply effects to GameState
        if (window.GameState) {
            window.GameState.mediaHeat = Math.max(0, Math.min(100, (window.GameState.mediaHeat || 50) + a.media));
            // Owner pressure: negative owner effect INCREASES pressure
            window.GameState.ownerPressure = Math.max(0, Math.min(100, (window.GameState.ownerPressure || 50) - a.owner));
        }
        
        this.currentIndex++;
        var self = this;
        setTimeout(function() {
            self.showQuestion(self.currentIndex);
        }, 300);
    },
    
    showResults: function() {
        var totalMedia = 0;
        var totalOwner = 0;
        for (var i = 0; i < this.answers.length; i++) {
            totalMedia += this.answers[i].mediaEffect;
            totalOwner += this.answers[i].ownerEffect;
        }
        
        var modal = document.getElementById('screen-replay');
        var content = document.getElementById('replay-content');
        
        var html = '<div style="padding:2rem;max-width:800px;margin:auto;">';
        html += '<h2 style="text-align:center;color:#f5a623;margin-bottom:2rem;">Press Conference Results</h2>';
        
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">';
        
        var mediaColor = totalMedia > 0 ? '#22c55e' : totalMedia < 0 ? '#ef4444' : '#7a8a9e';
        html += '<div style="padding:2rem;background:rgba(255,255,255,0.05);border:2px solid ' + mediaColor + ';border-radius:12px;text-align:center;">';
        html += '<div style="font-size:3rem;">' + (totalMedia > 0 ? '' : totalMedia < 0 ? '' : '') + '</div>';
        html += '<div style="margin-top:0.5rem;color:#b8c5d6;">Media Impact</div>';
        html += '<div style="font-size:2.5rem;font-weight:bold;color:' + mediaColor + ';">' + (totalMedia > 0 ? '+' : '') + totalMedia + '</div>';
        html += '</div>';
        
        var ownerColor = totalOwner > 0 ? '#22c55e' : totalOwner < 0 ? '#ef4444' : '#7a8a9e';
        html += '<div style="padding:2rem;background:rgba(255,255,255,0.05);border:2px solid ' + ownerColor + ';border-radius:12px;text-align:center;">';
        html += '<div style="font-size:3rem;">' + (totalOwner > 0 ? '' : totalOwner < 0 ? '' : '') + '</div>';
        html += '<div style="margin-top:0.5rem;color:#b8c5d6;">Owner Satisfaction</div>';
        html += '<div style="font-size:2.5rem;font-weight:bold;color:' + ownerColor + ';">' + (totalOwner > 0 ? '+' : '') + totalOwner + '</div>';
        html += '</div></div>';
        
        // Show updated pressure
        if (window.GameState) {
            var pressure = Math.round(window.GameState.ownerPressure);
            var pressureColor = pressure > 70 ? '#ef4444' : pressure > 50 ? '#f59e0b' : '#22c55e';
            html += '<div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:1.5rem;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
            html += '<span style="color:#b8c5d6;">Current Owner Pressure:</span>';
            html += '<span style="font-weight:bold;color:' + pressureColor + ';">' + pressure + '%</span>';
            html += '</div>';
            html += '<div style="background:rgba(0,0,0,0.3);height:8px;border-radius:4px;overflow:hidden;margin-top:0.5rem;">';
            html += '<div style="width:' + pressure + '%;height:100%;background:' + pressureColor + ';transition:width 0.5s;"></div>';
            html += '</div></div>';
        }
        
        html += '<button onclick="InteractivePressConference.close()" style="width:100%;padding:1.25rem;background:#f5a623;color:#000;font-weight:bold;border-radius:8px;border:none;cursor:pointer;">Continue</button>';
        html += '</div>';
        
        content.innerHTML = html;
        
        // Mark this cycle as completed and save
        this.completedCycles[this.currentCycle] = true;
        this.saveAnswers();
    },
    
    saveAnswers: function() {
        // Save to GameState history
        if (window.GameState) {
            if (!window.GameState.pressConferenceHistory) {
                window.GameState.pressConferenceHistory = [];
            }
            window.GameState.pressConferenceHistory.push({
                cycle: this.currentCycle,
                answers: this.answers,
                timestamp: Date.now()
            });
        }
        
        // Also save to localStorage for teacher dashboard
        if (!window.AuthSystem || window.AuthSystem.isTeacher) return;
        
        try {
            var classKey = 'class_' + window.AuthSystem.currentUser.classCode;
            var classData = JSON.parse(localStorage.getItem(classKey) || '{"students":[]}');
            
            for (var i = 0; i < classData.students.length; i++) {
                if (classData.students[i].name === window.AuthSystem.currentUser.name) {
                    if (!classData.students[i].pressConferenceAnswers) {
                        classData.students[i].pressConferenceAnswers = [];
                    }
                    classData.students[i].pressConferenceAnswers.push({
                        cycle: this.currentCycle,
                        answers: this.answers,
                        timestamp: Date.now()
                    });
                    localStorage.setItem(classKey, JSON.stringify(classData));
                    console.log('Press answers saved for cycle', this.currentCycle);
                    break;
                }
            }
        } catch(e) {
            console.error('Error saving press answers:', e);
        }
    },
    
    close: function() {
        document.getElementById('screen-replay').style.display = 'none';
    }
};

console.log(' Clean viewers and press conference loaded');




        // ================================
        // THE FRONT OFFICE - UPGRADED SYSTEM
        // Room-Specific UI + Advanced Logic
        // ================================
        
        // ================================
        // ADVANCED GAME STATE
        // ================================
        const GameState = {
            // Meta
            franchise: null,
            franchiseName: '',
            cycleIndex: 1,
            startTime: null,
            
            // Core Metrics (0-100)
            capFlexibility: 50,
            rosterQuality: 50,
            optionality: 50,
            
            // Reputation
            reputationPlayers: 50,
            reputationAgents: 50,
            reputationLeague: 50,
            mediaNarrative: 50,
            
            // Risk
            riskExposure: 50,
            injuryFragility: 50,
            
            // Composite
            trustIndex: 50,
            informationEdge: 50,
            taxExposure: 0,
            
            // ADVANCED: Caps & Modifiers
            optionalityCap: 100,  // Can be reduced by decisions
            trustCap: 100,
            agentTrustMultiplier: 1.0,  // Can be reduced permanently
            
            // Flags & Tracking
            flags: [],
            decisionLog: [],
            lockedRooms: [],
            
            // NEW: Random Events System
            currentEvent: null,
            eventsHistory: [],
            
            // NEW: Performance Outcomes
            seasonOutcomes: [],
            championships: 0,
            playoffAppearances: 0,
            
            // NEW: OWNER PRESSURE & MEDIA SYSTEM
            ownerPressure: 50,        // 0-100: How much pressure owner puts on you
            ownerPatience: 100,       // 0-100: Owner's patience (decreases over time)
            ownerExpectation: 'compete', // 'tank', 'compete', 'playoffs', 'championship'
            ownerMood: 'neutral',     // 'furious', 'unhappy', 'neutral', 'pleased', 'ecstatic'
            ownerMessages: [],        // Array of owner communications
            
            mediaHeat: 50,            // 0-100: How hot your seat is
            mediaStories: [],         // Current media narratives
            headlines: [],            // Recent headlines about you
            pressConferences: 0,      // How many you've faced
            hotSeatLevel: 'warm',     // 'cold', 'warm', 'hot', 'scorching', 'fired'
            
            fanSentiment: 50,         // 0-100: Fan happiness
            ticketSales: 50,          // 0-100: Revenue indicator
            
            // NEW: Teaching Mode
            teachingMode: false,
            conceptsLearned: [],
            
            // QUIZ TRACKING SYSTEM
            quizScores: {},  // { conceptId: { answered: X, correct: Y, points: Z } }
            totalQuizPoints: 0,
            maxQuizPoints: 0,
            
            // NEW: Mini-Games & Features
            draftPick: null,
            triviaStats: {
                currentStreak: 0,
                questionsAnswered: 0,
                correctAnswers: 0
            },
            rival: null,
            rivalDecisions: [],
            storyBeats: [],  // For replay
            skippedRooms: [],
            
            // Cycle Modifiers
            cycleModifiers: {},
            
            // Press Conference History
            pressConferenceHistory: [],
            
            // Helper Methods
            getBand(value) {
                if (value >= 80) return { label: 'Elite', class: 'elite', color: '#10b981' };
                if (value >= 65) return { label: 'Strong', class: 'strong', color: '#3b82f6' };
                if (value >= 45) return { label: 'Stable', class: 'stable', color: '#f5a623' };
                if (value >= 30) return { label: 'Weak', class: 'weak', color: '#ef4444' };
                return { label: 'Critical', class: 'critical', color: '#dc2626' };
            },
            
            getInverseBand(value) {
                if (value <= 20) return { label: 'Minimal', class: 'elite', color: '#10b981' };
                if (value <= 35) return { label: 'Low', class: 'strong', color: '#3b82f6' };
                if (value <= 55) return { label: 'Moderate', class: 'stable', color: '#f5a623' };
                if (value <= 70) return { label: 'High', class: 'weak', color: '#ef4444' };
                return { label: 'Severe', class: 'critical', color: '#dc2626' };
            },
            
            initializeFranchise(type) {
                this.franchise = type;
                this.startTime = Date.now();
                
                const data = {
                    'contender': {
                        name: 'Win-Now Contender',
                        rosterQuality: 85, capFlexibility: 25, optionality: 30,
                        riskExposure: 70, reputationPlayers: 75, trustIndex: 70,
                        taxExposure: 35, informationEdge: 55
                    },
                    'young': {
                        name: 'Rising Young Core',
                        rosterQuality: 60, capFlexibility: 75, optionality: 80,
                        riskExposure: 40, reputationAgents: 55, trustIndex: 60,
                        informationEdge: 50
                    },
                    'messy': {
                        name: 'Messy Middle',
                        rosterQuality: 45, capFlexibility: 35, optionality: 40,
                        riskExposure: 60, mediaNarrative: 35, trustIndex: 45,
                        informationEdge: 45
                    }
                };
                
                Object.assign(this, data[type]);
                this.franchiseName = data[type].name;
            },
            
            // ADVANCED: Apply effects with modifiers
            applyEffects(effects) {
                // Store actual applied effects for later display
                const appliedEffects = {};
                
                for (const [key, value] of Object.entries(effects)) {
                    if (key === 'flags') {
                        this.flags.push(...(Array.isArray(value) ? value : [value]));
                    } else if (key === 'optionalityCap') {
                        this.optionalityCap = Math.min(this.optionalityCap, value);
                    } else if (key === 'trustCap') {
                        this.trustCap = Math.min(this.trustCap, value);
                    } else if (key === 'agentTrustMultiplier') {
                        this.agentTrustMultiplier *= value;
                    } else if (this[key] !== undefined && typeof this[key] === 'number') {
                        // Apply variance: effects have 20% randomness
                        // Larger effects have more variance
                        const magnitude = Math.abs(value);
                        const variancePercent = 0.20; // 20% variance
                        const variance = magnitude * variancePercent * (Math.random() * 2 - 1); // -20% to +20%
                        
                        let adjustedValue = value + variance;
                        
                        // Apply agent trust multiplier to agent reputation changes
                        if (key === 'reputationAgents' && adjustedValue > 0) {
                            adjustedValue = adjustedValue * this.agentTrustMultiplier;
                        }
                        
                        // Store for display
                        appliedEffects[key] = adjustedValue;
                        
                        // Apply change
                        this[key] = Math.max(0, Math.min(100, this[key] + adjustedValue));
                        
                        // Enforce caps
                        if (key === 'optionality') {
                            this[key] = Math.min(this[key], this.optionalityCap);
                        }
                        if (key === 'trustIndex') {
                            this[key] = Math.min(this[key], this.trustCap);
                        }
                    }
                }
                
                // Store applied effects for display
                this.lastAppliedEffects = appliedEffects;
            },
            
            lockRoom(room) {
                if (!this.lockedRooms.includes(room)) {
                    this.lockedRooms.push(room);
                }
            },
            
            isRoomLocked(room) {
                return this.lockedRooms.includes(room);
            },
            
            hasFlag(flag) {
                return this.flags.includes(flag);
            },
            
            areAllRoomsLocked() {
                return this.lockedRooms.length === 4;
            },
            
            canAdvanceCycle() {
                // Can advance if at least 3 of 4 rooms are completed
                return this.lockedRooms.length >= 3;
            },
            
            skipRoom(room) {
                if (!this.lockedRooms.includes(room)) {
                    this.lockedRooms.push(room);
                    this.skippedRooms = this.skippedRooms || [];
                    this.skippedRooms.push({ room, cycle: this.cycleIndex });
                }
            },
            
            advanceCycle() {
                this.cycleIndex++;
                this.lockedRooms = [];
                this.applyCycleModifiers();
            },
            
            hasFlag(flag) {
                return this.flags.includes(flag);
            },
            
            // ADVANCED: Apply cycle-wide modifiers
            applyCycleModifiers() {
                const cycle = this.cycleIndex;
                
                // Cycle 2: Ownership Impatience
                if (cycle === 2 && this.franchise === 'contender') {
                    this.cycleModifiers.ownershipPressure = true;
                }
                
                // Cycle 3: Tax compounding
                if (cycle === 3 && this.hasFlag('tax_payer')) {
                    this.taxExposure += 10;
                    this.capFlexibility = Math.max(0, this.capFlexibility - 5);
                }
                
                // Cycle 3: Rebuild benefits
                if (cycle === 3 && this.hasFlag('rebuild_mode')) {
                    this.optionality = Math.min(this.optionalityCap, this.optionality + 10);
                    this.rosterQuality += 8;
                }
                
                // Cycle 4: Consequences manifest
                if (cycle === 4 && this.hasFlag('burned_agent_bridge')) {
                    this.reputationAgents = Math.max(0, this.reputationAgents - 10);
                }
            },
            
            // ADVANCED: Check if option is available
            isOptionAvailable(optionId) {
                // Hard cap triggered
                if (this.hasFlag('hard_cap_triggered') && optionId.includes('spend')) {
                    return false;
                }
                
                // Agent bridge burned
                if (this.hasFlag('burned_agent_bridge') && optionId.includes('agent_negotiate')) {
                    return false;
                }
                
                // All-in move restricts patience
                if (this.hasFlag('all_in_move') && optionId.includes('patient')) {
                    return false;
                }
                
                return true;
            },
            
            getOptionDisabledReason(optionId) {
                if (this.hasFlag('hard_cap_triggered') && optionId.includes('spend')) {
                    return 'Hard cap limits';
                }
                if (this.hasFlag('burned_agent_bridge') && optionId.includes('agent_negotiate')) {
                    return 'Bridge burned';
                }
                if (this.hasFlag('all_in_move') && optionId.includes('patient')) {
                    return 'Window closed';
                }
                return '';
            },
            
            getPerformanceBand() {
                // GOLD: Requires elite execution
                if (this.optionality >= 70 && 
                    this.reputationAgents >= 65 && 
                    this.riskExposure <= 50 &&
                    this.capFlexibility >= 55) {
                    return 'GOLD';
                }
                
                // SILVER: Strong but not elite
                if (this.optionality >= 55 && 
                    this.reputationAgents >= 50 &&
                    this.trustIndex >= 60) {
                    return 'SILVER';
                }
                
                // BRONZE: Completion
                return 'BRONZE';
            },
            
            generateClaimCode() {
                const band = this.getPerformanceBand();
                const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const time = new Date().toTimeString().slice(0, 5).replace(':', '');
                const hash = Math.random().toString(36).substring(2, 6).toUpperCase();
                return `T201-FO-${band}-${date}-${time}-${hash}`;
            }
        };
        
        // ================================
        // SCENARIOS WITH ROOM-SPECIFIC UI
        // ================================
        
        // 
        // RANDOM EVENTS SYSTEM - Unexpected situations between cycles
        // 
        
        const RandomEvents = {
            // INJURY EVENTS
            star_injury: {
                id: 'star_injury',
                type: 'injury',
                probability: 0.15,
                applicableWhen: (state) => state.rosterQuality > 60,
                title: ' Star Player Injury',
                description: 'BREAKING NEWS: Your star player tore his ACL in practice. He\'s out for the season. The medical staff says 12+ month recovery. Your championship window just slammed shutfor this year at least.',
                flavorText: 'ESPN: "Season Over Before It Started - Star\'s Injury Derails Title Hopes"',
                immediateEffects: { rosterQuality: -25, riskExposure: -10 },
                options: [
                    {
                        id: 'injury_tank',
                        text: 'Tank the Season - Preserve Assets',
                        rationale: 'No star = no playoffs. Get a lottery pick.',
                        effects: { rosterQuality: -5, optionality: 15, mediaNarrative: -15, flags: ['star_injured', 'tanked_after_injury'] },
                        teaches: 'OPPORTUNITY COST',
                        explanation: 'Accept the lost season. Trade veterans for picks. Build for next year when star returns. Fans will hate it, but it\'s the smart play.'
                    },
                    {
                        id: 'injury_compete',
                        text: 'Stay Competitive - Trade for Replacement',
                        rationale: 'Our other players deserve a shot. Keep fighting.',
                        effects: { rosterQuality: 8, optionality: -12, capFlexibility: -10, flags: ['star_injured', 'competed_despite_injury'] },
                        teaches: 'SUNK COST',
                        explanation: 'Spend assets to stay competitive without your star. Probably won\'t work, but shows commitment to team. Is that rational or emotional?'
                    }
                ]
            },
            
            role_player_injury: {
                id: 'role_player_injury',
                type: 'injury',
                probability: 0.20,
                applicableWhen: (state) => state.cycleIndex >= 2,
                title: ' Key Role Player Injured',
                description: 'Your starting center broke his hand. Out 8 weeks. He was playing wellthe team will miss him. Do you find a replacement or ride it out?',
                flavorText: 'Beat Reporter: "Timing couldn\'t be worse - team was finding rhythm"',
                immediateEffects: { rosterQuality: -8 },
                options: [
                    {
                        id: 'roleinjury_sign',
                        text: 'Sign Replacement - Use Exception',
                        rationale: 'Fill the hole. Can\'t compete with this gap.',
                        effects: { rosterQuality: 5, capFlexibility: -8 },
                        teaches: 'MARGINAL COST',
                        explanation: 'Spend resources to fix the immediate problem. Small move but it costs flexibility.'
                    },
                    {
                        id: 'roleinjury_next',
                        text: 'Next Man Up - Internal Options',
                        rationale: 'Develop our young guys. Save the money.',
                        effects: { rosterQuality: 2, trustIndex: 5 },
                        teaches: 'OPTION VALUE',
                        explanation: 'Young players get opportunity. Saves cap space. Shows faith in development system.'
                    }
                ]
            },
            
            // TRADE DEMAND EVENTS
            star_demands_trade: {
                id: 'star_demands_trade',
                type: 'demand',
                probability: 0.12,
                applicableWhen: (state) => state.reputationPlayers < 50 && state.cycleIndex >= 2,
                title: ' Star Demands Trade',
                description: 'Your star player\'s agent just went public: "He wants out. Tired of losing. Wants to compete for a championship." Other GMs are circling. You have 48 hours to respond before leverage evaporates.',
                flavorText: 'Woj: "Sources say star has preferred destinations - Knicks, Lakers, Heat"',
                immediateEffects: { mediaNarrative: -20, reputationLeague: -5 },
                options: [
                    {
                        id: 'demand_trade',
                        text: 'Trade Him Now - Get Best Offer',
                        rationale: 'Unhappy star is toxic. Cut our losses.',
                        effects: { rosterQuality: -15, optionality: 15, capFlexibility: 20, mediaNarrative: -10, flags: ['traded_demanding_star', 'rebuild_mode'] },
                        teaches: 'BARGAINING POWER',
                        explanation: 'Trade from weakness. Won\'t get fair value, but uncertainty ends. Can rebuild with assets.'
                    },
                    {
                        id: 'demand_wait',
                        text: 'Play Hardball - Demand Fair Value',
                        rationale: 'We have him under contract. Won\'t be bullied.',
                        effects: { reputationLeague: 10, mediaNarrative: -15, riskExposure: 20, flags: ['star_unhappy', 'played_hardball'] },
                        teaches: 'TIME PREFERENCE',
                        explanation: 'Wait for leverage to improve. Riskyrelationship could get toxic. But shows other GMs you won\'t panic.'
                    },
                    {
                        id: 'demand_repair',
                        text: 'Relationship Repair - Make Promises',
                        rationale: 'Talk him off the ledge. Commit to changes.',
                        effects: { reputationPlayers: 10, optionality: -15, riskExposure: 15, flags: ['star_pacified', 'committed_to_star'] },
                        teaches: 'COMMITMENT',
                        explanation: 'Promise to build around him. Limits future flexibility but could save the situation. High variance outcome.'
                    }
                ]
            },
            
            // FREE AGENT INTEREST EVENTS
            surprise_fa_interest: {
                id: 'surprise_fa_interest',
                type: 'opportunity',
                probability: 0.18,
                applicableWhen: (state) => state.capFlexibility > 40 && state.reputationAgents > 55,
                title: ' Surprise Free Agent Interest',
                description: 'A borderline All-Star calls your agent contact: "I want to sign there. Culture feels right. Winning situation." He\'s taking less money to join you. This doesn\'t happen often. But you\'d have to move some pieces to make room.',
                flavorText: 'Shams: "League sources indicate strong mutual interest"',
                immediateEffects: {},
                options: [
                    {
                        id: 'fa_sign',
                        text: 'Sign Him - Clear the Space',
                        rationale: 'Stars want to play here. Can\'t pass this up.',
                        effects: { rosterQuality: 18, capFlexibility: -25, optionality: -15, reputationAgents: 10 },
                        teaches: 'OPPORTUNITY COST',
                        explanation: 'Use your cap space and reputation. Gives up future flexibility but adds real talent now.'
                    },
                    {
                        id: 'fa_pass',
                        text: 'Pass - Stick to the Plan',
                        rationale: 'Good player, but not great. Don\'t deviate.',
                        effects: { optionality: 5, mediaNarrative: -10 },
                        teaches: 'DISCIPLINE',
                        explanation: 'Preserve flexibility for THE star, not just A star. Fans and media won\'t understand, but it\'s disciplined.'
                    }
                ]
            },
            
            // LOTTERY LUCK EVENTS
            lottery_jump_up: {
                id: 'lottery_jump_up',
                type: 'lottery',
                probability: 0.10,
                applicableWhen: (state) => state.rosterQuality < 50 && state.cycleIndex === 2,
                title: ' Lottery Luck - Jumped Up!',
                description: 'LOTTERY RESULTS: Your ping pong balls came through! You jumped from the 7th spot to the 3rd pick. Franchise-changing prospect is now in range. The basketball gods smiled on you.',
                flavorText: 'ESPN: "Lottery Winners - Team gets huge break in draft order"',
                immediateEffects: { optionality: 20, mediaNarrative: 15 },
                options: [
                    {
                        id: 'lottery_draft',
                        text: 'Draft the Prospect - Build Around Him',
                        rationale: 'Generational talent. Our future.',
                        effects: { rosterQuality: 15, optionality: -10, flags: ['committed_to_young_star'] },
                        teaches: 'COMMITMENT',
                        explanation: 'Lock in your direction. Build around this player for next 4+ years. High upside, but committed to his timeline.'
                    },
                    {
                        id: 'lottery_trade',
                        text: 'Trade the Pick - Accelerate Timeline',
                        rationale: 'Package it for proven talent. Win now.',
                        effects: { rosterQuality: 12, optionality: -15, capFlexibility: -10 },
                        teaches: 'TIME PREFERENCE',
                        explanation: 'Trade uncertainty for known value. Win-now move. Gives up ceiling for higher floor.'
                    }
                ]
            },
            
            lottery_fall_down: {
                id: 'lottery_fall_down',
                type: 'lottery',
                probability: 0.10,
                applicableWhen: (state) => state.rosterQuality < 50 && state.cycleIndex === 2,
                title: ' Lottery Unluck - Dropped Down',
                description: 'LOTTERY RESULTS: You dropped from 4th to 8th. The prospect you wanted is gone. You\'re left with consolation prizes. The tanking hurts more when the lottery screws you.',
                flavorText: 'ESPN: "Lottery Losers - Team\'s rebuild takes another hit"',
                immediateEffects: { mediaNarrative: -15 },
                options: [
                    {
                        id: 'lotteryfall_draft',
                        text: 'Draft Best Available - Stay Patient',
                        rationale: 'Still get a good player. Rebuild continues.',
                        effects: { rosterQuality: 8, optionality: 5 },
                        teaches: 'PATIENCE',
                        explanation: 'Take the hit. Build through the draft anyway. It\'ll take longer but stay disciplined.'
                    },
                    {
                        id: 'lotteryfall_trade',
                        text: 'Trade for Win-Now Pieces - Change Course',
                        rationale: 'Rebuild isn\'t working. Different approach.',
                        effects: { rosterQuality: 10, optionality: -10, capFlexibility: -8, flags: ['abandoned_rebuild'] },
                        teaches: 'ADAPTATION',
                        explanation: 'Pivot strategy. Sometimes circumstances force change. Admit the rebuild path got harder.'
                    }
                ]
            },
            
            // COACHING CHANGE EVENT
            coach_fired: {
                id: 'coach_fired',
                type: 'coaching',
                probability: 0.12,
                applicableWhen: (state) => state.mediaNarrative < 45 && state.cycleIndex >= 2,
                title: ' Head Coach Fired',
                description: 'Your owner just fired the head coach. "Not getting results. Team needs a new voice." The replacement coach has a completely different system. Some of your players don\'t fit anymore.',
                flavorText: 'Woj: "Team making change - ownership losing patience"',
                immediateEffects: { rosterQuality: -5, mediaNarrative: -10 },
                options: [
                    {
                        id: 'coach_adapt',
                        text: 'Adapt Roster - Get Coach\'s Players',
                        rationale: 'Coach wants different types. Make it work.',
                        effects: { rosterQuality: 8, optionality: -10, capFlexibility: -8 },
                        teaches: 'SUNK COST',
                        explanation: 'Trade players to fit new system. Means admitting prior roster construction didn\'t work. Expensive pivot.'
                    },
                    {
                        id: 'coach_stay',
                        text: 'Keep Roster - Force Coach to Adapt',
                        rationale: 'We have good players. Coach adjusts to them.',
                        effects: { riskExposure: 15, mediaNarrative: -5 },
                        teaches: 'COMMITMENT',
                        explanation: 'Bet your roster is good enough that coach will figure it out. Power struggle risk. High variance.'
                    }
                ]
            },
            
            // TAMPERING INVESTIGATION
            tampering_investigation: {
                id: 'tampering_investigation',
                type: 'league',
                probability: 0.08,
                applicableWhen: (state) => state.reputationLeague < 60 && state.cycleIndex >= 2,
                title: ' League Tampering Investigation',
                description: 'The NBA is investigating your franchise for tampering. They think you contacted a player before free agency. If guilty, you could lose a first-round pick. You can fight it or settle.',
                flavorText: 'League Office: "Investigation ongoing - penalties possible"',
                immediateEffects: { reputationLeague: -15 },
                options: [
                    {
                        id: 'tamper_fight',
                        text: 'Fight the Charges - Deny Everything',
                        rationale: 'We did nothing wrong. Won\'t accept punishment.',
                        effects: { reputationLeague: -10, riskExposure: 20, optionality: 0 },
                        teaches: 'RISK',
                        explanation: 'High variance. If league finds evidence, penalty could be worse. If you win, reputation restored.'
                    },
                    {
                        id: 'tamper_settle',
                        text: 'Settle - Accept Light Penalty',
                        rationale: 'Get it over with. Small fine beats uncertainty.',
                        effects: { optionality: -5, capFlexibility: -5, reputationLeague: 5 },
                        teaches: 'CERTAINTY VALUE',
                        explanation: 'Pay to end uncertainty. Lose a little now vs risk losing a lot later. Makes it go away.'
                    }
                ]
            },
            
            // HELPER: Get random event based on current state
            getRandomEvent(state) {
                // Filter events that are applicable to current state
                const applicableEvents = Object.values(this).filter(event => {
                    if (typeof event !== 'object' || !event.probability) return false;
                    if (event.applicableWhen && !event.applicableWhen(state)) return false;
                    // Don't repeat events in same playthrough
                    if (state.eventsHistory.includes(event.id)) return false;
                    return Math.random() < event.probability;
                });
                
                if (applicableEvents.length === 0) return null;
                
                // Return random event from applicable ones
                return applicableEvents[Math.floor(Math.random() * applicableEvents.length)];
            }
        };
        
        const Scenarios = {
            // EVALUATION ROOM - Intelligence Briefing Style
            cycle1_eval_contender: {
                id: 'eval_c1_contender',
                room: 'eval',
                title: 'Win-Now Trade Opportunity',
                context: 'Your franchise star is 34 with 2 years left. A younger All-Star becomes available via trade.',
                scenario: 'The 2019 Lakers: trade young assets for Anthony Davis to pair with LeBron.',
                question: 'Do you go all-in for the championship window?',
                
                // Evaluation Room: Signal confidence framing
                signals: [
                    { text: 'Target All-Star: Elite two-way impact', confidence: 'high' },
                    { text: 'Young assets: Potential unclear, injury concerns', confidence: 'noisy' },
                    { text: 'Star timeline: 2-3 years max', confidence: 'high' }
                ],
                
                options: [
                    {
                        id: 'eval_c1_contender_allin',
                        text: 'Trust the Data  Trade Everything',
                        rationale: 'Window is closing. Maximize championship probability now.',
                        effects: {
                            rosterQuality: 15, capFlexibility: -20, optionality: -25,
                            riskExposure: 15, reputationPlayers: 10,
                            optionalityCap: 60,  // PERMANENT CAP
                            flags: ['all_in_move']
                        },
                        explanation: {
                            immediate: 'Roster jumps to championship tier. Star approves.',
                            delayed: 'Future flexibility permanently reduced. No exit strategy.',
                            economic: 'OPPORTUNITY COST: Sacrificed future for present. IRREVERSIBILITY: Can\'t undo.'
                        }
                    },
                    {
                        id: 'eval_c1_contender_balanced',
                        text: 'Override the Model  Smaller Move',
                        rationale: 'Improve but keep some optionality.',
                        effects: {
                            rosterQuality: 8, capFlexibility: -10, optionality: -10,
                            riskExposure: 5, reputationAgents: 5
                        },
                        explanation: {
                            immediate: 'Moderate upgrade. Some flexibility preserved.',
                            delayed: 'Hedged bet. Middle ground often disappoints.',
                            economic: 'RISK MANAGEMENT: Diversified approach. OPTION VALUE: Kept some paths open.'
                        }
                    },
                    {
                        id: 'eval_c1_contender_patient',
                        text: 'Wait for More Information',
                        rationale: 'Star is aging. Don\'t overpay.',
                        effects: {
                            rosterQuality: -5, optionality: 15, capFlexibility: 5,
                            reputationPlayers: -15, mediaNarrative: -10,
                            flags: ['star_unhappy']
                        },
                        explanation: {
                            immediate: 'Aging star frustrated. Media critical.',
                            delayed: 'Positioned for post-star rebuild. Long-term thinking.',
                            economic: 'TIME PREFERENCE: Future over present. INFORMATION: Waiting reveals more data.'
                        }
                    }
                ],
                economicConcepts: {
                    'Information Asymmetry': 'Incomplete signals require judgment under uncertainty',
                    'Irreversibility': 'Some decisions permanently close future paths',
                    'Time Preference': 'Win now vs. sustainable success'
                }
            },
            
            // CAP ROOM - Control Panel Style
            cycle1_cap_contender: {
                id: 'cap_c1_contender',
                room: 'cap',
                title: 'Luxury Tax Decision',
                context: 'You\'re $18M over the cap. Adding another piece triggers the luxury tax.',
                scenario: '2020 Bucks: pay heavy tax to add Jrue Holiday.',
                question: 'How aggressive with the luxury tax?',
                
                // Cap Room: Before/After comparisons
                capSummary: {
                    currentSalary: '$152M',
                    capLine: '$136M',
                    taxLine: '$165M'
                },
                
                options: [
                    {
                        id: 'cap_c1_contender_tax',
                        text: 'Commit Resources  Enter Tax',
                        rationale: 'Championship window. Pay whatever it costs.',
                        beforeAfter: {
                            flexibility: { before: 'Moderate', after: 'Constrained' },
                            taxBill: { before: '$0', after: '$25M' }
                        },
                        effects: {
                            capFlexibility: -20, optionality: -15, rosterQuality: 10,
                            taxExposure: 25, reputationPlayers: 12,
                            flags: ['tax_payer', 'hard_cap_triggered']
                        },
                        explanation: {
                            immediate: 'Championship-caliber roster. Stars happy.',
                            delayed: 'Tax compounds yearly. Hard-capped in future transactions.',
                            economic: 'PROGRESSIVE TAX: Cost escalates each year. BUDGET CONSTRAINT: Hard limits now active.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'cap_c1_contender_avoid',
                        text: 'Preserve Flexibility  Stay Under',
                        rationale: 'Avoid escalating penalties.',
                        beforeAfter: {
                            flexibility: { before: 'Moderate', after: 'Maintained' },
                            taxBill: { before: '$0', after: '$0' }
                        },
                        effects: {
                            capFlexibility: 5, optionality: 10, rosterQuality: -5,
                            reputationPlayers: -8
                        },
                        explanation: {
                            immediate: 'Roster gap. Players question commitment.',
                            delayed: 'Preserved future flexibility. Avoided repeater tax.',
                            economic: 'OPTION VALUE: Flexibility has value. OPPORTUNITY COST: Roster hole today.'
                        }
                    },
                    {
                        id: 'cap_c1_contender_mle',
                        text: 'Use Exception Only',
                        rationale: 'Add talent within rules.',
                        beforeAfter: {
                            flexibility: { before: 'Moderate', after: 'Slightly Less' },
                            taxBill: { before: '$0', after: '$8M' }
                        },
                        effects: {
                            capFlexibility: -5, rosterQuality: 3, taxExposure: 8
                        },
                        explanation: {
                            immediate: 'Modest improvement using MLE exception.',
                            delayed: 'Incremental approach. Didn\'t maximize odds.',
                            economic: 'MARGINAL COST: Small addition. BUDGET CONSTRAINT: Used available exception.'
                        }
                    }
                ],
                economicConcepts: {
                    'Progressive Tax': 'Tax rate increases as spending increases',
                    'Budget Constraint': 'Hard limits on spending',
                    'Irreversibility': 'Financial commitments can\'t be undone'
                }
            },
            
            // RELATIONSHIPS ROOM - Dialogue Style
            cycle1_relationships_contender: {
                id: 'rel_c1_contender',
                room: 'relationships',
                title: 'Agent Negotiation  Star Extension',
                context: 'Your star\'s agent demands a no-trade clause. He has leverage.',
                scenario: 'Negotiating with Klutch Sports. Player empowerment era.',
                question: 'How much power do you concede?',
                
                // Relationships Room: Dialogue framing
                dialogue: {
                    speaker: 'Agent (via phone)',
                    text: '"My client has earned the right to control his destiny. No-trade clause or we explore other options next summer."'
                },
                relationshipTemp: 'tense',
                
                options: [
                    {
                        id: 'rel_c1_contender_clause',
                        text: 'Negotiate Terms  Grant Clause',
                        rationale: 'Keep star happy. Build trust.',
                        effects: {
                            reputationPlayers: 15, reputationAgents: 12, trustIndex: 15,
                            optionality: -20, optionalityCap: 70
                        },
                        explanation: {
                            immediate: 'Star and agent thrilled. Player-friendly reputation.',
                            delayed: 'Trade flexibility gone. If things go bad, you\'re stuck.',
                            economic: 'BARGAINING POWER: Agent had leverage. OPTION VALUE: Gave up valuable flexibility.'
                        },
                        memory: 'Agents remember: You honor player requests.'
                    },
                    {
                        id: 'rel_c1_contender_money',
                        text: 'Counter-Offer  More Money, No Clause',
                        rationale: 'Pay premium to keep flexibility.',
                        effects: {
                            reputationPlayers: 8, reputationAgents: 5, trustIndex: 5,
                            capFlexibility: -10, optionality: 5
                        },
                        explanation: {
                            immediate: 'Player accepts. Agent mildly frustrated.',
                            delayed: 'Paid for flexibility. Higher salary but maintained trade option.',
                            economic: 'BARGAINING: Negotiated compromise. OPTION VALUE: Paid to preserve flexibility.'
                        },
                        memory: 'Agents note: You negotiate hard.'
                    },
                    {
                        id: 'rel_c1_contender_firm',
                        text: 'Hold Ground  No Extra Concessions',
                        rationale: 'Set precedent. Don\'t cave.',
                        effects: {
                            reputationPlayers: -10, reputationAgents: -15, trustIndex: -12,
                            optionality: 10, mediaNarrative: -8,
                            agentTrustMultiplier: 0.5,  // PERMANENT PENALTY
                            flags: ['burned_agent_bridge']
                        },
                        explanation: {
                            immediate: 'Tense relationship. Agent remembers.',
                            delayed: 'Future negotiations harder. Reputation as difficult.',
                            economic: 'BARGAINING: Asserted control. SOCIAL CAPITAL: Permanent trust damage.'
                        },
                        delayedWarning: 'This agent represents multiple stars. Word spreads.'
                    }
                ],
                economicConcepts: {
                    'Bargaining Power': 'Leverage in negotiations',
                    'Social Capital': 'Reputation and trust as assets',
                    'Repeated Games': 'Today\'s actions affect future interactions'
                }
            },
            
            // RISK ROOM - Probability Framing
            cycle1_risk_contender: {
                id: 'risk_c1_contender',
                room: 'risk',
                title: 'Injury Insurance Decision',
                context: 'Championship core has injury history. Invest in backup or bet on health?',
                scenario: '2022 Clippers: Kawhi and PG injury-prone.',
                question: 'How do you protect against downside?',
                
                // Risk Room: Outcome distribution
                outcomeScenarios: {
                    likely: { label: 'Likely', outcome: 'Core stays healthy', impact: '+Elite season' },
                    worst: { label: 'Worst Case', outcome: 'Injury to star', impact: 'Season collapse' },
                    best: { label: 'Best Case', outcome: 'Health + depth', impact: 'Championship' }
                },
                riskLevel: 70,
                
                options: [
                    {
                        id: 'risk_c1_contender_insurance',
                        text: 'Buy Insurance  Expensive Backup',
                        rationale: 'Pay for downside protection.',
                        variance: 'Low',
                        effects: {
                            riskExposure: -15, injuryFragility: -12, capFlexibility: -12, rosterQuality: 5
                        },
                        explanation: {
                            immediate: 'Strong insurance policy. Can survive injury.',
                            delayed: 'Expensive spot for player who might not play.',
                            economic: 'RISK MANAGEMENT: Paid premium for protection. INSURANCE: Cost vs. probability.'
                        }
                    },
                    {
                        id: 'risk_c1_contender_diversify',
                        text: 'Diversify Exposure  Multiple Cheap Vets',
                        rationale: 'Spread risk across roster.',
                        variance: 'Moderate',
                        effects: {
                            riskExposure: -8, injuryFragility: -8, capFlexibility: -8, rosterQuality: 3
                        },
                        explanation: {
                            immediate: 'Depth across positions. No single point of failure.',
                            delayed: 'No elite backup. Multiple decent options.',
                            economic: 'PORTFOLIO THEORY: Diversification reduces concentrated risk.'
                        }
                    },
                    {
                        id: 'risk_c1_contender_bet',
                        text: 'Concentrate the Bet  Stars Stay Healthy',
                        rationale: 'Maximize resources to starters.',
                        variance: 'High',
                        effects: {
                            riskExposure: 18, injuryFragility: 15, capFlexibility: 10, optionality: 8
                        },
                        explanation: {
                            immediate: 'Max resources to starters. Thin depth.',
                            delayed: 'If injury hits, season collapses. High variance.',
                            economic: 'EXPECTED VALUE: Bet on most likely scenario. VARIANCE: High risk, high reward.'
                        },
                        varianceWarning: 'High variance decision. Outcome depends on health luck.'
                    }
                ],
                economicConcepts: {
                    'Expected Value': 'Probability-weighted outcomes',
                    'Portfolio Theory': 'Diversification vs. concentration',
                    'Variance': 'Range of possible outcomes'
                }
            },

            // CYCLE 1 - YOUNG FRANCHISE SCENARIOS
            cycle1_eval_young: {
                id: 'eval_c1_young', room: 'eval',
                title: 'Young Star Development Path',
                context: 'Your promising 21-year-old shows All-Star potential. Accelerate timeline or stay patient?',
                scenario: 'Trae Young/Hawks: Rush to compete or continue building?',
                question: 'Accelerate development or preserve flexibility?',
                signals: [
                    { text: 'Player potential: All-Star trajectory', confidence: 'high' },
                    { text: 'Current roster: Needs major upgrades', confidence: 'high' },
                    { text: 'Timeline: 2-3 years if patient', confidence: 'mixed' }
                ],
                options: [
                    {
                        id: 'eval_c1_young_patient',
                        text: 'Trust the Data  Stay Patient',
                        rationale: 'Let him develop. Build properly.',
                        effects: { optionality: 15, rosterQuality: 5, reputationPlayers: -5 },
                        explanation: {
                            immediate: 'Slow build. Player wants to win now.',
                            delayed: 'Preserved flexibility. Stronger foundation.',
                            economic: 'TIME PREFERENCE: Future over present. OPTION VALUE: Flexibility preserved.'
                        }
                    },
                    {
                        id: 'eval_c1_young_accelerate',
                        text: 'Override Model  Accelerate Timeline',
                        rationale: 'He\'s ready now. Add veterans.',
                        effects: { rosterQuality: 10, optionality: -12, capFlexibility: -10, reputationPlayers: 12 },
                        explanation: {
                            immediate: 'Veteran additions. Compete sooner.',
                            delayed: 'If premature, wasted window. Assets spent.',
                            economic: 'OPPORTUNITY COST: Flexibility for present. RISK: Uncertain readiness.'
                        }
                    },
                    {
                        id: 'eval_c1_young_hybrid',
                        text: 'Wait for Information  Hybrid Approach',
                        rationale: 'Add young pieces, stay flexible.',
                        effects: { rosterQuality: 6, optionality: 5, capFlexibility: -5 },
                        explanation: {
                            immediate: 'Balanced upgrades. Some flexibility kept.',
                            delayed: 'Hedged position. Moderate results.',
                            economic: 'PORTFOLIO: Diversified approach.'
                        }
                    }
                ],
                economicConcepts: {
                    'Time Preference': 'When to harvest young talent',
                    'Option Value': 'Flexibility as strategic asset'
                }
            },

            cycle1_cap_young: {
                id: 'cap_c1_young', room: 'cap',
                title: 'Rookie Extension Decision',
                context: 'Young star eligible for rookie extension. Lock in now at discount or wait?',
                scenario: 'Luka/Trae extensions: Lock in early or wait for max?',
                question: 'Extend now or wait for leverage?',
                capSummary: { currentSalary: '$85M', capLine: '$136M', extensionCost: '$30M/year vs $40M later' },
                options: [
                    {
                        id: 'cap_c1_young_extend',
                        text: 'Commit Resources  Extend Now',
                        rationale: 'Lock in before max contract.',
                        beforeAfter: { commitment: { before: '2 years', after: '6 years' }, annualCost: { before: '$8M', after: '$30M' } },
                        effects: { capFlexibility: -15, reputationPlayers: 15, trustIndex: 12, optionality: -10 },
                        explanation: {
                            immediate: 'Player thrilled. Long-term security.',
                            delayed: 'Saved $10M/year if he becomes superstar. Overpaid if he plateaus.',
                            economic: 'INFORMATION: Limited sample size. RISK: Bet on projection.'
                        }
                    },
                    {
                        id: 'cap_c1_young_wait',
                        text: 'Preserve Flexibility  Wait',
                        rationale: 'Need more data. He might not be max-worthy.',
                        beforeAfter: { commitment: { before: '2 years', after: '2 years' } },
                        effects: { capFlexibility: 10, optionality: 12, reputationPlayers: -10, trustIndex: -8 },
                        explanation: {
                            immediate: 'Player disappointed. More to prove.',
                            delayed: 'If he breaks out, pay more. If not, saved money.',
                            economic: 'OPTION VALUE: Waiting for information. RISK: Price may increase.'
                        }
                    },
                    {
                        id: 'cap_c1_young_incentive',
                        text: 'Use Exception  Incentive-Heavy Deal',
                        rationale: 'Base + performance bonuses.',
                        beforeAfter: { guaranteedMoney: { before: 'None', after: '$120M' }, potential: { before: 'None', after: '$180M' } },
                        effects: { capFlexibility: -10, reputationPlayers: 8, optionality: 5 },
                        explanation: {
                            immediate: 'Creative structure. Player accepts.',
                            delayed: 'Bonus risk. Could pay more than expected.',
                            economic: 'RISK SHARING: Player bears performance risk.'
                        }
                    }
                ],
                economicConcepts: {
                    'Information Asymmetry': 'Incomplete data on player trajectory',
                    'Option Value': 'Value of waiting for more information'
                }
            },

            cycle1_relationships_young: {
                id: 'rel_c1_young', room: 'relationships',
                title: 'Agent First Negotiation',
                context: 'First major negotiation with powerful agent. Set precedent: firm or flexible?',
                scenario: 'Establishing agency relationships early in process.',
                question: 'How do you approach this relationship?',
                dialogue: { speaker: 'Agent (Video Call)', text: '"My clients expect to be treated like stars. How you handle this sets the tone for our future."' },
                relationshipTemp: 'neutral',
                options: [
                    {
                        id: 'rel_c1_young_flexible',
                        text: 'Maintain Relationship  Be Flexible',
                        rationale: 'Build good relationship. Show respect.',
                        effects: { reputationAgents: 15, reputationPlayers: 10, trustIndex: 10, agentTrustMultiplier: 1.2 },
                        explanation: {
                            immediate: 'Agent pleased. Good first impression.',
                            delayed: 'Set precedent: you\'re reasonable. Easier future deals.',
                            economic: 'SOCIAL CAPITAL: Investment in relationship. REPEATED GAMES: Setting cooperative tone.'
                        },
                        memory: 'Agents know: You\'re reasonable to work with.'
                    },
                    {
                        id: 'rel_c1_young_firm',
                        text: 'Hold Ground  Set Firm Boundaries',
                        rationale: 'Establish you control roster decisions.',
                        effects: { reputationAgents: -8, reputationLeague: 12, trustIndex: -5, optionality: 8 },
                        explanation: {
                            immediate: 'Agent unhappy. League respects your stance.',
                            delayed: 'Future negotiations harder but you set boundaries.',
                            economic: 'BARGAINING POWER: Established control. SOCIAL CAPITAL: Relationship cost.'
                        },
                        memory: 'Agents know: You don\'t give easy concessions.'
                    },
                    {
                        id: 'rel_c1_young_balanced',
                        text: 'Negotiate Terms  Balanced Approach',
                        rationale: 'Firm on important things, flexible on others.',
                        effects: { reputationAgents: 5, reputationPlayers: 5, trustIndex: 5 },
                        explanation: {
                            immediate: 'Professional relationship established.',
                            delayed: 'Balanced precedent. Case-by-case approach.',
                            economic: 'BARGAINING: Strategic flexibility. SOCIAL CAPITAL: Neutral relationship.'
                        }
                    }
                ],
                economicConcepts: {
                    'Repeated Games': 'Early moves set precedent',
                    'Social Capital': 'Relationships as strategic assets'
                }
            },

            cycle1_risk_young: {
                id: 'risk_c1_young', room: 'risk',
                title: 'Draft Pick Portfolio',
                context: 'Multiple draft picks. Swing for stars or take safer prospects?',
                scenario: 'OKC strategy: High-upside vs high-floor picks.',
                question: 'Maximize upside or reduce downside?',
                outcomeScenarios: {
                    likely: { label: 'Base Case', outcome: 'Mix of hits and misses', impact: 'Some good players' },
                    worst: { label: 'All Bust', outcome: 'No stars develop', impact: 'Wasted years' },
                    best: { label: 'Multiple Stars', outcome: '2+ All-Stars', impact: 'Elite core' }
                },
                riskLevel: 60,
                options: [
                    {
                        id: 'risk_c1_young_upside',
                        text: 'Concentrate Bet  Swing for Stars',
                        rationale: 'High-upside, high-bust prospects.',
                        variance: 'High',
                        effects: { riskExposure: 15, optionality: -5, informationEdge: 10 },
                        explanation: {
                            immediate: 'Boom-or-bust picks. High variance.',
                            delayed: 'Championship ceiling if hits. Wasted picks if miss.',
                            economic: 'VARIANCE: Wide outcome range. EXPECTED VALUE: Low probability, high payoff.'
                        },
                        varianceWarning: 'High bust risk. Volatile outcomes.'
                    },
                    {
                        id: 'risk_c1_young_safe',
                        text: 'Buy Insurance  High-Floor Prospects',
                        rationale: 'Reliable, lower-ceiling players.',
                        variance: 'Low',
                        effects: { riskExposure: -10, rosterQuality: 8 },
                        explanation: {
                            immediate: 'Solid picks. Lower ceiling.',
                            delayed: 'Good role players. No superstars likely.',
                            economic: 'RISK MANAGEMENT: Reduced variance. CEILING: Limited upside.'
                        }
                    },
                    {
                        id: 'risk_c1_young_diversify',
                        text: 'Diversify  Mix of Both',
                        rationale: 'Balance risk across picks.',
                        variance: 'Moderate',
                        effects: { riskExposure: 5, optionality: 10, rosterQuality: 5 },
                        explanation: {
                            immediate: 'Balanced portfolio. Multiple paths.',
                            delayed: 'Diversified risk. Likely some hits.',
                            economic: 'PORTFOLIO THEORY: Diversification reduces concentrated risk.'
                        }
                    }
                ],
                economicConcepts: {
                    'Portfolio Theory': 'Diversification strategies',
                    'Variance': 'Range of possible outcomes'
                }
            },

            // CYCLE 1 - MESSY FRANCHISE SCENARIOS
            cycle1_eval_messy: {
                id: 'eval_c1_messy', room: 'eval',
                title: 'Rebuild or Compete',
                context: 'Stuck in mediocrity. Blow it up or try to compete?',
                scenario: 'Blazers 2023: Treadmill of mediocrity decision.',
                question: 'Commit to direction?',
                signals: [
                    { text: 'Current trajectory: 9th-10th seed annually', confidence: 'high' },
                    { text: 'Rebuild value: Could get significant assets', confidence: 'high' },
                    { text: 'Compete path: Expensive, low ceiling', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c1_messy_rebuild',
                        text: 'Trust the Data  Full Rebuild',
                        rationale: 'Tear it down. Start over.',
                        effects: { optionality: 20, rosterQuality: -15, mediaNarrative: -15, flags: ['rebuild_mode'] },
                        explanation: {
                            immediate: 'Mass exodus. Painful process begins.',
                            delayed: 'Draft assets accumulate. 3-5 year timeline.',
                            economic: 'SUNK COST: Writing off current roster. TIME PREFERENCE: Future over present.'
                        }
                    },
                    {
                        id: 'eval_c1_messy_compete',
                        text: 'Override  Push to Compete',
                        rationale: 'Add pieces. Go for playoffs.',
                        effects: { rosterQuality: 8, optionality: -12, capFlexibility: -15, mediaNarrative: 5 },
                        explanation: {
                            immediate: 'Playoff push. Fans happy short-term.',
                            delayed: 'Treadmill continues. First-round exit likely.',
                            economic: 'OPPORTUNITY COST: Assets spent on incremental gains.'
                        }
                    },
                    {
                        id: 'eval_c1_messy_wait',
                        text: 'Wait for Information  Status Quo',
                        rationale: 'See what develops naturally.',
                        effects: { optionality: 8, mediaNarrative: -8 },
                        explanation: {
                            immediate: 'No clear direction. Continued mediocrity.',
                            delayed: 'Avoided hard choice. Problem persists.',
                            economic: 'OPTION VALUE: Preserved flexibility. OPPORTUNITY COST: Time lost.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Don\'t let past investment dictate future',
                    'Time Preference': 'Present vs. future value'
                }
            },

            cycle1_cap_messy: {
                id: 'cap_c1_messy', room: 'cap',
                title: 'Cap Space Strategy',
                context: 'Opening significant cap space. Chase stars or build through draft?',
                scenario: 'Knicks perpetual cap space: How to deploy?',
                question: 'Free agency or draft?',
                capSummary: { currentSalary: '$92M', capLine: '$136M', projectedSpace: '$44M next summer' },
                options: [
                    {
                        id: 'cap_c1_messy_chase',
                        text: 'Commit  Chase Free Agents',
                        rationale: 'Use space for stars.',
                        beforeAfter: { capSpace: { before: '$44M', after: '$5M' }, timeline: { before: '3 years', after: 'Now' } },
                        effects: { capFlexibility: -25, optionality: -15, mediaNarrative: 15 },
                        explanation: {
                            immediate: 'Big splash. Media loves it.',
                            delayed: 'Success depends on who signs. Risky bet.',
                            economic: 'OPPORTUNITY COST: Cap space is one-time use. SIGNALING: Shows ambition.'
                        }
                    },
                    {
                        id: 'cap_c1_messy_patient',
                        text: 'Preserve Flexibility  Stay Patient',
                        rationale: 'Keep space. Draft and develop.',
                        beforeAfter: { capSpace: { before: '$44M', after: '$44M' } },
                        effects: { optionality: 20, capFlexibility: 15, mediaNarrative: -12 },
                        explanation: {
                            immediate: 'No splash. Fans disappointed.',
                            delayed: 'Flexibility preserved for right opportunity.',
                            economic: 'OPTION VALUE: Cap space as strategic asset. PATIENCE: Waiting for right deal.'
                        }
                    },
                    {
                        id: 'cap_c1_messy_short_deals',
                        text: 'Use Exception  Short-Term Deals',
                        rationale: 'Flexible contracts. Stay mobile.',
                        beforeAfter: { capSpace: { before: '$44M', after: '$25M' } },
                        effects: { capFlexibility: -10, optionality: 10, rosterQuality: 5 },
                        explanation: {
                            immediate: 'Moderate upgrades. Flexibility maintained.',
                            delayed: 'Can pivot quickly. Not committed long-term.',
                            economic: 'OPTION VALUE: Short contracts preserve flexibility.'
                        }
                    }
                ],
                economicConcepts: {
                    'Option Value': 'Cap space as strategic option',
                    'Opportunity Cost': 'Every dollar spent is unavailable elsewhere'
                }
            },

            cycle1_relationships_messy: {
                id: 'rel_c1_messy', room: 'relationships',
                title: 'Culture Change Decision',
                context: 'Years of losing. Culture is broken. Gradual change or shock therapy?',
                scenario: 'Post-Process Sixers: How to change culture?',
                question: 'Evolution or revolution?',
                dialogue: { speaker: 'Veteran Leader', text: '"This losing culture is ingrained. You can\'t just say things will change. You need to force change or it won\'t happen."' },
                relationshipTemp: 'frustrated',
                options: [
                    {
                        id: 'rel_c1_messy_shock',
                        text: 'Hold Ground  Shock Therapy',
                        rationale: 'Mass turnover. New culture immediately.',
                        effects: { trustIndex: -10, mediaNarrative: -10, optionality: 15, rosterQuality: -5 },
                        explanation: {
                            immediate: 'Major trades. Fresh start. Uncertainty.',
                            delayed: 'New group, new culture. High variance.',
                            economic: 'SUNK COST: Wrote off existing relationships. COMMITMENT: Clean break.'
                        }
                    },
                    {
                        id: 'rel_c1_messy_gradual',
                        text: 'Maintain Relationship  Gradual Change',
                        rationale: 'Add good culture pieces slowly.',
                        effects: { trustIndex: 5, reputationPlayers: 5, rosterQuality: 3 },
                        explanation: {
                            immediate: 'Stable approach. Slow improvement.',
                            delayed: 'Culture changes through winning, not force.',
                            economic: 'TIME PREFERENCE: Patient long-term approach.'
                        }
                    },
                    {
                        id: 'rel_c1_messy_leader',
                        text: 'Negotiate  Bring in Culture Leader',
                        rationale: 'Add respected veteran voice.',
                        effects: { trustIndex: 12, reputationLeague: 10, rosterQuality: 5, capFlexibility: -8 },
                        explanation: {
                            immediate: 'Veteran leadership. Standards set.',
                            delayed: 'Culture improves. Takes time.',
                            economic: 'PRINCIPAL-AGENT: Delegated culture building.'
                        }
                    }
                ],
                economicConcepts: {
                    'Social Capital': 'Culture as organizational asset',
                    'Time Preference': 'Immediate vs. gradual change'
                }
            },

            cycle1_risk_messy: {
                id: 'risk_c1_messy', room: 'risk',
                title: 'Asset Liquidation Strategy',
                context: 'Several tradeable veterans. Package for star or accumulate picks?',
                scenario: 'Asset management: consolidate or diversify?',
                question: 'One big bet or many small bets?',
                outcomeScenarios: {
                    likely: { label: 'Base Case', outcome: 'Mix of outcomes', impact: 'Some hits' },
                    worst: { label: 'Worst Case', outcome: 'Star busts or picks fail', impact: 'Wasted assets' },
                    best: { label: 'Best Case', outcome: 'Multiple quality players', impact: 'Strong core' }
                },
                riskLevel: 55,
                options: [
                    {
                        id: 'risk_c1_messy_consolidate',
                        text: 'Concentrate Bet  Trade for Star',
                        rationale: 'Package assets for proven player.',
                        variance: 'High',
                        effects: { riskExposure: 15, rosterQuality: 12, optionality: -18 },
                        explanation: {
                            immediate: 'Star acquired. Elevated floor.',
                            delayed: 'Bet on one player. High variance.',
                            economic: 'CONCENTRATION: All eggs in one basket. IRREVERSIBILITY: Can\'t undo.'
                        },
                        varianceWarning: 'Concentrated risk. Star must perform.'
                    },
                    {
                        id: 'risk_c1_messy_accumulate',
                        text: 'Diversify  Accumulate Picks',
                        rationale: 'Maximum draft capital.',
                        variance: 'Low',
                        effects: { riskExposure: -10, optionality: 20, rosterQuality: -8 },
                        explanation: {
                            immediate: 'Picks accumulate. Painful short-term.',
                            delayed: 'Multiple swings at stars. Long timeline.',
                            economic: 'PORTFOLIO: Diversified risk. TIME PREFERENCE: Long-term focus.'
                        }
                    },
                    {
                        id: 'risk_c1_messy_selective',
                        text: 'Diversify  Selective Trades',
                        rationale: 'Some picks, some young players.',
                        variance: 'Moderate',
                        effects: { riskExposure: 3, optionality: 12, rosterQuality: -3 },
                        explanation: {
                            immediate: 'Balanced approach. Multiple paths.',
                            delayed: 'Diversified portfolio. Reduced variance.',
                            economic: 'PORTFOLIO THEORY: Balanced risk distribution.'
                        }
                    }
                ],
                economicConcepts: {
                    'Portfolio Theory': 'Diversification vs. concentration',
                    'Variance': 'Risk-return tradeoff'
                }
            },

            // ================================
            // CYCLE 2 SCENARIOS
            // ================================

            cycle2_eval_contender: {
                id: 'eval_c2_contender', room: 'eval',
                title: 'Trade Deadline Decision',
                context: 'Trade deadline approaches. Your C1 moves have consequences. Rival made big move.',
                scenario: '2023 Suns trading for Durant while contending.',
                question: 'Double down or hold steady?',
                signals: [
                    { text: 'Available target: Expensive but proven', confidence: 'high' },
                    { text: 'Your young depth: Limited after C1 trades', confidence: 'high' },
                    { text: 'Championship window: Closing fast', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c2_contender_aggressive',
                        text: 'Trust the Data  Aggressive Add',
                        rationale: 'One more piece gets you there.',
                        effects: { rosterQuality: 12, capFlexibility: -15, optionality: -15, riskExposure: 12 },
                        explanation: {
                            immediate: 'Championship-caliber depth added.',
                            delayed: 'Future picks gone. Must win now.',
                            economic: 'SUNK COST: Already invested, continuing commitment. ESCALATION: Doubling down.'
                        }
                    },
                    {
                        id: 'eval_c2_contender_hold',
                        text: 'Override Model  Hold Assets',
                        rationale: 'Price too high. Trust current roster.',
                        effects: { rosterQuality: -3, optionality: 5, reputationPlayers: -5 },
                        explanation: {
                            immediate: 'Stars disappointed. Rivals got better.',
                            delayed: 'Preserved some flexibility.',
                            economic: 'OPTION VALUE: Kept future assets. OPPORTUNITY COST: Missed upgrade window.'
                        }
                    },
                    {
                        id: 'eval_c2_contender_minor',
                        text: 'Wait for Information  Minor Move',
                        rationale: 'Small upgrade without big cost.',
                        effects: { rosterQuality: 4, capFlexibility: -5, optionality: -3 },
                        explanation: {
                            immediate: 'Incremental improvement.',
                            delayed: 'Hedged bet. May regret half-measure.',
                            economic: 'MARGINAL IMPROVEMENT: Small gain, small cost.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Past investments shouldn\'t drive future decisions',
                    'Escalation of Commitment': 'Tendency to double down'
                }
            },

            cycle2_eval_young: {
                id: 'eval_c2_young', room: 'eval',
                title: 'Young Star Breakout Assessment',
                context: 'One of your young players is breaking out. Real or noise? Extension talks loom.',
                scenario: 'Evaluating if breakout is sustainable (Maxey, Haliburton situations).',
                question: 'Trust the breakout or wait?',
                signals: [
                    { text: 'Stats: Major improvement across board', confidence: 'high' },
                    { text: 'Sample size: 40 games of elite play', confidence: 'mixed' },
                    { text: 'Advanced metrics: Some concerning signs', confidence: 'noisy' }
                ],
                options: [
                    {
                        id: 'eval_c2_young_extend',
                        text: 'Trust Data  Extend Now',
                        rationale: 'Lock in value before max contract.',
                        effects: { rosterQuality: 8, capFlexibility: -12, reputationPlayers: 12, trustIndex: 10 },
                        explanation: {
                            immediate: 'Player thrilled. Betting on breakout.',
                            delayed: 'If real, saved $10M/year. If not, overpaid.',
                            economic: 'INFORMATION: Acting on limited sample. RISK: Uncertain outcome.'
                        }
                    },
                    {
                        id: 'eval_c2_young_wait',
                        text: 'Override  Wait Full Season',
                        rationale: 'Need more data. One hot stretch isn\'t enough.',
                        effects: { rosterQuality: 3, optionality: 8, reputationPlayers: -8, trustIndex: -5 },
                        explanation: {
                            immediate: 'Player frustrated. Wants commitment.',
                            delayed: 'If breakout real, pay max. If not, dodged bullet.',
                            economic: 'OPTION VALUE: Preserved flexibility. INFORMATION: Waiting reveals more.'
                        }
                    },
                    {
                        id: 'eval_c2_young_incentive',
                        text: 'Conditional  Incentive-Laden Deal',
                        rationale: 'Base salary + bonuses for performance.',
                        effects: { capFlexibility: -8, reputationPlayers: 5, trustIndex: 5, optionality: 3 },
                        explanation: {
                            immediate: 'Creative structure. Player accepts.',
                            delayed: 'Bonus risk. Could pay more than expected.',
                            economic: 'RISK SHARING: Player bears performance risk.'
                        }
                    }
                ],
                economicConcepts: {
                    'Information Asymmetry': 'Limited data requires judgment',
                    'Option Value': 'Waiting provides information'
                }
            },

            cycle2_eval_messy: {
                id: 'eval_c2_messy', room: 'eval',
                title: 'Draft Lottery Decision',
                context: 'You\'re in lottery position. Tank harder or show competitive spirit?',
                scenario: 'Thunder/Pistons-style strategic losing vs. development culture.',
                question: 'Optimize lottery odds or develop culture?',
                signals: [
                    { text: 'Draft class: Generational talent at top', confidence: 'high' },
                    { text: 'Young players: Need competitive reps', confidence: 'high' },
                    { text: 'Lottery odds: Better at bottom 3', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c2_messy_tank',
                        text: 'Trust Math  Maximize Lottery Odds',
                        rationale: 'Top pick changes everything.',
                        effects: { rosterQuality: -8, optionality: 15, mediaNarrative: -12, trustIndex: -8 },
                        explanation: {
                            immediate: 'Obvious tanking. Players frustrated. Media critical.',
                            delayed: 'Better lottery position. Young players lack winning habits.',
                            economic: 'EXPECTED VALUE: Maximizing probability of top pick.'
                        }
                    },
                    {
                        id: 'eval_c2_messy_develop',
                        text: 'Override  Competitive Development',
                        rationale: 'Build winning culture. Teach habits.',
                        effects: { rosterQuality: 5, optionality: -5, trustIndex: 8, mediaNarrative: 5 },
                        explanation: {
                            immediate: 'Players develop in competitive environment.',
                            delayed: 'Worse lottery odds. Better organizational culture.',
                            economic: 'TIME PREFERENCE: Long-term culture over short-term odds.'
                        }
                    },
                    {
                        id: 'eval_c2_messy_hybrid',
                        text: 'Conditional  Play Young, Rest Vets',
                        rationale: 'Development + positioning.',
                        effects: { rosterQuality: -3, optionality: 8, trustIndex: 3 },
                        explanation: {
                            immediate: 'Young players get minutes. Not obvious tank.',
                            delayed: 'Middle ground often means middle results.',
                            economic: 'COMPROMISE: Split the difference.'
                        }
                    }
                ],
                economicConcepts: {
                    'Expected Value': 'Probability  Outcome value',
                    'Time Preference': 'Immediate vs. delayed benefits'
                }
            },

            cycle2_cap_contender: {
                id: 'cap_c2_contender', room: 'cap',
                title: 'Repeater Tax Threshold',
                context: 'You\'ve been in tax for years. Crossing repeater threshold triggers harsh penalties.',
                scenario: 'Warriors 2019: Repeater tax consequences.',
                question: 'Pay repeater tax or shed salary?',
                capSummary: { currentSalary: '$178M', capLine: '$136M', taxLine: '$165M', repeaterLine: '$172M' },
                options: [
                    {
                        id: 'cap_c2_contender_pay',
                        text: 'Commit  Pay Repeater Tax',
                        rationale: 'Window requires maximum commitment.',
                        beforeAfter: { taxBill: { before: '$25M', after: '$65M' }, flexibility: { before: 'Low', after: 'None' } },
                        effects: { taxExposure: 40, capFlexibility: -25, optionalityCap: 40, rosterQuality: 5, reputationPlayers: 10 },
                        explanation: {
                            immediate: 'Massive tax bill. Stars happy. Future crippled.',
                            delayed: 'Repeater penalties compound. Hard to ever get under.',
                            economic: 'PROGRESSIVE TAX: Penalties accelerate exponentially.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'cap_c2_contender_shed',
                        text: 'Cut Losses  Shed Salary',
                        rationale: 'Reset tax clock. Preserve future.',
                        beforeAfter: { taxBill: { before: '$25M', after: '$0' }, flexibility: { before: 'Low', after: 'Moderate' } },
                        effects: { taxExposure: -25, capFlexibility: 15, rosterQuality: -10, reputationPlayers: -12 },
                        explanation: {
                            immediate: 'Roster weakened. Stars angry. Media critical.',
                            delayed: 'Reset tax clock. Future flexibility restored.',
                            economic: 'SUNK COST: Wrote off prior investment. OPTION VALUE: Future flexibility.'
                        }
                    },
                    {
                        id: 'cap_c2_contender_balance',
                        text: 'Hedge  Stay Below Repeater',
                        rationale: 'Pay tax but avoid repeater.',
                        beforeAfter: { taxBill: { before: '$25M', after: '$35M' }, flexibility: { before: 'Low', after: 'Low' } },
                        effects: { taxExposure: 10, capFlexibility: -10, rosterQuality: -3 },
                        explanation: {
                            immediate: 'Moderate tax. Avoided worst penalties.',
                            delayed: 'Kick can down road. Problem persists.',
                            economic: 'RISK MANAGEMENT: Avoided tail risk.'
                        }
                    }
                ],
                economicConcepts: {
                    'Progressive Tax': 'Penalties accelerate with spending',
                    'Irreversibility': 'Hard to escape once committed'
                }
            },

            cycle2_cap_young: {
                id: 'cap_c2_young', room: 'cap',
                title: 'Extension Timing Strategy',
                context: 'Multiple young players eligible for extensions. Sign all now or wait?',
                scenario: 'Staggering contracts vs. committing early (OKC strategy).',
                question: 'Lock in value or preserve flexibility?',
                capSummary: { currentSalary: '$95M', capLine: '$136M', projectedExtensions: '$45M/year' },
                options: [
                    {
                        id: 'cap_c2_young_extend_all',
                        text: 'Commit  Extend Everyone',
                        rationale: 'Lock in before prices rise.',
                        beforeAfter: { capSpace: { before: '$41M', after: '$0' }, committedYears: { before: '2 years', after: '5 years' } },
                        effects: { capFlexibility: -20, rosterQuality: 10, reputationPlayers: 15, trustIndex: 15, optionality: -20 },
                        explanation: {
                            immediate: 'Players thrilled. Core locked in.',
                            delayed: 'No flexibility for 5 years. Better hope they develop.',
                            economic: 'IRREVERSIBILITY: Committed to core. OPTION VALUE: Sacrificed.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'cap_c2_young_wait',
                        text: 'Preserve Options  Wait on Extensions',
                        rationale: 'Need more information on development.',
                        beforeAfter: { capSpace: { before: '$41M', after: '$35M' }, committedYears: { before: '2 years', after: '2 years' } },
                        effects: { capFlexibility: 5, optionality: 15, reputationPlayers: -10, trustIndex: -10 },
                        explanation: {
                            immediate: 'Players disappointed. Uncertainty.',
                            delayed: 'Flexibility preserved. May pay more later.',
                            economic: 'OPTION VALUE: Waiting for information. RISK: Price may rise.'
                        }
                    },
                    {
                        id: 'cap_c2_young_stagger',
                        text: 'Hedge  Stagger Extensions',
                        rationale: 'Extend some, wait on others.',
                        beforeAfter: { capSpace: { before: '$41M', after: '$18M' }, committedYears: { before: '2 years', after: '3-4 years' } },
                        effects: { capFlexibility: -10, rosterQuality: 5, reputationPlayers: 5, optionality: 5 },
                        explanation: {
                            immediate: 'Mixed reactions. Partial commitment.',
                            delayed: 'Moderate flexibility. Hedged bet.',
                            economic: 'PORTFOLIO THEORY: Diversified approach.'
                        }
                    }
                ],
                economicConcepts: {
                    'Option Value': 'Value of waiting for information',
                    'Irreversibility': 'Long-term commitments hard to undo'
                }
            },

            cycle2_cap_messy: {
                id: 'cap_c2_messy', room: 'cap',
                title: 'Bad Contract Decision',
                context: 'You have an albatross contract. Attach assets to dump it or wait it out?',
                scenario: 'Westbrook trade cost (Lakers gave up pick to dump contract).',
                question: 'Pay to clear space or absorb cost?',
                capSummary: { currentSalary: '$115M', capLine: '$136M', badContract: '$35M/year for 2 years' },
                options: [
                    {
                        id: 'cap_c2_messy_dump',
                        text: 'Cut Losses  Attach Pick to Dump',
                        rationale: 'Clear space now. Worth the cost.',
                        beforeAfter: { capSpace: { before: '$21M', after: '$56M' }, assets: { before: '2 firsts', after: '0 firsts' } },
                        effects: { capFlexibility: 25, optionality: -15, rosterQuality: -5 },
                        explanation: {
                            immediate: 'Space cleared. Assets gone.',
                            delayed: 'Flexibility restored. Future picks sacrificed.',
                            economic: 'SUNK COST: Paid to undo mistake. OPPORTUNITY COST: Lost assets.'
                        }
                    },
                    {
                        id: 'cap_c2_messy_wait',
                        text: 'Accept Sunk Cost  Wait It Out',
                        rationale: 'Don\'t throw good money after bad.',
                        beforeAfter: { capSpace: { before: '$21M', after: '$21M' }, assets: { before: '2 firsts', after: '2 firsts' } },
                        effects: { capFlexibility: -5, optionality: 10, mediaNarrative: -8 },
                        explanation: {
                            immediate: 'Stuck with bad contract. Media critical.',
                            delayed: 'Preserved assets. Eventually clears.',
                            economic: 'SUNK COST: Don\'t pay to fix past mistake. TIME PREFERENCE: Patient approach.'
                        }
                    },
                    {
                        id: 'cap_c2_messy_flip',
                        text: 'Creative Solution  Flip to Contender',
                        rationale: 'Find team that values player.',
                        beforeAfter: { capSpace: { before: '$21M', after: '$38M' }, assets: { before: '2 firsts', after: '1 first + player' } },
                        effects: { capFlexibility: 15, optionality: 5, rosterQuality: 3 },
                        explanation: {
                            immediate: 'Creative deal. Some space cleared.',
                            delayed: 'Moderate asset cost. Better than dumping.',
                            economic: 'BARGAINING: Found better counterparty. INFORMATION: Player has value somewhere.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Past mistakes shouldn\'t drive future decisions',
                    'Opportunity Cost': 'Assets spent on cleanup can\'t be used elsewhere'
                }
            },

            cycle2_relationships_contender: {
                id: 'rel_c2_contender', room: 'relationships',
                title: 'Veteran Role Conflict',
                context: 'Your veteran star wants more minutes but analytics say young player is better.',
                scenario: 'Melo/Westbrook end-of-career role disputes.',
                question: 'Respect seniority or optimize roster?',
                dialogue: { speaker: 'Veteran Star (Team Meeting)', text: '"I\'ve earned the right to play. You can\'t bench me for some kid."' },
                relationshipTemp: 'hostile',
                options: [
                    {
                        id: 'rel_c2_contender_defer',
                        text: 'Maintain Relationship  Give Minutes',
                        rationale: 'Keep veteran happy. Avoid conflict.',
                        effects: { reputationPlayers: 10, trustIndex: 5, rosterQuality: -8, mediaNarrative: -5 },
                        explanation: {
                            immediate: 'Veteran satisfied. Analytics say wrong choice.',
                            delayed: 'Suboptimal roster. Set bad precedent.',
                            economic: 'SOCIAL CAPITAL: Preserved relationship. OPPORTUNITY COST: Better lineup.'
                        },
                        memory: 'Players note: Loyalty over performance.',
                        delayedWarning: 'Other players expect same treatment.'
                    },
                    {
                        id: 'rel_c2_contender_firm',
                        text: 'Hold Ground  Merit-Based Minutes',
                        rationale: 'Performance dictates playing time.',
                        effects: { reputationPlayers: -5, reputationLeague: 8, trustIndex: -10, rosterQuality: 5, mediaNarrative: -8 },
                        explanation: {
                            immediate: 'Veteran angry. Public dispute. Young players respect meritocracy.',
                            delayed: 'Short-term pain. Better roster optimization.',
                            economic: 'PRINCIPAL-AGENT: Aligned incentives with winning.'
                        },
                        memory: 'Players note: You prioritize winning over politics.',
                        delayedWarning: 'Veteran may demand trade or become locker room problem.'
                    },
                    {
                        id: 'rel_c2_contender_transition',
                        text: 'Negotiate  Mentorship Role',
                        rationale: 'Transition him to leadership position.',
                        effects: { reputationPlayers: 5, trustIndex: 10, reputationLeague: 10, rosterQuality: 0 },
                        explanation: {
                            immediate: 'Creative solution. Veteran accepts gracefully.',
                            delayed: 'Maintained relationship. Optimized roster.',
                            economic: 'BARGAINING: Win-win negotiation. SOCIAL CAPITAL: Preserved relationships.'
                        }
                    }
                ],
                economicConcepts: {
                    'Social Capital': 'Relationships as assets or liabilities',
                    'Principal-Agent Problem': 'Aligning individual and team incentives'
                }
            },

            cycle2_relationships_young: {
                id: 'rel_c2_young', room: 'relationships',
                title: 'Agent Power Play',
                context: 'Your breakout star\'s agent (Klutch) wants you to sign another of his clients.',
                scenario: 'Agent leveraging roster construction (LeBron/Klutch dynamics).',
                question: 'Cave to agent pressure?',
                dialogue: { speaker: 'Agent (conference call)', text: '"If you want my guy long-term, you need to show you\'re serious about building around him. My other client would be perfect."' },
                relationshipTemp: 'tense',
                options: [
                    {
                        id: 'rel_c2_young_comply',
                        text: 'Negotiate  Sign His Client',
                        rationale: 'Keep star happy. Agent controls market.',
                        effects: { reputationAgents: 15, reputationPlayers: 10, trustIndex: 10, capFlexibility: -12, rosterQuality: -3 },
                        explanation: {
                            immediate: 'Agent thrilled. Star happy. Roster fit questionable.',
                            delayed: 'Set precedent. Agents control your moves.',
                            economic: 'BARGAINING POWER: Agent had leverage. Used it.'
                        },
                        memory: 'Agents know: You can be pressured.',
                        delayedWarning: 'Future agents will use same tactic.'
                    },
                    {
                        id: 'rel_c2_young_refuse',
                        text: 'Hold Ground  Refuse Firmly',
                        rationale: 'Roster decisions are yours, not agents\'.',
                        effects: { reputationAgents: -15, reputationPlayers: -8, trustIndex: -5, optionality: 10 },
                        explanation: {
                            immediate: 'Agent angry. Star disappointed. Established boundaries.',
                            delayed: 'Future negotiations harder but you control roster.',
                            economic: 'BARGAINING POWER: Asserted control. SOCIAL CAPITAL: Relationship cost.'
                        },
                        memory: 'Agents know: You don\'t bend.',
                        delayedWarning: 'Extension talks may be difficult.'
                    },
                    {
                        id: 'rel_c2_young_counter',
                        text: 'Negotiate  Different Client',
                        rationale: 'Willing to work with agent, on your terms.',
                        effects: { reputationAgents: 5, reputationPlayers: 5, trustIndex: 5, capFlexibility: -8, rosterQuality: 2 },
                        explanation: {
                            immediate: 'Compromise reached. Agent accepts.',
                            delayed: 'Maintained relationship. Set boundaries.',
                            economic: 'BARGAINING: Found middle ground. SOCIAL CAPITAL: Preserved relationship.'
                        }
                    }
                ],
                economicConcepts: {
                    'Bargaining Power': 'Who controls the negotiation',
                    'Repeated Games': 'Setting precedent for future interactions'
                }
            },

            cycle2_relationships_messy: {
                id: 'rel_c2_messy', room: 'relationships',
                title: 'Culture Reset Decision',
                context: 'Losing culture entrenched. Do you bring in tough veteran voice?',
                scenario: 'Culture change agents (Udoka to Houston, Thibs to NY).',
                question: 'Impose culture or let it evolve?',
                dialogue: { speaker: 'Veteran Leader (Potential Signing)', text: '"I can change this culture, but I need authority. Players won\'t like it at first. You backing me?"' },
                relationshipTemp: 'tense',
                options: [
                    {
                        id: 'rel_c2_messy_empower',
                        text: 'Negotiate  Empower Leader',
                        rationale: 'Veteran enforces standards.',
                        effects: { trustIndex: 20, reputationPlayers: -5, mediaNarrative: 10, rosterQuality: 5, reputationLeague: 8 },
                        explanation: {
                            immediate: 'Short-term friction. Culture shifts dramatically.',
                            delayed: 'Standards established. Winning habits formed.',
                            economic: 'PRINCIPAL-AGENT: Delegated enforcement. SHORT-TERM PAIN: Long-term gain.'
                        },
                        memory: 'Players know: Standards are enforced.',
                        delayedWarning: 'Some players may request trades.'
                    },
                    {
                        id: 'rel_c2_messy_gradual',
                        text: 'Hold Ground  Gradual Change',
                        rationale: 'Culture changes through winning, not force.',
                        effects: { trustIndex: 5, reputationPlayers: 5, mediaNarrative: -3 },
                        explanation: {
                            immediate: 'No dramatic shift. Evolution not revolution.',
                            delayed: 'Slower change. Less resistance.',
                            economic: 'TIME PREFERENCE: Gradual vs. immediate change.'
                        }
                    },
                    {
                        id: 'rel_c2_messy_turnover',
                        text: 'Clean House  Roster Turnover',
                        rationale: 'Change players, not culture.',
                        effects: { trustIndex: -10, reputationPlayers: -12, optionality: 15, capFlexibility: 10 },
                        explanation: {
                            immediate: 'Mass turnover. Fresh start.',
                            delayed: 'New group, new culture. High variance.',
                            economic: 'SUNK COST: Wrote off existing relationships.'
                        }
                    }
                ],
                economicConcepts: {
                    'Social Capital': 'Culture as organizational asset',
                    'Time Preference': 'Immediate pain for long-term gain'
                }
            },

            cycle2_risk_contender: {
                id: 'risk_c2_contender', room: 'risk',
                title: 'Injury Crisis Response',
                context: 'Key rotation player injured. Championship window open. Rush back or be cautious?',
                scenario: 'Playoff injury decisions (Durant Achilles, Kawhi decisions).',
                question: 'How much risk acceptable?',
                outcomeScenarios: {
                    likely: { label: 'Base Case', outcome: 'Full recovery, slower', impact: 'Miss playoffs' },
                    worst: { label: 'Worst Case', outcome: 'Re-injury, career impact', impact: 'Lost asset' },
                    best: { label: 'Best Case', outcome: 'Quick return, healthy', impact: 'Championship run' }
                },
                riskLevel: 75,
                options: [
                    {
                        id: 'risk_c2_contender_rush',
                        text: 'Concentrate Bet  Rush Return',
                        rationale: 'Window closing. Need him now.',
                        variance: 'High',
                        effects: { rosterQuality: 10, riskExposure: 25, injuryFragility: 20, reputationPlayers: -8 },
                        explanation: {
                            immediate: 'Player returns. Championship odds up. Re-injury risk high.',
                            delayed: 'If re-injury, long-term damage. Player trust damaged.',
                            economic: 'EXPECTED VALUE: High variance. RISK: Tail risk of catastrophe.'
                        },
                        varianceWarning: 'High probability of worsening injury. Could lose player long-term.'
                    },
                    {
                        id: 'risk_c2_contender_cautious',
                        text: 'Buy Insurance  Full Recovery',
                        rationale: 'Protect long-term asset.',
                        variance: 'Low',
                        effects: { rosterQuality: -8, riskExposure: -15, injuryFragility: -10, reputationPlayers: 10, trustIndex: 10 },
                        explanation: {
                            immediate: 'Miss playoffs. Player appreciates caution.',
                            delayed: 'Healthy for future. This year lost.',
                            economic: 'RISK MANAGEMENT: Avoided tail risk. OPPORTUNITY COST: This season.'
                        }
                    },
                    {
                        id: 'risk_c2_contender_conditional',
                        text: 'Diversify  Limited Minutes',
                        rationale: 'Bring back slowly with restrictions.',
                        variance: 'Moderate',
                        effects: { rosterQuality: 3, riskExposure: 8, injuryFragility: 5 },
                        explanation: {
                            immediate: 'Partial contribution. Moderate risk.',
                            delayed: 'Compromise. May satisfy neither goal.',
                            economic: 'HEDGING: Split difference. MODERATE: Outcomes.'
                        }
                    }
                ],
                economicConcepts: {
                    'Expected Value': 'Probability  Payoff',
                    'Tail Risk': 'Low probability, catastrophic outcome'
                }
            },

            cycle2_risk_young: {
                id: 'risk_c2_young', room: 'risk',
                title: 'Development Pathway Variance',
                context: 'Young core developing unevenly. Invest in boom-bust project or safer player?',
                scenario: 'High-ceiling vs. high-floor young talent development.',
                question: 'Maximize upside or reduce downside?',
                outcomeScenarios: {
                    likely: { label: 'Base Case', outcome: 'Uneven development', impact: 'Mixed results' },
                    worst: { label: 'Worst Case', outcome: 'Projects bust', impact: 'Wasted years' },
                    best: { label: 'Best Case', outcome: 'All hit ceiling', impact: 'Elite core' }
                },
                riskLevel: 60,
                options: [
                    {
                        id: 'risk_c2_young_upside',
                        text: 'Concentrate Bet  High-Upside Focus',
                        rationale: 'Swing for stars.',
                        variance: 'High',
                        effects: { rosterQuality: 5, riskExposure: 18, optionality: -8, informationEdge: 5 },
                        explanation: {
                            immediate: 'Prioritize boom-bust players. High variance.',
                            delayed: 'Championship upside. Bust risk significant.',
                            economic: 'VARIANCE: Wide range of outcomes. UPSIDE: Max potential.'
                        },
                        varianceWarning: 'High bust risk. Outcome highly uncertain.'
                    },
                    {
                        id: 'risk_c2_young_floor',
                        text: 'Diversify  High-Floor Additions',
                        rationale: 'Build reliable foundation.',
                        variance: 'Low',
                        effects: { rosterQuality: 8, riskExposure: -12, optionality: 5 },
                        explanation: {
                            immediate: 'Reliable players. Lower ceiling.',
                            delayed: 'Solid but unspectacular. Limited upside.',
                            economic: 'RISK MANAGEMENT: Reduced variance. CEILING: Lower upside.'
                        }
                    },
                    {
                        id: 'risk_c2_young_portfolio',
                        text: 'Diversify  Balanced Portfolio',
                        rationale: 'Mix of high-upside and safe bets.',
                        variance: 'Moderate',
                        effects: { rosterQuality: 6, riskExposure: 3, optionality: 8 },
                        explanation: {
                            immediate: 'Diversified approach. Multiple paths to success.',
                            delayed: 'Reduced risk. Maintained upside.',
                            economic: 'PORTFOLIO THEORY: Diversification reduces concentrated risk.'
                        }
                    }
                ],
                economicConcepts: {
                    'Variance': 'Range of possible outcomes',
                    'Portfolio Theory': 'Diversification strategy'
                }
            },

            cycle2_risk_messy: {
                id: 'risk_c2_messy', room: 'risk',
                title: 'Competitive vs. Draft Positioning',
                context: 'You\'re borderline playoff. Fight for 8 seed or improve draft position?',
                scenario: 'Treadmill of mediocrity vs. strategic positioning.',
                question: 'Compete for playoffs or position for draft?',
                outcomeScenarios: {
                    likely: { label: 'Base Case', outcome: '9th seed finish', impact: 'Worst of both worlds' },
                    worst: { label: 'Playoff Case', outcome: '8 seed, swept', impact: 'Low pick, no progress' },
                    best: { label: 'Lottery Case', outcome: 'Top-6 pick', impact: 'Star talent' }
                },
                riskLevel: 50,
                options: [
                    {
                        id: 'risk_c2_messy_compete',
                        text: 'Accept Exposure  Fight for Playoffs',
                        rationale: 'Develop winning culture.',
                        variance: 'Moderate',
                        effects: { rosterQuality: 5, optionality: -8, trustIndex: 10, mediaNarrative: 8 },
                        explanation: {
                            immediate: 'Competitive. Players engaged. Likely 9th seed.',
                            delayed: 'No playoffs. Worse draft pick. Good culture.',
                            economic: 'TIME PREFERENCE: Short-term competition over long-term assets.'
                        }
                    },
                    {
                        id: 'risk_c2_messy_draft',
                        text: 'Buy Insurance  Optimize Draft',
                        rationale: 'Strategic positioning for talent.',
                        variance: 'Low',
                        effects: { rosterQuality: -8, optionality: 15, trustIndex: -8, mediaNarrative: -10 },
                        explanation: {
                            immediate: 'Obviously positioning. Players frustrated.',
                            delayed: 'Better draft pick. Culture questions.',
                            economic: 'EXPECTED VALUE: Maximizing probability of star talent.'
                        }
                    },
                    {
                        id: 'risk_c2_messy_flexible',
                        text: 'Diversify  Stay Flexible',
                        rationale: 'Let season play out naturally.',
                        variance: 'High',
                        effects: { optionality: 10 },
                        explanation: {
                            immediate: 'No clear strategy. Outcome uncertain.',
                            delayed: 'Avoided hard choice. Risk mediocrity.',
                            economic: 'OPTION VALUE: Preserved flexibility. VARIANCE: High uncertainty.'
                        }
                    }
                ],
                economicConcepts: {
                    'Expected Value': 'Probability-weighted outcomes',
                    'Time Preference': 'Present vs. future value'
                }
            },

            // ====================================================================
            // BRANCHING SCENARIOS - Reference Your Specific Prior Choices  
            // ====================================================================
            
            // CYCLE 2 WAR ROOM - Branches based on C1 choice
            cycle2_eval_contender_allin: {
                id: 'eval_c2_contender_allin',
                room: 'eval',
                title: 'Your All-In Bet: Early Returns',
                context: 'Last cycle you traded everything for the All-Star. Early results are mixedgreat games followed by puzzling losses.',
                scenario: 'The 2020 Lakers after trading for AD: championship-caliber talent, but chemistry takes time.',
                question: 'Double down or hedge your bet?',
                signals: [
                    { text: 'All-Star production: Elite but inconsistent', confidence: 'mixed' },
                    { text: 'Team chemistry: Building but not there yet', confidence: 'noisy' },
                    { text: 'Remaining assets: Almost nothing left', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c2_allin_double',
                        text: 'Double Down  Add One More Piece',
                        rationale: 'We\'re all-in. Finish the job.',
                        effects: { rosterQuality: 12, optionality: -15, capFlexibility: -10, riskExposure: 10 },
                        explanation: {
                            immediate: 'Roster reaches championship level. Assets gone.',
                            delayed: 'No flexibility left. This roster must win now.',
                            economic: 'COMMITMENT: Already invested, so keep investing. SUNK COST: Past trade drives current decision.'
                        }
                    },
                    {
                        id: 'eval_c2_allin_patient',
                        text: 'Be Patient  Let Chemistry Build',
                        rationale: 'Give it time to work.',
                        effects: { rosterQuality: 5, trustIndex: 5, mediaNarrative: -5 },
                        explanation: {
                            immediate: 'Roster stays same. Media questions lack of urgency.',
                            delayed: 'Chemistry improves naturally, or window closes.',
                            economic: 'TIME: Trust the process vs instant results.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Should past investment force continued commitment?',
                    'Commitment': 'Tendency to invest more when already invested'
                }
            },
            
            cycle2_eval_contender_patient: {
                id: 'eval_c2_contender_patient',
                room: 'eval',
                title: 'Your Patience Tested',
                context: 'Last cycle you stayed patient while your aging star got frustrated. Now he\'s demanding a trade. Other GMs smell weakness.',
                scenario: 'The 2018 Spurs with Kawhi: patience backfired, forced to trade from weakness.',
                question: 'Cave to pressure or stay disciplined?',
                signals: [
                    { text: 'Star trade value: Declining due to public demands', confidence: 'high' },
                    { text: 'Your young assets: Growing well', confidence: 'mixed' },
                    { text: 'Other GMs: Making lowball offers', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c2_patient_discipline',
                        text: 'Stay Disciplined  Demand Fair Value',
                        rationale: 'Won\'t panic-sell our star.',
                        effects: { optionality: 10, mediaNarrative: -10, rosterQuality: -5, reputationLeague: 10 },
                        explanation: {
                            immediate: 'Media pressure intense. Star relationship toxic.',
                            delayed: 'Other GMs respect your discipline. Better deals may come.',
                            economic: 'BARGAINING: Don\'t negotiate from weakness. TIME: Wait for better offers.'
                        }
                    },
                    {
                        id: 'eval_c2_patient_accept',
                        text: 'Accept Reality  Take Best Offer',
                        rationale: 'Get what we can and move on.',
                        effects: { rosterQuality: -8, optionality: 5, capFlexibility: 15, mediaNarrative: -15 },
                        explanation: {
                            immediate: 'Rebuild begins. Media says you got fleeced.',
                            delayed: 'Quick resolution. Can plan around new assets.',
                            economic: 'COST: Bad trade but ends uncertainty.'
                        }
                    }
                ],
                economicConcepts: {
                    'Bargaining Power': 'Negotiating from weakness reduces return',
                    'Time': 'Patient plan meets impatient reality'
                }
            },
            
            cycle2_eval_contender_balanced: {
                id: 'eval_c2_contender_balanced',
                room: 'eval',
                title: 'The Middle Path Meets Reality',
                context: 'Last cycle you made a moderate move. Results are moderate. Not bad, not great. Your owner wants to know: what\'s the plan?',
                scenario: 'Teams that try to compete and rebuild usually fail at both.',
                question: 'Pick a direction or stay the middle course?',
                signals: [
                    { text: 'Current roster: Playoff team, not contender', confidence: 'high' },
                    { text: 'Asset base: Decent but nothing special', confidence: 'high' },
                    { text: 'Owner patience: Running out', confidence: 'mixed' }
                ],
                options: [
                    {
                        id: 'eval_c2_balanced_commit',
                        text: 'Commit to Competing',
                        rationale: 'Make a real push now.',
                        effects: { rosterQuality: 10, optionality: -15, capFlexibility: -10, flags: ['all_in_move'] },
                        explanation: {
                            immediate: 'Clear direction. Roster improves a lot.',
                            delayed: 'Committed to win-now. Future flexibility limited.',
                            economic: 'CLARITY: Ending uncertainty has value.'
                        }
                    },
                    {
                        id: 'eval_c2_balanced_rebuild',
                        text: 'Commit to Rebuilding',
                        rationale: 'Accept we\'re not ready. Build properly.',
                        effects: { rosterQuality: -10, optionality: 20, capFlexibility: 15, flags: ['rebuild_mode'] },
                        explanation: {
                            immediate: 'Painful short term. Clear plan forward.',
                            delayed: 'Young assets build up. 3-5 year timeline.',
                            economic: 'TIME: Accept short-term pain for long-term gain.'
                        }
                    }
                ],
                economicConcepts: {
                    'Commitment': 'Half-measures rarely succeed in NBA',
                    'Option Value': 'Keeping options open has limits'
                }
            },
            
            // CYCLE 2 CAP ROOM - Branches based on C1 choice
            cycle2_cap_contender_allin: {
                id: 'cap_c2_contender_allin',
                room: 'cap',
                title: 'Your Tax Bill: Year Two',
                context: 'Last cycle you entered the luxury tax. The bill just arrived: $35M. Your owner wants to know if this is sustainable.',
                scenario: 'Teams in the tax for multiple years face repeater penalties that grow dramatically.',
                question: 'Stay in tax or find a way out?',
                capSummary: { currentSalary: '$178M', capLine: '$141M', taxLine: '$171M' },
                options: [
                    {
                        id: 'cap_c2_allin_stay',
                        text: 'Stay the Course  Pay Again',
                        rationale: 'We\'re committed. Can\'t back out now.',
                        effects: { taxExposure: 20, capFlexibility: -15, reputationPlayers: 10, flags: ['repeater_track'] },
                        explanation: {
                            immediate: 'Tax bill grows to $55M. Players see commitment.',
                            delayed: 'Repeater tax looms in 2 more years. Even costlier.',
                            economic: 'ESCALATION: Tax penalties increase each consecutive year.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'cap_c2_allin_cut',
                        text: 'Get Under  Trade Salary',
                        rationale: 'Escape before repeater kicks in.',
                        effects: { capFlexibility: 10, rosterQuality: -8, taxExposure: -15, reputationPlayers: -12 },
                        explanation: {
                            immediate: 'Roster takes a hit. Players feel betrayed.',
                            delayed: 'Avoided repeater tax trap. More sustainable.',
                            economic: 'SUNK COST: Last year\'s tax is gone. Don\'t let it trap you.'
                        }
                    }
                ],
                economicConcepts: {
                    'Progressive Tax': 'Tax rate increases with each dollar over the line',
                    'Repeater Penalty': 'Multiple years trigger even higher rates'
                }
            },
            
            cycle2_cap_contender_patient: {
                id: 'cap_c2_contender_patient',
                room: 'cap',
                title: 'Your Flexibility: Time to Use It',
                context: 'Last cycle you stayed under the tax. You have $42M in cap spacerare for a competitive team. Agents are calling.',
                scenario: 'The 2019 Clippers with cap space: flexibility to add Paul George and Kawhi.',
                question: 'Use your cap space or keep waiting?',
                capSummary: { currentSalary: '$127M', capLine: '$141M', taxLine: '$171M' },
                options: [
                    {
                        id: 'cap_c2_patient_strike',
                        text: 'Strike Now  Sign Star',
                        rationale: 'This is what we saved for.',
                        effects: { rosterQuality: 18, capFlexibility: -30, optionality: -20, reputationAgents: 15 },
                        explanation: {
                            immediate: 'Major signing. Instant contender. Space gone.',
                            delayed: 'Patience paid off. But now committed for years.',
                            economic: 'OPTION VALUE: Flexibility used at best moment.'
                        }
                    },
                    {
                        id: 'cap_c2_patient_wait',
                        text: 'Keep Waiting  Better Deal Coming',
                        rationale: 'Don\'t settle. Perfect move is out there.',
                        effects: { capFlexibility: 5, mediaNarrative: -10, reputationAgents: -5 },
                        explanation: {
                            immediate: 'Fans frustrated. Agents wonder if you\'ll ever act.',
                            delayed: 'Flexibility kept, but clock is ticking.',
                            economic: 'OPTION VALUE: Keeping flexibility too long has costs.'
                        }
                    }
                ],
                economicConcepts: {
                    'Option Value': 'Flexibility has value but must be used eventually',
                    'Timing': 'When to use resources vs when to wait'
                }
            },
            
            cycle2_cap_contender_balanced: {
                id: 'cap_c2_contender_balanced',
                room: 'cap',
                title: 'Your Exception Strategy: Working?',
                context: 'Last cycle you used your Mid-Level Exception. Moderate spend, moderate results. Your cap expert says you\'re at a decision point.',
                scenario: 'Teams that stay just under the tax often lack championship upside.',
                question: 'Go bigger or stay conservative?',
                capSummary: { currentSalary: '$155M', capLine: '$141M', taxLine: '$171M' },
                options: [
                    {
                        id: 'cap_c2_balanced_jump',
                        text: 'Jump In  Enter the Tax',
                        rationale: 'Time to commit. Make a real push.',
                        effects: { rosterQuality: 10, capFlexibility: -15, taxExposure: 20, flags: ['tax_payer'] },
                        explanation: {
                            immediate: 'Real upgrade. Tax bill starts.',
                            delayed: 'Crossed the line. Must decide if sustainable.',
                            economic: 'THRESHOLD: Tax line is a clear commitment point.'
                        }
                    },
                    {
                        id: 'cap_c2_balanced_stay',
                        text: 'Stay Conservative',
                        rationale: 'Our approach is sustainable.',
                        effects: { capFlexibility: 5, rosterQuality: 2, mediaNarrative: -8 },
                        explanation: {
                            immediate: 'Financially safe. Competitively limited.',
                            delayed: 'Conservative play rarely wins titles.',
                            economic: 'RISK: Safety over upside.'
                        }
                    }
                ],
                economicConcepts: {
                    'Tax Threshold': 'Clear commitment line in NBA salary structure',
                    'Sustainable Advantage': 'Can you maintain spending over years?'
                }
            },
            
            // YOUNG FRANCHISE BRANCHING - Cycle 2
            cycle2_eval_young_allin: {
                id: 'eval_c2_young_allin',
                room: 'eval',
                title: 'Your Rookie: Breakout or Bust?',
                context: 'Last cycle you drafted the young star. Year 1 flashed potentialexciting highlights mixed with rookie mistakes. Do you build around him or hedge?',
                scenario: 'Teams that commit too early to young stars sometimes regret it (see: Sacramento)',
                question: 'Commit to your young star or stay flexible?',
                signals: [
                    { text: 'Rookie stats: Promising but inconsistent', confidence: 'mixed' },
                    { text: 'Development curve: Uncertain trajectory', confidence: 'noisy' },
                    { text: 'Trade offers: Teams interested in acquiring him', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c2_young_commit',
                        text: 'Commit  Build Around Him',
                        rationale: 'He\'s our future. Get him help.',
                        effects: { rosterQuality: 8, optionality: -15, trustIndex: 10, flags: ['committed_to_young_star'] },
                        explanation: {
                            immediate: 'Clear direction. Young star trusts the plan.',
                            delayed: 'Committed to his timeline. If he busts, years wasted.',
                            economic: 'COMMITMENT: Betting on uncertain trajectory.'
                        }
                    },
                    {
                        id: 'eval_c2_young_keep_flexible',
                        text: 'Stay Flexible  Don\'t Commit Yet',
                        rationale: 'Too early to know. Keep options open.',
                        effects: { optionality: 10, trustIndex: -5, mediaNarrative: -5 },
                        explanation: {
                            immediate: 'Preserved flexibility. Rookie questions commitment.',
                            delayed: 'Smart to wait, but relationships matter.',
                            economic: 'OPTION VALUE: Keeping flexibility has costs.'
                        }
                    }
                ],
                economicConcepts: {
                    'Information': 'More time reveals player quality',
                    'Commitment': 'When to bet on uncertain potential'
                }
            },
            
            cycle2_cap_young_allin: {
                id: 'cap_c2_young_allin',
                room: 'cap',
                title: 'Your Rookie Extension Decision',
                context: 'Last cycle you spent to add pieces around your rookie. Now extension talks are starting. Lock him in early or wait to see more?',
                scenario: 'Early extensions are riskypay now or wait and pay more (or less) later.',
                question: 'Extend early or wait for leverage?',
                capSummary: { currentSalary: '$98M', capLine: '$141M', taxLine: '$171M' },
                options: [
                    {
                        id: 'cap_c2_young_extend',
                        text: 'Extend Early  Lock In',
                        rationale: 'Show commitment. Control cost.',
                        effects: { capFlexibility: -20, reputationPlayers: 15, trustIndex: 10 },
                        explanation: {
                            immediate: 'Star secured. Cap space gone.',
                            delayed: 'Either great value or terrible overpay.',
                            economic: 'UNCERTAINTY: Pay before knowing true value.'
                        }
                    },
                    {
                        id: 'cap_c2_young_wait',
                        text: 'Wait  Maximize Info',
                        rationale: 'See more before committing.',
                        effects: { capFlexibility: 10, reputationPlayers: -10, riskExposure: 10 },
                        explanation: {
                            immediate: 'Flexibility kept. Player relationship strained.',
                            delayed: 'Might pay more later, or dodge a bullet.',
                            economic: 'INFORMATION VALUE: Wait to learn more.'
                        }
                    }
                ],
                economicConcepts: {
                    'Information': 'Time reveals value',
                    'Price': 'Early commitment vs waiting to know'
                }
            },
            
            // MESSY FRANCHISE BRANCHING - Cycle 2  
            cycle2_eval_messy_allin: {
                id: 'eval_c2_messy_allin',
                room: 'eval',
                title: 'Your Win-Now Bet: Is It Working?',
                context: 'Last cycle you tried to jump into contention with veteran moves. Results are mixedsome wins, but not looking like a real threat. Continue or pivot?',
                scenario: 'Play-in teams that go win-now often end up stuck in mediocrity.',
                question: 'Keep pushing or reset?',
                signals: [
                    { text: 'Vets producing: Okay but not elite', confidence: 'high' },
                    { text: 'Ceiling: Play-in, not contender', confidence: 'high' },
                    { text: 'Asset cost: Significant, not fatal', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c2_messy_push',
                        text: 'Keep Pushing  Add More',
                        rationale: 'We\'re close. One more piece.',
                        effects: { rosterQuality: 8, optionality: -15, capFlexibility: -10 },
                        explanation: {
                            immediate: 'Incremental improvement. Asset cost grows.',
                            delayed: 'Doubling down on mediocrity likely.',
                            economic: 'ESCALATION: Already invested, keep going.'
                        }
                    },
                    {
                        id: 'eval_c2_messy_reset',
                        text: 'Reset  Admit It\'s Not Working',
                        rationale: 'Cut losses. Start real rebuild.',
                        effects: { rosterQuality: -12, optionality: 20, capFlexibility: 15, flags: ['rebuild_mode'] },
                        explanation: {
                            immediate: 'Painful admission. Clear direction finally.',
                            delayed: 'Real rebuild begins. 3-5 year timeline.',
                            economic: 'SUNK COST: Accept the loss and move on.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Don\'t let past investment force bad future choices',
                    'Escalation': 'Tendency to keep investing in failing strategy'
                }
            },
            
            cycle2_cap_messy_allin: {
                id: 'cap_c2_messy_allin',
                room: 'cap',
                title: 'Your Bad Contract Problem',
                context: 'Last cycle you signed a veteran. He\'s underperforming badly. The contract is an anchor. Trade him at a loss or wait it out?',
                scenario: 'Bad contracts force hard choicespay to dump or ride it out.',
                question: 'Pay to fix the mistake or accept it?',
                capSummary: { currentSalary: '$138M', capLine: '$141M', taxLine: '$171M' },
                options: [
                    {
                        id: 'cap_c2_messy_dump',
                        text: 'Pay to Dump  Clear the Space',
                        rationale: 'Cut our losses. Get it over with.',
                        effects: { capFlexibility: 15, optionality: -10, mediaNarrative: -10 },
                        explanation: {
                            immediate: 'Assets spent to clear bad contract. Cap opens.',
                            delayed: 'Expensive but creates flexibility.',
                            economic: 'SUNK COST: Paying to undo past mistake.'
                        }
                    },
                    {
                        id: 'cap_c2_messy_wait',
                        text: 'Wait It Out  Preserve Assets',
                        rationale: 'Don\'t throw good money after bad.',
                        effects: { capFlexibility: -5, optionality: 5 },
                        explanation: {
                            immediate: 'Stuck with bad contract. Assets preserved.',
                            delayed: 'Patient approach saves assets.',
                            economic: 'SUNK COST: Don\'t compound the error.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Past mistake shouldn\'t dictate future spending',
                    'Cost': 'Pay now to fix or wait for time'
                }
            },

            // ================================
            // CYCLE 3 SCENARIOS - HIGH PRESSURE
            // ================================

            cycle3_eval_contender: {
                id: 'eval_c3_contender', room: 'eval',
                title: 'Championship Window Closing',
                context: 'Your star is declining. This is likely the last realistic championship shot. All-in or pivot?',
                scenario: '2016 Cavs: LeBron at 31, championship-or-bust mentality.',
                question: 'Mortgage the future or accept the window closed?',
                signals: [
                    { text: 'Star performance: Clear decline in metrics', confidence: 'high' },
                    { text: 'Championship odds: 15% with current roster', confidence: 'high' },
                    { text: 'Cost to upgrade: Massive asset drain', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c3_contender_final_push',
                        text: 'Trust the Data  Final All-In Push',
                        rationale: 'Last chance. Empty the war chest.',
                        effects: { rosterQuality: 20, optionality: -30, capFlexibility: -25, riskExposure: 20, flags: ['championship_or_bust'] },
                        explanation: {
                            immediate: 'Maximum championship odds. No future left.',
                            delayed: 'If you fail, rebuild from scratch. No assets.',
                            economic: 'IRREVERSIBILITY: Point of no return. TIME PREFERENCE: All present, no future.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'eval_c3_contender_accept',
                        text: 'Override  Accept Window Closed',
                        rationale: 'Pivot to future. Star era is over.',
                        effects: { rosterQuality: -15, optionality: 25, reputationPlayers: -20, mediaNarrative: -15, flags: ['rebuild_initiated'] },
                        explanation: {
                            immediate: 'Star furious. Media calls you a quitter.',
                            delayed: 'Positioned for next era. Painful transition.',
                            economic: 'SUNK COST: Walking away from investment. OPTION VALUE: Preserving future.'
                        }
                    },
                    {
                        id: 'eval_c3_contender_moderate',
                        text: 'Wait for Information  Moderate Add',
                        rationale: 'Small upgrades. Hedge the bet.',
                        effects: { rosterQuality: 8, optionality: -10, capFlexibility: -10 },
                        explanation: {
                            immediate: 'Incremental improvement. Unlikely to win.',
                            delayed: 'Half-measures rarely satisfy anyone.',
                            economic: 'COMPROMISE: Split difference, split results.'
                        }
                    }
                ],
                economicConcepts: {
                    'Irreversibility': 'Cannot undo this commitment',
                    'Sunk Cost': 'Past investment shouldn\'t dictate future'
                }
            },

            cycle3_eval_young: {
                id: 'eval_c3_young', room: 'eval',
                title: 'Championship Timeline Decision',
                context: 'Young core developing well. Rush to compete or stay patient?',
                scenario: 'Grizzlies 2022: Rush young core or continue building?',
                question: 'Accelerate timeline or let it develop?',
                signals: [
                    { text: 'Core development: Ahead of schedule', confidence: 'high' },
                    { text: 'Competitive window: Could open early', confidence: 'mixed' },
                    { text: 'Cost to accelerate: Moderate to high', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c3_young_accelerate',
                        text: 'Trust Data  Accelerate Timeline',
                        rationale: 'They\'re ready now. Go compete.',
                        effects: { rosterQuality: 15, optionality: -15, riskExposure: 15, reputationPlayers: 15 },
                        explanation: {
                            immediate: 'Playoff push. Players energized.',
                            delayed: 'If premature, wasted opportunity. If right, early success.',
                            economic: 'TIME PREFERENCE: Present over future. RISK: High variance outcome.'
                        }
                    },
                    {
                        id: 'eval_c3_young_patient',
                        text: 'Override  Stay Patient',
                        rationale: 'One more year of development.',
                        effects: { optionality: 15, reputationPlayers: -8, rosterQuality: 5 },
                        explanation: {
                            immediate: 'Players want to compete. Frustration building.',
                            delayed: 'Extra year of growth. Stronger foundation.',
                            economic: 'OPTION VALUE: Patience preserves flexibility.'
                        }
                    },
                    {
                        id: 'eval_c3_young_tactical',
                        text: 'Conditional  Tactical Additions',
                        rationale: 'Small moves to test readiness.',
                        effects: { rosterQuality: 8, optionality: -5, capFlexibility: -8 },
                        explanation: {
                            immediate: 'Measured approach. See how they handle pressure.',
                            delayed: 'Information-gathering year.',
                            economic: 'INFORMATION: Learn through experience.'
                        }
                    }
                ],
                economicConcepts: {
                    'Time Preference': 'When to harvest investment',
                    'Option Value': 'Value of waiting'
                }
            },

            cycle3_eval_messy: {
                id: 'eval_c3_messy', room: 'eval',
                title: 'Validation Moment',
                context: 'Rebuild strategy being tested. Assets accumulating but no clear star yet.',
                scenario: 'OKC 2023: Mountains of picks, but when to use them?',
                question: 'Stay patient or start consolidating?',
                signals: [
                    { text: 'Draft assets: Significant accumulation', confidence: 'high' },
                    { text: 'Young talent: Promising but unproven', confidence: 'mixed' },
                    { text: 'Market opportunities: Some stars available', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c3_messy_consolidate',
                        text: 'Trust Math  Consolidate Assets',
                        rationale: 'Trade picks for proven star.',
                        effects: { rosterQuality: 18, optionality: -25, trustIndex: 10 },
                        explanation: {
                            immediate: 'Star acquired. Timeline accelerated.',
                            delayed: 'Burned assets. Better work out.',
                            economic: 'CONCENTRATION: Betting on one outcome.'
                        }
                    },
                    {
                        id: 'eval_c3_messy_continue',
                        text: 'Override  Continue Accumulating',
                        rationale: 'Not the right opportunity yet.',
                        effects: { optionality: 15, mediaNarrative: -10, trustIndex: -5 },
                        explanation: {
                            immediate: 'Media questions strategy. Patience wearing thin.',
                            delayed: 'More assets, more options. When is enough?',
                            economic: 'OPTION VALUE: Preserving flexibility. OPPORTUNITY COST: Not competing.'
                        }
                    },
                    {
                        id: 'eval_c3_messy_partial',
                        text: 'Conditional  Partial Consolidation',
                        rationale: 'Use some picks, keep some.',
                        effects: { rosterQuality: 10, optionality: -8 },
                        explanation: {
                            immediate: 'Balanced approach. Upgrade without going all-in.',
                            delayed: 'Hedged position.',
                            economic: 'PORTFOLIO: Diversified approach.'
                        }
                    }
                ],
                economicConcepts: {
                    'Option Value': 'When to exercise your options',
                    'Opportunity Cost': 'Cost of waiting vs. acting'
                }
            },

            cycle3_cap_contender: {
                id: 'cap_c3_contender', room: 'cap',
                title: 'Luxury Tax Crisis',
                context: 'Deep in repeater tax. Ownership considering selling. Financial crisis looming.',
                scenario: 'Warriors 2020: Repeater tax + injuries + ownership pressure.',
                question: 'Stay the course or financial reset?',
                capSummary: { currentSalary: '$195M', capLine: '$136M', taxLine: '$165M', taxBill: '$85M' },
                options: [
                    {
                        id: 'cap_c3_contender_pay',
                        text: 'Commit  Pay Whatever It Takes',
                        rationale: 'Ownership committed. Championship worth it.',
                        beforeAfter: { taxBill: { before: '$85M', after: '$120M+' }, years: { before: '1 more', after: '3+ more' } },
                        effects: { taxExposure: 60, capFlexibility: -35, optionalityCap: 30, reputationPlayers: 15 },
                        explanation: {
                            immediate: 'Players see commitment. Massive tax bill.',
                            delayed: 'Financial flexibility destroyed for years.',
                            economic: 'SUNK COST: Escalating commitment. IRREVERSIBILITY: Can\'t get out.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'cap_c3_contender_reset',
                        text: 'Cut Losses  Financial Reset',
                        rationale: 'Unsustainable. Reset the cap.',
                        beforeAfter: { taxBill: { before: '$85M', after: '$0' }, roster: { before: 'Contender', after: 'Gutted' } },
                        effects: { taxExposure: -60, capFlexibility: 30, rosterQuality: -25, reputationPlayers: -25 },
                        explanation: {
                            immediate: 'Mass exodus. Tear it down.',
                            delayed: 'Financial health restored. Rebuild begins.',
                            economic: 'SUNK COST: Walking away. OPTION VALUE: Future flexibility.'
                        }
                    },
                    {
                        id: 'cap_c3_contender_compromise',
                        text: 'Hedge  Strategic Cuts',
                        rationale: 'Reduce tax but stay competitive.',
                        beforeAfter: { taxBill: { before: '$85M', after: '$45M' }, roster: { before: 'Deep', after: 'Thin' } },
                        effects: { taxExposure: -25, capFlexibility: 10, rosterQuality: -10 },
                        explanation: {
                            immediate: 'Reduced bill. Weaker roster.',
                            delayed: 'Bought time but problem persists.',
                            economic: 'COMPROMISE: Split the difference.'
                        }
                    }
                ],
                economicConcepts: {
                    'Escalation of Commitment': 'Doubling down on failing strategy',
                    'Sunk Cost': 'Past spending shouldn\'t determine future'
                }
            },

            cycle3_cap_young: {
                id: 'cap_c3_young', room: 'cap',
                title: 'Max Contract Decisions',
                context: 'Multiple young players eligible for max extensions. Can\'t afford everyone.',
                scenario: 'Celtics with Brown/Tatum: Who gets paid, who gets traded?',
                question: 'Who gets the max money?',
                capSummary: { currentSalary: '$118M', capLine: '$136M', maxSlots: '2 available', candidates: '3 deserving' },
                options: [
                    {
                        id: 'cap_c3_young_both',
                        text: 'Commit  Max Both Best Players',
                        rationale: 'Keep the core together.',
                        beforeAfter: { capSpace: { before: '$18M', after: '$0' }, committed: { before: '3 years', after: '7 years' } },
                        effects: { capFlexibility: -30, rosterQuality: 12, reputationPlayers: 18, trustIndex: 20, optionality: -20 },
                        explanation: {
                            immediate: 'Core locked in. No flexibility left.',
                            delayed: 'This IS your team for 5+ years.',
                            economic: 'IRREVERSIBILITY: All-in on these players. OPPORTUNITY COST: Other options closed.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'cap_c3_young_trade',
                        text: 'Preserve Options  Trade Third Player',
                        rationale: 'Get value before he walks.',
                        beforeAfter: { capSpace: { before: '$18M', after: '$30M' }, assets: { before: '0 picks', after: '2 picks + prospect' } },
                        effects: { capFlexibility: 15, optionality: 15, rosterQuality: -8, reputationPlayers: -10 },
                        explanation: {
                            immediate: 'Painful move. Got assets back.',
                            delayed: 'Flexibility preserved. Did you trade the wrong guy?',
                            economic: 'OPPORTUNITY COST: Player value vs. cap space.'
                        }
                    },
                    {
                        id: 'cap_c3_young_wait',
                        text: 'Wait for Information  Delay Decision',
                        rationale: 'See who develops more.',
                        beforeAfter: { risk: { before: 'Controlled', after: 'High' } },
                        effects: { optionality: 10, reputationPlayers: -12, trustIndex: -10, capFlexibility: -5 },
                        explanation: {
                            immediate: 'Players frustrated. Uncertainty reigns.',
                            delayed: 'Might lose someone for nothing.',
                            economic: 'INFORMATION: Waiting reveals more. RISK: Delay has costs.'
                        }
                    }
                ],
                economicConcepts: {
                    'Opportunity Cost': 'Every yes is multiple nos',
                    'Irreversibility': 'Max contracts are near-permanent'
                }
            },

            cycle3_cap_messy: {
                id: 'cap_c3_messy', room: 'cap',
                title: 'Cap Space Decision Point',
                context: 'Significant cap space opening. Use it or preserve it?',
                scenario: 'Knicks perpetual cap space: Use it wisely or waste it?',
                question: 'Spend the space or stay patient?',
                capSummary: { currentSalary: '$88M', capLine: '$136M', availableSpace: '$48M' },
                options: [
                    {
                        id: 'cap_c3_messy_spend',
                        text: 'Commit  Spend Aggressively',
                        rationale: 'Cap space is for using, not preserving.',
                        beforeAfter: { capSpace: { before: '$48M', after: '$3M' }, roster: { before: 'Young', after: 'Veteran-laden' } },
                        effects: { capFlexibility: -35, rosterQuality: 12, optionality: -15, mediaNarrative: 10 },
                        explanation: {
                            immediate: 'Big splash. Media loves it.',
                            delayed: 'Hope you picked the right guys.',
                            economic: 'OPPORTUNITY COST: Can\'t use twice. TIME PREFERENCE: Act now.'
                        }
                    },
                    {
                        id: 'cap_c3_messy_preserve',
                        text: 'Preserve Options  Stay Patient',
                        rationale: 'Wrong free agent class. Wait.',
                        beforeAfter: { capSpace: { before: '$48M', after: '$48M' } },
                        effects: { optionality: 20, mediaNarrative: -15, trustIndex: -8 },
                        explanation: {
                            immediate: 'Media: "Another wasted year." Fans angry.',
                            delayed: 'Space preserved for better opportunity.',
                            economic: 'OPTION VALUE: Flexibility has value. PATIENCE: Waiting for right deal.'
                        }
                    },
                    {
                        id: 'cap_c3_messy_selective',
                        text: 'Hedge  Selective Additions',
                        rationale: 'Use some space, keep some.',
                        beforeAfter: { capSpace: { before: '$48M', after: '$25M' } },
                        effects: { capFlexibility: -15, rosterQuality: 6, optionality: 8 },
                        explanation: {
                            immediate: 'Balanced approach. Modest upgrades.',
                            delayed: 'Preserved some flexibility.',
                            economic: 'PORTFOLIO: Diversified approach.'
                        }
                    }
                ],
                economicConcepts: {
                    'Option Value': 'Cap space as a strategic resource',
                    'Opportunity Cost': 'Every dollar spent is a dollar unavailable'
                }
            },

            cycle3_relationships_contender: {
                id: 'rel_c3_contender', room: 'relationships',
                title: 'Star Player Ultimatum',
                context: 'Your aging star demands his friend be signed or he requests a trade.',
                scenario: 'LeBron/Lakers: Pressure to sign specific players.',
                question: 'Capitulate or hold firm?',
                dialogue: { speaker: 'Star Player (Private Meeting)', text: '"I carried this franchise. Sign my guy or trade me. Your choice."' },
                relationshipTemp: 'hostile',
                options: [
                    {
                        id: 'rel_c3_contender_sign',
                        text: 'Maintain Relationship  Sign His Friend',
                        rationale: 'Can\'t lose the star.',
                        effects: { reputationPlayers: 15, trustIndex: 10, capFlexibility: -15, rosterQuality: -5, reputationLeague: -10 },
                        explanation: {
                            immediate: 'Star happy. League views you as weak.',
                            delayed: 'Set precedent. Players dictate roster.',
                            economic: 'BARGAINING POWER: Star has all leverage. PRINCIPAL-AGENT: Misaligned incentives.'
                        },
                        memory: 'League knows: Stars control your decisions.',
                        delayedWarning: 'Other players will make similar demands.'
                    },
                    {
                        id: 'rel_c3_contender_refuse',
                        text: 'Hold Ground  Refuse and Risk Trade',
                        rationale: 'You run this team, not players.',
                        effects: { reputationPlayers: -20, reputationLeague: 15, trustIndex: -15, riskExposure: 25, flags: ['star_demands_trade'] },
                        explanation: {
                            immediate: 'Standoff. Trade rumors explode.',
                            delayed: 'Might lose star for nothing. But you kept control.',
                            economic: 'BARGAINING POWER: Called his bluff. RISK: High variance outcome.'
                        },
                        memory: 'League knows: You don\'t bend to threats.'
                    },
                    {
                        id: 'rel_c3_contender_compromise',
                        text: 'Negotiate  Different Role for Friend',
                        rationale: 'Sign him but not as star wants.',
                        effects: { reputationPlayers: 5, capFlexibility: -8, rosterQuality: 0 },
                        explanation: {
                            immediate: 'Creative solution. Star grudgingly accepts.',
                            delayed: 'Tension remains but managed.',
                            economic: 'BARGAINING: Found middle ground.'
                        }
                    }
                ],
                economicConcepts: {
                    'Bargaining Power': 'Who has leverage in negotiation',
                    'Principal-Agent Problem': 'Player interests vs. team interests'
                }
            },

            cycle3_relationships_young: {
                id: 'rel_c3_young', room: 'relationships',
                title: 'Extension Negotiation Breakdown',
                context: 'Your rising star\'s agent is playing hardball. Offensive demands and threats.',
                scenario: 'Towns/Wolves: Difficult extension negotiations.',
                question: 'Meet demands or prepare for trade?',
                dialogue: { speaker: 'Agent (Via Media)', text: '"My client deserves a super-max. If they don\'t get it, we\'ll explore other options in free agency."' },
                relationshipTemp: 'hostile',
                options: [
                    {
                        id: 'rel_c3_young_supermax',
                        text: 'Negotiate  Offer Supermax',
                        rationale: 'Can\'t lose him. Pay the price.',
                        effects: { capFlexibility: -35, reputationPlayers: 20, trustIndex: 15, rosterQuality: 10, optionalityCap: 50 },
                        explanation: {
                            immediate: 'Star locked in. Massive financial commitment.',
                            delayed: 'This contract defines your decade.',
                            economic: 'IRREVERSIBILITY: Cannot undo. OPPORTUNITY COST: All other options closed.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'rel_c3_young_trade',
                        text: 'Hold Ground  Trade Before Free Agency',
                        rationale: 'Too expensive. Get value now.',
                        effects: { rosterQuality: -15, optionality: 20, capFlexibility: 20, reputationPlayers: -20, mediaNarrative: -20 },
                        explanation: {
                            immediate: 'Shocking move. Fans outraged.',
                            delayed: 'Flexibility restored. Did you give up too early?',
                            economic: 'SUNK COST: Walking away. OPPORTUNITY COST: His future value vs. assets.'
                        }
                    },
                    {
                        id: 'rel_c3_young_standard_max',
                        text: 'Negotiate  Standard Max Only',
                        rationale: 'Max yes, super-max no.',
                        effects: { capFlexibility: -25, reputationPlayers: 5, trustIndex: -5, optionality: -15, riskExposure: 15 },
                        explanation: {
                            immediate: 'Agent unhappy. Player taking meeting.',
                            delayed: 'Risk of losing him. But set boundaries.',
                            economic: 'BARGAINING: Held position. RISK: He might leave.'
                        }
                    }
                ],
                economicConcepts: {
                    'Irreversibility': 'Super-max is permanent burden',
                    'Sunk Cost': 'Development investment shouldn\'t force overpay'
                }
            },

            cycle3_relationships_messy: {
                id: 'rel_c3_messy', room: 'relationships',
                title: 'Coach-Front Office Conflict',
                context: 'Coach wants to win now. You\'re building for future. Public disagreement brewing.',
                scenario: 'Thibs/Wolves: Coach-FO timeline misalignment.',
                question: 'Support coach or stay the course?',
                dialogue: { speaker: 'Head Coach (Team Meeting)', text: '"You\'re asking me to develop kids. I was hired to win. Make up your mind what this franchise wants."' },
                relationshipTemp: 'tense',
                options: [
                    {
                        id: 'rel_c3_messy_coach',
                        text: 'Maintain Relationship  Support Coach Timeline',
                        rationale: 'Make win-now moves to align.',
                        effects: { rosterQuality: 8, optionality: -15, reputationLeague: 5, trustIndex: -8, mediaNarrative: 5 },
                        explanation: {
                            immediate: 'Coach happy. Accelerated timeline.',
                            delayed: 'Abandoning patient strategy. Worth it?',
                            economic: 'TIME PREFERENCE: Short-term over long-term. CONSISTENCY: Strategy changed mid-stream.'
                        }
                    },
                    {
                        id: 'rel_c3_messy_fire',
                        text: 'Hold Ground  Fire Coach',
                        rationale: 'Coach doesn\'t fit vision.',
                        effects: { reputationLeague: -10, trustIndex: -10, mediaNarrative: -10, optionality: 10, rosterQuality: -5 },
                        explanation: {
                            immediate: 'Coach fired. Media: "Dysfunction." Players confused.',
                            delayed: 'Back on patient path. But instability.',
                            economic: 'SUNK COST: Coach salary wasted. COMMITMENT: Stayed with strategy.'
                        }
                    },
                    {
                        id: 'rel_c3_messy_compromise',
                        text: 'Negotiate  Hybrid Approach',
                        rationale: 'Small moves to placate coach.',
                        effects: { rosterQuality: 3, optionality: -5, trustIndex: 5 },
                        explanation: {
                            immediate: 'Uneasy truce. Neither fully satisfied.',
                            delayed: 'Managed conflict without resolution.',
                            economic: 'COMPROMISE: Split difference.'
                        }
                    }
                ],
                economicConcepts: {
                    'Time Preference': 'Present vs. future value',
                    'Commitment': 'Staying with strategy vs. pivoting'
                }
            },

            cycle3_risk_contender: {
                id: 'risk_c3_contender', room: 'risk',
                title: 'Playoff Load Management Crisis',
                context: 'Star playing through injury in playoffs. Doctors split on severity. Championship in reach.',
                scenario: 'Kawhi 2019 Finals: Playing hurt for championship.',
                question: 'Risk career for championship?',
                outcomeScenarios: {
                    likely: { label: 'Base Case', outcome: 'Gets through playoffs, needs surgery after', impact: 'Ring + long recovery' },
                    worst: { label: 'Worst Case', outcome: 'Catastrophic injury mid-series', impact: 'Career in jeopardy, no ring' },
                    best: { label: 'Best Case', outcome: 'Wins championship, injury not serious', impact: 'Ring + healthy return' }
                },
                riskLevel: 85,
                options: [
                    {
                        id: 'risk_c3_contender_play',
                        text: 'Concentrate Bet  Play Through It',
                        rationale: 'Championship trumps everything.',
                        variance: 'Extreme',
                        effects: { rosterQuality: 15, riskExposure: 35, injuryFragility: 30, reputationPlayers: 20 },
                        explanation: {
                            immediate: 'Star battles through pain. Heroic.',
                            delayed: 'Career-altering injury risk. Championship or catastrophe.',
                            economic: 'TAIL RISK: Low probability disaster. EXPECTED VALUE: High variance gamble.'
                        },
                        varianceWarning: 'EXTREME RISK: Potential career-ending injury.'
                    },
                    {
                        id: 'risk_c3_contender_shut_down',
                        text: 'Buy Insurance  Shut Him Down',
                        rationale: 'Player\'s career over rings.',
                        variance: 'Low',
                        effects: { rosterQuality: -20, riskExposure: -25, reputationPlayers: 15, mediaNarrative: -20 },
                        explanation: {
                            immediate: 'Championship gone. Media: "Soft." Player appreciates care.',
                            delayed: 'Star healthy for future. This year sacrificed.',
                            economic: 'RISK MANAGEMENT: Avoided catastrophe. OPPORTUNITY COST: Championship chance.'
                        }
                    },
                    {
                        id: 'risk_c3_contender_limited',
                        text: 'Diversify  Severely Limited Minutes',
                        rationale: 'Spot minutes only. Manage risk.',
                        variance: 'Moderate',
                        effects: { rosterQuality: -5, riskExposure: 10, injuryFragility: 10 },
                        explanation: {
                            immediate: 'Reduced impact. Championship odds plummet.',
                            delayed: 'Tried to have both. Got neither?',
                            economic: 'HEDGING: Split difference. MODERATE: Outcomes.'
                        }
                    }
                ],
                economicConcepts: {
                    'Tail Risk': 'Catastrophic low-probability events',
                    'Expected Value': 'Probability-weighted calculation'
                }
            },

            cycle3_risk_young: {
                id: 'risk_c3_young', room: 'risk',
                title: 'Trade Asset Consolidation',
                context: 'Multiple trade scenarios to consolidate picks into star. Which package?',
                scenario: 'Thunder decision point: When to cash in picks?',
                question: 'Which star bet to make?',
                outcomeScenarios: {
                    likely: { label: 'Base Case', outcome: 'Star solid but not elite', impact: 'Decent but not transformative' },
                    worst: { label: 'Worst Case', outcome: 'Star doesn\'t fit/busts', impact: 'Assets wasted' },
                    best: { label: 'Best Case', outcome: 'Star is franchise player', impact: 'Title contender' }
                },
                riskLevel: 70,
                options: [
                    {
                        id: 'risk_c3_young_proven',
                        text: 'Diversify  Target Proven All-Star',
                        rationale: 'Known commodity. Lower ceiling, lower risk.',
                        variance: 'Low',
                        effects: { rosterQuality: 15, riskExposure: -10, optionality: -20 },
                        explanation: {
                            immediate: 'Safe choice. Reliable production.',
                            delayed: 'Lower upside. Good not great.',
                            economic: 'RISK MANAGEMENT: Reduced variance. CEILING: Limited upside.'
                        }
                    },
                    {
                        id: 'risk_c3_young_upside',
                        text: 'Concentrate Bet  High-Upside Young Star',
                        rationale: 'Swing for MVP-level talent.',
                        variance: 'High',
                        effects: { rosterQuality: 10, riskExposure: 20, optionality: -20 },
                        explanation: {
                            immediate: 'Big bet on potential. High variance.',
                            delayed: 'Championship upside. But significant bust risk.',
                            economic: 'VARIANCE: Wide outcome range. UPSIDE: Max potential.'
                        },
                        varianceWarning: 'High bust risk. Player could flame out.'
                    },
                    {
                        id: 'risk_c3_young_wait',
                        text: 'Accept Exposure  Wait for Better Deal',
                        rationale: 'These aren\'t THE guys. Stay patient.',
                        variance: 'Moderate',
                        effects: { optionality: 15, mediaNarrative: -10, trustIndex: -10 },
                        explanation: {
                            immediate: 'Passed on opportunities. Pressure mounting.',
                            delayed: 'Preserved assets. When is right time?',
                            economic: 'OPTION VALUE: Waiting for optimal target. OPPORTUNITY COST: Not competing now.'
                        }
                    }
                ],
                economicConcepts: {
                    'Variance': 'Range of possible outcomes',
                    'Risk-Return Tradeoff': 'Higher risk, higher potential return'
                }
            },

            cycle3_risk_messy: {
                id: 'risk_c3_messy', room: 'risk',
                title: 'Tank or Compete Fork',
                context: 'Mediocre record. Fork in road: commit to tank or push for playoffs.',
                scenario: '2024 Bulls: Stuck in middle, need to choose direction.',
                question: 'Tank or compete?',
                outcomeScenarios: {
                    likely: { label: 'Tank Path', outcome: 'High pick, 2 more losing years', impact: 'Painful but prospects' },
                    worst: { label: 'Worst Case', outcome: 'Bad tank, mid picks', impact: 'Wasted years' },
                    best: { label: 'Compete Path', outcome: 'Surprise playoff run', impact: 'Culture + momentum' }
                },
                riskLevel: 60,
                options: [
                    {
                        id: 'risk_c3_messy_tank',
                        text: 'Accept Exposure  Full Tank',
                        rationale: 'Need top pick. Tear it down.',
                        variance: 'Moderate',
                        effects: { rosterQuality: -15, optionality: 25, trustIndex: -15, mediaNarrative: -15, flags: ['full_tank'] },
                        explanation: {
                            immediate: 'Blatant tank. Media/fans angry. Players quit.',
                            delayed: 'High pick secured. Culture damaged.',
                            economic: 'TIME PREFERENCE: Future over present. EXPECTED VALUE: Probability math.'
                        }
                    },
                    {
                        id: 'risk_c3_messy_compete',
                        text: 'Buy Insurance  Fight for Playoffs',
                        rationale: 'Culture matters. Compete.',
                        variance: 'High',
                        effects: { rosterQuality: 5, optionality: -10, trustIndex: 15, mediaNarrative: 10 },
                        explanation: {
                            immediate: 'Effort matters. Good culture.',
                            delayed: 'Likely miss playoffs AND draft pick. Treadmill.',
                            economic: 'TIME PREFERENCE: Present over future. RISK: Worst of both worlds.'
                        }
                    },
                    {
                        id: 'risk_c3_messy_evaluate',
                        text: 'Diversify  Let Season Decide',
                        rationale: 'Play it out organically.',
                        variance: 'Moderate',
                        effects: { optionality: 10 },
                        explanation: {
                            immediate: 'No clear direction. Outcome unclear.',
                            delayed: 'Avoided hard choice. Probably mediocre result.',
                            economic: 'OPTION VALUE: Preserved flexibility. VARIANCE: Uncertain outcome.'
                        }
                    }
                ],
                economicConcepts: {
                    'Expected Value': 'Probability-weighted outcomes',
                    'Time Preference': 'Present vs. future value'
                }
            },

            // ================================
            // EVENT-REACTIVE SCENARIOS
            // These appear in later cycles based on random event choices
            // ================================
            
            // If star got injured and you tanked
            cycle3_eval_star_return: {
                id: 'eval_c3_star_return',
                room: 'eval',
                title: 'Star Returns from Injury',
                context: 'Your star is cleared to play after ACL recovery. Last year you tanked after his injurynow you have a lottery pick AND your star back. Build around both or trade one?',
                scenario: 'Teams coming off tank years with returning stars face this choice.',
                question: 'How do you integrate the returning star?',
                signals: [
                    { text: 'Star: Eager but cautious after injury', confidence: 'high' },
                    { text: 'Rookie pick: High potential, needs reps', confidence: 'high' },
                    { text: 'Window: 2-3 years before star declines', confidence: 'medium' }
                ],
                options: [
                    {
                        id: 'return_build',
                        text: 'Build Championship Team Now',
                        rationale: 'Star is back. Add pieces. Go for it.',
                        effects: { rosterQuality: 20, optionality: -20, capFlexibility: -15, flags: ['all_in_post_injury'] },
                        explanation: {
                            immediate: 'All-in mode activated. Championship or bust.',
                            delayed: 'Star healthy? Win big. Reinjury? Disaster.',
                            economic: 'COMMITMENT after PATIENCE.'
                        }
                    },
                    {
                        id: 'return_patient',
                        text: 'Let Chemistry Develop',
                        rationale: 'Don\'t rush. Star + rookie need time.',
                        effects: { rosterQuality: 10, optionality: 10, trustIndex: 10 },
                        explanation: {
                            immediate: 'Patient approach. Lower ceiling, higher floor.',
                            delayed: 'Sustainable build. Less variance.',
                            economic: 'PATIENCE COMPOUNDED.'
                        }
                    }
                ],
                economicConcepts: {
                    'Path Dependency': 'Your tank created this choice'
                }
            },
            
            // ================================
            // CYCLE 4 SCENARIOS - LEGACY DEFINING
            // ================================

            cycle4_eval_contender: {
                id: 'eval_c4_contender', room: 'eval',
                title: 'Legacy vs. Future Final Decision',
                context: 'This is it. Last year of star\'s contract. Championship or bust. Future be damned?',
                scenario: '2020 Lakers: LeBron\'s final title window.',
                question: 'Burn everything for one more shot?',
                signals: [
                    { text: 'Star status: Final elite year likely', confidence: 'high' },
                    { text: 'Championship odds: 20% with max moves', confidence: 'high' },
                    { text: 'Future cost: Complete scorched earth', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c4_contender_scorched',
                        text: 'Trust the Data  Scorched Earth',
                        rationale: 'Every asset, every pick, every dollar. Now or never.',
                        effects: { rosterQuality: 25, optionality: -40, capFlexibility: -35, riskExposure: 30, flags: ['legacy_move'] },
                        explanation: {
                            immediate: 'Maximum championship odds. No tomorrow.',
                            delayed: 'Decade-long rebuild if you fail. Ring or ruins.',
                            economic: 'IRREVERSIBILITY: Point of absolute no return. ALL-IN: Complete commitment.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'eval_c4_contender_transition',
                        text: 'Override  Begin Transition',
                        rationale: 'Star era is over. Start the rebuild.',
                        effects: { rosterQuality: -20, optionality: 35, reputationPlayers: -25, mediaNarrative: -20 },
                        explanation: {
                            immediate: 'Star leaves bitter. Brutal media cycle.',
                            delayed: 'Positioned for next generation. Painful but necessary.',
                            economic: 'SUNK COST: Walked away from investment. TIME PREFERENCE: Future over glory.'
                        }
                    },
                    {
                        id: 'eval_c4_contender_balanced',
                        text: 'Wait for Information  Balanced Try',
                        rationale: 'Compete but don\'t mortgage everything.',
                        effects: { rosterQuality: 10, optionality: -15, capFlexibility: -15 },
                        explanation: {
                            immediate: 'Half-measure. Unlikely to win championship.',
                            delayed: 'Preserved something. Satisfied no one.',
                            economic: 'COMPROMISE: Hedged bet usually fails.'
                        }
                    }
                ],
                economicConcepts: {
                    'Irreversibility': 'Cannot undo this path',
                    'Time Preference': 'Glory now vs. future success'
                }
            },

            cycle4_eval_young: {
                id: 'eval_c4_young', room: 'eval',
                title: 'Championship Push or Patience',
                context: 'Your young core has arrived. Push for championship or one more year of patience?',
                scenario: 'Nuggets 2023: Jump from good to championship.',
                question: 'Go for it now or wait one more year?',
                signals: [
                    { text: 'Core readiness: Very strong, could be ready', confidence: 'mixed' },
                    { text: 'Championship window: Opening now', confidence: 'high' },
                    { text: 'One more year: Potentially even better', confidence: 'mixed' }
                ],
                options: [
                    {
                        id: 'eval_c4_young_push',
                        text: 'Trust Data  Championship Push',
                        rationale: 'They\'re ready. Strike while hot.',
                        effects: { rosterQuality: 20, optionality: -20, riskExposure: 15, reputationPlayers: 20 },
                        explanation: {
                            immediate: 'All-in on young core. They\'re energized.',
                            delayed: 'Window open. They must deliver.',
                            economic: 'TIME PREFERENCE: Capitalize on momentum. IRREVERSIBILITY: Committed now.'
                        }
                    },
                    {
                        id: 'eval_c4_young_patient',
                        text: 'Override  One More Year',
                        rationale: 'Almost there. Be patient.',
                        effects: { optionality: 20, reputationPlayers: -10, rosterQuality: 8 },
                        explanation: {
                            immediate: 'Players want to compete NOW. Frustration high.',
                            delayed: 'One more year of development. But did you miss the moment?',
                            economic: 'OPTION VALUE: Preserved flexibility. TIMING RISK: Windows can close unexpectedly.'
                        }
                    },
                    {
                        id: 'eval_c4_young_selective',
                        text: 'Conditional  Selective Upgrades',
                        rationale: 'Add pieces without going all-in.',
                        effects: { rosterQuality: 12, optionality: -10, capFlexibility: -12 },
                        explanation: {
                            immediate: 'Measured approach. Incremental improvement.',
                            delayed: 'Hedged position. Might miss championship.',
                            economic: 'RISK MANAGEMENT: Balanced approach.'
                        }
                    }
                ],
                economicConcepts: {
                    'Timing Risk': 'Windows open and close unpredictably',
                    'Option Value': 'When to exercise your call option'
                }
            },

            cycle4_eval_messy: {
                id: 'eval_c4_messy', room: 'eval',
                title: 'Rebuild Validation',
                context: 'Years of patience. Assets accumulated. Young players developing. Moment of truth.',
                scenario: 'OKC 2024: Finally ready to consolidate and compete?',
                question: 'Commit to the plan or keep waiting?',
                signals: [
                    { text: 'Asset accumulation: Maximum haul', confidence: 'high' },
                    { text: 'Young talent: Legitimate prospects', confidence: 'high' },
                    { text: 'Market opportunities: Stars available', confidence: 'high' }
                ],
                options: [
                    {
                        id: 'eval_c4_messy_execute',
                        text: 'Trust Math  Execute The Plan',
                        rationale: 'This is what we built for. Trade for star.',
                        effects: { rosterQuality: 25, optionality: -30, trustIndex: 20, mediaNarrative: 15 },
                        explanation: {
                            immediate: 'Years of patience pay off. Major consolidation.',
                            delayed: 'Bet the farm on this core. Must work.',
                            economic: 'COMMITMENT: Executing long-term strategy. IRREVERSIBILITY: Can\'t go back.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'eval_c4_messy_continue',
                        text: 'Override  Keep Accumulating',
                        rationale: 'Not the right star. Keep waiting.',
                        effects: { optionality: 20, mediaNarrative: -20, trustIndex: -15 },
                        explanation: {
                            immediate: 'Media: "When is enough?" Patience questioned.',
                            delayed: 'Still waiting. Forever process?',
                            economic: 'OPTION VALUE: Preserving flexibility. OPPORTUNITY COST: Not competing.'
                        }
                    },
                    {
                        id: 'eval_c4_messy_partial',
                        text: 'Conditional  Partial Execution',
                        rationale: 'Use some assets, keep some.',
                        effects: { rosterQuality: 15, optionality: -15 },
                        explanation: {
                            immediate: 'Hedged approach. Moderate upgrade.',
                            delayed: 'Half-in rarely wins championships.',
                            economic: 'COMPROMISE: Split difference.'
                        }
                    }
                ],
                economicConcepts: {
                    'Commitment': 'When to fully commit to strategy',
                    'Opportunity Cost': 'Cost of perpetual waiting'
                }
            },

            cycle4_cap_contender: {
                id: 'cap_c4_contender', room: 'cap',
                title: 'Financial Armageddon',
                context: 'Repeater tax bill astronomical. Ownership at breaking point. One last year or blow it up?',
                scenario: 'Warriors 2023: $200M+ tax bill decision.',
                question: 'Pay the ultimate price or surrender?',
                capSummary: { currentSalary: '$210M', capLine: '$136M', taxLine: '$165M', projectedTaxBill: '$150M+' },
                options: [
                    {
                        id: 'cap_c4_contender_ultimate',
                        text: 'Commit  Pay Ultimate Price',
                        rationale: 'Ownership writes the check. No regrets.',
                        beforeAfter: { taxBill: { before: '$150M', after: '$150M+' }, totalCost: { before: '$360M', after: '$360M+' } },
                        effects: { taxExposure: 80, capFlexibility: -40, rosterQuality: 8, reputationPlayers: 25, optionalityCap: 20 },
                        explanation: {
                            immediate: 'Historic financial commitment. Players in awe.',
                            delayed: 'Financial crater for decade. Hope it was worth it.',
                            economic: 'SUNK COST: Escalation to extreme. IRREVERSIBILITY: Financial ruin or glory.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'cap_c4_contender_surrender',
                        text: 'Cut Losses  Complete Teardown',
                        rationale: 'Unsustainable. Start over.',
                        beforeAfter: { taxBill: { before: '$150M', after: '$0' }, timeline: { before: 'Now', after: '5+ year rebuild' } },
                        effects: { taxExposure: -70, capFlexibility: 40, rosterQuality: -35, reputationPlayers: -30, mediaNarrative: -25 },
                        explanation: {
                            immediate: 'Everything sold. Complete reset.',
                            delayed: 'Financial health restored. Decade to compete again.',
                            economic: 'SUNK COST: Massive write-off. OPTION VALUE: Future flexibility.'
                        }
                    },
                    {
                        id: 'cap_c4_contender_retool',
                        text: 'Hedge  Expensive Retool',
                        rationale: 'Keep some pieces, shed others.',
                        beforeAfter: { taxBill: { before: '$150M', after: '$60M' } },
                        effects: { taxExposure: -40, capFlexibility: 15, rosterQuality: -15 },
                        explanation: {
                            immediate: 'Painful cuts. Competitive but diminished.',
                            delayed: 'Extended mediocrity likely.',
                            economic: 'COMPROMISE: Avoided extremes, achieved mediocrity.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Escalation to extreme conclusion',
                    'Irreversibility': 'Financial commitments are permanent'
                }
            },

            cycle4_cap_young: {
                id: 'cap_c4_young', room: 'cap',
                title: 'Core Lock-In Final Decision',
                context: 'Last chance to lock in young core before bidding war. Everyone maxed or someone traded.',
                scenario: 'Celtics with Brown/Tatum: Final commitment decision.',
                question: 'Lock in EVERYONE or make the hard cut?',
                capSummary: { currentSalary: '$140M', capLine: '$136M', maxCommitments: '3 players, $180M', available: '$0' },
                options: [
                    {
                        id: 'cap_c4_young_lock_all',
                        text: 'Commit  Lock In Entire Core',
                        rationale: 'This IS the team. All-in.',
                        beforeAfter: { capSpace: { before: '$0', after: '$0' }, commitment: { before: '4 years', after: '8 years' } },
                        effects: { capFlexibility: -40, rosterQuality: 18, reputationPlayers: 25, trustIndex: 25, optionalityCap: 30 },
                        explanation: {
                            immediate: 'Core locked. Zero flexibility.',
                            delayed: 'This team for a decade. They MUST win.',
                            economic: 'IRREVERSIBILITY: Absolute commitment. OPPORTUNITY COST: All other paths closed.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'cap_c4_young_trade_best',
                        text: 'Preserve Options  Trade Best Asset',
                        rationale: 'Get maximum value while you can.',
                        beforeAfter: { assets: { before: '0 picks', after: '3 picks + prospects' } },
                        effects: { capFlexibility: 25, optionality: 25, rosterQuality: -12, reputationPlayers: -20, mediaNarrative: -15 },
                        explanation: {
                            immediate: 'Shocking trade. Massive haul.',
                            delayed: 'Did you trade the wrong player? Hindsight will judge.',
                            economic: 'OPTION VALUE: Preserved max flexibility. RISK: Could regret forever.'
                        }
                    },
                    {
                        id: 'cap_c4_young_hybrid',
                        text: 'Hedge  Lock Two, Trade One',
                        rationale: 'Keep stars, shed third piece.',
                        beforeAfter: { capSpace: { before: '$0', after: '$15M' } },
                        effects: { capFlexibility: -20, rosterQuality: 8, optionality: -10, reputationPlayers: 10 },
                        explanation: {
                            immediate: 'Core duo locked. Some flexibility.',
                            delayed: 'Reasonable compromise. Less upside.',
                            economic: 'PORTFOLIO: Diversified risk.'
                        }
                    }
                ],
                economicConcepts: {
                    'Irreversibility': 'Decade-long commitment',
                    'Option Value': 'Flexibility vs. commitment trade-off'
                }
            },

            cycle4_cap_messy: {
                id: 'cap_c4_messy', room: 'cap',
                title: 'Asset Conversion Final Window',
                context: 'Mountains of cap space and picks. Use them wisely or they depreciate.',
                scenario: 'OKC 2024: Finally time to spend?',
                question: 'Deploy assets or keep hoarding?',
                capSummary: { currentSalary: '$95M', capLine: '$136M', availableSpace: '$41M', draftAssets: '8 first-round picks' },
                options: [
                    {
                        id: 'cap_c4_messy_deploy',
                        text: 'Commit  Deploy Everything',
                        rationale: 'Built the war chest. Now use it.',
                        beforeAfter: { capSpace: { before: '$41M', after: '$0' }, picks: { before: '8 FRPs', after: '1 FRP' } },
                        effects: { capFlexibility: -35, rosterQuality: 25, optionality: -35, mediaNarrative: 20, trustIndex: 20 },
                        explanation: {
                            immediate: 'Massive moves. Championship push.',
                            delayed: 'Bet everything on this core. Must deliver.',
                            economic: 'COMMITMENT: Executed plan. CONCENTRATION: All eggs in basket.'
                        },
                        irreversible: true
                    },
                    {
                        id: 'cap_c4_messy_hoard',
                        text: 'Preserve Options  Keep Hoarding',
                        rationale: 'Not the right time. Wait more.',
                        beforeAfter: { unchanged: true },
                        effects: { optionality: 25, mediaNarrative: -25, trustIndex: -20, reputationLeague: -15 },
                        explanation: {
                            immediate: 'League mockery. "Process forever."',
                            delayed: 'Still waiting. Assets depreciate with time.',
                            economic: 'OPTION VALUE: Preserved but at what cost? OPPORTUNITY COST: Years of not competing.'
                        }
                    },
                    {
                        id: 'cap_c4_messy_partial_deploy',
                        text: 'Hedge  Partial Deployment',
                        rationale: 'Use half, keep half.',
                        beforeAfter: { capSpace: { before: '$41M', after: '$20M' }, picks: { before: '8 FRPs', after: '4 FRPs' } },
                        effects: { capFlexibility: -18, rosterQuality: 15, optionality: -15 },
                        explanation: {
                            immediate: 'Measured approach. Solid upgrades.',
                            delayed: 'Hedged bet. Probably not enough.',
                            economic: 'PORTFOLIO: Diversification.'
                        }
                    }
                ],
                economicConcepts: {
                    'Commitment': 'When to stop preserving and execute',
                    'Asset Depreciation': 'Flexibility loses value over time'
                }
            },

            cycle4_relationships_contender: {
                id: 'rel_c4_contender', room: 'relationships',
                title: 'Star Retirement Decision',
                context: 'Your aging star considering retirement. Can you convince him for one last year?',
                scenario: 'Duncan 2016: One more year or retire?',
                question: 'Convince him to stay or accept retirement?',
                dialogue: { speaker: 'Star (Private Conversation)', text: '"I\'ve given everything. My body is breaking down. Convince me why one more year is worth it."' },
                relationshipTemp: 'reflective',
                options: [
                    {
                        id: 'rel_c4_contender_convince',
                        text: 'Negotiate  Convince Him to Stay',
                        rationale: 'One more year. We can win.',
                        effects: { reputationPlayers: 15, rosterQuality: 10, riskExposure: 20, injuryFragility: 25, trustIndex: 15 },
                        explanation: {
                            immediate: 'He agrees to stay. High injury risk.',
                            delayed: 'One last shot. Could end badly.',
                            economic: 'RISK: High probability of injury. SUNK COST: Squeezing last value.'
                        }
                    },
                    {
                        id: 'rel_c4_contender_accept',
                        text: 'Hold Ground  Accept Retirement',
                        rationale: 'Let him go out on his terms.',
                        effects: { reputationPlayers: 20, reputationLeague: 20, rosterQuality: -20, mediaNarrative: 10 },
                        explanation: {
                            immediate: 'Graceful exit. Team must rebuild.',
                            delayed: 'Respected decision. Era over.',
                            economic: 'SUNK COST: Walking away. SOCIAL CAPITAL: Preserved relationship.'
                        }
                    },
                    {
                        id: 'rel_c4_contender_reduced',
                        text: 'Negotiate  Reduced Role',
                        rationale: 'Limited minutes. Mentor role.',
                        effects: { reputationPlayers: 10, rosterQuality: 3, trustIndex: 10 },
                        explanation: {
                            immediate: 'Compromise reached. Limited impact.',
                            delayed: 'Managed transition. Neither fully satisfied.',
                            economic: 'COMPROMISE: Middle ground.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Past value doesn\'t justify future risk',
                    'Social Capital': 'Relationships beyond basketball'
                }
            },

            cycle4_relationships_young: {
                id: 'rel_c4_young', room: 'relationships',
                title: 'Dynasty Foundation Decision',
                context: 'Your young core wants to know: are you building a dynasty or just competing?',
                scenario: 'Warriors 2015: Establishing dynasty culture.',
                question: 'Promise dynasty or stay measured?',
                dialogue: { speaker: 'Young Star (Team Meeting)', text: '"We want to win multiple championships. Are you committed to that vision or are we just trying to make playoffs?"' },
                relationshipTemp: 'hopeful',
                options: [
                    {
                        id: 'rel_c4_young_dynasty',
                        text: 'Negotiate  Promise Dynasty',
                        rationale: 'Full commitment. Championship culture.',
                        effects: { reputationPlayers: 25, trustIndex: 25, capFlexibility: -30, riskExposure: 20, flags: ['dynasty_promise'] },
                        explanation: {
                            immediate: 'Players inspired. Massive commitment.',
                            delayed: 'You promised dynasty. Anything less is failure.',
                            economic: 'COMMITMENT: Raised expectations. IRREVERSIBILITY: Can\'t walk it back.'
                        }
                    },
                    {
                        id: 'rel_c4_young_measured',
                        text: 'Hold Ground  Stay Measured',
                        rationale: 'Compete but don\'t overpromise.',
                        effects: { reputationPlayers: -8, trustIndex: 5, optionality: 15 },
                        explanation: {
                            immediate: 'Players disappointed. Wanted bigger vision.',
                            delayed: 'Preserved flexibility. Lower expectations.',
                            economic: 'OPTION VALUE: Didn\'t over-commit. SOCIAL CAPITAL: Dampened enthusiasm.'
                        }
                    },
                    {
                        id: 'rel_c4_young_conditional',
                        text: 'Negotiate  Conditional Promise',
                        rationale: 'Earn it together. Build year by year.',
                        effects: { reputationPlayers: 10, trustIndex: 15, riskExposure: 10 },
                        explanation: {
                            immediate: 'Shared vision. Mutual commitment.',
                            delayed: 'Set realistic expectations. Room to grow.',
                            economic: 'BARGAINING: Aligned incentives. EXPECTATIONS: Realistic.'
                        }
                    }
                ],
                economicConcepts: {
                    'Commitment': 'Level of promise affects future decisions',
                    'Expectations Management': 'Setting realistic vs. aspirational goals'
                }
            },

            cycle4_relationships_messy: {
                id: 'rel_c4_messy', room: 'relationships',
                title: 'Trust Restoration Final Test',
                context: 'Years of losing. Players, media, fans all skeptical. One move to restore trust or lose them.',
                scenario: 'Kings 2023: Finally showing commitment after decades.',
                question: 'Prove commitment or accept skepticism?',
                dialogue: { speaker: 'Team Leaders (Players Only Meeting Report)', text: '"We need to see you\'re serious. No more tanking, no more fake promises. Show us or we\'re out."' },
                relationshipTemp: 'skeptical',
                options: [
                    {
                        id: 'rel_c4_messy_prove',
                        text: 'Negotiate  Prove Commitment',
                        rationale: 'Make major move. Show seriousness.',
                        effects: { reputationPlayers: 25, trustIndex: 30, mediaNarrative: 20, capFlexibility: -25, rosterQuality: 15 },
                        explanation: {
                            immediate: 'Major acquisition. Trust restored.',
                            delayed: 'Put money where mouth is. Must work.',
                            economic: 'SIGNALING: Actions speak louder. COMMITMENT: Demonstrated.'
                        }
                    },
                    {
                        id: 'rel_c4_messy_patience',
                        text: 'Hold Ground  Ask for Patience',
                        rationale: 'Process takes time. Trust the plan.',
                        effects: { reputationPlayers: -15, trustIndex: -15, mediaNarrative: -15, optionality: 20 },
                        explanation: {
                            immediate: 'Players leave. Fans give up.',
                            delayed: 'Stuck in cycle. When does it end?',
                            economic: 'TIME PREFERENCE: Future over present. SOCIAL CAPITAL: Exhausted.'
                        }
                    },
                    {
                        id: 'rel_c4_messy_incremental',
                        text: 'Negotiate  Incremental Progress',
                        rationale: 'Moderate moves. Show direction.',
                        effects: { reputationPlayers: 8, trustIndex: 10, mediaNarrative: 5, capFlexibility: -12, rosterQuality: 6 },
                        explanation: {
                            immediate: 'Some improvement. Still skepticism.',
                            delayed: 'Incremental trust. Slow process.',
                            economic: 'SIGNALING: Moderate commitment. BARGAINING: Small steps.'
                        }
                    }
                ],
                economicConcepts: {
                    'Signaling': 'Actions demonstrate commitment',
                    'Social Capital': 'Trust takes time to rebuild'
                }
            },

            cycle4_risk_contender: {
                id: 'risk_c4_contender', room: 'risk',
                title: 'Final Championship Gamble',
                context: 'Championship Finals. Star has injury. Play him at 60% or sit him. Title or health.',
                scenario: 'Numerous Finals injury decisions throughout history.',
                question: 'Risk everything for the ring?',
                outcomeScenarios: {
                    likely: { label: 'Play Hurt', outcome: 'Wins title, career shortened', impact: 'Ring but future cost' },
                    worst: { label: 'Worst Case', outcome: 'Season-ending injury, lose Finals', impact: 'No ring, ruined career' },
                    best: { label: 'Best Case', outcome: 'Wins title, injury heals', impact: 'Ring and future' }
                },
                riskLevel: 95,
                options: [
                    {
                        id: 'risk_c4_contender_play',
                        text: 'Concentrate Bet  Play Him',
                        rationale: 'This is why we\'re here. Ring trumps everything.',
                        variance: 'Extreme',
                        effects: { rosterQuality: 20, riskExposure: 40, injuryFragility: 40, flags: ['legacy_gamble'] },
                        explanation: {
                            immediate: 'Star plays hurt. Heroic effort.',
                            delayed: 'Championship or career-ending disaster. History will judge.',
                            economic: 'TAIL RISK: Catastrophic potential. EXPECTED VALUE: Ultimate gamble.'
                        },
                        varianceWarning: 'MAXIMUM RISK: Career could end here.'
                    },
                    {
                        id: 'risk_c4_contender_sit',
                        text: 'Buy Insurance  Sit Him',
                        rationale: 'His career matters more than one ring.',
                        variance: 'Low',
                        effects: { rosterQuality: -25, riskExposure: -30, reputationPlayers: 20, mediaNarrative: -30 },
                        explanation: {
                            immediate: 'Championship lost. Media crushes you. Star grateful.',
                            delayed: 'Regret forever. Right choice?',
                            economic: 'RISK MANAGEMENT: Avoided disaster. OPPORTUNITY COST: Title.'
                        }
                    },
                    {
                        id: 'risk_c4_contender_limited_final',
                        text: 'Diversify  Extreme Limitations',
                        rationale: 'Play him 15 minutes. Symbolic presence.',
                        variance: 'Moderate',
                        effects: { rosterQuality: -10, riskExposure: 15, injuryFragility: 15 },
                        explanation: {
                            immediate: 'Limited impact. Probably lose.',
                            delayed: 'Tried to have both. Got neither.',
                            economic: 'COMPROMISE: Hedged bet.'
                        }
                    }
                ],
                economicConcepts: {
                    'Tail Risk': 'Low probability, career-ending event',
                    'Expected Value': 'Ring probability vs. career cost'
                }
            },

            cycle4_risk_young: {
                id: 'risk_c4_young', room: 'risk',
                title: 'Trade Asset Final Deployment',
                context: 'All your assets. One target. This is THE decision. Make it count.',
                scenario: 'Nets trading everything for Harden.',
                question: 'Bet the farm on this specific star?',
                outcomeScenarios: {
                    likely: { label: 'Base Case', outcome: 'Star performs well', impact: 'Contender for 3-4 years' },
                    worst: { label: 'Worst Case', outcome: 'Star leaves/busts', impact: 'Decade lost' },
                    best: { label: 'Best Case', outcome: 'Multiple championships', impact: 'Dynasty' }
                },
                riskLevel: 90,
                options: [
                    {
                        id: 'risk_c4_young_all_in',
                        text: 'Concentrate Bet  All Assets for Star',
                        rationale: 'This is THE guy. Bet everything.',
                        variance: 'Extreme',
                        effects: { rosterQuality: 28, riskExposure: 35, optionality: -40, flags: ['bet_the_farm'] },
                        explanation: {
                            immediate: 'Massive trade. Championship window opens.',
                            delayed: 'Dynasty or disaster. No middle ground.',
                            economic: 'CONCENTRATION: Opposite of diversification. IRREVERSIBILITY: Point of no return.'
                        },
                        varianceWarning: 'EXTREME VARIANCE: Championship or ruin.',
                        irreversible: true
                    },
                    {
                        id: 'risk_c4_young_pass',
                        text: 'Buy Insurance  Pass on This Star',
                        rationale: 'Not the right fit. Keep assets.',
                        variance: 'Low',
                        effects: { optionality: 30, mediaNarrative: -25, trustIndex: -20 },
                        explanation: {
                            immediate: 'Passed on opportunity. Massive backlash.',
                            delayed: 'Assets preserved. When will you ever use them?',
                            economic: 'OPTION VALUE: Kept flexibility. OPPORTUNITY COST: Star + championship window.'
                        }
                    },
                    {
                        id: 'risk_c4_young_partial_package',
                        text: 'Diversify  Partial Asset Package',
                        rationale: 'Good not great star. Keep some assets.',
                        variance: 'Moderate',
                        effects: { rosterQuality: 15, riskExposure: 15, optionality: -20 },
                        explanation: {
                            immediate: 'Solid move. Not transformative.',
                            delayed: 'Hedged bet. Probably not enough to win title.',
                            economic: 'PORTFOLIO: Diversified. CEILING: Limited.'
                        }
                    }
                ],
                economicConcepts: {
                    'Concentration vs. Diversification': 'Opposite strategies',
                    'Irreversibility': 'Cannot undo once executed'
                }
            },

            cycle4_risk_messy: {
                id: 'risk_c4_messy', room: 'risk',
                title: 'Final Validation',
                context: 'Years of strategic losing. Moment of truth: did it work? Go all-in or admit failure.',
                scenario: 'Sixers "Process": Was it all worth it?',
                question: 'Validate the process or admit failure?',
                outcomeScenarios: {
                    likely: { label: 'All-In', outcome: 'Competitive team', impact: 'Playoff contender' },
                    worst: { label: 'Worst Case', outcome: 'All-in fails, rebuild reset', impact: 'Decade wasted' },
                    best: { label: 'Best Case', outcome: 'Championship', impact: 'Process validated' }
                },
                riskLevel: 85,
                options: [
                    {
                        id: 'risk_c4_messy_validate',
                        text: 'Accept Exposure  Validate Process',
                        rationale: 'We did this for a reason. Execute.',
                        variance: 'High',
                        effects: { rosterQuality: 22, riskExposure: 30, optionality: -35, trustIndex: 25, mediaNarrative: 20 },
                        explanation: {
                            immediate: 'Major moves. Process culminates.',
                            delayed: 'Years judged by this outcome. Must deliver.',
                            economic: 'COMMITMENT: Full execution. VARIANCE: High stakes.'
                        }
                    },
                    {
                        id: 'risk_c4_messy_admit',
                        text: 'Buy Insurance  Admit Failure, Reset',
                        rationale: 'Process failed. Start over.',
                        variance: 'Low',
                        effects: { rosterQuality: -20, optionality: 30, trustIndex: -25, mediaNarrative: -30, reputationLeague: -25 },
                        explanation: {
                            immediate: 'Wasted years. Brutal admission.',
                            delayed: 'Clean slate. Another decade ahead.',
                            economic: 'SUNK COST: Massive write-off. OPTION VALUE: Fresh start.'
                        }
                    },
                    {
                        id: 'risk_c4_messy_moderate_commit',
                        text: 'Diversify  Moderate Commitment',
                        rationale: 'Some moves but preserve assets.',
                        variance: 'Moderate',
                        effects: { rosterQuality: 12, riskExposure: 15, optionality: -15 },
                        explanation: {
                            immediate: 'Hedged approach. Incremental improvement.',
                            delayed: 'Neither fully committed nor fully reset.',
                            economic: 'COMPROMISE: Middle path.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Past years shouldn\'t force bad decision',
                    'Commitment': 'When to fully execute or walk away'
                }
            },
            
            // 
            // NEW BRANCHING SCENARIOS - Event Reactive & Complex Paths
            // 
            
            // TRADE DEADLINE SCENARIOS
            cycle3_eval_trade_deadline: {
                id: 'eval_c3_deadline', room: 'eval',
                title: 'Trade Deadline Decision',
                context: 'You\'re 35-25 at the deadline. Contender or seller?',
                scenario: '2020 Heat: Go all-in or stay patient?',
                question: 'Buy or stand pat?',
                options: [
                    {
                        id: 'eval_c3_deadline_buy',
                        text: 'All-In  Acquire Rental Star',
                        rationale: 'Championship window is NOW.',
                        effects: { rosterQuality: 20, optionality: -30, capFlexibility: -15, flags: ['trade_deadline_buyer'] },
                        explanation: {
                            immediate: 'Roster upgraded. Picks gone. Locked in.',
                            delayed: 'Win now or face consequences.',
                            economic: 'IRREVERSIBILITY: Can\'t undo this. COMMITMENT: All chips in pot.'
                        }
                    },
                    {
                        id: 'eval_c3_deadline_sell',
                        text: 'Strategic  Sell Expiring Contracts',
                        rationale: 'Accumulate assets for next window.',
                        effects: { rosterQuality: -15, optionality: 25, capFlexibility: 10, flags: ['trade_deadline_seller'] },
                        explanation: {
                            immediate: 'Roster downgraded. Assets acquired.',
                            delayed: 'Building toward sustainable success.',
                            economic: 'OPTION VALUE: Picks are flexible assets. TIME PREFERENCE: Future over now.'
                        }
                    },
                    {
                        id: 'eval_c3_deadline_hold',
                        text: 'Conservative  Hold Current Team',
                        rationale: 'Team good enough as constructed.',
                        effects: { trustIndex: 5, mediaNarrative: -5 },
                        explanation: {
                            immediate: 'No moves. Fans disappointed.',
                            delayed: 'Live with what you have.',
                            economic: 'STATUS QUO BIAS: Sometimes no move is the move.'
                        }
                    }
                ],
                economicConcepts: {
                    'Irreversibility': 'Trade deadline deals can\'t be undone',
                    'Time Preference': 'Now vs later payoffs'
                }
            },
            
            // STAR DEMANDS MAX EXTENSION
            cycle2_cap_star_demand: {
                id: 'cap_c2_stardemand', room: 'cap',
                title: 'Max Extension Demand',
                context: 'Your All-Star wants max extension NOW or he\'ll test free agency.',
                scenario: '2019 Bucks with Giannis: Sign or risk losing him?',
                question: 'Pay now or gamble on later?',
                options: [
                    {
                        id: 'cap_c2_stardemand_max',
                        text: 'Lock In  Max Extension Now',
                        rationale: 'Can\'t risk losing franchise player.',
                        effects: { capFlexibility: -30, rosterQuality: 10, trustIndex: 15, flags: ['max_contract_signed'] },
                        explanation: {
                            immediate: 'Star secured. Cap locked. Flexibility gone.',
                            delayed: 'Committed to this core for 5 years.',
                            economic: 'INSURANCE: Pay premium to eliminate risk.'
                        }
                    },
                    {
                        id: 'cap_c2_stardemand_wait',
                        text: 'Call Bluff  Make Him Wait',
                        rationale: 'He won\'t actually leave. Keep leverage.',
                        effects: { riskExposure: 30, optionality: 15, trustIndex: -15, flags: ['star_unhappy'] },
                        explanation: {
                            immediate: 'Relationship strained. Risk elevated.',
                            delayed: 'Either saves money or loses star.',
                            economic: 'MORAL HAZARD: Agent may not be bluffing.'
                        }
                    },
                    {
                        id: 'cap_c2_stardemand_shorter',
                        text: 'Negotiate  Shorter Deal with Opt-Out',
                        rationale: 'Compromise: 3 years with player option.',
                        effects: { capFlexibility: -15, optionality: -10, trustIndex: 5, riskExposure: 10 },
                        explanation: {
                            immediate: 'Middle ground reached. Some flexibility preserved.',
                            delayed: 'Will face same decision in 3 years.',
                            economic: 'OPTION VALUE: Player option increases his leverage.'
                        }
                    }
                ],
                economicConcepts: {
                    'Insurance': 'Paying to eliminate risk',
                    'Bargaining Power': 'Leverage in negotiations'
                }
            },
            
            // INJURY CRISIS MID-SEASON
            cycle3_risk_injury_crisis: {
                id: 'risk_c3_injury', room: 'risk',
                title: 'Injury Crisis Management',
                context: 'Three starters injured. Season spiraling. Cut losses or push through?',
                scenario: '2022 Clippers: Playoff team destroyed by injuries.',
                question: 'Shut it down or fight?',
                options: [
                    {
                        id: 'risk_c3_injury_shutdown',
                        text: 'Prudent  Shut Down Injured Players',
                        rationale: 'Protect assets. Tank for pick.',
                        effects: { rosterQuality: -20, optionality: 15, injuryFragility: -15, flags: ['injury_shutdown'] },
                        explanation: {
                            immediate: 'Season over. Health preserved. Lottery bound.',
                            delayed: 'Draft pick consolation prize.',
                            economic: 'SUNK COST: Season already lost. Don\'t throw good money after bad.'
                        }
                    },
                    {
                        id: 'risk_c3_injury_fight',
                        text: 'Aggressive  Push Injured Stars to Play',
                        rationale: 'Playoff push worth the risk.',
                        effects: { riskExposure: 40, injuryFragility: 25, rosterQuality: 5, flags: ['pushed_through_injuries'] },
                        explanation: {
                            immediate: 'Stars playing hurt. Risk compounding.',
                            delayed: 'Either miracle run or catastrophic re-injury.',
                            economic: 'ESCALATION OF COMMITMENT: Doubling down on failing bet.'
                        }
                    },
                    {
                        id: 'risk_c3_injury_develop',
                        text: 'Strategic  Play Young Players',
                        rationale: 'Opportunity to develop bench.',
                        effects: { rosterQuality: -10, optionality: 10, informationEdge: 10 },
                        explanation: {
                            immediate: 'Losing more. But learning about assets.',
                            delayed: 'Development time for prospects.',
                            economic: 'OPTION VALUE: Information about young players valuable.'
                        }
                    }
                ],
                economicConcepts: {
                    'Sunk Cost': 'Don\'t escalate losing investment',
                    'Escalation of Commitment': 'Doubling down on bad bets'
                }
            },
            
            // COACHING CHANGE PRESSURE
            cycle2_relationships_coaching: {
                id: 'rel_c2_coaching', room: 'relationships',
                title: 'Coaching Pressure Decision',
                context: 'Coach is 25-30. Media wants him fired. Players support him.',
                scenario: '2020 Sixers with Brett Brown: Scapegoat or support?',
                question: 'Fire coach or stay loyal?',
                options: [
                    {
                        id: 'rel_c2_coaching_fire',
                        text: 'Decisive  Fire the Coach',
                        rationale: 'Change needed. Fresh voice.',
                        effects: { mediaNarrative: 15, reputationPlayers: -10, trustIndex: -10, flags: ['fired_coach'] },
                        explanation: {
                            immediate: 'Media applauds. Locker room shocked.',
                            delayed: 'New coach bounce or more chaos?',
                            economic: 'SCAPEGOATING: Blame individual for systemic issues.'
                        }
                    },
                    {
                        id: 'rel_c2_coaching_support',
                        text: 'Loyal  Publicly Support Coach',
                        rationale: 'Roster is the problem, not coach.',
                        effects: { reputationPlayers: 15, trustIndex: 10, mediaNarrative: -15 },
                        explanation: {
                            immediate: 'Players love it. Media roasts you.',
                            delayed: 'Loyalty builds trust with players.',
                            economic: 'PRINCIPAL-AGENT: Coach is agent. Whose side are you on?'
                        }
                    },
                    {
                        id: 'rel_c2_coaching_associate',
                        text: 'Political  Promote Assistant to Associate HC',
                        rationale: 'Appease both sides.',
                        effects: { mediaNarrative: 5, reputationPlayers: 5, trustIndex: -5 },
                        explanation: {
                            immediate: 'Half-measure. Nobody happy.',
                            delayed: 'Kicked the can down the road.',
                            economic: 'COMPROMISE: Sometimes pleases nobody.'
                        }
                    }
                ],
                economicConcepts: {
                    'Principal-Agent Problem': 'Whose interests align with yours?',
                    'Signaling': 'What message does firing send?'
                }
            },
            
            // OWNER INTERFERENCE
            cycle3_relationships_owner: {
                id: 'rel_c3_owner', room: 'relationships',
                title: 'Owner Interference',
                context: 'Owner wants to sign his college friend\'s son. Terrible player.',
                scenario: 'Jerry Jones-style meddling: Appease or resist?',
                question: 'Autonomy or politics?',
                options: [
                    {
                        id: 'rel_c3_owner_resist',
                        text: 'Principled  Refuse Owner\'s Demand',
                        rationale: 'I\'m the GM. I make basketball decisions.',
                        effects: { reputationLeague: 15, trustIndex: 10, reputationOwner: -20, riskExposure: 15, flags: ['defied_owner'] },
                        explanation: {
                            immediate: 'Owner furious. Job security shaky.',
                            delayed: 'Earn respect of players and league.',
                            economic: 'PRINCIPAL-AGENT: Owner is principal. Dangerous game.'
                        }
                    },
                    {
                        id: 'rel_c3_owner_appease',
                        text: 'Political  Sign Player to Appease Owner',
                        rationale: 'Pick your battles. Not worth the fight.',
                        effects: { reputationLeague: -10, reputationPlayers: -5, rosterQuality: -3, trustIndex: -5 },
                        explanation: {
                            immediate: 'Owner happy. Everyone else knows what happened.',
                            delayed: 'Reputation as owner\'s puppet.',
                            economic: 'MORAL HAZARD: More interference coming.'
                        }
                    },
                    {
                        id: 'rel_c3_owner_creative',
                        text: 'Creative  Two-Way Contract Compromise',
                        rationale: 'Sign him, but keep him in G-League.',
                        effects: { reputationOwner: 5, reputationLeague: 5, informationEdge: -5 },
                        explanation: {
                            immediate: 'Owner satisfied. Roster barely affected.',
                            delayed: 'Creative solution but wastes a roster spot.',
                            economic: 'NEGOTIATION: Win-win through creativity.'
                        }
                    }
                ],
                economicConcepts: {
                    'Principal-Agent': 'Who really has the power?',
                    'Moral Hazard': 'Rewarding bad behavior invites more'
                }
            },
            
            // TAMPERING ACCUSATION
            cycle4_relationships_tampering: {
                id: 'rel_c4_tamper', room: 'relationships',
                title: 'Tampering Investigation',
                context: 'League investigating you for early contact with free agent.',
                scenario: '2019 Lakers with AD: How to handle investigation?',
                question: 'Come clean or deny?',
                options: [
                    {
                        id: 'rel_c4_tamper_admit',
                        text: 'Honest  Admit and Accept Punishment',
                        rationale: 'Take the fine. Move on.',
                        effects: { reputationLeague: 5, mediaNarrative: -10, capFlexibility: -5, flags: ['admitted_tampering'] },
                        explanation: {
                            immediate: 'Fined $250K and lose second-round pick.',
                            delayed: 'Clean slate. Respected for honesty.',
                            economic: 'SIGNALING: Honesty builds long-term trust.'
                        }
                    },
                    {
                        id: 'rel_c4_tamper_deny',
                        text: 'Defiant  Deny Everything',
                        rationale: 'They have no proof.',
                        effects: { reputationLeague: -15, riskExposure: 20, mediaNarrative: 10 },
                        explanation: {
                            immediate: 'Investigation drags on. Cloud of suspicion.',
                            delayed: 'If they find proof later, punishment worse.',
                            economic: 'INFORMATION ASYMMETRY: They don\'t know. Yet.'
                        }
                    },
                    {
                        id: 'rel_c4_tamper_lawyer',
                        text: 'Legal  Lawyer Up and Fight',
                        rationale: 'Make them prove it.',
                        effects: { reputationLeague: -10, mediaNarrative: 5, capFlexibility: -3 },
                        explanation: {
                            immediate: 'Legal fees mounting. Process slow.',
                            delayed: 'Either vindicated or punished harder.',
                            economic: 'TRANSACTION COSTS: Legal battle is expensive.'
                        }
                    }
                ],
                economicConcepts: {
                    'Information Asymmetry': 'What do they actually know?',
                    'Signaling': 'Your response signals character'
                }
            },
            
            // LUXURY TAX REPEATER PENALTY
            cycle4_cap_repeater: {
                id: 'cap_c4_repeater', room: 'cap',
                title: 'Luxury Tax Repeater Penalty',
                context: 'You\'ve been in tax 3 straight years. Repeater penalty now 3.75x.',
                scenario: '2016 Cavs: Pay anything to keep window open?',
                question: 'Pay historic tax or cut salary?',
                options: [
                    {
                        id: 'cap_c4_repeater_pay',
                        text: 'All-In  Pay Record Tax Bill',
                        rationale: 'Championship is priceless.',
                        effects: { taxExposure: 40, capFlexibility: -20, reputationOwner: -20, flags: ['repeater_tax_payer'] },
                        explanation: {
                            immediate: 'Tax bill: $150M+. Ownership livid.',
                            delayed: 'Window extends but future capped.',
                            economic: 'SUNK COST: Already paid. In for a penny, in for a pound?'
                        }
                    },
                    {
                        id: 'cap_c4_repeater_duck',
                        text: 'Strategic  Duck Under Tax Line',
                        rationale: 'Reset repeater clock.',
                        effects: { rosterQuality: -10, capFlexibility: 15, optionality: 10 },
                        explanation: {
                            immediate: 'Trade rotation player. Roster weakened.',
                            delayed: 'Repeater timer resets. Future flexibility.',
                            economic: 'TIME PREFERENCE: Short-term pain for long-term gain.'
                        }
                    }
                ],
                economicConcepts: {
                    'Escalation': 'Each year in tax makes next year more expensive',
                    'Sunk Cost': 'Past tax payments shouldn\'t dictate future'
                }
            },
            
            // REBUILD SUCCESS - GRADUATION MOMENT
            cycle4_eval_rebuild_complete: {
                id: 'eval_c4_rebuild_done', room: 'eval',
                title: 'The Graduation Moment',
                context: 'Your rebuild is complete. Young core ready. Time to compete?',
                scenario: '2021 Grizzlies: Stay patient or accelerate timeline?',
                question: 'Graduate or develop one more year?',
                options: [
                    {
                        id: 'eval_c4_graduate_now',
                        text: 'Decisive  Compete Now',
                        rationale: 'Window is open. Strike.',
                        effects: { rosterQuality: 15, optionality: -15, mediaNarrative: 15, flags: ['playoff_push'] },
                        explanation: {
                            immediate: 'Add veteran pieces. Playoff push.',
                            delayed: 'Risk rushing young players.',
                            economic: 'TIME PREFERENCE: Impatience can backfire.'
                        }
                    },
                    {
                        id: 'eval_c4_one_more',
                        text: 'Patient  One More Development Year',
                        rationale: 'Let them cook. Don\'t rush.',
                        effects: { optionality: 15, mediaNarrative: -10, informationEdge: 10 },
                        explanation: {
                            immediate: 'Fans frustrated. Another lottery year.',
                            delayed: 'More sustainable long-term success.',
                            economic: 'OPTION VALUE: Patience preserves upside.'
                        }
                    }
                ],
                economicConcepts: {
                    'Time Preference': 'When to cash in?',
                    'Path Dependency': 'How you got here affects where you go'
                }
            }
        };
        
        // 
        // DRAFT LOTTERY SIMULATOR
        // 
        
        const DraftLottery = {
            odds: {
                1: 0.140, 2: 0.140, 3: 0.140,
                4: 0.125, 5: 0.105, 6: 0.090,
                7: 0.075, 8: 0.060, 9: 0.045,
                10: 0.030, 11: 0.020, 12: 0.015,
                13: 0.010, 14: 0.005
            },
            
            determineYourPosition(state) {
                if (state.rosterQuality < 30) return 1;
                if (state.rosterQuality < 35) return 2;
                if (state.rosterQuality < 40) return 3;
                if (state.rosterQuality < 45) return 4;
                if (state.rosterQuality < 50) return 5;
                if (state.rosterQuality < 55) return 6;
                if (state.rosterQuality < 60) return 7;
                return 8;
            },
            
            simulateLottery(yourPosition) {
                const results = [];
                const teams = Array.from({length: 14}, (_, i) => i + 1);
                
                for (let pick = 1; pick <= 4; pick++) {
                    const winner = this.weightedRandom(teams, this.odds);
                    results.push(winner);
                    const idx = teams.indexOf(winner);
                    teams.splice(idx, 1);
                }
                
                if (results.includes(yourPosition)) {
                    return results.indexOf(yourPosition) + 1;
                }
                
                const remainingBetter = teams.filter(t => t < yourPosition).length;
                return 5 + remainingBetter;
            },
            
            weightedRandom(teams, odds) {
                const totalWeight = teams.reduce((sum, team) => sum + odds[team], 0);
                let random = Math.random() * totalWeight;
                
                for (const team of teams) {
                    random -= odds[team];
                    if (random <= 0) return team;
                }
                
                return teams[teams.length - 1];
            },
            
            async show(state) {
                const yourPosition = this.determineYourPosition(state);
                const yourOdds = this.odds[yourPosition];
                
                const content = document.getElementById('lottery-content');
                content.innerHTML = `
                    <div style="padding:2rem;text-align:center;">
                        <div style="font-size:3rem;margin-bottom:1rem;"></div>
                        <h2 style="color:var(--gold);font-size:2rem;margin-bottom:2rem;">
                            NBA Draft Lottery
                        </h2>
                        
                        <div style="background:rgba(245,166,35,0.1);border:1px solid var(--gold);padding:1.5rem;border-radius:4px;margin-bottom:2rem;">
                            <div style="font-size:1.2rem;margin-bottom:1rem;">
                                Your Team: ${yourPosition}${this.ordinal(yourPosition)} Worst Record
                            </div>
                            <div style="font-size:1rem;color:var(--text-secondary);">
                                Odds for #1 Pick: ${(yourOdds * 100).toFixed(1)}%<br>
                                Odds for Top-4 Pick: ${(this.topFourOdds(yourPosition) * 100).toFixed(1)}%
                            </div>
                        </div>
                        
                        <div id="lottery-animation" style="min-height:200px;margin-bottom:2rem;">
                            <div style="color:var(--text-secondary);font-style:italic;">
                                Drawing lottery combinations...
                            </div>
                        </div>
                        
                        <button id="btn-start-lottery" class="btn-primary" onclick="startLotteryAnimation()" style="padding:1rem 2rem;">
                            Start Lottery
                        </button>
                    </div>
                `;
                
                document.getElementById('screen-lottery').style.display = 'flex';
                
                window.lotteryData = {
                    yourPosition,
                    yourOdds,
                    state
                };
            },
            
            topFourOdds(position) {
                let total = 0;
                for (let i = 1; i <= 4; i++) {
                    if (position <= 14) {
                        total += this.odds[position] * (i === 1 ? 1 : 0.95);
                    }
                }
                return Math.min(total, this.odds[position] * 4);
            },
            
            ordinal(n) {
                const s = ["th", "st", "nd", "rd"];
                const v = n % 100;
                return (s[(v - 20) % 10] || s[v] || s[0]);
            }
        };
        
        async function startLotteryAnimation() {
            document.getElementById('btn-start-lottery').style.display = 'none';
            
            const data = window.lotteryData;
            const animDiv = document.getElementById('lottery-animation');
            
            const finalPick = DraftLottery.simulateLottery(data.yourPosition);
            
            for (let i = 1; i <= 4; i++) {
                await animateBallDrop(i, animDiv);
                await new Promise(resolve => setTimeout(resolve, 800));
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const jumpedUp = finalPick < data.yourPosition;
            const fellDown = finalPick > data.yourPosition;
            
            animDiv.innerHTML = `
                <div style="padding:2rem;background:${jumpedUp ? 'rgba(16,185,129,0.1)' : fellDown ? 'rgba(239,68,68,0.1)' : 'rgba(245,166,35,0.1)'};border-radius:4px;">
                    <div style="font-size:4rem;margin-bottom:1rem;">
                        ${jumpedUp ? '' : fellDown ? '' : ''}
                    </div>
                    <div style="font-size:1.5rem;color:var(--gold);margin-bottom:1rem;">
                        ${jumpedUp ? 'LOTTERY WIN!' : fellDown ? 'Fell Down' : 'Stayed Put'}
                    </div>
                    <div style="font-size:2rem;margin-bottom:1rem;">
                        You Pick: #${finalPick}
                    </div>
                    <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:1.5rem;">
                        Expected: #${data.yourPosition} | Actual: #${finalPick}
                        ${jumpedUp ? ` (Jumped up ${data.yourPosition - finalPick} spots!)` :
                          fellDown ? ` (Fell ${finalPick - data.yourPosition} spots)` :
                          ' (Matched expectation)'}
                    </div>
                    <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:4px;text-align:left;font-size:0.85rem;">
                        <strong>Economics: Expected Value & Variance</strong><br>
                        Your expected pick was #${data.yourPosition}. You got #${finalPick}. 
                        ${jumpedUp ? 'Variance worked in your favor!' : 
                          fellDown ? 'Variance worked against you.' :
                          'The expected outcome happened.'}
                        Good decisions can have bad outcomes. Bad decisions can have good outcomes.
                        That's variance.
                    </div>
                </div>
                
                <button class="btn-primary" onclick="completeLottery(${finalPick})" style="margin-top:2rem;padding:1rem 2rem;">
                    Continue with Pick #${finalPick}
                </button>
            `;
        }
        
        async function animateBallDrop(ballNum, container) {
            return new Promise(resolve => {
                const ballNumber = Math.floor(Math.random() * 14) + 1;
                
                container.innerHTML += `
                    <div style="display:inline-block;margin:0.5rem;animation:ballDrop 0.5s ease;">
                        <div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg, #f5a623, #f59623);display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:bold;color:#000;box-shadow:0 4px 8px rgba(0,0,0,0.3);">
                            ${ballNumber}
                        </div>
                    </div>
                `;
                
                setTimeout(resolve, 500);
            });
        }
        
        function completeLottery(pick) {
            GameState.flags.push(`lottery_pick_${pick}`);
            GameState.draftPick = pick;
            
            document.getElementById('screen-lottery').style.display = 'none';
            
            continueToCycleAfterOutcome();
        }
        
        // 
        // TRADE MACHINE PUZZLE
        // 
        
        const TradePuzzle = {
            currentPuzzle: null,
            selectedPlayers: [],
            
            puzzles: {
                contender: {
                    target: {
                        name: 'All-Star Small Forward',
                        salary: 35000000,
                        rating: 88
                    },
                    roster: [
                        { id: 'pg1', name: 'Veteran Point Guard', salary: 18000000, position: 'PG', rating: 78 },
                        { id: 'sf1', name: 'Wing Defender', salary: 12000000, position: 'SF', rating: 75 },
                        { id: 'pf1', name: 'Stretch Four', salary: 10000000, position: 'PF', rating: 74 },
                        { id: 'sg1', name: 'Shooting Guard', salary: 8000000, position: 'SG', rating: 72 },
                        { id: 'pg2', name: 'Backup Guard', salary: 4000000, position: 'PG', rating: 68 },
                        { id: 'sf2', name: 'Young Wing', salary: 3000000, position: 'SF', rating: 70 }
                    ]
                }
            },
            
            show(franchiseType) {
                this.currentPuzzle = this.puzzles[franchiseType] || this.puzzles.contender;
                this.selectedPlayers = [];
                
                const content = document.getElementById('trade-puzzle-content');
                content.innerHTML = this.renderPuzzle();
                
                document.getElementById('screen-trade-puzzle').style.display = 'flex';
            },
            
            renderPuzzle() {
                const p = this.currentPuzzle;
                const minSalary = Math.floor(p.target.salary * 0.80);
                const maxSalary = Math.floor(p.target.salary * 1.25);
                
                return `
                    <div style="padding:2rem;">
                        <h2 style="color:var(--gold);font-size:1.8rem;margin-bottom:1rem;">
                            Trade Challenge
                        </h2>
                        
                        <div style="background:rgba(59,130,246,0.1);border:1px solid #3b82f6;padding:1.5rem;border-radius:4px;margin-bottom:2rem;">
                            <div style="font-size:1.2rem;margin-bottom:0.5rem;">
                                <strong>Goal:</strong> Acquire ${p.target.name}
                            </div>
                            <div style="color:var(--text-secondary);">
                                Salary: $${(p.target.salary / 1000000).toFixed(1)}M | Rating: ${p.target.rating}
                            </div>
                        </div>
                        
                        <div style="background:rgba(245,166,35,0.1);border:1px solid var(--gold);padding:1rem;border-radius:4px;margin-bottom:2rem;">
                            <div style="font-weight:bold;margin-bottom:0.5rem;">NBA Salary Matching Rule:</div>
                            <div style="font-size:0.9rem;color:var(--text-secondary);">
                                Your outgoing salary must be within 80-125% of incoming salary<br>
                                Required range: $${(minSalary / 1000000).toFixed(1)}M - $${(maxSalary / 1000000).toFixed(1)}M
                            </div>
                        </div>
                        
                        <div style="margin-bottom:2rem;">
                            <h3 style="margin-bottom:1rem;">Your Roster - Select Players to Trade:</h3>
                            <div id="roster-grid" style="display:grid;gap:0.75rem;">
                                ${p.roster.map(player => this.renderPlayerCard(player)).join('')}
                            </div>
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:4px;margin-bottom:1.5rem;">
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;text-align:center;">
                                <div>
                                    <div style="font-size:0.85rem;color:var(--text-secondary);">Players Selected</div>
                                    <div id="players-count" style="font-size:1.5rem;color:var(--gold);">0</div>
                                </div>
                                <div>
                                    <div style="font-size:0.85rem;color:var(--text-secondary);">Total Salary</div>
                                    <div id="total-salary" style="font-size:1.5rem;color:var(--gold);">$0M</div>
                                </div>
                                <div>
                                    <div style="font-size:0.85rem;color:var(--text-secondary);">Status</div>
                                    <div id="trade-status" style="font-size:1.2rem;">Select players</div>
                                </div>
                            </div>
                            
                            <div id="efficiency-display" style="margin-top:1rem;text-align:center;display:none;">
                                <div style="font-size:0.85rem;color:var(--text-secondary);">Efficiency Score</div>
                                <div id="efficiency-score" style="font-size:2rem;color:var(--gold);">--/100</div>
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:1rem;">
                            <button id="btn-submit-trade" class="btn-primary" onclick="submitTrade()" disabled style="flex:1;">
                                Complete Trade
                            </button>
                            <button class="btn-ghost" onclick="resetPuzzle()">
                                Reset
                            </button>
                        </div>
                    </div>
                `;
            },
            
            renderPlayerCard(player) {
                const selected = this.selectedPlayers.includes(player.id);
                
                return `
                    <div class="player-select-card ${selected ? 'selected' : ''}" 
                         onclick="togglePlayer('${player.id}')"
                         style="padding:1rem;background:${selected ? 'rgba(245,166,35,0.2)' : 'rgba(255,255,255,0.05)'};
                                border:2px solid ${selected ? 'var(--gold)' : 'var(--border)'};
                                border-radius:4px;cursor:pointer;transition:all 0.2s;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:600;">${player.name}</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);">
                                    ${player.position} | Rating: ${player.rating}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:1.1rem;color:var(--gold);">
                                    $${(player.salary / 1000000).toFixed(1)}M
                                </div>
                                <div style="font-size:0.85rem;">
                                    ${selected ? ' Selected' : 'Click to select'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            calculateEfficiency(selectedPlayers, totalSalary) {
                const p = this.currentPuzzle;
                
                let score = 100;
                
                const playerPenalty = Math.max(0, (selectedPlayers.length - 2) * 8);
                score -= playerPenalty;
                
                const excess = totalSalary - p.target.salary;
                const wastePenalty = Math.abs(excess) / 500000;
                score -= wastePenalty;
                
                if (Math.abs(excess) < 1000000) {
                    score += 10;
                }
                
                return Math.max(0, Math.min(100, Math.round(score)));
            },
            
            updateDisplay() {
                const selectedPlayers = this.currentPuzzle.roster.filter(p => 
                    this.selectedPlayers.includes(p.id)
                );
                
                const totalSalary = selectedPlayers.reduce((sum, p) => sum + p.salary, 0);
                const minSalary = Math.floor(this.currentPuzzle.target.salary * 0.80);
                const maxSalary = Math.floor(this.currentPuzzle.target.salary * 1.25);
                
                const valid = totalSalary >= minSalary && totalSalary <= maxSalary;
                
                document.getElementById('players-count').textContent = selectedPlayers.length;
                document.getElementById('total-salary').textContent = `$${(totalSalary / 1000000).toFixed(1)}M`;
                
                const statusEl = document.getElementById('trade-status');
                if (selectedPlayers.length === 0) {
                    statusEl.textContent = 'Select players';
                    statusEl.style.color = 'var(--text-secondary)';
                } else if (totalSalary < minSalary) {
                    statusEl.textContent = 'Too low';
                    statusEl.style.color = '#ef4444';
                } else if (totalSalary > maxSalary) {
                    statusEl.textContent = 'Too high';
                    statusEl.style.color = '#ef4444';
                } else {
                    statusEl.textContent = ' Valid!';
                    statusEl.style.color = '#10b981';
                    
                    const efficiency = this.calculateEfficiency(selectedPlayers, totalSalary);
                    document.getElementById('efficiency-display').style.display = 'block';
                    document.getElementById('efficiency-score').textContent = `${efficiency}/100`;
                }
                
                document.getElementById('btn-submit-trade').disabled = !valid;
            }
        };
        
        function togglePlayer(playerId) {
            const idx = TradePuzzle.selectedPlayers.indexOf(playerId);
            if (idx > -1) {
                TradePuzzle.selectedPlayers.splice(idx, 1);
            } else {
                TradePuzzle.selectedPlayers.push(playerId);
            }
            
            const content = document.getElementById('trade-puzzle-content');
            content.innerHTML = TradePuzzle.renderPuzzle();
            TradePuzzle.updateDisplay();
        }
        
        function resetPuzzle() {
            TradePuzzle.selectedPlayers = [];
            const content = document.getElementById('trade-puzzle-content');
            content.innerHTML = TradePuzzle.renderPuzzle();
            TradePuzzle.updateDisplay();
        }
        
        function submitTrade() {
            const selectedPlayers = TradePuzzle.currentPuzzle.roster.filter(p => 
                TradePuzzle.selectedPlayers.includes(p.id)
            );
            const totalSalary = selectedPlayers.reduce((sum, p) => sum + p.salary, 0);
            const efficiency = TradePuzzle.calculateEfficiency(selectedPlayers, totalSalary);
            
            const effects = {
                rosterQuality: efficiency > 85 ? 25 : efficiency > 70 ? 20 : 15,
                optionality: efficiency > 85 ? -10 : efficiency > 70 ? -15 : -20,
                capFlexibility: -15,
                flags: ['completed_trade_puzzle']
            };
            
            GameState.applyEffects(effects);
            
            showTradeResult(efficiency, selectedPlayers);
        }
        
        function showTradeResult(efficiency, players) {
            const content = document.getElementById('trade-puzzle-content');
            content.innerHTML = `
                <div style="padding:2rem;text-align:center;">
                    <div style="font-size:4rem;margin-bottom:1rem;">
                        ${efficiency > 85 ? '' : efficiency > 70 ? '' : ''}
                    </div>
                    <h2 style="color:var(--gold);margin-bottom:1rem;">Trade Completed!</h2>
                    
                    <div style="background:rgba(16,185,129,0.1);border:1px solid #10b981;padding:1.5rem;border-radius:4px;margin-bottom:2rem;">
                        <div style="font-size:2rem;color:#10b981;margin-bottom:0.5rem;">
                            Efficiency: ${efficiency}/100
                        </div>
                        <div style="color:var(--text-secondary);">
                            ${efficiency > 85 ? 'Excellent trade! Minimal waste, preserved depth.' :
                              efficiency > 70 ? 'Good trade. Reasonable value for the star.' :
                              'Trade works, but could be more efficient.'}
                        </div>
                    </div>
                    
                    <div style="text-align:left;padding:1rem;background:rgba(255,255,255,0.05);border-radius:4px;margin-bottom:2rem;">
                        <div style="font-weight:bold;margin-bottom:0.5rem;">What You Traded:</div>
                        ${players.map(p => `
                            <div style="padding:0.5rem;border-left:2px solid var(--gold);margin:0.5rem 0;padding-left:1rem;">
                                ${p.name} ($${(p.salary/1000000).toFixed(1)}M)
                            </div>
                        `).join('')}
                        <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);">
                            <strong>Total:</strong> ${players.length} players, $${(players.reduce((s,p) => s + p.salary, 0)/1000000).toFixed(1)}M
                        </div>
                    </div>
                    
                    <div style="padding:1rem;background:rgba(245,166,35,0.1);border-left:3px solid var(--gold);text-align:left;font-size:0.9rem;margin-bottom:2rem;">
                        <strong>Economics: Constrained Optimization</strong><br>
                        You optimized within a constraint (salary matching rule). The goal: maximize value 
                        (get the star) while minimizing cost (fewest players, closest salary match). 
                        Every choice involves trade-offs under constraints.
                    </div>
                    
                    <button class="btn-primary" onclick="closeTradePuzzle()" style="padding:1rem 2rem;">
                        Continue
                    </button>
                </div>
            `;
        }
        
        function closeTradePuzzle() {
            document.getElementById('screen-trade-puzzle').style.display = 'none';
            GameState.lockRoom('eval');
            UI.updateHubMetrics();
            UI.updateRoomStatuses();
        }
        
        // 
        // ROOM MINI-GAMES (One for Each Room Type)
        // 
        
        // EVAL ROOM: SCOUTING REPORT ANALYSIS GAME
        const ScoutingGame = {
            currentProspects: [],
            selectedProspect: null,
            
            prospects: [
                { id: 1, name: 'Marcus Johnson', pos: 'PG', rating: 75, upside: 88, risk: 35, age: 19, college: 'Duke',
                  stats: '18 PPG, 7 APG, 45% FG', strengths: 'Elite vision, high IQ', weaknesses: 'Inconsistent shooter',
                  comparison: 'Young Chris Paul', cost: 'Top 5 pick' },
                { id: 2, name: 'DeAndre Williams', pos: 'SF', rating: 82, upside: 85, risk: 20, age: 21, college: 'Gonzaga',
                  stats: '22 PPG, 8 RPG, 51% FG', strengths: 'NBA-ready body, scoring', weaknesses: 'Limited playmaking',
                  comparison: 'Kawhi Leonard lite', cost: 'Top 10 pick' },
                { id: 3, name: 'Kai Thompson', pos: 'SG', rating: 70, upside: 92, risk: 60, age: 18, college: 'International',
                  stats: '25 PPG overseas', strengths: 'Explosive scorer, elite athlete', weaknesses: 'Raw, inconsistent',
                  comparison: 'Anthony Edwards upside', cost: 'Lottery pick' },
                { id: 4, name: 'Brandon Mitchell', pos: 'C', rating: 78, upside: 80, risk: 25, age: 22, college: 'Kentucky',
                  stats: '15 PPG, 11 RPG, 62% FG', strengths: 'Proven winner, great hands', weaknesses: 'Limited athleticism',
                  comparison: 'Al Horford', cost: 'Mid first round' },
                { id: 5, name: 'Jamal Carter', pos: 'PF', rating: 68, upside: 90, risk: 70, age: 19, college: 'G-League',
                  stats: '20 PPG G-League', strengths: 'Length, potential', weaknesses: 'Very raw, thin frame',
                  comparison: 'Giannis project', cost: 'Late lottery' }
            ],
            
            show(franchise, cycle) {
                // Select 3 random prospects
                const shuffled = [...this.prospects].sort(() => Math.random() - 0.5);
                this.currentProspects = shuffled.slice(0, 3);
                this.selectedProspect = null;
                
                const modal = document.getElementById('screen-trade-puzzle');
                const content = document.getElementById('trade-puzzle-content');
                
                content.innerHTML = `
                    <div style="padding:2rem;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:3rem;margin-bottom:1rem;"></div>
                            <h2 style="color:var(--gold);font-size:1.8rem;">Scouting Report Analysis</h2>
                            <div style="color:var(--text-secondary);">Evaluate prospects and identify the best fit</div>
                        </div>
                        
                        <div style="background:rgba(245,166,35,0.1);border:1px solid var(--gold);padding:1rem;border-radius:4px;margin-bottom:2rem;">
                            <strong>Your Mission:</strong> Analyze these prospects and choose who best fits your team's needs.
                            Consider: Current rating, upside potential, injury risk, and cost.
                        </div>
                        
                        <div id="prospects-container" style="display:grid;gap:1rem;margin-bottom:2rem;">
                            ${this.currentProspects.map(p => this.renderProspectCard(p)).join('')}
                        </div>
                        
                        <div id="selection-area" style="min-height:100px;">
                            ${this.selectedProspect ? this.renderSelection() : `
                                <div style="text-align:center;padding:2rem;background:rgba(255,255,255,0.03);border-radius:4px;border:2px dashed var(--border);">
                                    <div style="color:var(--text-secondary);">Select a prospect above to see detailed analysis</div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },
            
            renderProspectCard(prospect) {
                return `
                    <div class="prospect-card" onclick="selectProspect(${prospect.id})" 
                         style="padding:1.5rem;background:${this.selectedProspect?.id === prospect.id ? 'rgba(245,166,35,0.2)' : 'rgba(255,255,255,0.05)'};
                                border:2px solid ${this.selectedProspect?.id === prospect.id ? 'var(--gold)' : 'var(--border)'};
                                border-radius:6px;cursor:pointer;transition:all 0.2s;">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem;">
                            <div>
                                <div style="font-size:1.3rem;font-weight:bold;">${prospect.name}</div>
                                <div style="font-size:0.9rem;color:var(--text-secondary);">${prospect.pos}  ${prospect.age} yrs  ${prospect.college}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:1.5rem;color:var(--gold);">${prospect.rating}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">Current</div>
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem;margin-bottom:1rem;">
                            <div style="text-align:center;padding:0.5rem;background:rgba(0,0,0,0.3);border-radius:4px;">
                                <div style="font-size:0.75rem;color:var(--text-secondary);">Upside</div>
                                <div style="font-size:1.2rem;color:${prospect.upside >= 90 ? '#10b981' : prospect.upside >= 85 ? 'var(--gold)' : '#fff'};">
                                    ${prospect.upside}
                                </div>
                            </div>
                            <div style="text-align:center;padding:0.5rem;background:rgba(0,0,0,0.3);border-radius:4px;">
                                <div style="font-size:0.75rem;color:var(--text-secondary);">Risk</div>
                                <div style="font-size:1.2rem;color:${prospect.risk >= 60 ? '#ef4444' : prospect.risk >= 40 ? 'var(--gold)' : '#10b981'};">
                                    ${prospect.risk}%
                                </div>
                            </div>
                            <div style="text-align:center;padding:0.5rem;background:rgba(0,0,0,0.3);border-radius:4px;">
                                <div style="font-size:0.75rem;color:var(--text-secondary);">Cost</div>
                                <div style="font-size:0.8rem;">${prospect.cost}</div>
                            </div>
                        </div>
                        
                        <div style="font-size:0.85rem;color:var(--text-secondary);">
                             ${prospect.stats}
                        </div>
                    </div>
                `;
            },
            
            renderSelection() {
                const p = this.selectedProspect;
                return `
                    <div style="background:linear-gradient(135deg,rgba(245,166,35,0.1),rgba(59,130,246,0.1));padding:2rem;border-radius:8px;border:2px solid var(--gold);">
                        <div style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem;color:var(--gold);">
                            ${p.name} - Detailed Scouting Report
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem;">
                            <div>
                                <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">Strengths:</div>
                                <div style="padding:1rem;background:rgba(16,185,129,0.1);border-left:3px solid #10b981;border-radius:4px;">
                                    ${p.strengths}
                                </div>
                            </div>
                            <div>
                                <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">Weaknesses:</div>
                                <div style="padding:1rem;background:rgba(239,68,68,0.1);border-left:3px solid #ef4444;border-radius:4px;">
                                    ${p.weaknesses}
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding:1rem;background:rgba(0,0,0,0.3);border-radius:4px;margin-bottom:1.5rem;">
                            <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">NBA Comparison:</div>
                            <div style="font-size:1.1rem;">${p.comparison}</div>
                        </div>
                        
                        <div style="padding:1rem;background:rgba(245,166,35,0.1);border-left:3px solid var(--gold);margin-bottom:1.5rem;">
                            <strong>Economics: Expected Value</strong><br>
                            Current Rating (${p.rating})  Risk Success (${100-p.risk}%) = ${Math.round(p.rating * (100-p.risk) / 100)} Expected Value<br>
                            But upside (${p.upside}) could be worth the gamble if ${p.upside - p.rating} point improvement happens.
                        </div>
                        
                        <button class="btn-primary" onclick="draftProspect()" style="width:100%;padding:1rem;font-size:1.1rem;">
                            Draft ${p.name}
                        </button>
                    </div>
                `;
            }
        };
        
        function selectProspect(id) {
            ScoutingGame.selectedProspect = ScoutingGame.currentProspects.find(p => p.id === id);
            ScoutingGame.show(GameState.franchise, GameState.cycleIndex);
        }
        
        function draftProspect() {
            const p = ScoutingGame.selectedProspect;
            
            // Calculate effects based on prospect quality
            const rosterBoost = Math.round((p.rating + p.upside) / 2 / 5); // 15-18 range
            const riskIncrease = Math.round(p.risk / 3); // 7-23 range
            const optionalityLoss = p.cost.includes('Top 5') ? -20 : p.cost.includes('Top 10') ? -15 : -10;
            
            GameState.applyEffects({
                rosterQuality: rosterBoost,
                riskExposure: riskIncrease,
                optionality: optionalityLoss,
                flags: [`drafted_${p.pos.toLowerCase()}`]
            });
            
            const modal = document.getElementById('screen-trade-puzzle');
            modal.style.display = 'none';
            
            GameState.lockRoom('eval');
            UI.updateHubMetrics();
            UI.addAlert(`Drafted ${p.name}! +${rosterBoost} Roster Quality`, 'success');
        }
        
        // CAP ROOM: SALARY CAP PUZZLE GAME
        const CapPuzzle = {
            currentSalaries: [],
            capSpace: 136000000,
            targetSpace: 0,
            
            show() {
                // Generate random salary situation
                this.currentSalaries = [
                    { name: 'Star Player', salary: 45000000, movable: false },
                    { name: 'All-Star', salary: 32000000, movable: true },
                    { name: 'Starter 1', salary: 18000000, movable: true },
                    { name: 'Starter 2', salary: 15000000, movable: true },
                    { name: 'Rotation', salary: 8000000, movable: true },
                    { name: 'Rotation', salary: 6000000, movable: true },
                    { name: 'Bench', salary: 4000000, movable: true },
                    { name: 'Bench', salary: 3000000, movable: true },
                    { name: 'Bench', salary: 2000000, movable: true }
                ];
                
                this.targetSpace = 25000000; // Need to create this much space
                
                const modal = document.getElementById('screen-trade-puzzle');
                const content = document.getElementById('trade-puzzle-content');
                
                content.innerHTML = `
                    <div style="padding:2rem;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:3rem;margin-bottom:1rem;"></div>
                            <h2 style="color:var(--gold);font-size:1.8rem;">Cap Space Creation Challenge</h2>
                            <div style="color:var(--text-secondary);">Create $${(this.targetSpace/1000000).toFixed(1)}M in cap space</div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">
                            <div style="padding:1.5rem;background:rgba(239,68,68,0.1);border:2px solid #ef4444;border-radius:6px;">
                                <div style="font-size:0.9rem;color:var(--text-secondary);">Current Payroll</div>
                                <div style="font-size:2rem;font-weight:bold;color:#ef4444;">
                                    $${(this.getTotalSalary()/1000000).toFixed(1)}M
                                </div>
                                <div style="font-size:0.8rem;margin-top:0.5rem;">
                                    ${(this.getTotalSalary() - this.capSpace)/1000000 > 0 ? 
                                      `$${((this.getTotalSalary() - this.capSpace)/1000000).toFixed(1)}M OVER cap` :
                                      `$${((this.capSpace - this.getTotalSalary())/1000000).toFixed(1)}M under cap`}
                                </div>
                            </div>
                            <div style="padding:1.5rem;background:rgba(16,185,129,0.1);border:2px solid #10b981;border-radius:6px;">
                                <div style="font-size:0.9rem;color:var(--text-secondary);">Target Cap Space</div>
                                <div style="font-size:2rem;font-weight:bold;color:#10b981;">
                                    $${(this.targetSpace/1000000).toFixed(1)}M
                                </div>
                                <div style="font-size:0.8rem;margin-top:0.5rem;">
                                    Must get to $${((this.capSpace - this.targetSpace)/1000000).toFixed(1)}M payroll
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:1.5rem;">
                            <div style="font-weight:bold;margin-bottom:1rem;">Your Roster (click to trade/waive):</div>
                            <div style="display:grid;gap:0.5rem;">
                                ${this.currentSalaries.map((player, idx) => `
                                    <div onclick="removePlayer(${idx})" 
                                         style="padding:1rem;background:${player.movable ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.02)'};
                                                border:1px solid var(--border);border-radius:4px;
                                                ${player.movable ? 'cursor:pointer;' : 'opacity:0.5;cursor:not-allowed;'}
                                                display:flex;justify-content:space-between;align-items:center;">
                                        <div>
                                            <span style="font-weight:600;">${player.name}</span>
                                            ${!player.movable ? '<span style="font-size:0.75rem;color:#ef4444;margin-left:0.5rem;">UNTRADEABLE</span>' : ''}
                                        </div>
                                        <div style="font-size:1.1rem;color:var(--gold);">
                                            $${(player.salary/1000000).toFixed(1)}M
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="padding:1rem;background:rgba(245,166,35,0.1);border-left:3px solid var(--gold);margin-bottom:1.5rem;">
                            <strong>Economics: Constrained Resource Allocation</strong><br>
                            Limited cap space forces trade-offs. Every dollar to one player is unavailable for others.
                            Strategic cuts create flexibility for future moves.
                        </div>
                        
                        <button class="btn-primary" onclick="completeCapPuzzle()" style="width:100%;">
                            Finalize Salary Cap Strategy
                        </button>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },
            
            getTotalSalary() {
                return this.currentSalaries.reduce((sum, p) => sum + p.salary, 0);
            },
            
            getCurrentSpace() {
                return this.capSpace - this.getTotalSalary();
            }
        };
        
        function removePlayer(idx) {
            const player = CapPuzzle.currentSalaries[idx];
            if (!player.movable) {
                UI.addAlert('Cannot trade franchise player!', 'warning');
                return;
            }
            
            CapPuzzle.currentSalaries.splice(idx, 1);
            CapPuzzle.show();
        }
        
        function completeCapPuzzle() {
            const currentSpace = CapPuzzle.getCurrentSpace();
            const success = currentSpace >= CapPuzzle.targetSpace;
            
            if (success) {
                const efficiency = Math.round((currentSpace / CapPuzzle.targetSpace) * 100);
                GameState.applyEffects({
                    capFlexibility: efficiency > 150 ? 25 : efficiency > 120 ? 20 : 15,
                    rosterQuality: -10, // Traded players
                    optionality: 15,
                    flags: ['completed_cap_puzzle']
                });
                
                UI.addAlert(`Created $${(currentSpace/1000000).toFixed(1)}M in cap space!`, 'success');
            } else {
                UI.addAlert('Need more cap space! Try trading more players.', 'warning');
                return;
            }
            
            document.getElementById('screen-trade-puzzle').style.display = 'none';
            GameState.lockRoom('cap');
            UI.updateHubMetrics();
        }
        
        // RELATIONSHIPS: NEGOTIATION MINI-GAME
        const NegotiationGame = {
            playerDemand: 0,
            currentOffer: 0,
            playerHappiness: 50,
            rounds: 0,
            maxRounds: 5,
            
            show() {
                this.playerDemand = 35000000; // Player wants $35M
                this.currentOffer = 28000000;  // You start at $28M
                this.playerHappiness = 50;
                this.rounds = 0;
                
                const modal = document.getElementById('screen-trade-puzzle');
                const content = document.getElementById('trade-puzzle-content');
                
                this.renderNegotiation();
                modal.style.display = 'flex';
            },
            
            renderNegotiation() {
                const content = document.getElementById('trade-puzzle-content');
                const gap = this.playerDemand - this.currentOffer;
                const gapPercent = (gap / this.playerDemand) * 100;
                
                content.innerHTML = `
                    <div style="padding:2rem;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:3rem;margin-bottom:1rem;"></div>
                            <h2 style="color:var(--gold);font-size:1.8rem;">Contract Negotiation</h2>
                            <div style="color:var(--text-secondary);">Round ${this.rounds + 1} of ${this.maxRounds}</div>
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.05);padding:2rem;border-radius:8px;margin-bottom:2rem;">
                            <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;align-items:center;margin-bottom:2rem;">
                                <div style="text-align:center;">
                                    <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">Your Offer</div>
                                    <div style="font-size:2.5rem;font-weight:bold;color:var(--info);">
                                        $${(this.currentOffer/1000000).toFixed(1)}M
                                    </div>
                                </div>
                                <div style="font-size:2rem;color:var(--text-secondary);"></div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">Player Demands</div>
                                    <div style="font-size:2.5rem;font-weight:bold;color:#ef4444;">
                                        $${(this.playerDemand/1000000).toFixed(1)}M
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom:1rem;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                                    <span style="font-size:0.9rem;">Gap: $${(gap/1000000).toFixed(1)}M (${gapPercent.toFixed(0)}%)</span>
                                    <span style="font-size:0.9rem;">Player Happiness: ${this.playerHappiness}%</span>
                                </div>
                                <div style="background:rgba(255,255,255,0.1);height:12px;border-radius:6px;overflow:hidden;">
                                    <div style="width:${this.playerHappiness}%;height:100%;background:${this.playerHappiness > 70 ? '#10b981' : this.playerHappiness > 40 ? 'var(--gold)' : '#ef4444'};transition:all 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                        
                        ${this.rounds < this.maxRounds ? `
                            <div style="margin-bottom:2rem;">
                                <div style="font-weight:bold;margin-bottom:1rem;">Your Move:</div>
                                <div style="display:grid;gap:1rem;">
                                    <button class="btn-primary" onclick="negotiate('aggressive')" style="padding:1rem;">
                                         Aggressive - Increase $1M (Hold firm)
                                    </button>
                                    <button class="btn-primary" onclick="negotiate('moderate')" style="padding:1rem;">
                                         Moderate - Increase $2M (Show good faith)
                                    </button>
                                    <button class="btn-primary" onclick="negotiate('generous')" style="padding:1rem;">
                                         Generous - Increase $3M (Make him happy)
                                    </button>
                                    <button class="btn-ghost" onclick="negotiate('walk')" style="padding:1rem;">
                                         Walk Away (End negotiation)
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="padding:1rem;background:rgba(245,166,35,0.1);border-left:3px solid var(--gold);">
                            <strong>Economics: Bargaining Power</strong><br>
                            ${gapPercent > 15 ? 'Big gap! Player has leverage. Be generous or risk losing him.' :
                              gapPercent > 5 ? 'Close! One more good offer could seal it.' :
                              'Almost there! Don\'t overpay now.'}
                        </div>
                    </div>
                `;
            }
        };
        
        function negotiate(type) {
            NegotiationGame.rounds++;
            
            if (type === 'walk') {
                UI.addAlert('Negotiation failed. Player will test free agency.', 'warning');
                GameState.applyEffects({
                    reputationPlayers: -15,
                    reputationAgents: -10,
                    riskExposure: 20,
                    flags: ['failed_negotiation']
                });
                document.getElementById('screen-trade-puzzle').style.display = 'none';
                GameState.lockRoom('relationships');
                UI.updateHubMetrics();
                return;
            }
            
            const increases = { aggressive: 1000000, moderate: 2000000, generous: 3000000 };
            const happinessChange = { aggressive: -5, moderate: 5, generous: 15 };
            
            NegotiationGame.currentOffer += increases[type];
            NegotiationGame.playerHappiness += happinessChange[type];
            
            // Player counter-offers
            if (NegotiationGame.playerHappiness > 70 && Math.random() < 0.4) {
                NegotiationGame.playerDemand -= 1000000; // Player lowers demand
            }
            
            // Check if deal reached
            const gap = NegotiationGame.playerDemand - NegotiationGame.currentOffer;
            if (gap <= 1000000 || NegotiationGame.playerHappiness >= 80) {
                // Deal!
                const finalSalary = (NegotiationGame.currentOffer + NegotiationGame.playerDemand) / 2;
                const efficiency = 100 - ((finalSalary - 28000000) / 28000000 * 100);
                
                GameState.applyEffects({
                    capFlexibility: -Math.round((finalSalary - 28000000) / 1000000),
                    trustIndex: 15,
                    reputationPlayers: 10,
                    flags: ['signed_star']
                });
                
                UI.addAlert(`Deal reached at $${(finalSalary/1000000).toFixed(1)}M!`, 'success');
                document.getElementById('screen-trade-puzzle').style.display = 'none';
                GameState.lockRoom('relationships');
                UI.updateHubMetrics();
                return;
            }
            
            if (NegotiationGame.rounds >= NegotiationGame.maxRounds) {
                UI.addAlert('Negotiation ended without deal.', 'warning');
                GameState.applyEffects({
                    reputationPlayers: -10,
                    riskExposure: 15
                });
                document.getElementById('screen-trade-puzzle').style.display = 'none';
                GameState.lockRoom('relationships');
                UI.updateHubMetrics();
                return;
            }
            
            NegotiationGame.renderNegotiation();
        }
        
        // RISK ROOM: PORTFOLIO BALANCING GAME
        const RiskPortfolio = {
            assets: [],
            targetBalance: 60, // Want 60% safety, 40% risk
            
            show() {
                this.assets = [
                    { name: 'Proven Veterans', allocation: 40, risk: 10, return: 5 },
                    { name: 'Young Stars', allocation: 30, risk: 30, return: 15 },
                    { name: 'Draft Picks', allocation: 20, risk: 60, return: 30 },
                    { name: 'Injury-Prone Stars', allocation: 10, risk: 70, return: 35 }
                ];
                
                const modal = document.getElementById('screen-trade-puzzle');
                const content = document.getElementById('trade-puzzle-content');
                
                this.render();
                modal.style.display = 'flex';
            },
            
            render() {
                const content = document.getElementById('trade-puzzle-content');
                const totalAllocation = this.assets.reduce((sum, a) => sum + a.allocation, 0);
                const weightedRisk = this.assets.reduce((sum, a) => sum + (a.allocation * a.risk / 100), 0);
                const weightedReturn = this.assets.reduce((sum, a) => sum + (a.allocation * a.return / 100), 0);
                
                const balanced = Math.abs(weightedRisk - 40) < 10;
                
                content.innerHTML = `
                    <div style="padding:2rem;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:3rem;margin-bottom:1rem;"></div>
                            <h2 style="color:var(--gold);font-size:1.8rem;">Risk Portfolio Balancing</h2>
                            <div style="color:var(--text-secondary);">Optimize risk vs reward allocation</div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:2rem;">
                            <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:4px;text-align:center;">
                                <div style="font-size:0.8rem;color:var(--text-secondary);">Total Allocation</div>
                                <div style="font-size:1.8rem;font-weight:bold;color:${totalAllocation === 100 ? '#10b981' : '#ef4444'};">
                                    ${totalAllocation}%
                                </div>
                            </div>
                            <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:4px;text-align:center;">
                                <div style="font-size:0.8rem;color:var(--text-secondary);">Portfolio Risk</div>
                                <div style="font-size:1.8rem;font-weight:bold;color:${balanced ? '#10b981' : 'var(--gold)'};">
                                    ${weightedRisk.toFixed(0)}%
                                </div>
                            </div>
                            <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:4px;text-align:center;">
                                <div style="font-size:0.8rem;color:var(--text-secondary);">Expected Return</div>
                                <div style="font-size:1.8rem;font-weight:bold;color:var(--gold);">
                                    ${weightedReturn.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:2rem;">
                            ${this.assets.map((asset, idx) => `
                                <div style="margin-bottom:1.5rem;padding:1rem;background:rgba(255,255,255,0.03);border-radius:6px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:0.75rem;">
                                        <div>
                                            <div style="font-weight:600;">${asset.name}</div>
                                            <div style="font-size:0.8rem;color:var(--text-secondary);">
                                                Risk: ${asset.risk}% | Return: ${asset.return}%
                                            </div>
                                        </div>
                                        <div style="font-size:1.3rem;color:var(--gold);">${asset.allocation}%</div>
                                    </div>
                                    <input type="range" min="0" max="100" value="${asset.allocation}" 
                                           onchange="updateAsset(${idx}, this.value)"
                                           style="width:100%;accent-color:var(--gold);">
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="padding:1rem;background:${balanced ? 'rgba(16,185,129,0.1)' : 'rgba(245,166,35,0.1)'};border-left:3px solid ${balanced ? '#10b981' : 'var(--gold)'};margin-bottom:1.5rem;">
                            <strong>Portfolio Status:</strong><br>
                            ${balanced ? ' Well balanced! Good risk/reward ratio.' : 
                              weightedRisk > 50 ? ' Too risky! Add more proven assets.' :
                              ' Too conservative! Need more upside.'}
                        </div>
                        
                        <div style="padding:1rem;background:rgba(245,166,35,0.1);border-left:3px solid var(--gold);margin-bottom:1.5rem;">
                            <strong>Economics: Risk-Return Tradeoff</strong><br>
                            Higher risk assets offer higher returns but more variance. Diversification reduces risk.
                            Smart GMs balance both.
                        </div>
                        
                        <button class="btn-primary" onclick="finalizePortfolio()" 
                                ${totalAllocation !== 100 ? 'disabled' : ''}
                                style="width:100%;">
                            ${totalAllocation !== 100 ? `Need to allocate exactly 100% (currently ${totalAllocation}%)` : 'Lock In Portfolio'}
                        </button>
                    </div>
                `;
            },
            
            getBalance() {
                const weightedRisk = this.assets.reduce((sum, a) => sum + (a.allocation * a.risk / 100), 0);
                return Math.abs(weightedRisk - 40) < 10;
            }
        };
        
        function updateAsset(idx, value) {
            RiskPortfolio.assets[idx].allocation = parseInt(value);
            RiskPortfolio.render();
        }
        
        function finalizePortfolio() {
            const balanced = RiskPortfolio.getBalance();
            const weightedReturn = RiskPortfolio.assets.reduce((sum, a) => sum + (a.allocation * a.return / 100), 0);
            
            GameState.applyEffects({
                riskExposure: balanced ? -15 : -5,
                optionality: Math.round(weightedReturn / 2),
                informationEdge: 10,
                flags: ['completed_risk_portfolio']
            });
            
            UI.addAlert(`Portfolio locked! ${balanced ? 'Well balanced!' : 'Acceptable risk level.'}`, 'success');
            document.getElementById('screen-trade-puzzle').style.display = 'none';
            GameState.lockRoom('risk');
            UI.updateHubMetrics();
        }
        
        // 
        // GM MENTOR SYSTEM - FULLY EXPANDED
        // 
        
        const GMMentors = {
            mentors: {
                jerry_west: {
                    id: 'jerry_west',
                    name: 'Jerry West',
                    nickname: 'The Logo',
                    emoji: '',
                    era: '1960s-2020s',
                    teams: 'Lakers, Grizzlies, Warriors',
                    championships: '8 as executive',
                    philosophy: 'Star-Driven Excellence',
                    fullBio: 'Built the Showtime Lakers (Magic/Kareem), traded for Kobe Bryant, and architected the modern Warriors dynasty. Jerry believes championships require elite talent - you build around superstars, not systems.',
                    description: 'Built the Showtime Lakers and modern Warriors. Believes championships require superstars.',
                    approvalFactors: {
                        loves: ['star_acquisition', 'aggressive_trades', 'win_now'],
                        hates: ['excessive_patience', 'role_player_focus', 'tanking']
                    },
                    advice: {
                        // General
                        general: "Don't be afraid to make the big move. Stars win championships, not systems.",
                        welcome: "You want to win? Get stars. Everything else is secondary.",
                        
                        // Situation-specific
                        lowRoster: "You need talent NOW. Trade for a proven All-Star or tank hard for the #1 pick. Don't waste time on mediocrity.",
                        highRoster: "You've got the talent. Now surround them with the right pieces and go win it all.",
                        highCap: "Cap space is meant to be used. Go get your superstar. Don't be timid - the big fish are what matter.",
                        lowCap: "Stuck financially? Then you better have stars worth being stuck for. If not, blow it up.",
                        allIn: "I LOVE it. Fortune favors the bold. All-in is the only way to win championships. Half-measures win nothing.",
                        patient: "Patience is fine, but don't wait too long. Championship windows close fast in this league.",
                        risky: "Smart risks win titles. Dumb risks cost jobs. Know the difference.",
                        
                        // Decision-type specific
                        trade: "Every player has a price. If it gets you closer to a title, pull the trigger. Don't fall in love with anyone except superstars.",
                        draft: "Draft the best talent available - especially if it's a potential superstar. Role players you can find anywhere.",
                        signing: "Max contracts for stars are worth it. Mid-level deals for role players are fine. Everything in between is dangerous.",
                        relationships: "Players respect winning more than anything. Build a championship culture, stars will follow.",
                        
                        // After events
                        injury: "This is why you need depth. But don't panic - great players bounce back.",
                        success: "You're winning? Good. Now don't get complacent. Championships are the only thing that matters.",
                        failure: "Losses hurt, but they teach you what you need. Did you lose because of bad luck or bad talent?",
                        
                        // Economics concepts
                        opportunityCost: "Every dollar you don't spend on a star is a dollar wasted. The opportunity cost of mediocrity is your entire career.",
                        timePreference: "Your window is NOW. The future is uncertain. Win today.",
                        riskReturn: "High risk, high reward. That's how championships are won."
                    },
                    challenge: {
                        id: 'west_challenge',
                        title: 'Win Now',
                        description: 'Win a championship within 3 cycles',
                        requirement: 'championships > 0 AND cycleIndex <= 3',
                        reward: 30,
                        completionMessage: 'You did it! I knew you had what it takes to win when it matters!'
                    }
                },
                
                sam_presti: {
                    id: 'sam_presti',
                    name: 'Sam Presti',
                    nickname: 'The Asset King',
                    emoji: '',
                    era: '2007-Present',
                    teams: 'Oklahoma City Thunder',
                    championships: 'Multiple Finals appearances',
                    philosophy: 'Patient Asset Accumulation',
                    fullBio: 'Thunder GM who drafted Durant, Westbrook, and Harden. Known for stockpiling draft picks and playing the long game. Currently holds historic number of future first-round picks. Believes in sustainable success through development.',
                    description: 'OKC architect. Stockpiles picks and develops talent. Plays the long game.',
                    approvalFactors: {
                        loves: ['draft_picks', 'young_talent', 'optionality', 'patience'],
                        hates: ['desperation_moves', 'overpaying', 'rushing']
                    },
                    advice: {
                        general: "Assets compound over time. Today's picks become tomorrow's stars. Be patient and strategic.",
                        welcome: "The best GMs think five years ahead, not five minutes ahead.",
                        
                        lowRoster: "Perfect time to accumulate assets. Tank intelligently, stockpile high picks, and build the right way.",
                        highRoster: "You've got something. Now preserve flexibility while you figure out if this core can win it all.",
                        highCap: "Don't waste cap space just because you have it. Sign the RIGHT star, not just any star. Patience.",
                        lowCap: "Cap problems are opportunity problems. Trade bad contracts for picks and rebuild your flexibility.",
                        allIn: "Be very careful. All-in is risky. Make absolutely sure you have championship-caliber pieces first.",
                        patient: "Excellent. Patience beats panic every single time. Let your assets mature.",
                        risky: "Calculate the downside. If the worst case is catastrophic, don't do it. Preserve optionality.",
                        
                        trade: "Don't fall in love with players. Everything has a price. Always ask: what's the asset return?",
                        draft: "Draft for upside and character. Stars can be developed if you're patient and smart.",
                        signing: "Long-term deals are commitments. Make sure you're committing to the right players.",
                        relationships: "Build genuine relationships. Players and agents remember who treated them right.",
                        
                        injury: "This is why you don't go all-in on injury-prone players. Protect yourself with depth and picks.",
                        success: "Winning is great, but sustainable winning is better. Don't mortgage the future for one ring.",
                        failure: "Failure with assets is fine - you can rebuild. Failure without assets is career-ending.",
                        
                        opportunityCost: "What you give up matters more than what you get. Never forget the opportunity cost.",
                        timePreference: "Low time preference wins long-term. Think decades, not seasons.",
                        optionValue: "Flexibility is valuable. Every decision should preserve some optionality."
                    },
                    challenge: {
                        id: 'presti_challenge',
                        title: 'The Asset King',
                        description: 'Accumulate 5+ decision points with high optionality (>70)',
                        requirement: 'count decisions where optionality increased',
                        reward: 30,
                        completionMessage: 'Perfect execution! You understand the long game like I do!'
                    }
                },
                
                pat_riley: {
                    id: 'pat_riley',
                    name: 'Pat Riley',
                    nickname: 'The Godfather',
                    emoji: '',
                    era: '1980s-Present',
                    teams: 'Lakers, Knicks, Heat',
                    championships: '9 total (coach + exec)',
                    philosophy: 'Culture & Discipline',
                    fullBio: 'Coached Showtime Lakers, built championship Heat culture. Known for demanding excellence, no excuses, and creating environments where stars want to compete. Culture eats strategy for breakfast.',
                    description: 'Heat president. Demands excellence. Culture eats strategy for breakfast.',
                    approvalFactors: {
                        loves: ['culture_building', 'discipline', 'accountability', 'trust'],
                        hates: ['excuses', 'drama', 'shortcuts', 'disrespect']
                    },
                    advice: {
                        general: "Culture is everything. Great players want to play in great organizations. Build that first.",
                        welcome: "Championship culture isn't optional. It's the foundation of everything.",
                        
                        lowRoster: "Don't panic. Use this time to establish championship standards. Culture outlasts talent.",
                        highRoster: "Talent without discipline fails. Make sure your stars buy into the culture.",
                        highCap: "Sign players who fit the culture, not just talented mercenaries. Culture fit matters.",
                        lowCap: "Cap problems are solved by winning. Build a culture players want to sacrifice for.",
                        allIn: "Only go all-in if your culture can sustain championship pressure. Otherwise you'll implode.",
                        patient: "Patience is fine, but never compromise on standards. Demand excellence every day.",
                        risky: "Calculated risks built on strong culture are fine. Desperate risks destroy organizations.",
                        
                        trade: "Trade for fit and character, not just talent. Locker room chemistry is real.",
                        draft: "Draft players with work ethic and coachability. Talent means nothing without discipline.",
                        signing: "Sign players who respect the organization. Divas destroy teams.",
                        relationships: "Build trust. Players will sacrifice millions for organizations they believe in.",
                        
                        injury: "Culture shows up in adversity. Champions find a way. Pretenders make excuses.",
                        success: "Stay humble, stay hungry. Championships don't give you permission to relax.",
                        failure: "Did you lose because you weren't good enough, or because you didn't compete hard enough?",
                        
                        opportunityCost: "The cost of bad culture is your entire franchise. Protect it at all costs.",
                        timePreference: "Build for sustained excellence, not flash-in-the-pan success.",
                        trustIndex: "Trust is earned through consistency. Once broken, it's nearly impossible to rebuild."
                    },
                    challenge: {
                        id: 'riley_challenge',
                        title: 'Culture Builder',
                        description: 'Maintain Trust Index above 70 for all 4 cycles',
                        requirement: 'trustIndex > 70 at end of each cycle',
                        reward: 30,
                        completionMessage: 'Perfect! You built a championship culture that lasts!'
                    }
                },
                
                daryl_morey: {
                    id: 'daryl_morey',
                    name: 'Daryl Morey',
                    nickname: 'The Analytics Pioneer',
                    emoji: '',
                    era: '2006-Present',
                    teams: 'Rockets, 76ers',
                    championships: '1 as President (2024)',
                    philosophy: 'Data-Driven Aggression',
                    fullBio: 'Pioneered analytics in NBA front offices. Built Rockets around 3-point shooting and efficiency. Now with Sixers pursuing championship through mathematical optimization. Believes in stars + math.',
                    description: 'Analytics pioneer. Uses data to make bold, calculated moves. Stars + math.',
                    approvalFactors: {
                        loves: ['analytics', 'stars', 'efficiency', 'calculated_risks'],
                        hates: ['gut_decisions', 'mid-range_mediocrity', 'innumeracy']
                    },
                    advice: {
                        general: "Calculate expected value. Take the mathematically correct risk, even if it feels wrong.",
                        welcome: "The numbers don't lie. Learn to read them and trust them.",
                        
                        lowRoster: "Tank efficiently. Half-tanking is the worst strategy - commit or compete, don't do both poorly.",
                        highRoster: "You've got talent? Good. Now optimize around it. Stars + shooters + efficiency = championships.",
                        highCap: "Max contracts for superstars have positive expected value. Role players are replaceable.",
                        lowCap: "Optimize what you have. Find market inefficiencies. Analytics finds value others miss.",
                        allIn: "If the math supports it, go all-in. Expected value calculations don't care about fear.",
                        patient: "Good, but don't be TOO patient. The goal is to win championships, not accumulate assets forever.",
                        risky: "Run the numbers. If expected value is positive, the risk is worth it. Variance happens.",
                        
                        trade: "Analyze win shares and advanced metrics. Trade for positive-sum outcomes, not big names.",
                        draft: "Draft for upside and fit. Don't reach for need - that's how you miss on stars.",
                        signing: "Pay for impact, not reputation. Analytics shows who's actually moving the needle.",
                        relationships: "Relationships matter, but championships matter more. Make the optimal move.",
                        
                        injury: "Injury risk is priced into contracts. If you accounted for it, don't panic. If you didn't, learn.",
                        success: "Winning validates the process, but variance exists. Don't change a good process based on luck.",
                        failure: "Did the process fail or did variance go against you? Know the difference.",
                        
                        opportunityCost: "Every decision has an expected value. Choose the highest EV option.",
                        riskReturn: "High variance plays with positive expected value win long-term. Embrace them.",
                        informationEdge: "Information asymmetry is your advantage. Know what others don't."
                    },
                    challenge: {
                        id: 'morey_challenge',
                        title: 'Analytics Master',
                        description: 'Make 3 high-risk, high-reward decisions (risk >60, reward potential)',
                        requirement: 'count risky decisions with positive outcomes',
                        reward: 30,
                        completionMessage: 'You trusted the math! Expected value wins long-term!'
                    }
                },
                
                rc_buford: {
                    id: 'rc_buford',
                    name: 'R.C. Buford',
                    nickname: 'The Developer',
                    emoji: '',
                    era: '1994-2019',
                    teams: 'San Antonio Spurs',
                    championships: '5 as GM',
                    philosophy: 'Development & International Scouting',
                    fullBio: 'Spurs GM for 5 championships. Found gems internationally and in late rounds. Developed Parker, Ginobili, Leonard. Mastered sustainable success through elite scouting and player development.',
                    description: 'Spurs dynasty architect. Found hidden gems, developed talent, built sustained excellence.',
                    approvalFactors: {
                        loves: ['development', 'scouting', 'international', 'sustainability', 'character'],
                        hates: ['shortcuts', 'neglecting_development', 'impatience']
                    },
                    advice: {
                        general: "Find undervalued players. Develop them. Sustainable success comes from within.",
                        welcome: "The best organizations build from within. Develop your own stars.",
                        
                        lowRoster: "Perfect time to focus on development. Find your diamonds in the rough.",
                        highRoster: "Keep developing. Today's role player is tomorrow's starter. Never stop improving.",
                        highCap: "Sign players with development upside, not just proven commodities. Growth matters.",
                        lowCap: "Cap constraints force creativity. Find overlooked talent and develop it.",
                        allIn: "Be cautious. Quick fixes rarely work. Sustained excellence requires development.",
                        patient: "Perfect approach. Development takes time but creates loyalty and sustainable success.",
                        risky: "Risk is fine when backed by strong scouting and development infrastructure.",
                        
                        trade: "Trade for character and work ethic. Skills can be taught. Mindset can't.",
                        draft: "Don't overlook international players. Some of the best value in the world.",
                        signing: "Sign players who want to improve. Complacent veterans kill development culture.",
                        relationships: "Invest in your young players. They'll grow with your system and stay loyal.",
                        
                        injury: "This is why development depth matters. Next man up should be ready.",
                        success: "Success comes from systems, not individuals. Keep developing the next wave.",
                        failure: "Did your development system fail, or did you not give players enough time?",
                        
                        optionValue: "Young players represent option value. Don't trade upside for certainty too early.",
                        timePreference: "Favor the future slightly. Developed players stay longer.",
                        sunkCost: "Don't give up on developing players too early. But know when to cut losses."
                    },
                    challenge: {
                        id: 'buford_challenge',
                        title: 'The International Scout',
                        description: 'Draft or sign 2 international players and maintain high optionality',
                        requirement: 'flags includes international_player twice AND optionality > 60 at end',
                        reward: 30,
                        completionMessage: 'You found hidden gems like I did with Parker and Ginobili!'
                    }
                }
            },
            
            currentMentor: null,
            mentorChallenge: null,
            challengeProgress: {
                championships: 0,
                picks_accumulated: 0,
                trust_cycles: 0,
                international_players: 0,
                ev_decisions: 0
            },
            adviceShown: [],
            approvalRating: 50, // 0-100 scale
            interactionCount: 0,
            
            selectMentor(mentorId) {
                this.currentMentor = this.mentors[mentorId];
                this.approvalRating = 50; // Start neutral
                GameState.flags.push(`mentor_${mentorId}`);
                
                // Show welcome message
                setTimeout(() => {
                    this.showAdvicePopup(this.currentMentor.advice.welcome, true);
                }, 1500);
            },
            
            updateApproval(decision) {
                if (!this.currentMentor) return;
                
                const mentor = this.currentMentor;
                let change = 0;
                
                // Check if decision aligns with mentor's philosophy
                const decisionType = this.classifyDecision(decision);
                
                if (mentor.approvalFactors.loves.includes(decisionType)) {
                    change = 10;
                } else if (mentor.approvalFactors.hates.includes(decisionType)) {
                    change = -10;
                }
                
                // Adjust based on outcomes if available
                if (decision.outcome) {
                    if (decision.outcome === 'success') change += 5;
                    if (decision.outcome === 'failure') change -= 5;
                }
                
                this.approvalRating = Math.max(0, Math.min(100, this.approvalRating + change));
                this.interactionCount++;
                
                return change;
            },
            
            classifyDecision(decision) {
                // Classify decision type for approval system
                if (!decision || !decision.optionText) return 'neutral';
                
                const text = decision.optionText.toLowerCase();
                
                if (text.includes('star') || text.includes('superstar')) return 'star_acquisition';
                if (text.includes('pick') || text.includes('draft')) return 'draft_picks';
                if (text.includes('patient') || text.includes('wait')) return 'patience';
                if (text.includes('all-in') || text.includes('commit')) return 'win_now';
                if (text.includes('young') || text.includes('develop')) return 'young_talent';
                if (text.includes('tank')) return 'tanking';
                if (text.includes('culture')) return 'culture_building';
                if (text.includes('analytic') || text.includes('data')) return 'analytics';
                if (text.includes('trade')) return 'aggressive_trades';
                if (text.includes('international')) return 'international';
                
                return 'neutral';
            },
            
            showMentorSelection() {
                const modal = document.getElementById('screen-trade-puzzle');
                const content = document.getElementById('trade-puzzle-content');
                
                content.innerHTML = `
                    <div style="padding:2rem;max-width:1200px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:4rem;margin-bottom:1rem;"></div>
                            <h2 style="color:var(--gold);font-size:2rem;">Choose Your Mentor</h2>
                            <div style="color:var(--text-secondary);font-size:1.1rem;">
                                Learn from a legendary GM. Their philosophy will guide your journey.
                            </div>
                        </div>
                        
                        <div style="display:grid;gap:1.5rem;">
                            ${Object.values(this.mentors).map(mentor => `
                                <div onclick="selectMentorAndClose('${mentor.id}')" 
                                     style="padding:2rem;background:rgba(255,255,255,0.05);border:2px solid var(--border);
                                            border-radius:12px;cursor:pointer;transition:all 0.3s;"
                                     onmouseover="this.style.borderColor='var(--gold)';this.style.background='rgba(245,166,35,0.08)';"
                                     onmouseout="this.style.borderColor='var(--border)';this.style.background='rgba(255,255,255,0.05)';">
                                    
                                    <div style="display:grid;grid-template-columns:auto 1fr;gap:2rem;margin-bottom:1.5rem;">
                                        <div style="text-align:center;">
                                            <div style="font-size:4rem;margin-bottom:0.5rem;">${mentor.emoji}</div>
                                            <div style="font-size:0.75rem;color:var(--text-secondary);">
                                                ${mentor.era}
                                            </div>
                                        </div>
                                        <div>
                                            <div style="font-size:1.5rem;font-weight:bold;color:var(--gold);margin-bottom:0.25rem;">
                                                ${mentor.name}
                                            </div>
                                            <div style="font-size:1rem;color:var(--text-secondary);margin-bottom:0.5rem;">
                                                "${mentor.nickname}"
                                            </div>
                                            <div style="font-size:0.85rem;color:var(--text-secondary);">
                                                 ${mentor.championships}  ${mentor.teams}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom:1.5rem;padding:1.5rem;background:rgba(0,0,0,0.4);border-left:4px solid var(--gold);border-radius:6px;">
                                        <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.5rem;text-transform:uppercase;letter-spacing:0.05em;">
                                            Philosophy
                                        </div>
                                        <div style="font-size:1.2rem;font-weight:600;color:var(--gold);">
                                            ${mentor.philosophy}
                                        </div>
                                    </div>
                                    
                                    <div style="font-size:0.95rem;line-height:1.6;color:var(--text);margin-bottom:1.5rem;">
                                        ${mentor.fullBio}
                                    </div>
                                    
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                                        <div style="padding:1rem;background:rgba(34,197,94,0.1);border-radius:6px;">
                                            <div style="font-size:0.75rem;color:var(--success);margin-bottom:0.5rem;font-weight:600;">
                                                 APPROVES OF
                                            </div>
                                            <div style="font-size:0.85rem;">
                                                ${mentor.approvalFactors.loves.map(l => l.replace(/_/g, ' ')).join(', ')}
                                            </div>
                                        </div>
                                        <div style="padding:1rem;background:rgba(239,68,68,0.1);border-radius:6px;">
                                            <div style="font-size:0.75rem;color:var(--danger);margin-bottom:0.5rem;font-weight:600;">
                                                 DISAPPROVES OF
                                            </div>
                                            <div style="font-size:0.85rem;">
                                                ${mentor.approvalFactors.hates.map(h => h.replace(/_/g, ' ')).join(', ')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },
            
            getAdvice(situation) {
                if (!this.currentMentor) return null;
                
                const mentor = this.currentMentor;
                let advice = mentor.advice.general;
                
                // Determine best advice for situation
                if (situation) {
                    advice = mentor.advice[situation] || advice;
                } else {
                    // Auto-detect situation
                    if (GameState.rosterQuality < 40) {
                        advice = mentor.advice.lowRoster || advice;
                    } else if (GameState.rosterQuality > 70) {
                        advice = mentor.advice.highRoster || advice;
                    } else if (GameState.capFlexibility > 70) {
                        advice = mentor.advice.highCap || advice;
                    } else if (GameState.capFlexibility < 30) {
                        advice = mentor.advice.lowCap || advice;
                    } else if (GameState.optionality > 70) {
                        advice = mentor.advice.patient || advice;
                    } else if (GameState.flags.includes('all_in_mode')) {
                        advice = mentor.advice.allIn || advice;
                    }
                }
                
                // Don't repeat advice too soon
                if (this.adviceShown.includes(advice)) {
                    return mentor.advice.general;
                }
                
                this.adviceShown.push(advice);
                if (this.adviceShown.length > 8) {
                    this.adviceShown.shift(); // Keep last 8
                }
                
                return advice;
            },
            
            showAdvice() {
                if (!this.currentMentor) return;
                const advice = this.getAdvice();
                
                // 40% chance to show advice
                if (advice && Math.random() < 0.4) {
                    this.showAdvicePopup(advice);
                }
            },
            
            showAdvicePopup(advice, isWelcome = false) {
                const popup = document.createElement('div');
                const rating = this.getApprovalRating();
                
                popup.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    max-width: 380px;
                    padding: 1.5rem;
                    background: linear-gradient(135deg, ${rating.color}dd, ${rating.color}bb);
                    border: 2px solid ${rating.color};
                    border-radius: 12px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                    z-index: 10000;
                    animation: slideInRight 0.5s ease;
                    color: #000;
                `;
                
                popup.innerHTML = `
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                        <div style="font-size:2.5rem;">${this.currentMentor.emoji}</div>
                        <div style="flex:1;">
                            <div style="font-weight:bold;font-size:1.1rem;">${this.currentMentor.name}</div>
                            <div style="font-size:0.75rem;opacity:0.9;">
                                ${isWelcome ? 'Welcome Message' : 'Mentor Advice'}  Approval: ${Math.round(this.approvalRating)}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(0,0,0,0.2);padding:1rem;border-radius:6px;margin-bottom:1rem;">
                        <div style="font-size:0.95rem;line-height:1.5;font-style:italic;">
                            "${advice}"
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:0.5rem;">
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="flex:1;padding:0.6rem;background:#000;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.85rem;">
                            Got it, ${this.currentMentor.name.split(' ')[0]}
                        </button>
                        ${!isWelcome ? `
                            <button onclick="GMMentors.showMentorProfile()" 
                                    style="padding:0.6rem 1rem;background:rgba(0,0,0,0.3);color:#000;border:2px solid #000;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.85rem;">
                                 Profile
                            </button>
                        ` : ''}
                    </div>
                `;
                
                document.body.appendChild(popup);
                
                // Auto-remove after 12 seconds
                setTimeout(() => {
                    if (popup.parentElement) {
                        popup.style.animation = 'fadeOut 0.5s ease';
                        setTimeout(() => popup.remove(), 500);
                    }
                }, 12000);
            },
            
            getApprovalRating() {
                const rating = this.approvalRating;
                if (rating >= 80) return { level: 'Trusts You', color: '#22c55e', emoji: '' };
                if (rating >= 60) return { level: 'Approves', color: '#3b82f6', emoji: '' };
                if (rating >= 40) return { level: 'Neutral', color: '#f59e0b', emoji: '' };
                if (rating >= 20) return { level: 'Concerned', color: '#ef4444', emoji: '' };
                return { level: 'Very Disappointed', color: '#991b1b', emoji: '' };
            },
            
            showMentorProfile() {
                // Remove any existing popups
                document.querySelectorAll('div[style*="position: fixed"]').forEach(el => {
                    if (el.textContent.includes(this.currentMentor?.name)) el.remove();
                });
                
                const modal = document.getElementById('screen-replay');
                const content = document.getElementById('replay-content');
                const rating = this.getApprovalRating();
                
                content.innerHTML = `
                    <div style="padding:2rem;max-width:800px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:5rem;margin-bottom:1rem;">${this.currentMentor.emoji}</div>
                            <h2 style="color:var(--gold);font-size:2.5rem;margin-bottom:0.5rem;">
                                ${this.currentMentor.name}
                            </h2>
                            <div style="font-size:1.2rem;color:var(--text-secondary);margin-bottom:0.5rem;">
                                "${this.currentMentor.nickname}"
                            </div>
                            <div style="font-size:0.9rem;color:var(--text-secondary);">
                                ${this.currentMentor.teams}  ${this.currentMentor.championships}
                            </div>
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.05);padding:2rem;border-radius:8px;margin-bottom:2rem;">
                            <div style="text-align:center;margin-bottom:1.5rem;">
                                <div style="font-size:3rem;margin-bottom:0.5rem;">${rating.emoji}</div>
                                <div style="font-size:1.5rem;font-weight:bold;color:${rating.color};">
                                    ${rating.level}
                                </div>
                                <div style="font-size:0.9rem;color:var(--text-secondary);margin-top:0.5rem;">
                                    Approval Rating: ${Math.round(this.approvalRating)}%
                                </div>
                            </div>
                            
                            <div style="background:rgba(0,0,0,0.3);height:12px;border-radius:6px;overflow:hidden;">
                                <div style="width:${this.approvalRating}%;height:100%;background:linear-gradient(90deg,${rating.color},${rating.color}dd);transition:width 0.5s;"></div>
                            </div>
                        </div>
                        
                        <div style="background:rgba(245,166,35,0.1);padding:1.5rem;border-left:4px solid var(--gold);border-radius:8px;margin-bottom:2rem;">
                            <div style="font-size:0.9rem;color:var(--gold);margin-bottom:0.5rem;font-weight:600;">
                                PHILOSOPHY
                            </div>
                            <div style="font-size:1.1rem;font-weight:600;margin-bottom:1rem;">
                                ${this.currentMentor.philosophy}
                            </div>
                            <div style="font-size:0.95rem;line-height:1.6;">
                                ${this.currentMentor.fullBio}
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">
                            <div style="padding:1.5rem;background:rgba(34,197,94,0.1);border:2px solid var(--success);border-radius:8px;">
                                <div style="font-size:0.85rem;color:var(--success);margin-bottom:1rem;font-weight:600;">
                                     APPROVES OF
                                </div>
                                <div style="display:flex;flex-direction:column;gap:0.5rem;">
                                    ${this.currentMentor.approvalFactors.loves.map(l => 
                                        `<div style="font-size:0.9rem;"> ${l.replace(/_/g, ' ')}</div>`
                                    ).join('')}
                                </div>
                            </div>
                            <div style="padding:1.5rem;background:rgba(239,68,68,0.1);border:2px solid var(--danger);border-radius:8px;">
                                <div style="font-size:0.85rem;color:var(--danger);margin-bottom:1rem;font-weight:600;">
                                     DISAPPROVES OF
                                </div>
                                <div style="display:flex;flex-direction:column;gap:0.5rem;">
                                    ${this.currentMentor.approvalFactors.hates.map(h => 
                                        `<div style="font-size:0.9rem;"> ${h.replace(/_/g, ' ')}</div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:8px;margin-bottom:2rem;">
                            <div style="font-size:0.9rem;color:var(--gold);margin-bottom:1rem;font-weight:600;">
                                 INTERACTION STATS
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                                <div>
                                    <div style="font-size:0.8rem;color:var(--text-secondary);">Decisions Made</div>
                                    <div style="font-size:1.5rem;font-weight:bold;">${this.interactionCount}</div>
                                </div>
                                <div>
                                    <div style="font-size:0.8rem;color:var(--text-secondary);">Advice Given</div>
                                    <div style="font-size:1.5rem;font-weight:bold;">${this.adviceShown.length}</div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn-primary" onclick="document.getElementById('screen-replay').style.display='none'" style="width:100%;padding:1rem;">
                            Return to Game
                        </button>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },
            
            // 
            // FEATURE 1: MENTOR CHALLENGES
            // 
            
            initChallenge() {
                if (!this.currentMentor || !this.currentMentor.challenge) return;
                this.mentorChallenge = {
                    ...this.currentMentor.challenge,
                    started: true,
                    completed: false,
                    progress: 0
                };
            },
            
            updateChallengeProgress(decision) {
                if (!this.mentorChallenge || this.mentorChallenge.completed) return;
                
                const challengeId = this.mentorChallenge.id;
                
                // Track progress based on challenge type
                if (challengeId === 'west_challenge') {
                    // Check for championship
                    if (GameState.championships > 0 && GameState.cycleIndex <= 3) {
                        this.completeChallenge();
                    }
                } else if (challengeId === 'presti_challenge') {
                    // Track optionality decisions
                    if (GameState.optionality > 70) {
                        this.challengeProgress.picks_accumulated++;
                        if (this.challengeProgress.picks_accumulated >= 5) {
                            this.completeChallenge();
                        }
                    }
                } else if (challengeId === 'riley_challenge') {
                    // Track trust cycles
                    if (GameState.trustIndex > 70) {
                        this.challengeProgress.trust_cycles++;
                    }
                    if (GameState.cycleIndex === 4 && this.challengeProgress.trust_cycles >= 4) {
                        this.completeChallenge();
                    }
                } else if (challengeId === 'morey_challenge') {
                    // Track high-risk decisions
                    if (GameState.riskExposure > 60) {
                        this.challengeProgress.ev_decisions++;
                        if (this.challengeProgress.ev_decisions >= 3) {
                            this.completeChallenge();
                        }
                    }
                } else if (challengeId === 'buford_challenge') {
                    // Track international players and optionality
                    const intlCount = GameState.flags.filter(f => f.includes('international')).length;
                    if (intlCount >= 2 && GameState.optionality > 60) {
                        this.completeChallenge();
                    }
                }
            },
            
            completeChallenge() {
                if (!this.mentorChallenge || this.mentorChallenge.completed) return;
                
                this.mentorChallenge.completed = true;
                this.approvalRating = Math.min(100, this.approvalRating + this.mentorChallenge.reward);
                
                // Show completion popup
                setTimeout(() => {
                    const popup = document.createElement('div');
                    popup.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        max-width: 500px;
                        padding: 2rem;
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        border: 3px solid var(--gold);
                        border-radius: 16px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.6);
                        z-index: 10001;
                        animation: bounceIn 0.6s ease;
                        text-align: center;
                        color: #000;
                    `;
                    
                    popup.innerHTML = `
                        <div style="font-size:5rem;margin-bottom:1rem;"></div>
                        <div style="font-size:1.8rem;font-weight:bold;margin-bottom:1rem;">
                            CHALLENGE COMPLETE!
                        </div>
                        <div style="font-size:1.2rem;margin-bottom:1.5rem;font-weight:600;">
                            ${this.mentorChallenge.title}
                        </div>
                        <div style="background:rgba(0,0,0,0.3);padding:1.5rem;border-radius:8px;margin-bottom:1.5rem;">
                            <div style="font-size:3rem;margin-bottom:0.5rem;">${this.currentMentor.emoji}</div>
                            <div style="font-style:italic;line-height:1.5;">
                                "${this.mentorChallenge.completionMessage}"
                            </div>
                        </div>
                        <div style="font-size:1.5rem;font-weight:bold;color:#fff;margin-bottom:1rem;">
                            +${this.mentorChallenge.reward}% Approval!
                        </div>
                        <button onclick="this.parentElement.remove()" 
                                style="width:100%;padding:1rem;background:#000;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:1.1rem;">
                            Amazing! Thanks ${this.currentMentor.name}!
                        </button>
                    `;
                    
                    document.body.appendChild(popup);
                    UI.updateMentorWidget();
                }, 500);
            },
            
            showChallengeWidget() {
                if (!this.mentorChallenge) return '';
                
                const progress = this.getChallengeProgress();
                const statusColor = this.mentorChallenge.completed ? '#22c55e' : 
                                   progress > 50 ? '#f59e0b' : '#6b7280';
                
                return `
                    <div style="margin-top:1rem;padding:1rem;background:rgba(245,166,35,0.1);border:2px solid var(--gold);border-radius:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                            <div style="font-size:0.85rem;font-weight:600;color:var(--gold);">
                                 ${this.mentorChallenge.title}
                            </div>
                            <div style="font-size:0.85rem;font-weight:bold;color:${statusColor};">
                                ${this.mentorChallenge.completed ? ' COMPLETE' : `${Math.round(progress)}%`}
                            </div>
                        </div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.5rem;">
                            ${this.mentorChallenge.description}
                        </div>
                        <div style="background:rgba(0,0,0,0.3);height:6px;border-radius:3px;overflow:hidden;">
                            <div style="width:${progress}%;height:100%;background:${statusColor};transition:width 0.5s;"></div>
                        </div>
                    </div>
                `;
            },
            
            getChallengeProgress() {
                if (!this.mentorChallenge) return 0;
                if (this.mentorChallenge.completed) return 100;
                
                const id = this.mentorChallenge.id;
                if (id === 'west_challenge') {
                    return GameState.championships > 0 ? 100 : (GameState.cycleIndex / 3) * 100;
                } else if (id === 'presti_challenge') {
                    return Math.min(100, (this.challengeProgress.picks_accumulated / 5) * 100);
                } else if (id === 'riley_challenge') {
                    return (this.challengeProgress.trust_cycles / 4) * 100;
                } else if (id === 'morey_challenge') {
                    return Math.min(100, (this.challengeProgress.ev_decisions / 3) * 100);
                } else if (id === 'buford_challenge') {
                    const intlCount = GameState.flags.filter(f => f.includes('international')).length;
                    const optGood = GameState.optionality > 60;
                    return ((intlCount / 2) * 70 + (optGood ? 30 : 0));
                }
                return 0;
            },
            
            // 
            // FEATURE 2: MENTOR QUICK ADVICE (Simplified from Debate)
            // 
            
            // Removed complex debate system - replaced with single mentor voice
            triggerDebate(decision) {
                // Now just shows mentor's take on the decision (20% chance, non-intrusive)
                if (Math.random() > 0.2 || !this.currentMentor) return;
                
                this.showMentorReaction(decision);
            },
            
            showMentorReaction(decision) {
                const mentor = this.currentMentor;
                const effects = decision.effects || {};
                
                // Generate contextual reaction
                let reaction = '';
                let emoji = '';
                
                // Check if decision aligns with mentor philosophy
                const isAggressive = effects.rosterQuality > 10 || effects.optionality < -10;
                const isPatient = effects.optionality > 10 || (effects.rosterQuality < 5 && effects.capFlexibility > 5);
                const isRisky = effects.riskExposure > 10;
                
                if (mentor.id === 'jerry_west') {
                    if (isAggressive) {
                        reaction = "That's the kind of move I respect. Go get your star.";
                        emoji = '';
                    } else if (isPatient) {
                        reaction = "Hmm. I understand, but don't wait too long. Windows close.";
                        emoji = '';
                    } else {
                        reaction = "Solid move. Keep building toward that championship.";
                        emoji = '';
                    }
                } else if (mentor.id === 'sam_presti') {
                    if (isPatient) {
                        reaction = "Perfect. Patience and assets win in the long run.";
                        emoji = '';
                    } else if (isAggressive) {
                        reaction = "Bold move. Make sure you're not mortgaging the future.";
                        emoji = '';
                    } else {
                        reaction = "Good process. Trust the system.";
                        emoji = '';
                    }
                } else if (mentor.id === 'pat_riley') {
                    reaction = isAggressive ? 
                        "Championship mentality. That's Heat Culture." :
                        "Remember - excellence requires commitment, not half-measures.";
                    emoji = isAggressive ? '' : '';
                } else if (mentor.id === 'daryl_morey') {
                    reaction = isRisky ?
                        "High variance play. The math says it's worth it if the upside is there." :
                        "Solid expected value decision. The numbers support this.";
                    emoji = '';
                } else {
                    reaction = "Interesting choice. Let's see how it plays out.";
                    emoji = '';
                }
                
                // Show as a subtle toast notification (non-modal)
                this.showMentorToast(emoji, mentor.name, reaction);
            },
            
            showMentorToast(emoji, mentorName, message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    max-width: 350px;
                    padding: 1rem 1.25rem;
                    background: linear-gradient(135deg, #1e293b, #0f172a);
                    border: 2px solid var(--gold);
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
                    z-index: 9000;
                    animation: slideInRight 0.4s ease;
                `;
                
                toast.innerHTML = `
                    <div style="display:flex;align-items:flex-start;gap:0.75rem;">
                        <div style="font-size:1.5rem;">${emoji}</div>
                        <div style="flex:1;">
                            <div style="font-size:0.75rem;color:var(--gold);margin-bottom:0.25rem;">${mentorName}</div>
                            <div style="font-size:0.9rem;color:#fff;line-height:1.4;">${message}</div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background:none;border:none;color:#7a8a9e;cursor:pointer;font-size:1.2rem;padding:0;"></button>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.style.animation = 'fadeOut 0.4s ease';
                        setTimeout(() => toast.remove(), 400);
                    }
                }, 6000);
            },
            
            // 
            // FEATURE 3: CALL YOUR MENTOR
            // 
            
            callsRemaining: 2,
            
            canCallMentor() {
                return this.currentMentor && this.callsRemaining > 0;
            },
            
            callMentor(scenario) {
                if (!this.canCallMentor()) return null;
                
                this.callsRemaining--;
                
                // DEEP ANALYSIS - Rate each option based on mentor's ACTUAL philosophy
                const ratings = scenario.options.map((option, idx) => {
                    const analysis = this.analyzeOptionForMentor(option, scenario);
                    
                    return {
                        index: idx,
                        stars: analysis.stars,
                        advice: analysis.advice
                    };
                });
                
                return {
                    ratings: ratings,
                    callsLeft: this.callsRemaining,
                    generalAdvice: this.getContextualAdvice(scenario)
                };
            },
            
            analyzeOptionForMentor(option, scenario) {
                const mentor = this.currentMentor;
                const text = (option.text || '').toLowerCase();
                const rationale = (option.rationale || '').toLowerCase();
                const effects = option.effects || {};
                
                let stars = 2; // Default neutral
                let reasoning = '';
                
                console.log('Analyzing for', mentor.id, '- Option:', text);
                console.log('Effects:', effects);
                
                // 
                // JERRY WEST - Star-Driven, Win-Now
                // 
                if (mentor.id === 'jerry_west') {
                    // Check EFFECTS first (most reliable)
                    if ((effects.rosterQuality || 0) > 10) {
                        stars = 3;
                        reasoning = "This gets you talent. That's what wins championships.";
                    }
                    else if ((effects.rosterQuality || 0) < -10) {
                        stars = 1;
                        reasoning = "You're getting worse. Unacceptable.";
                    }
                    // Check for win-now keywords
                    else if (text.match(/star|max.*contract|aggressive|all.?in|compete.*now/i)) {
                        stars = 3;
                        reasoning = "I LOVE it. Be bold. Stars win championships.";
                    }
                    // Check for patience keywords (Jerry hates)
                    else if (text.match(/tank|patient|wait|rebuild.*slow/i)) {
                        stars = 1;
                        reasoning = "Too patient. Windows close. Act NOW.";
                    }
                    // Check for talent acquisition
                    else if (text.match(/enter.*tax|commit.*resource/i) && (effects.capFlexibility || 0) < 0) {
                        stars = 3;
                        reasoning = "Use your resources. Go get talent.";
                    }
                    else {
                        stars = 2;
                        reasoning = "Could work. But I'd be bolder.";
                    }
                }
                
                // 
                // SAM PRESTI - Asset Accumulation, Patience
                // 
                else if (mentor.id === 'sam_presti') {
                    // Check EFFECTS first
                    if ((effects.optionality || 0) > 10) {
                        stars = 3;
                        reasoning = "Love it. This preserves flexibility and options.";
                    }
                    else if ((effects.optionality || 0) < -15) {
                        stars = 1;
                        reasoning = "You're killing your flexibility. Keep more options open.";
                    }
                    // Check for asset keywords
                    else if (text.match(/pick|asset|draft|flexibility|preserve|diversify/i)) {
                        stars = 3;
                        reasoning = "Assets are king. Always accumulate.";
                    }
                    // Check for patience keywords  
                    else if (text.match(/tank|patient|rebuild|young.*develop/i)) {
                        stars = 3;
                        reasoning = "Patience builds championships. Trust the process.";
                    }
                    // Check for desperate moves (Presti hates)
                    else if (text.match(/all.?in|desperate|commit.*resource.*tax/i)) {
                        stars = 1;
                        reasoning = "Too desperate. Don't mortgage the future.";
                    }
                    else {
                        stars = 2;
                        reasoning = "Not bad, but I'd want more assets.";
                    }
                }
                
                // 
                // PAT RILEY - Culture, Discipline
                // 
                else if (mentor.id === 'pat_riley') {
                    // Check trust effects
                    if ((effects.trustIndex || 0) > 10) {
                        stars = 3;
                        reasoning = "This builds trust. Culture is everything.";
                    }
                    else if ((effects.trustIndex || 0) < -10) {
                        stars = 1;
                        reasoning = "This breaks trust. You'll lose the locker room.";
                    }
                    // Check for culture keywords
                    else if (text.match(/culture|trust|discipline|accountab|character/i)) {
                        stars = 3;
                        reasoning = "Culture is everything. This is how you win.";
                    }
                    // Check for shortcuts (Riley hates)
                    else if (text.match(/shortcut|easy.*way|quick.*fix/i)) {
                        stars = 1;
                        reasoning = "No shortcuts. Do it right or don't do it.";
                    }
                    else {
                        stars = 2;
                        reasoning = "Acceptable, but where's the culture emphasis?";
                    }
                }
                
                // 
                // DARYL MOREY - Analytics, Efficiency
                // 
                else if (mentor.id === 'daryl_morey') {
                    // Check for analytics keywords
                    if (text.match(/analytic|data|efficiency|optimize|math|expected.*value/i)) {
                        stars = 3;
                        reasoning = "Data-driven. This is how smart teams operate.";
                    }
                    // Check for gut decisions (Morey hates)
                    else if (text.match(/gut|feeling|instinct|hunch/i)) {
                        stars = 1;
                        reasoning = "Gut feelings lose games. Use data.";
                    }
                    // Check for star accumulation
                    else if (text.match(/star/i) && (effects.rosterQuality || 0) > 5) {
                        stars = 3;
                        reasoning = "Stars + analytics = championships.";
                    }
                    else {
                        stars = 2;
                        reasoning = "It's okay, but have you run the numbers?";
                    }
                }
                
                // 
                // R.C. BUFORD - Development, Scouting
                // 
                else if (mentor.id === 'rc_buford') {
                    // Check for development keywords
                    if (text.match(/develop|international|scout|young.*invest|character.*work/i)) {
                        stars = 3;
                        reasoning = "Development builds sustained excellence. Perfect.";
                    }
                    // Check for shortcuts (Buford hates)
                    else if (text.match(/shortcut|quick.*fix|win.*now.*abandon/i)) {
                        stars = 1;
                        reasoning = "No shortcuts. Development takes time.";
                    }
                    else {
                        stars = 2;
                        reasoning = "It's fine, but are you developing your players?";
                    }
                }
                
                console.log('Result:', stars, 'stars -', reasoning);
                
                return {
                    stars: stars,
                    advice: reasoning
                };
            },
            
            getGenericAdvice(stars) {
                const phrases = {
                    3: ["This is the move.", "I strongly recommend this.", "This gets you closer to your goal.", "Good instinct here."],
                    2: ["Could work.", "Middle of the road.", "Not bad, not great.", "Safe choice."],
                    1: ["I don't like this.", "This could backfire.", "Be very careful here.", "I'd reconsider."]
                };
                return phrases[stars][Math.floor(Math.random() * phrases[stars].length)];
            },
            
            getContextualAdvice(scenario) {
                // Get situation-appropriate advice from mentor
                if (GameState.rosterQuality < 40) {
                    return this.currentMentor.advice.lowRoster || this.currentMentor.advice.general;
                } else if (GameState.rosterQuality > 70) {
                    return this.currentMentor.advice.highRoster || this.currentMentor.advice.general;
                } else if (GameState.capFlexibility < 30) {
                    return this.currentMentor.advice.lowCap || this.currentMentor.advice.general;
                } else {
                    return this.currentMentor.advice.general;
                }
            },
            
            getMentorAdviceForOption(option, stars) {
                // This is now handled by analyzeOptionForMentor
                return this.getGenericAdvice(stars);
            },
            
            // 
            // LEGENDARY UPGRADES START HERE
            // 
            
            // UPGRADE 1: MENTOR RELATIONSHIP DEPTH
            relationship: {
                trust: 50,        // 0-100: How much they trust you
                respect: 50,      // 0-100: Professional respect
                friendship: 0,    // 0-100: Personal bond
                disappointment: 0 // 0-100: Accumulated letdowns
            },
            
            // UPGRADE 2: MENTOR EMOTIONAL STATES
            currentMood: 'neutral', // excited, concerned, angry, proud, disappointed
            lastInteraction: null,
            
            getMood() {
                if (this.approvalRating >= 90) return 'proud';
                if (this.approvalRating >= 70) return 'excited';
                if (this.approvalRating >= 40) return 'neutral';
                if (this.approvalRating >= 20) return 'concerned';
                return 'disappointed';
            },
            
            // UPGRADE 3: MENTOR PERSONAL STORIES
            unlockPersonalStory(trigger) {
                const stories = {
                    first_championship: {
                        mentor: 'jerry_west',
                        title: "Jerry's 1972 Lakers Championship",
                        story: `You know, when I finally won as a player in 1972, it changed everything. 
                        I'd lost 8 times in the Finals before that. EIGHT TIMES. 
                        
                        People thought I'd never win. I thought I'd never win.
                        
                        But that '72 team? 33-game win streak. We were unstoppable.
                        
                        The lesson? Sometimes you have to keep pushing through failure after failure.
                        Your first championship as a GM reminds me of that feeling.
                        
                        Savor this. It never gets old.`,
                        unlocked: false
                    },
                    major_trade: {
                        mentor: 'sam_presti',
                        title: "Sam's Harden Trade Regret",
                        story: `Let me tell you about 2012. We had Durant, Westbrook, and Harden.
                        Young. Talented. Just been to the Finals.
                        
                        I traded Harden for role players and picks. It made financial sense.
                        The owner wouldn't pay the luxury tax.
                        
                        But I think about it every single day. What if we'd kept them together?
                        Three MVPs on one team.
                        
                        Sometimes the "smart" decision haunts you forever.
                        Be very careful with generational talent.`,
                        unlocked: false
                    },
                    culture_success: {
                        mentor: 'pat_riley',
                        title: "Pat's Heat Culture",
                        story: `2006. Shaq and Wade. We won the championship.
                        But you want to know the real story?
                        
                        In 2008, we went 15-67. Worst record in the league.
                        Players wanted out. Media killed us. Fans stopped coming.
                        
                        But we never compromised on culture. Not once.
                        We drafted Wade in '03. We built the right way.
                        When LeBron and Bosh came in 2010, the culture was ready.
                        
                        That's why we won 2 more championships.
                        Culture outlasts talent. Always.`,
                        unlocked: false
                    }
                };
                
                const story = stories[trigger];
                if (story && story.mentor === this.currentMentor.id && !story.unlocked) {
                    story.unlocked = true;
                    this.showPersonalStory(story);
                }
            },
            
            showPersonalStory(story) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.95);
                    z-index: 10002;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.5s ease;
                `;
                
                modal.innerHTML = `
                    <div style="max-width:800px;padding:3rem;background:linear-gradient(135deg,#1a1a2e,#16213e);border:3px solid var(--gold);border-radius:16px;position:relative;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:4rem;margin-bottom:1rem;">${this.currentMentor.emoji}</div>
                            <div style="font-size:0.9rem;color:var(--gold);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:0.5rem;">
                                Personal Story Unlocked
                            </div>
                            <h2 style="font-size:2rem;color:var(--gold);">${story.title}</h2>
                        </div>
                        
                        <div style="background:rgba(0,0,0,0.4);padding:2rem;border-left:4px solid var(--gold);border-radius:8px;margin-bottom:2rem;">
                            <div style="font-size:1.1rem;line-height:1.8;white-space:pre-line;font-style:italic;">
                                ${story.story}
                            </div>
                        </div>
                        
                        <div style="text-align:center;">
                            <button onclick="this.closest('[style*=fixed]').remove()" 
                                    class="btn-primary" 
                                    style="padding:1rem 3rem;font-size:1.1rem;">
                                Thank you for sharing, ${this.currentMentor.name}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            // UPGRADE 4: MENTOR PROGRESSION SYSTEM
            mentorLevel: 1, // Level up as relationship grows
            mentorXP: 0,
            
            gainXP(amount) {
                this.mentorXP += amount;
                const xpNeeded = this.mentorLevel * 100;
                
                if (this.mentorXP >= xpNeeded) {
                    this.mentorLevel++;
                    this.mentorXP = 0;
                    this.levelUpMentor();
                }
            },
            
            levelUpMentor() {
                const rewards = {
                    2: { name: 'Deeper Insights', effect: 'More detailed advice' },
                    3: { name: 'Personal Network', effect: 'Unlock mentor connections' },
                    4: { name: 'War Stories', effect: 'Unlock personal stories' },
                    5: { name: 'Ultimate Trust', effect: 'Mentor becomes co-GM' }
                };
                
                const reward = rewards[this.mentorLevel];
                if (reward) {
                    this.showLevelUp(reward);
                }
            },
            
            showLevelUp(reward) {
                const popup = document.createElement('div');
                popup.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    padding: 2.5rem;
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    border: 4px solid var(--gold);
                    border-radius: 20px;
                    z-index: 10003;
                    text-align: center;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.7);
                    animation: bounceIn 0.6s ease;
                    color: #000;
                `;
                
                popup.innerHTML = `
                    <div style="font-size:6rem;margin-bottom:1rem;"></div>
                    <div style="font-size:2.5rem;font-weight:bold;margin-bottom:1rem;">
                        LEVEL UP!
                    </div>
                    <div style="font-size:1.3rem;margin-bottom:1rem;">
                        ${this.currentMentor.name} - Level ${this.mentorLevel}
                    </div>
                    <div style="background:rgba(0,0,0,0.3);padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;">
                        <div style="font-size:1.1rem;font-weight:600;margin-bottom:0.5rem;">
                             New Ability Unlocked:
                        </div>
                        <div style="font-size:1.5rem;font-weight:bold;color:#fff;margin-bottom:0.5rem;">
                            ${reward.name}
                        </div>
                        <div style="font-size:0.95rem;">
                            ${reward.effect}
                        </div>
                    </div>
                    <button onclick="this.parentElement.remove()" 
                            style="width:100%;padding:1.2rem;background:#000;color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:bold;font-size:1.2rem;">
                        Incredible!
                    </button>
                `;
                
                document.body.appendChild(popup);
            },
            
            // UPGRADE 5: MENTOR SPECIAL ABILITIES (UNLOCK WITH LEVELS)
            specialAbilities: {
                network_introduction: {
                    unlockLevel: 3,
                    used: false,
                    description: "Mentor introduces you to their network",
                    effect: "One-time: Get a discount on next signing or better draft intel"
                },
                crisis_intervention: {
                    unlockLevel: 4,
                    uses: 2,
                    description: "Mentor steps in during crisis",
                    effect: "Reduce negative outcome by 50%"
                },
                co_gm_mode: {
                    unlockLevel: 5,
                    active: false,
                    description: "Mentor becomes your co-GM",
                    effect: "Appears in EVERY decision with advice"
                }
            },
            
            useSpecialAbility(ability) {
                const special = this.specialAbilities[ability];
                
                if (this.mentorLevel < special.unlockLevel) {
                    return { error: 'Not unlocked yet' };
                }
                
                if (ability === 'network_introduction' && special.used) {
                    return { error: 'Already used' };
                }
                
                if (ability === 'crisis_intervention' && special.uses <= 0) {
                    return { error: 'No uses remaining' };
                }
                
                return this.activateAbility(ability);
            },
            
            // UPGRADE 6: DYNAMIC MENTOR DIALOGUE SYSTEM
            dialogueHistory: [],
            conversationDepth: 0,
            
            generateContextualDialogue(situation) {
                this.conversationDepth++;
                const mood = this.getMood();
                const level = this.mentorLevel;
                
                // High-level mentors give deeper, more personal advice
                if (level >= 4) {
                    return this.getDeepAdvice(situation, mood);
                } else if (level >= 2) {
                    return this.getIntermediateAdvice(situation, mood);
                } else {
                    return this.getBasicAdvice(situation, mood);
                }
            },
            
            getDeepAdvice(situation, mood) {
                // Level 4+ mentors reference past decisions and show vulnerability
                const mentor = this.currentMentor;
                const templates = {
                    proud: `You know, ${GameState.cycleIndex === 1 ? 'I see a lot of myself in you' : 'you remind me why I love this game'}. {advice}. Trust your instincts - they've been solid.`,
                    concerned: `I'm worried about you. {advice}. I made similar mistakes early in my career. Let me help you avoid them.`,
                    disappointed: `We need to have a serious conversation. {advice}. I believe in you, but you're not listening to what I'm trying to teach you.`
                };
                
                return templates[mood] || templates.proud;
            },
            
            // UPGRADE 7: MENTOR CONFRONTATION SYSTEM
            confrontationTriggered: false,
            
            triggerConfrontation() {
                if (this.approvalRating < 30 && !this.confrontationTriggered) {
                    this.confrontationTriggered = true;
                    this.showConfrontation();
                }
            },
            
            showConfrontation() {
                const modal = document.getElementById('screen-replay');
                const content = document.getElementById('replay-content');
                
                content.innerHTML = `
                    <div style="padding:3rem;max-width:900px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:5rem;margin-bottom:1rem;"></div>
                            <h2 style="color:#ef4444;font-size:2.5rem;">We Need to Talk</h2>
                        </div>
                        
                        <div style="background:rgba(239,68,68,0.1);border:3px solid #ef4444;padding:2.5rem;border-radius:12px;margin-bottom:2rem;">
                            <div style="font-size:1.3rem;font-weight:bold;margin-bottom:1.5rem;color:#ef4444;">
                                ${this.currentMentor.emoji} ${this.currentMentor.name}:
                            </div>
                            <div style="font-size:1.1rem;line-height:1.8;margin-bottom:1.5rem;">
                                "Look, I agreed to mentor you because I saw potential. But you're not listening.
                                <br><br>
                                Every decision we've discussed, you've gone the opposite direction. 
                                You asked for my help, but you're ignoring everything I'm trying to teach you.
                                <br><br>
                                I don't mentor people who don't want to be mentored."
                            </div>
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.05);padding:2rem;border-radius:8px;margin-bottom:2rem;">
                            <div style="font-size:1rem;margin-bottom:1.5rem;">
                                <strong>This is a critical moment in your relationship.</strong>
                            </div>
                            <div style="font-size:0.95rem;line-height:1.6;">
                                You can either:
                                <br><br>
                                1) <strong>Commit to your mentor's philosophy</strong> - Start making decisions that align with their approach
                                <br><br>
                                2) <strong>Part ways and continue alone</strong> - Lose mentor benefits but maintain your independence
                                <br><br>
                                3) <strong>Find a new mentor</strong> - Switch to someone whose philosophy matches your actual style
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">
                            <button class="btn-primary" onclick="GMMentors.commitToMentor()" 
                                    style="padding:1.2rem;background:#22c55e;">
                                I'll do better
                            </button>
                            <button class="btn-ghost" onclick="GMMentors.goSolo()" 
                                    style="padding:1.2rem;">
                                I'll go solo
                            </button>
                            <button class="btn-primary" onclick="GMMentors.showMentorSelection()" 
                                    style="padding:1.2rem;background:#f59e0b;">
                                Find new mentor
                            </button>
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },
            
            commitToMentor() {
                this.approvalRating += 20;
                this.relationship.trust += 30;
                this.confrontationTriggered = false;
                document.getElementById('screen-replay').style.display = 'none';
                UI.addAlert(`${this.currentMentor.emoji} ${this.currentMentor.name}: "Alright. Let's start fresh. I'm here for you."`, 'success');
            },
            
            goSolo() {
                this.currentMentor = null;
                this.approvalRating = 0;
                document.getElementById('screen-replay').style.display = 'none';
                UI.addAlert('You are now mentorless. Independent but alone.', 'warning');
                document.getElementById('mentor-widget').style.display = 'none';
            },
            
            // UPGRADE 8: MENTOR CELEBRATION MOMENTS
            celebrationTriggers: {
                first_playoff: false,
                first_championship: false,
                comeback_win: false,
                perfect_decision: false
            },
            
            triggerCelebration(type) {
                if (this.celebrationTriggers[type]) return; // Already celebrated
                this.celebrationTriggers[type] = true;
                
                const celebrations = {
                    first_playoff: {
                        title: "WE MADE THE PLAYOFFS!",
                        message: `${this.currentMentor.name} calls you on the phone:\n\n"Hey! We did it! Playoffs! I knew you had it in you. This is just the beginning. Enjoy this moment - your first playoff berth as a GM. It's special.\n\nNow let's go win it all."`,
                        emoji: ''
                    },
                    first_championship: {
                        title: "CHAMPIONSHIP!!!",
                        message: `${this.currentMentor.name} finds you in the locker room after the game:\n\n"This... THIS is what it's all about. You just won your first championship as a GM.\n\nI've won before. But watching YOU do it? This might be even better.\n\nYou earned this. Every decision, every sleepless night, every tough call. It was all worth it.\n\nChampion GM. Those are two words that will follow you forever."`,
                        emoji: '',
                        specialReward: '+50% approval, unlock special ability'
                    },
                    comeback_win: {
                        title: "THE COMEBACK!",
                        message: `${this.currentMentor.name} texts you:\n\n"THAT'S HOW YOU RESPOND TO ADVERSITY! Everyone counted you out. You proved them all wrong.\n\nThis is what separates great GMs from good ones. You didn't give up. You adjusted. You fought back.\n\nI'm proud of you."`,
                        emoji: ''
                    }
                };
                
                this.showCelebration(celebrations[type]);
            },
            
            showCelebration(celebration) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.92);
                    z-index: 10004;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.5s ease;
                `;
                
                modal.innerHTML = `
                    <div style="max-width:700px;padding:3rem;background:linear-gradient(135deg,#22c55e,#16a34a);border:4px solid #fff;border-radius:20px;text-align:center;color:#000;">
                        <div style="font-size:7rem;margin-bottom:1rem;animation:bounce 1s infinite;">${celebration.emoji}</div>
                        <h1 style="font-size:3rem;font-weight:bold;margin-bottom:1.5rem;text-shadow:2px 2px 4px rgba(0,0,0,0.3);">
                            ${celebration.title}
                        </h1>
                        <div style="background:rgba(0,0,0,0.2);padding:2rem;border-radius:12px;margin-bottom:2rem;">
                            <div style="font-size:1.2rem;line-height:1.8;white-space:pre-line;">
                                ${celebration.message}
                            </div>
                        </div>
                        ${celebration.specialReward ? `
                            <div style="background:#fff;color:#000;padding:1rem;border-radius:8px;margin-bottom:1.5rem;font-weight:bold;">
                                 ${celebration.specialReward}
                            </div>
                        ` : ''}
                        <button onclick="this.closest('[style*=fixed]').remove()" 
                                style="width:100%;padding:1.5rem;background:#000;color:#fff;border:none;border-radius:12px;font-size:1.3rem;font-weight:bold;cursor:pointer;">
                            Thank you, coach!
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                if (celebration.specialReward) {
                    this.approvalRating = Math.min(100, this.approvalRating + 50);
                    this.unlockPersonalStory('first_championship');
                }
            }
        };
        
        function selectMentorAndClose(mentorId) {
            GMMentors.selectMentor(mentorId);
            GMMentors.initChallenge(); // Start challenge
            GMMentors.sendWelcomeMessage(); // NEW: Send personalized welcome
            document.getElementById('screen-trade-puzzle').style.display = 'none';
            showScreen('hub');
        }
        
        // Add these new mentor features as global extensions
        GMMentors.sendWelcomeMessage = function() {
            setTimeout(() => {
                const messages = {
                    jerry_west: `Hey. Jerry West here. Listen, I don't usually do this mentorship thing, but I see something in you. You've got potential.\n\nI'm going to be straight with you - I demand excellence. No excuses. No shortcuts. We're here to win championships.\n\nI won 8 as an executive. Let's add yours to that list.\n\nCall me anytime. I'm in your corner.`,
                    
                    sam_presti: `Hi, it's Sam. Thanks for choosing me as your mentor.\n\nI want you to know - we're going to do this the right way. Patience. Assets. Development.\n\nThe league is full of GMs making desperate moves. We won't be one of them.\n\nI've been doing this since 2007. I've seen everything. Trust the process, and we'll build something sustainable.\n\nLet's get to work.`,
                    
                    pat_riley: `Welcome. This is Pat Riley.\n\nYou made the right choice picking me. I don't tolerate mediocrity. I don't accept excuses. And I sure as hell don't believe in shortcuts.\n\nCulture is everything. You're about to learn that.\n\nI've won 9 championships. Not because I had the most talent - because I built organizations that demanded excellence.\n\nYou ready to do this right? Good. Let's go.`,
                    
                    daryl_morey: `Hey! Daryl here. Excited to work with you.\n\nLook, I know people think I'm all about numbers and spreadsheets. They're not wrong. But here's the thing - the numbers work.\n\nWe're going to make data-driven decisions. We're going to calculate expected value. And we're going to win because we're smarter than everyone else.\n\nMath doesn't lie. Let's prove it.\n\nReady when you are.`,
                    
                    rc_buford: `Hello. R.C. Buford speaking.\n\nI'm honored you want to learn from me. The Spurs way isn't flashy, but it works.\n\nWe're going to find undervalued players. We're going to develop talent. We're going to build a sustainable system.\n\n5 championships. 20+ years of excellence. That doesn't happen by accident.\n\nTake your time. Learn. Grow. I'll be here.\n\nLet's build something special together.`
                };
                
                this.showVoiceMessage(messages[this.currentMentor.id]);
            }, 2000);
        };
        
        GMMentors.showVoiceMessage = function(message) {
            const voiceModal = document.createElement('div');
            voiceModal.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                max-width: 400px;
                padding: 1.5rem;
                background: linear-gradient(135deg, #1e293b, #0f172a);
                border: 2px solid var(--gold);
                border-radius: 16px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                z-index: 10005;
                animation: slideInRight 0.5s ease;
            `;
            
            voiceModal.innerHTML = `
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                    <div style="font-size:2.5rem;">${this.currentMentor.emoji}</div>
                    <div style="flex:1;">
                        <div style="font-size:0.75rem;color:var(--text-secondary);text-transform:uppercase;">Voice Message</div>
                        <div style="font-weight:bold;color:var(--gold);">${this.currentMentor.name}</div>
                    </div>
                    <div style="font-size:2rem;color:var(--gold);animation:pulse 2s infinite;"></div>
                </div>
                <div style="background:rgba(0,0,0,0.4);padding:1.5rem;border-radius:8px;margin-bottom:1rem;">
                    <div id="voice-message-text" style="font-size:0.95rem;line-height:1.6;white-space:pre-line;"></div>
                </div>
                <div style="display:flex;gap:0.5rem;">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="btn-primary" style="flex:1;padding:0.75rem;">
                        Got it
                    </button>
                    <button onclick="GMMentors.saveMessage()" 
                            class="btn-ghost" style="padding:0.75rem 1rem;">
                         Save
                    </button>
                </div>
            `;
            
            document.body.appendChild(voiceModal);
            
            // Typewriter effect
            let i = 0;
            const textEl = document.getElementById('voice-message-text');
            const typeWriter = () => {
                if (i < message.length) {
                    textEl.textContent += message.charAt(i);
                    i++;
                    setTimeout(typeWriter, 20);
                }
            };
            typeWriter();
            
            // Auto-dismiss after 25 seconds
            setTimeout(() => {
                if (voiceModal.parentElement) {
                    voiceModal.style.animation = 'fadeOut 0.5s ease';
                    setTimeout(() => voiceModal.remove(), 500);
                }
            }, 25000);
        };
        
        GMMentors.savedMessages = [];
        GMMentors.saveMessage = function() {
            this.savedMessages.push({
                from: this.currentMentor.name,
                time: new Date().toLocaleString(),
                message: 'Saved'
            });
            UI.addAlert('Message saved to inbox', 'success');
        };
        
        // UPGRADE 9: MENTOR TEXTING SYSTEM
        GMMentors.sendText = function(message, delay = 0) {
            setTimeout(() => {
                const textPopup = document.createElement('div');
                textPopup.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    max-width: 350px;
                    padding: 1rem;
                    background: #1e293b;
                    border: 2px solid var(--gold);
                    border-radius: 12px;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                    z-index: 10006;
                    animation: slideInRight 0.3s ease;
                `;
                
                textPopup.innerHTML = `
                    <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                        <div style="font-size:1.8rem;">${this.currentMentor.emoji}</div>
                        <div style="font-size:0.85rem;color:var(--text-secondary);">
                            Text from ${this.currentMentor.name}
                        </div>
                    </div>
                    <div style="background:rgba(245,166,35,0.1);padding:1rem;border-radius:8px;font-size:0.95rem;">
                        ${message}
                    </div>
                `;
                
                document.body.appendChild(textPopup);
                
                setTimeout(() => {
                    textPopup.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => textPopup.remove(), 300);
                }, 5000);
            }, delay);
        };
        
        // UPGRADE 10: REACTIVE MENTOR SYSTEM - Reacts to specific situations
        GMMentors.reactToSituation = function(situation, data) {
            const reactions = {
                big_trade: [
                    "Just saw the trade. Bold move. I like the confidence.",
                    "Whoa. That's a big swing. Make sure you know what you're doing.",
                    " Now THAT'S a trade! Let's see if it pays off."
                ],
                injury: [
                    "Heard about the injury. Tough break. How are you handling it?",
                    "Injuries are part of the game. Don't panic. We'll figure this out.",
                    "This is a test. Great GMs adapt. You got this."
                ],
                winning_streak: [
                    "4 wins in a row! The plan is working! Keep it up!",
                    "I see what you're building. This is exciting.",
                    "The pieces are coming together. Love what I'm seeing."
                ],
                losing_streak: [
                    "Rough stretch. Remember - this is a marathon, not a sprint.",
                    "Hey. Bad runs happen. Stay focused on the process.",
                    "Don't let this shake you. We've seen worse. Adjust and push forward."
                ]
            };
            
            if (reactions[situation]) {
                const message = reactions[situation][Math.floor(Math.random() * reactions[situation].length)];
                this.sendText(message, 2000);
            }
        };
        
        // UPGRADE 11: MENTOR CHECK-INS - Periodic messages
        GMMentors.scheduleCheckIn = function() {
            if (!this.currentMentor) return;
            
            const checkIns = [
                "How's everything going? Just checking in.",
                "Saw your last move. Wanted to get your thoughts on it.",
                "Quick question - what's your plan for next cycle?",
                "Coffee later? I want to talk through some ideas.",
                "Remember what we discussed about {concept}? Seeing you apply it well."
            ];
            
            // Random check-in every 2-3 decisions
            if (this.interactionCount % 3 === 0) {
                const message = checkIns[Math.floor(Math.random() * checkIns.length)];
                this.sendText(message, 5000);
            }
        };
        
        // UPGRADE 12: MENTOR DISAGREEMENT & ARGUMENT SYSTEM
        GMMentors.strongDisagreement = function(decision) {
            if (this.approvalRating > 40) return; // Only if relationship is strained
            
            const modal = document.getElementById('screen-replay');
            const content = document.getElementById('replay-content');
            
            content.innerHTML = `
                <div style="padding:2.5rem;max-width:800px;margin:0 auto;">
                    <div style="text-align:center;margin-bottom:2rem;">
                        <div style="font-size:5rem;margin-bottom:1rem;"></div>
                        <h2 style="color:#ef4444;font-size:2.2rem;">We Have a Problem</h2>
                    </div>
                    
                    <div style="background:rgba(239,68,68,0.15);border:2px solid #ef4444;padding:2rem;border-radius:12px;margin-bottom:2rem;">
                        <div style="font-size:1.2rem;font-weight:bold;margin-bottom:1rem;color:#ef4444;">
                            ${this.currentMentor.emoji} ${this.currentMentor.name}:
                        </div>
                        <div style="font-size:1.05rem;line-height:1.7;">
                            "I can't support this decision. I really can't.
                            <br><br>
                            You just chose '${decision.optionText}' and I think it's a mistake. A big one.
                            <br><br>
                            I've been in this league for decades. I know what works and what doesn't. 
                            This doesn't work.
                            <br><br>
                            Now you can ignore me - that's your right as the GM. 
                            But if you keep making decisions like this, we're going to have a serious problem."
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
                        <button class="btn-primary" onclick="GMMentors.defendDecision(); document.getElementById('screen-replay').style.display='none';" 
                                style="padding:1.2rem;background:#ef4444;">
                            I respect your opinion but I'm doing this
                        </button>
                        <button class="btn-primary" onclick="GMMentors.acceptAdvice(); document.getElementById('screen-replay').style.display='none';" 
                                style="padding:1.2rem;background:#22c55e;">
                            You're right. I'll reconsider
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        };
        
        GMMentors.defendDecision = function() {
            this.approvalRating -= 15;
            this.relationship.respect -= 10;
            UI.addAlert(`${this.currentMentor.name}: "Fine. It's your franchise. I hope you're right."`, 'warning');
        };
        
        GMMentors.acceptAdvice = function() {
            this.approvalRating += 10;
            this.relationship.respect += 15;
            UI.addAlert(`${this.currentMentor.name}: "Thank you for hearing me out. That means a lot."`, 'success');
        };
        
        // 
        // COMPLETELY OVERHAULED CALL MENTOR SYSTEM
        // 
        
        // Store mentor advice in session (doesn't decrement calls until clicked)
        GMMentors.currentAdvice = null;
        GMMentors.currentScenarioId = null;
        
        function callMentorForAdvice(scenarioId, roomName) {
            const scenario = Scenarios[scenarioId];
            if (!scenario || !GMMentors.canCallMentor()) return;
            
            // Actually call the mentor (this decrements the call count)
            const advice = GMMentors.callMentor(scenario);
            
            // Store it
            GMMentors.currentAdvice = advice;
            GMMentors.currentScenarioId = scenarioId;
            
            // Re-render the room to show advice
            const content = document.getElementById('room-modal-content');
            if (roomName === 'eval') {
                content.innerHTML = UI.renderEvaluationRoom(scenario, roomName, scenarioId);
            } else if (roomName === 'cap') {
                content.innerHTML = UI.renderCapRoom(scenario, roomName, scenarioId);
            } else if (roomName === 'relationships') {
                content.innerHTML = UI.renderRelationshipsRoom(scenario, roomName, scenarioId);
            } else if (roomName === 'risk') {
                content.innerHTML = UI.renderRiskRoom(scenario, roomName, scenarioId);
            }
            
            // Add XP for using mentor
            GMMentors.gainXP(10);
            GMMentors.unlockAchievement('first_call');
        }
        
        // UPGRADE 13: MENTOR INBOX SYSTEM
        GMMentors.inbox = [];
        
        GMMentors.addToInbox = function(message) {
            this.inbox.push({
                from: this.currentMentor.name,
                emoji: this.currentMentor.emoji,
                subject: message.subject,
                body: message.body,
                time: new Date().toLocaleString(),
                read: false
            });
        };
        
        GMMentors.showInbox = function() {
            const modal = document.getElementById('screen-replay');
            const content = document.getElementById('replay-content');
            
            content.innerHTML = `
                <div style="padding:2rem;max-width:900px;margin:0 auto;">
                    <div style="text-align:center;margin-bottom:2rem;">
                        <div style="font-size:4rem;margin-bottom:1rem;"></div>
                        <h2 style="color:var(--gold);font-size:2rem;">Mentor Messages</h2>
                        <div style="color:var(--text-secondary);">
                            ${this.inbox.length} ${this.inbox.length === 1 ? 'message' : 'messages'}
                            ${this.inbox.filter(m => !m.read).length > 0 ? ` (${this.inbox.filter(m => !m.read).length} unread)` : ''}
                        </div>
                    </div>
                    
                    ${this.inbox.length === 0 ? `
                        <div style="text-align:center;padding:3rem;color:var(--text-secondary);">
                            No messages yet. Your mentor will send you updates as you play.
                        </div>
                    ` : `
                        <div style="display:grid;gap:1rem;">
                            ${this.inbox.slice().reverse().map((msg, idx) => `
                                <div onclick="GMMentors.readMessage(${this.inbox.length - 1 - idx})" 
                                     style="padding:1.5rem;background:${msg.read ? 'rgba(255,255,255,0.03)' : 'rgba(245,166,35,0.1)'};
                                            border:2px solid ${msg.read ? 'var(--border)' : 'var(--gold)'};
                                            border-radius:8px;cursor:pointer;transition:all 0.2s;"
                                     onmouseover="this.style.borderColor='var(--gold)';"
                                     onmouseout="this.style.borderColor='${msg.read ? 'var(--border)' : 'var(--gold)'}';">
                                    
                                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.75rem;">
                                        <div style="font-size:2rem;">${msg.emoji}</div>
                                        <div style="flex:1;">
                                            <div style="font-weight:bold;font-size:1.1rem;">${msg.from}</div>
                                            <div style="font-size:0.8rem;color:var(--text-secondary);">${msg.time}</div>
                                        </div>
                                        ${!msg.read ? `<div style="width:10px;height:10px;background:var(--gold);border-radius:50%;"></div>` : ''}
                                    </div>
                                    
                                    <div style="font-weight:600;margin-bottom:0.5rem;">${msg.subject}</div>
                                    <div style="font-size:0.9rem;color:var(--text-secondary);">
                                        ${msg.body.substring(0, 100)}${msg.body.length > 100 ? '...' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                    
                    <button class="btn-primary" onclick="document.getElementById('screen-replay').style.display='none'" 
                            style="width:100%;margin-top:2rem;padding:1rem;">
                        Close Inbox
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        };
        
        GMMentors.readMessage = function(index) {
            const msg = this.inbox[index];
            msg.read = true;
            
            const modal = document.getElementById('screen-replay');
            const content = document.getElementById('replay-content');
            
            content.innerHTML = `
                <div style="padding:2.5rem;max-width:800px;margin:0 auto;">
                    <div style="display:flex;align-items:center;gap:1.5rem;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:2px solid var(--border);">
                        <div style="font-size:4rem;">${msg.emoji}</div>
                        <div style="flex:1;">
                            <div style="font-size:1.5rem;font-weight:bold;color:var(--gold);">${msg.from}</div>
                            <div style="font-size:0.9rem;color:var(--text-secondary);">${msg.time}</div>
                        </div>
                    </div>
                    
                    <div style="font-size:1.3rem;font-weight:bold;margin-bottom:1.5rem;">
                        ${msg.subject}
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.05);padding:2rem;border-radius:8px;margin-bottom:2rem;">
                        <div style="font-size:1.05rem;line-height:1.8;white-space:pre-line;">
                            ${msg.body}
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:1rem;">
                        <button class="btn-ghost" onclick="GMMentors.showInbox()" style="flex:1;padding:1rem;">
                             Back to Inbox
                        </button>
                        <button class="btn-primary" onclick="document.getElementById('screen-replay').style.display='none'" 
                                style="flex:1;padding:1rem;">
                            Close
                        </button>
                    </div>
                </div>
            `;
        };
        
        // UPGRADE 14: RELATIONSHIP TIMELINE
        GMMentors.timeline = [];
        
        GMMentors.addTimelineEvent = function(event) {
            this.timeline.push({
                cycle: GameState.cycleIndex,
                type: event.type,
                title: event.title,
                description: event.description,
                approvalChange: event.approvalChange || 0,
                timestamp: Date.now()
            });
        };
        
        GMMentors.showTimeline = function() {
            const modal = document.getElementById('screen-replay');
            const content = document.getElementById('replay-content');
            
            content.innerHTML = `
                <div style="padding:2rem;max-width:1000px;margin:0 auto;">
                    <div style="text-align:center;margin-bottom:2rem;">
                        <div style="font-size:4rem;margin-bottom:1rem;"></div>
                        <h2 style="color:var(--gold);font-size:2rem;">Your Journey with ${this.currentMentor.name}</h2>
                        <div style="color:var(--text-secondary);">
                            From mentee to ${this.approvalRating >= 80 ? 'trusted partner' : 'developing GM'}
                        </div>
                    </div>
                    
                    <div style="position:relative;padding-left:3rem;">
                        <!-- Timeline line -->
                        <div style="position:absolute;left:1.25rem;top:0;bottom:0;width:2px;background:var(--gold);"></div>
                        
                        ${this.timeline.map((event, idx) => `
                            <div style="position:relative;margin-bottom:2rem;">
                                <!-- Timeline dot -->
                                <div style="position:absolute;left:-1.85rem;width:16px;height:16px;background:${event.approvalChange > 0 ? '#22c55e' : event.approvalChange < 0 ? '#ef4444' : 'var(--gold)'};border:3px solid #000;border-radius:50%;"></div>
                                
                                <div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-left:3px solid ${event.approvalChange > 0 ? '#22c55e' : event.approvalChange < 0 ? '#ef4444' : 'var(--gold)'};border-radius:8px;">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.75rem;">
                                        <div>
                                            <div style="font-size:0.75rem;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.25rem;">
                                                Cycle ${event.cycle}  ${event.type}
                                            </div>
                                            <div style="font-size:1.1rem;font-weight:bold;">${event.title}</div>
                                        </div>
                                        ${event.approvalChange !== 0 ? `
                                            <div style="padding:0.5rem 1rem;background:${event.approvalChange > 0 ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'};border-radius:6px;font-weight:bold;color:${event.approvalChange > 0 ? '#22c55e' : '#ef4444'};">
                                                ${event.approvalChange > 0 ? '+' : ''}${event.approvalChange}%
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div style="font-size:0.95rem;color:var(--text-secondary);">
                                        ${event.description}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="btn-primary" onclick="document.getElementById('screen-replay').style.display='none'" 
                            style="width:100%;margin-top:2rem;padding:1rem;">
                        Close Timeline
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        };
        
        // UPGRADE 15: MENTOR ACHIEVEMENTS
        GMMentors.achievements = {
            first_call: { unlocked: false, title: "Breaking the Ice", description: "Called your mentor for the first time" },
            level_3: { unlocked: false, title: "Building Trust", description: "Reached mentor level 3" },
            level_5: { unlocked: false, title: "True Partnership", description: "Reached mentor level 5 - Co-GM status" },
            perfect_alignment: { unlocked: false, title: "Perfect Alignment", description: "95%+ approval rating" },
            comeback: { unlocked: false, title: "Redemption Arc", description: "Went from 20% to 80% approval" },
            challenge_complete: { unlocked: false, title: "Challenge Accepted", description: "Completed your mentor's challenge" },
            personal_story: { unlocked: false, title: "Trusted Confidant", description: "Unlocked a personal story" },
            defended_yourself: { unlocked: false, title: "Independent Thinker", description: "Defended a decision against mentor advice" },
            took_advice: { unlocked: false, title: "Humble Student", description: "Accepted mentor's criticism and changed course" },
            graduation: { unlocked: false, title: "Ready to Lead", description: "Your mentor says you're ready to be on your own" }
        };
        
        GMMentors.unlockAchievement = function(achievementId) {
            const achievement = this.achievements[achievementId];
            if (!achievement || achievement.unlocked) return;
            
            achievement.unlocked = true;
            
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                max-width: 350px;
                padding: 1.5rem;
                background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                border: 3px solid #a78bfa;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.6);
                z-index: 10007;
                animation: slideInRight 0.5s ease;
                color: #fff;
            `;
            
            popup.innerHTML = `
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                    <div style="font-size:3rem;"></div>
                    <div style="flex:1;">
                        <div style="font-size:0.75rem;text-transform:uppercase;opacity:0.9;">Achievement Unlocked</div>
                        <div style="font-size:1.1rem;font-weight:bold;">${achievement.title}</div>
                    </div>
                </div>
                <div style="font-size:0.9rem;opacity:0.9;margin-bottom:1rem;">
                    ${achievement.description}
                </div>
                <button onclick="this.parentElement.remove()" 
                        style="width:100%;padding:0.75rem;background:rgba(0,0,0,0.3);border:2px solid #fff;border-radius:6px;color:#fff;cursor:pointer;font-weight:bold;">
                    Awesome!
                </button>
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.style.animation = 'slideOutRight 0.5s ease';
                    setTimeout(() => popup.remove(), 500);
                }
            }, 8000);
        };
        
        // UPGRADE 16: GRADUATION CEREMONY (End of game)
        GMMentors.showGraduation = function() {
            if (this.approvalRating < 70) return; // Must have good relationship
            
            const modal = document.getElementById('screen-replay');
            const content = document.getElementById('replay-content');
            
            const speeches = {
                jerry_west: `You know, I've mentored a lot of people over the years. Some made it. Some didn't.
                
You? You're going to make it.

When you started, you had potential. Now you have something more - you have the skills, the instincts, and the guts to be a great GM.

I've taught you everything I know. The rest is up to you.

Go out there and win championships. Make me proud.

You're ready.`,

                sam_presti: `When we started this journey, I told you we were going to do it the right way.

And you did. You were patient when others would panic. You built assets when others chased quick fixes.

That's not easy. It requires discipline. Vision. Trust in the process.

You have all of that now.

I'm proud of you. Not just for the results - but for how you got there.

You're ready to lead your own franchise now. Go build something special.`,

                pat_riley: `You know what separates great GMs from good ones?

Character. Discipline. The refusal to accept mediocrity.

When you came to me, you had talent. But talent isn't enough in this league.

Now? Now you have the complete package.

You built culture. You demanded excellence. You never compromised your standards.

That's why you're ready.

Go lead. Go win. Go build a dynasty.

I'll be watching. Make me proud.`
            };
            
            content.innerHTML = `
                <div style="padding:3rem;max-width:900px;margin:0 auto;text-align:center;">
                    <div style="font-size:6rem;margin-bottom:1.5rem;animation:bounce 1s ease;"></div>
                    <h1 style="font-size:3rem;color:var(--gold);margin-bottom:2rem;">Graduation Day</h1>
                    
                    <div style="background:rgba(245,166,35,0.1);border:3px solid var(--gold);padding:3rem;border-radius:16px;margin-bottom:2rem;">
                        <div style="font-size:1.2rem;margin-bottom:1rem;">
                            <strong>${this.currentMentor.emoji} ${this.currentMentor.name} addresses you:</strong>
                        </div>
                        <div style="font-size:1.1rem;line-height:2;white-space:pre-line;font-style:italic;text-align:left;">
                            "${speeches[this.currentMentor.id] || speeches.jerry_west}"
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:2rem;text-align:center;">
                        <div style="padding:1.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                            <div style="font-size:2.5rem;margin-bottom:0.5rem;"></div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">Final Approval</div>
                            <div style="font-size:2rem;font-weight:bold;color:var(--gold);">${Math.round(this.approvalRating)}%</div>
                        </div>
                        <div style="padding:1.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                            <div style="font-size:2.5rem;margin-bottom:0.5rem;"></div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">Mentor Level</div>
                            <div style="font-size:2rem;font-weight:bold;color:var(--gold);">${this.mentorLevel}</div>
                        </div>
                        <div style="padding:1.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                            <div style="font-size:2.5rem;margin-bottom:0.5rem;"></div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">Achievements</div>
                            <div style="font-size:2rem;font-weight:bold;color:var(--gold);">
                                ${Object.values(this.achievements).filter(a => a.unlocked).length}/${Object.keys(this.achievements).length}
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="document.getElementById('screen-replay').style.display='none'" 
                            style="padding:1.5rem 3rem;font-size:1.2rem;">
                        Thank you, ${this.currentMentor.name}
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
            this.unlockAchievement('graduation');
        };
        
        // UPGRADE 17: ACHIEVEMENTS SCREEN
        GMMentors.showAchievements = function() {
            const modal = document.getElementById('screen-replay');
            const content = document.getElementById('replay-content');
            
            const unlockedCount = Object.values(this.achievements).filter(a => a.unlocked).length;
            const totalCount = Object.keys(this.achievements).length;
            
            content.innerHTML = `
                <div style="padding:2rem;max-width:1000px;margin:0 auto;">
                    <div style="text-align:center;margin-bottom:2rem;">
                        <div style="font-size:5rem;margin-bottom:1rem;"></div>
                        <h2 style="color:var(--gold);font-size:2rem;">Mentor Achievements</h2>
                        <div style="color:var(--text-secondary);font-size:1.1rem;">
                            ${unlockedCount} / ${totalCount} Unlocked (${Math.round((unlockedCount/totalCount)*100)}%)
                        </div>
                        <div style="background:rgba(0,0,0,0.3);height:10px;border-radius:5px;overflow:hidden;margin-top:1rem;max-width:400px;margin-left:auto;margin-right:auto;">
                            <div style="width:${(unlockedCount/totalCount)*100}%;height:100%;background:var(--gold);transition:width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
                        ${Object.entries(this.achievements).map(([id, achievement]) => `
                            <div style="padding:1.5rem;background:${achievement.unlocked ? 'rgba(245,166,35,0.1)' : 'rgba(255,255,255,0.03)'};
                                        border:2px solid ${achievement.unlocked ? 'var(--gold)' : 'var(--border)'};
                                        border-radius:12px;${!achievement.unlocked ? 'opacity:0.5;' : ''}">
                                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                                    <div style="font-size:3rem;">${achievement.unlocked ? '' : ''}</div>
                                    <div style="flex:1;">
                                        <div style="font-size:1.1rem;font-weight:bold;color:${achievement.unlocked ? 'var(--gold)' : 'var(--text-secondary)'};">
                                            ${achievement.title}
                                        </div>
                                        ${achievement.unlocked ? `
                                            <div style="font-size:0.75rem;color:#22c55e;font-weight:600;">
                                                 UNLOCKED
                                            </div>
                                        ` : `
                                            <div style="font-size:0.75rem;color:var(--text-secondary);">
                                                Locked
                                            </div>
                                        `}
                                    </div>
                                </div>
                                <div style="font-size:0.9rem;color:var(--text-secondary);">
                                    ${achievement.description}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="btn-primary" onclick="document.getElementById('screen-replay').style.display='none'" 
                            style="width:100%;margin-top:2rem;padding:1rem;">
                        Close
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        };
        
        // 
        // ECONOMIC MASTERY TREE - FOR 8TH GRADERS
        // 
        
        const EconomicMasteryTree = {
            // SIMPLIFIED FOR 8TH GRADE - Clear, relatable concepts
            concepts: {
                // TIER 1: "I Get It!" Level (Start unlocked)
                opportunity_cost: {
                    tier: 1,
                    name: "Opportunity Cost",
                    kid_friendly_name: "What You Give Up",
                    emoji: "",
                    unlocked: true,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    
                    simple_explanation: "Every choice means giving up something else. If you pick pizza, you can't have tacos!",
                    nba_example: "Trade your young player for a star? You give up future potential for wins NOW.",
                    unlocks: ['time_preference', 'sunk_cost'],
                    
                    mini_lesson: {
                        title: "What You Give Up (Opportunity Cost)",
                        story: "You have $10. You can buy a basketball OR a video game. If you choose the basketball, the opportunity cost is the video game - that's what you gave up!",
                        nba_connection: "NBA GMs face this constantly! Sign a max contract player? The opportunity cost is all the other players you COULD have signed with that money.",
                        key_question: "Before every big decision, ask: What am I giving up?",
                        quiz: [
                            {
                                q: "You trade 3 young players for 1 star. What's the opportunity cost?",
                                options: ["The star player", "The 3 young players", "Nothing", "Money"],
                                correct: 1,
                                explanation: "The opportunity cost is what you GAVE UP - the 3 young players and their potential."
                            },
                            {
                                q: "Why do GMs think about opportunity cost?",
                                options: ["To sound smart", "To see what they're giving up", "To confuse people", "It's not important"],
                                correct: 1,
                                explanation: "Smart GMs always ask: 'What am I giving up?' to make better decisions."
                            }
                        ]
                    }
                },
                
                time_preference: {
                    tier: 1,
                    name: "Time Preference",
                    kid_friendly_name: "Now vs Later",
                    emoji: "",
                    unlocked: true,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    
                    simple_explanation: "Do you want something NOW or wait for something better LATER?",
                    nba_example: "Win championships now by going all-in? Or be patient and build a dynasty?",
                    unlocks: ['patience_value'],
                    
                    mini_lesson: {
                        title: "Now vs Later (Time Preference)",
                        story: "Would you rather have $100 today or $200 next month? Some people really want money NOW. Others can wait for MORE later. That's time preference!",
                        nba_connection: "Lakers in 2019 traded young players for Anthony Davis. They wanted to win NOW. Thunder rebuild slowly - they prefer LATER success.",
                        key_question: "Do I need to win right now, or can I build for the future?",
                        quiz: [
                            {
                                q: "A team trades future picks for a star. What's their time preference?",
                                options: ["They prefer the future", "They want to win NOW", "They don't care", "They're confused"],
                                correct: 1,
                                explanation: "Trading the future for the present means they value NOW more than LATER!"
                            }
                        ]
                    }
                },
                
                risk_vs_return: {
                    tier: 1,
                    name: "Risk vs Return",
                    kid_friendly_name: "Taking Chances",
                    emoji: "",
                    unlocked: true,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    
                    simple_explanation: "Bigger risks can mean bigger rewards... or bigger failures!",
                    nba_example: "Draft an unknown player - risky but could be the next superstar!",
                    unlocks: ['calculated_risk'],
                    
                    mini_lesson: {
                        title: "Taking Chances (Risk vs Return)",
                        story: "Imagine a carnival game. Easy game = small prize. Hard game = HUGE prize! Higher risk, higher reward!",
                        nba_connection: "Draft Giannis at pick 15 in 2013? HUGE risk (nobody knew him). HUGE reward (became MVP)!",
                        key_question: "Is the possible reward worth the risk?",
                        quiz: [
                            {
                                q: "Why do some GMs take big risks?",
                                options: ["They're reckless", "They're dumb", "Big rewards need big risks", "They like losing"],
                                correct: 2,
                                explanation: "Smart risk-taking! Can't win championships playing it safe!"
                            }
                        ]
                    }
                },
                
                trust_value: {
                    tier: 1,
                    name: "Trust & Reputation",
                    kid_friendly_name: "Keeping Your Word",
                    emoji: "",
                    unlocked: true,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    
                    simple_explanation: "If you break promises, nobody will trust you again!",
                    nba_example: "Promise a player you'll take care of them, then trade them? They'll tell everyone you can't be trusted.",
                    unlocks: ['reputation_effects'],
                    
                    mini_lesson: {
                        title: "Keeping Your Word (Trust & Reputation)",
                        story: "If you borrow your friend's bike and break it, will they lend you stuff again? Trust is EASY to lose, HARD to rebuild!",
                        nba_connection: "Isaiah Thomas played injured for Celtics. They traded him anyway. Players remember! Free agents avoid teams that don't keep promises.",
                        key_question: "Will this decision make people trust me more or less?",
                        quiz: [
                            {
                                q: "You promise to give a player a max contract, then don't. What happens?",
                                options: ["Nothing", "Other players won't trust you", "You save money", "Everyone forgets"],
                                correct: 1,
                                explanation: "Players TALK! Break your word once, they'll never believe you again."
                            }
                        ]
                    }
                },
                
                // TIER 2: "Wow, That's Cool!" Level (Unlock after mastering 2 Tier 1)
                sunk_cost: {
                    tier: 2,
                    name: "Sunk Cost Fallacy",
                    kid_friendly_name: "Don't Chase Bad Decisions",
                    emoji: "",
                    unlocked: false,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    prerequisite: ['opportunity_cost'],
                    
                    simple_explanation: "Just because you already spent money/time doesn't mean you should keep spending more!",
                    nba_example: "Drafted a bust? Don't keep playing him just because you used a high pick. That pick is GONE.",
                    unlocks: ['knowing_when_to_quit'],
                    
                    mini_lesson: {
                        title: "Don't Chase Bad Bets (Sunk Cost Fallacy)",
                        story: "You bought a bad video game for $60. Should you keep playing it because you spent money? NO! That money is GONE. Move on!",
                        nba_connection: "Kings drafted Marvin Bagley over Luka Doncic. Should they keep playing Bagley to 'prove' they were right? NO! The pick is gone. Do what's best NOW.",
                        key_question: "Am I doing this because it's smart, or because I already invested in it?",
                        quiz: [
                            {
                                q: "You gave a player a big contract. He's terrible. What should you do?",
                                options: ["Keep playing him - you paid him!", "Trade or bench him - past is past", "Feel sad forever", "Retire as GM"],
                                correct: 1,
                                explanation: "The contract is a SUNK COST. Can't get it back. Do what's best for the team NOW!"
                            }
                        ]
                    }
                },
                
                information_edge: {
                    tier: 2,
                    name: "Information Advantage", 
                    kid_friendly_name: "Knowing Secrets",
                    emoji: "",
                    unlocked: false,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    prerequisite: ['risk_vs_return'],
                    
                    simple_explanation: "If you know something others don't, you can make smarter decisions!",
                    nba_example: "Your scouts discovered a hidden gem internationally. Other teams don't know how good he is!",
                    unlocks: ['scouting_value'],
                    
                    mini_lesson: {
                        title: "Knowing Secrets (Information Advantage)",
                        story: "In poker, if you can see the other player's cards, you'll win! Information is POWER!",
                        nba_connection: "Spurs knew about Manu Ginobili when other teams didn't. Got him at pick 57! Information advantage = championships.",
                        key_question: "What do I know that others don't?",
                        quiz: [
                            {
                                q: "Why do teams spend millions on scouts?",
                                options: ["Waste of money", "To find players others don't know about", "For fun", "Scouts are cool"],
                                correct: 1,
                                explanation: "Information advantage! If you know about a great player before others, you can draft him late!"
                            }
                        ]
                    }
                },
                
                patience_value: {
                    tier: 2,
                    name: "Value of Patience",
                    kid_friendly_name: "Good Things Take Time",
                    emoji: "",
                    unlocked: false,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    prerequisite: ['time_preference'],
                    
                    simple_explanation: "Sometimes waiting is better than rushing!",
                    nba_example: "Let young players develop for 3 years instead of trading them for quick wins.",
                    unlocks: ['dynasty_building'],
                    
                    mini_lesson: {
                        title: "Good Things Take Time (Value of Patience)",
                        story: "Plant a tree today, get fruit in 5 years. Or buy fruit today but never have a tree. Patience = bigger rewards!",
                        nba_connection: "Thunder drafted Durant, Westbrook, Harden, Ibaka. Took 4 years to reach Finals. Warriors built slowly - then won 3 championships!",
                        key_question: "Can I wait for something better?",
                        quiz: [
                            {
                                q: "Your young players are struggling. Should you trade them for veterans?",
                                options: ["Yes, win now!", "No, let them develop", "Flip a coin", "Ask your mom"],
                                correct: 1,
                                explanation: "Patience! Young players often become stars if you give them time. Warriors waited on Curry and Klay!"
                            }
                        ]
                    }
                },
                
                reputation_effects: {
                    tier: 2,
                    name: "Reputation Matters",
                    kid_friendly_name: "What People Say About You",
                    emoji: "",
                    unlocked: false,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    prerequisite: ['trust_value'],
                    
                    simple_explanation: "Your reputation follows you everywhere!",
                    nba_example: "Free agents talk! 'Don't sign with them - they don't keep promises.'",
                    unlocks: [],
                    
                    mini_lesson: {
                        title: "What People Say (Reputation Matters)",
                        story: "School bully is mean to everyone. Nobody wants to be their partner in class. Reputation sticks!",
                        nba_connection: "Knicks had bad reputation for years. Free agents didn't want to sign there! Heat culture = everyone wants to join.",
                        key_question: "What will people say about me after this?",
                        quiz: [
                            {
                                q: "Why do some teams have trouble signing free agents?",
                                options: ["Bad weather", "Bad reputation - players don't trust them", "Not enough money", "Bad uniforms"],
                                correct: 1,
                                explanation: "Players talk! Bad reputation = nobody wants to sign. Good reputation = everyone wants in!"
                            }
                        ]
                    }
                },
                
                // TIER 3: "I'm Really Good at This!" Level (Unlock after mastering 3 Tier 2)
                option_value: {
                    tier: 3,
                    name: "Option Value",
                    kid_friendly_name: "Keeping Choices Open",
                    emoji: "",
                    unlocked: false,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    prerequisite: ['sunk_cost', 'patience_value'],
                    
                    simple_explanation: "Having lots of choices is valuable! Don't close doors too early.",
                    nba_example: "Keep draft picks = more options later. Trade them all away = stuck with what you have!",
                    unlocks: [],
                    
                    mini_lesson: {
                        title: "Keeping Choices Open (Option Value)",
                        story: "You can pick your elective next semester. Should you lock in NOW or wait to see what's offered? Waiting = more options!",
                        nba_connection: "Sam Presti hoards draft picks. Why? OPTIONS! Can draft, trade, or package them. Flexibility is powerful!",
                        key_question: "Am I closing off future choices?",
                        quiz: [
                            {
                                q: "Why do smart GMs keep draft picks?",
                                options: ["They're greedy", "Picks = options = flexibility", "They like drafting busts", "No reason"],
                                correct: 1,
                                explanation: "Draft picks are OPTIONS! Can use them to draft, trade for stars, or make deals. Options = power!"
                            }
                        ]
                    }
                },
                
                principal_agent: {
                    tier: 3,
                    name: "Principal-Agent Problem",
                    kid_friendly_name: "When Bosses and Workers Want Different Things",
                    emoji: "",
                    unlocked: false,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    prerequisite: ['reputation_effects'],
                    
                    simple_explanation: "You want to keep your job. Owner wants championships. Sometimes you want different things!",
                    nba_example: "Owner wants to win NOW. You know tanking is smarter. Conflict!",
                    unlocks: [],
                    
                    mini_lesson: {
                        title: "Different Goals (Principal-Agent Problem)",
                        story: "Your parents (principal) pay you to mow the lawn. You (agent) want to finish fast to play games. They want it done WELL. Different goals!",
                        nba_connection: "Owner wants to sell tickets NOW. GM knows tanking gets better picks. Who wins? This is the principal-agent problem!",
                        key_question: "Do my boss and I want the same thing?",
                        quiz: [
                            {
                                q: "Owner demands playoffs. You know tanking is better. What's the problem?",
                                options: ["The owner is dumb", "Principal-agent problem - different goals", "You're wrong", "Nothing"],
                                correct: 1,
                                explanation: "Classic principal-agent problem! Owner (principal) and GM (agent) want different things!"
                            }
                        ]
                    }
                },
                
                calculated_risk: {
                    tier: 3,
                    name: "Calculated Risk",
                    kid_friendly_name: "Smart Gambling",
                    emoji: "",
                    unlocked: false,
                    mastered: false,
                    uses: 0,
                    successes: 0,
                    prerequisite: ['risk_vs_return', 'information_edge'],
                    
                    simple_explanation: "Not all risks are equal! Some are smarter than others.",
                    nba_example: "Draft a player with knee injury vs player with bad attitude. Both risky, but which is smarter?",
                    unlocks: [],
                    
                    mini_lesson: {
                        title: "Smart Gambling (Calculated Risk)",
                        story: "Bet on a coin flip = 50/50. Bet on yourself making a free throw if you practice = better odds! Calculate your chances!",
                        nba_connection: "Daryl Morey: 'We take risks with positive expected value.' Not RANDOM risks - CALCULATED ones!",
                        key_question: "What are the ACTUAL chances this works?",
                        quiz: [
                            {
                                q: "What's a calculated risk?",
                                options: ["Any risk", "A smart risk based on data and odds", "No risk at all", "Asking a calculator"],
                                correct: 1,
                                explanation: "Calculated = you did the math! 'This has a 70% chance of working' is better than 'I hope this works!'"
                            }
                        ]
                    }
                }
            },
            
            // Track progress
            getMasteryProgress() {
                const total = Object.keys(this.concepts).length;
                const mastered = Object.values(this.concepts).filter(c => c.mastered).length;
                const unlocked = Object.values(this.concepts).filter(c => c.unlocked).length;
                
                return {
                    total,
                    mastered,
                    unlocked,
                    masteryPercent: Math.round((mastered / total) * 100),
                    unlockPercent: Math.round((unlocked / total) * 100)
                };
            },
            
            // Track when concept is used
            trackConceptUse(conceptId, wasSuccessful) {
                const concept = this.concepts[conceptId];
                if (!concept) return;
                
                concept.uses++;
                if (wasSuccessful) concept.successes++;
                
                // Check for mastery: 3+ uses with 60%+ success rate
                const successRate = concept.uses > 0 ? concept.successes / concept.uses : 0;
                
                if (concept.uses >= 3 && successRate >= 0.6 && !concept.mastered) {
                    this.masterConcept(conceptId);
                }
            },
            
            // Master a concept
            masterConcept(conceptId) {
                const concept = this.concepts[conceptId];
                if (!concept || concept.mastered) return;
                
                concept.mastered = true;
                
                // Unlock dependent concepts
                if (concept.unlocks) {
                    concept.unlocks.forEach(nextId => {
                        this.unlockConcept(nextId);
                    });
                }
                
                // Show mastery notification
                this.showMasteryNotification(concept);
                
                // Check if we should unlock next tier
                this.checkTierUnlocks();
            },
            
            unlockConcept(conceptId) {
                const concept = this.concepts[conceptId];
                if (!concept || concept.unlocked) return;
                
                // Check prerequisites
                if (concept.prerequisite) {
                    const prereqs = Array.isArray(concept.prerequisite) ? concept.prerequisite : [concept.prerequisite];
                    const allMastered = prereqs.every(id => this.concepts[id]?.mastered);
                    
                    if (allMastered) {
                        concept.unlocked = true;
                        this.showUnlockNotification(concept);
                    }
                }
            },
            
            checkTierUnlocks() {
                const tier1Mastered = Object.values(this.concepts).filter(c => c.tier === 1 && c.mastered).length;
                const tier2Mastered = Object.values(this.concepts).filter(c => c.tier === 2 && c.mastered).length;
                
                // Unlock Tier 2 after mastering 2 Tier 1 concepts
                if (tier1Mastered >= 2) {
                    Object.values(this.concepts).filter(c => c.tier === 2).forEach(c => {
                        this.unlockConcept(c.name.toLowerCase().replace(/ /g, '_').replace(/-/g, '_'));
                    });
                }
                
                // Unlock Tier 3 after mastering 3 Tier 2 concepts
                if (tier2Mastered >= 3) {
                    Object.values(this.concepts).filter(c => c.tier === 3).forEach(c => {
                        this.unlockConcept(c.name.toLowerCase().replace(/ /g, '_').replace(/-/g, '_'));
                    });
                }
            },
            
            showMasteryNotification(concept) {
                const popup = document.createElement('div');
                popup.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    max-width: 500px;
                    padding: 2.5rem;
                    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                    border: 4px solid #a78bfa;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.7);
                    z-index: 10008;
                    text-align: center;
                    color: #fff;
                    animation: bounceIn 0.6s ease;
                `;
                
                popup.innerHTML = `
                    <div style="font-size:6rem;margin-bottom:1rem;"></div>
                    <div style="font-size:2.5rem;font-weight:bold;margin-bottom:1rem;">
                        CONCEPT MASTERED!
                    </div>
                    <div style="font-size:3rem;margin-bottom:1rem;">${concept.emoji}</div>
                    <div style="font-size:1.5rem;font-weight:bold;margin-bottom:0.5rem;">
                        ${concept.kid_friendly_name}
                    </div>
                    <div style="font-size:1rem;opacity:0.9;margin-bottom:1.5rem;">
                        (${concept.name})
                    </div>
                    <div style="background:rgba(0,0,0,0.3);padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;">
                        <div style="font-size:1.1rem;line-height:1.6;">
                            ${concept.simple_explanation}
                        </div>
                    </div>
                    <div style="font-size:0.9rem;opacity:0.8;margin-bottom:1.5rem;">
                        You used this concept ${concept.uses} times with ${Math.round((concept.successes/concept.uses)*100)}% success!
                    </div>
                    <button onclick="this.parentElement.remove()" 
                            style="width:100%;padding:1.2rem;background:#fff;color:#7c3aed;border:none;border-radius:12px;cursor:pointer;font-weight:bold;font-size:1.1rem;">
                        Awesome! I get it now! 
                    </button>
                `;
                
                document.body.appendChild(popup);
                
                setTimeout(() => {
                    if (popup.parentElement) {
                        popup.style.animation = 'fadeOut 0.5s ease';
                        setTimeout(() => popup.remove(), 500);
                    }
                }, 10000);
            },
            
            showUnlockNotification(concept) {
                const popup = document.createElement('div');
                popup.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    right: 20px;
                    max-width: 350px;
                    padding: 1.5rem;
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    border: 3px solid var(--gold);
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
                    z-index: 10007;
                    animation: slideInRight 0.5s ease;
                    color: #000;
                `;
                
                popup.innerHTML = `
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                        <div style="font-size:3rem;"></div>
                        <div style="flex:1;">
                            <div style="font-size:0.75rem;font-weight:600;text-transform:uppercase;">Concept Unlocked</div>
                            <div style="font-size:1.1rem;font-weight:bold;">${concept.kid_friendly_name}</div>
                        </div>
                        <div style="font-size:2.5rem;">${concept.emoji}</div>
                    </div>
                    <div style="font-size:0.9rem;margin-bottom:1rem;">
                        ${concept.simple_explanation}
                    </div>
                    <button onclick="EconomicMasteryTree.showMiniLesson('${concept.name.toLowerCase().replace(/ /g, '_').replace(/-/g, '_')}')" 
                            class="btn-primary" style="width:100%;padding:0.75rem;margin-bottom:0.5rem;">
                        Learn This Concept!
                    </button>
                    <button onclick="this.parentElement.remove()" 
                            class="btn-ghost" style="width:100%;padding:0.75rem;">
                        Later
                    </button>
                `;
                
                document.body.appendChild(popup);
                
                setTimeout(() => {
                    if (popup.parentElement) {
                        popup.style.animation = 'slideOutRight 0.5s ease';
                        setTimeout(() => popup.remove(), 500);
                    }
                }, 12000);
            },
            
            // Show mini lesson
            showMiniLesson(conceptId) {
                const concept = this.concepts[conceptId];
                if (!concept || !concept.mini_lesson) return;
                
                // Close any notification
                document.querySelectorAll('[style*="slideInRight"]').forEach(el => el.remove());
                
                const modal = document.getElementById('screen-replay');
                const content = document.getElementById('replay-content');
                
                content.innerHTML = `
                    <div style="padding:2.5rem;max-width:900px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:5rem;margin-bottom:1rem;">${concept.emoji}</div>
                            <h2 style="color:var(--gold);font-size:2rem;">${concept.mini_lesson.title}</h2>
                            <div style="color:var(--text-secondary);">Tier ${concept.tier} Concept</div>
                        </div>
                        
                        <!-- Kid-Friendly Story -->
                        <div style="background:rgba(59,130,246,0.1);border-left:4px solid #3b82f6;padding:2rem;border-radius:8px;margin-bottom:2rem;">
                            <div style="font-size:0.9rem;color:#3b82f6;font-weight:600;margin-bottom:0.75rem;">
                                 EVERYDAY EXAMPLE:
                            </div>
                            <div style="font-size:1.05rem;line-height:1.7;">
                                ${concept.mini_lesson.story}
                            </div>
                        </div>
                        
                        <!-- NBA Connection -->
                        <div style="background:rgba(245,166,35,0.1);border-left:4px solid var(--gold);padding:2rem;border-radius:8px;margin-bottom:2rem;">
                            <div style="font-size:0.9rem;color:var(--gold);font-weight:600;margin-bottom:0.75rem;">
                                 NBA EXAMPLE:
                            </div>
                            <div style="font-size:1.05rem;line-height:1.7;">
                                ${concept.mini_lesson.nba_connection}
                            </div>
                        </div>
                        
                        <!-- Key Question -->
                        <div style="background:rgba(34,197,94,0.1);border-left:4px solid #22c55e;padding:2rem;border-radius:8px;margin-bottom:2rem;">
                            <div style="font-size:0.9rem;color:#22c55e;font-weight:600;margin-bottom:0.75rem;">
                                 KEY QUESTION TO ASK:
                            </div>
                            <div style="font-size:1.1rem;line-height:1.7;font-weight:600;">
                                "${concept.mini_lesson.key_question}"
                            </div>
                        </div>
                        
                        <!-- QUIZ RUBRIC -->
                        <div style="background:rgba(139,92,246,0.1);border:2px solid #8b5cf6;padding:2rem;border-radius:12px;margin-bottom:2rem;">
                            <div style="text-align:center;margin-bottom:1.5rem;">
                                <div style="font-size:1.3rem;font-weight:bold;color:#a78bfa;margin-bottom:0.5rem;">
                                     How You'll Be Graded
                                </div>
                                <div style="font-size:0.9rem;color:var(--text-secondary);">
                                    Each concept has ${concept.mini_lesson.quiz.length} questions worth 10 points each
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;text-align:center;">
                                <div style="padding:1rem;background:rgba(34,197,94,0.1);border-radius:8px;">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;"></div>
                                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.25rem;">Correct</div>
                                    <div style="font-size:1.5rem;font-weight:bold;color:#22c55e;">10 pts</div>
                                </div>
                                <div style="padding:1rem;background:rgba(239,68,68,0.1);border-radius:8px;">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;"></div>
                                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.25rem;">Incorrect</div>
                                    <div style="font-size:1.5rem;font-weight:bold;color:#ef4444;">0 pts</div>
                                </div>
                                <div style="padding:1rem;background:rgba(245,166,35,0.1);border-radius:8px;">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;"></div>
                                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.25rem;">Max Score</div>
                                    <div style="font-size:1.5rem;font-weight:bold;color:var(--gold);">${concept.mini_lesson.quiz.length * 10} pts</div>
                                </div>
                            </div>
                            
                            <div style="margin-top:1.5rem;padding:1rem;background:rgba(0,0,0,0.3);border-radius:6px;text-align:center;">
                                <div style="font-size:0.85rem;color:var(--text-secondary);">
                                     <strong>Tip:</strong> Read carefully! Explanations will help you learn from mistakes.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quiz -->
                        <div id="mini-lesson-quiz" style="margin-bottom:2rem;">
                            <div style="font-size:1.2rem;font-weight:bold;margin-bottom:1.5rem;text-align:center;">
                                 Quick Check - Do You Get It?
                            </div>
                            ${concept.mini_lesson.quiz.map((q, idx) => `
                                <div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:8px;margin-bottom:1rem;">
                                    <div style="font-size:1.05rem;font-weight:600;margin-bottom:1rem;">
                                        ${idx + 1}. ${q.q} <span style="color:var(--gold);font-size:0.9rem;">(10 points)</span>
                                    </div>
                                    <div style="display:grid;gap:0.75rem;">
                                        ${q.options.map((opt, optIdx) => `
                                            <button onclick="EconomicMasteryTree.checkAnswer('${conceptId}', ${idx}, ${optIdx})"
                                                    class="quiz-option-${conceptId}-${idx}-${optIdx}"
                                                    style="padding:1rem;background:rgba(255,255,255,0.1);border:2px solid var(--border);border-radius:8px;text-align:left;cursor:pointer;transition:all 0.2s;"
                                                    onmouseover="this.style.borderColor='var(--gold)';"
                                                    onmouseout="if(!this.classList.contains('selected')) this.style.borderColor='var(--border)';">
                                                ${opt}
                                            </button>
                                        `).join('')}
                                    </div>
                                    <div id="explanation-${conceptId}-${idx}" style="display:none;margin-top:1rem;padding:1rem;background:rgba(34,197,94,0.1);border-left:3px solid #22c55e;border-radius:4px;">
                                        <div style="font-weight:600;color:#22c55e;margin-bottom:0.5rem;"> Correct!</div>
                                        <div style="font-size:0.95rem;">${q.explanation}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                            <button class="btn-ghost" onclick="document.getElementById('screen-replay').style.display='none'" 
                                    style="padding:1rem;">
                                Close
                            </button>
                            <button class="btn-primary" onclick="EconomicMasteryTree.showMasteryTree()" 
                                    style="padding:1rem;">
                                View All Concepts
                            </button>
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },
            
            checkAnswer(conceptId, quizIdx, selectedIdx) {
                const concept = this.concepts[conceptId];
                const quiz = concept.mini_lesson.quiz[quizIdx];
                const isCorrect = selectedIdx === quiz.correct;
                
                // INITIALIZE QUIZ TRACKING
                if (!GameState.quizScores[conceptId]) {
                    GameState.quizScores[conceptId] = {
                        answered: 0,
                        correct: 0,
                        points: 0,
                        maxPoints: concept.mini_lesson.quiz.length * 10
                    };
                }
                
                // Track this answer
                GameState.quizScores[conceptId].answered++;
                
                const pointsEarned = isCorrect ? 10 : 0;
                GameState.quizScores[conceptId].correct += isCorrect ? 1 : 0;
                GameState.quizScores[conceptId].points += pointsEarned;
                
                // Update total quiz tracking
                GameState.totalQuizPoints += pointsEarned;
                if (!GameState.maxQuizPoints) {
                    // Calculate max points from all unlocked concepts
                    GameState.maxQuizPoints = Object.values(this.concepts)
                        .filter(c => c.unlocked)
                        .reduce((sum, c) => sum + (c.mini_lesson.quiz.length * 10), 0);
                }
                
                // Highlight selection
                const buttons = document.querySelectorAll(`[class^="quiz-option-${conceptId}-${quizIdx}"]`);
                buttons.forEach((btn, idx) => {
                    if (idx === selectedIdx) {
                        if (isCorrect) {
                            btn.style.background = 'rgba(34,197,94,0.2)';
                            btn.style.borderColor = '#22c55e';
                            btn.innerHTML = `${quiz.options[idx]} `;
                        } else {
                            btn.style.background = 'rgba(239,68,68,0.2)';
                            btn.style.borderColor = '#ef4444';
                            btn.innerHTML = `${quiz.options[idx]} `;
                        }
                    } else if (idx === quiz.correct && !isCorrect) {
                        // Show correct answer if they got it wrong
                        btn.style.background = 'rgba(34,197,94,0.1)';
                        btn.style.borderColor = '#22c55e';
                        btn.innerHTML = `${quiz.options[idx]}  Correct`;
                    }
                    btn.disabled = true;
                    btn.style.cursor = 'not-allowed';
                });
                
                // Show explanation
                const explanationEl = document.getElementById(`explanation-${conceptId}-${quizIdx}`);
                if (explanationEl) {
                    explanationEl.style.display = 'block';
                    
                    // Add points feedback
                    const pointsFeedback = document.createElement('div');
                    pointsFeedback.style.cssText = 'margin-top:1rem;padding:1rem;background:rgba(245,166,35,0.1);border-radius:6px;text-align:center;';
                    pointsFeedback.innerHTML = isCorrect ? 
                        `<div style="font-size:1.5rem;color:#22c55e;margin-bottom:0.5rem;">+${pointsEarned} points!</div>` :
                        `<div style="font-size:1.5rem;color:#ef4444;margin-bottom:0.5rem;">0 points</div>`;
                    
                    pointsFeedback.innerHTML += `
                        <div style="font-size:0.9rem;color:var(--text-secondary);">
                            Concept Score: ${GameState.quizScores[conceptId].points}/${GameState.quizScores[conceptId].maxPoints}
                            (${Math.round((GameState.quizScores[conceptId].points / GameState.quizScores[conceptId].maxPoints) * 100)}%)
                        </div>
                    `;
                    
                    explanationEl.appendChild(pointsFeedback);
                }
                
                // Check if all questions for this concept are answered
                if (GameState.quizScores[conceptId].answered === concept.mini_lesson.quiz.length) {
                    const score = GameState.quizScores[conceptId].points;
                    const max = GameState.quizScores[conceptId].maxPoints;
                    const percentage = Math.round((score / max) * 100);
                    
                    setTimeout(() => {
                        UI.addAlert(` ${concept.kid_friendly_name} Quiz Complete: ${percentage}%`, 
                                   percentage >= 70 ? 'success' : 'warning');
                    }, 1000);
                }
                
                console.log('Quiz Progress:', GameState.quizScores);
                console.log(`Total Quiz Score: ${GameState.totalQuizPoints}/${GameState.maxQuizPoints}`);
            },
            
            // Show full mastery tree
            showMasteryTree() {
                const modal = document.getElementById('screen-replay');
                const content = document.getElementById('replay-content');
                
                const progress = this.getMasteryProgress();
                const tier1Concepts = Object.entries(this.concepts).filter(([id, c]) => c.tier === 1);
                const tier2Concepts = Object.entries(this.concepts).filter(([id, c]) => c.tier === 2);
                const tier3Concepts = Object.entries(this.concepts).filter(([id, c]) => c.tier === 3);
                
                content.innerHTML = `
                    <div style="padding:2rem;max-width:1200px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:5rem;margin-bottom:1rem;"></div>
                            <h2 style="color:var(--gold);font-size:2rem;">Economic Mastery Tree</h2>
                            <div style="color:var(--text-secondary);font-size:1.1rem;margin-bottom:1rem;">
                                Learn Economics Through NBA Decisions!
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;max-width:600px;margin:0 auto;">
                                <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;"></div>
                                    <div style="font-size:0.8rem;color:var(--text-secondary);">Unlocked</div>
                                    <div style="font-size:1.5rem;font-weight:bold;">${progress.unlocked}/${progress.total}</div>
                                </div>
                                <div style="padding:1rem;background:rgba(245,166,35,0.1);border-radius:8px;">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;"></div>
                                    <div style="font-size:0.8rem;color:var(--text-secondary);">Mastered</div>
                                    <div style="font-size:1.5rem;font-weight:bold;color:var(--gold);">${progress.mastered}/${progress.total}</div>
                                </div>
                                <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;"></div>
                                    <div style="font-size:0.8rem;color:var(--text-secondary);">Progress</div>
                                    <div style="font-size:1.5rem;font-weight:bold;">${progress.masteryPercent}%</div>
                                </div>
                            </div>
                        </div>
                        
                        ${this.renderTier('TIER 1: "I Get It!" Level', tier1Concepts, '', 'Start here! These are the basics.')}
                        ${this.renderTier('TIER 2: "Wow, That\'s Cool!" Level', tier2Concepts, '', 'Master 2 Tier 1 concepts to unlock!')}
                        ${this.renderTier('TIER 3: "I\'m Really Good!" Level', tier3Concepts, '', 'Master 3 Tier 2 concepts to unlock!')}
                        
                        <button class="btn-primary" onclick="document.getElementById('screen-replay').style.display='none'" 
                                style="width:100%;margin-top:2rem;padding:1rem;">
                            Close
                        </button>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },
            
            renderTier(title, concepts, emoji, subtitle) {
                return `
                    <div style="margin-bottom:2.5rem;">
                        <div style="text-align:center;margin-bottom:1.5rem;">
                            <div style="font-size:2rem;margin-bottom:0.5rem;">${emoji}</div>
                            <h3 style="font-size:1.5rem;color:var(--gold);margin-bottom:0.25rem;">${title}</h3>
                            <div style="font-size:0.9rem;color:var(--text-secondary);">${subtitle}</div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
                            ${concepts.map(([id, concept]) => `
                                <div onclick="${concept.unlocked ? `EconomicMasteryTree.showMiniLesson('${id}')` : ''}" 
                                     style="padding:1.5rem;
                                            background:${concept.mastered ? 'rgba(245,166,35,0.15)' : concept.unlocked ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.3)'};
                                            border:2px solid ${concept.mastered ? 'var(--gold)' : concept.unlocked ? 'var(--border)' : '#333'};
                                            border-radius:12px;
                                            cursor:${concept.unlocked ? 'pointer' : 'not-allowed'};
                                            opacity:${concept.unlocked ? '1' : '0.4'};
                                            transition:all 0.2s;
                                            position:relative;"
                                     ${concept.unlocked ? `onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='${concept.mastered ? 'var(--gold)' : 'var(--border)'}'"` : ''}>
                                    
                                    ${concept.mastered ? `
                                        <div style="position:absolute;top:-10px;right:-10px;width:35px;height:35px;background:var(--gold);border:3px solid #000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">
                                            
                                        </div>
                                    ` : ''}
                                    
                                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                                        <div style="font-size:2.5rem;">${concept.unlocked ? concept.emoji : ''}</div>
                                        <div style="flex:1;">
                                            <div style="font-size:1.1rem;font-weight:bold;color:${concept.mastered ? 'var(--gold)' : concept.unlocked ? '#fff' : 'var(--text-secondary)'};">
                                                ${concept.kid_friendly_name}
                                            </div>
                                            <div style="font-size:0.75rem;color:var(--text-secondary);">
                                                ${concept.name}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:1rem;">
                                        ${concept.simple_explanation}
                                    </div>
                                    
                                    ${concept.unlocked ? `
                                        <div style="display:flex;justify-content:space-between;align-items:center;padding-top:1rem;border-top:1px solid var(--border);">
                                            <div style="font-size:0.8rem;">
                                                ${concept.mastered ? 
                                                    `<span style="color:#22c55e;font-weight:600;"> MASTERED (${concept.uses} uses)</span>` :
                                                    `<span style="color:var(--text-secondary);">Used ${concept.uses} times</span>`
                                                }
                                            </div>
                                            <div style="font-size:0.8rem;color:var(--gold);">
                                                Click to learn 
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="font-size:0.8rem;color:var(--text-secondary);padding-top:1rem;border-top:1px solid var(--border);">
                                             Locked - Complete prerequisites
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },
            
            // INITIALIZE THE TREE
            init() {
                console.log('=== INITIALIZING ECONOMIC MASTERY TREE ===');
                
                // Ensure Tier 1 is unlocked
                Object.entries(this.concepts).forEach(([id, concept]) => {
                    if (concept.tier === 1) {
                        concept.unlocked = true;
                        console.log(` Tier 1 unlocked: ${concept.kid_friendly_name}`);
                    } else {
                        concept.unlocked = false;
                    }
                });
                
                const progress = this.getMasteryProgress();
                console.log(`Initial state: ${progress.unlocked}/${progress.total} unlocked, ${progress.mastered}/${progress.total} mastered`);
                console.log('=======================================');
            },
            
            // Fix tier unlocking
            checkTierUnlocks() {
                const tier1Mastered = Object.values(this.concepts).filter(c => c.tier === 1 && c.mastered).length;
                const tier2Mastered = Object.values(this.concepts).filter(c => c.tier === 2 && c.mastered).length;
                
                // Unlock Tier 2 if mastered 2+ Tier 1 concepts
                if (tier1Mastered >= 2) {
                    Object.entries(this.concepts).forEach(([id, concept]) => {
                        if (concept.tier === 2 && !concept.unlocked) {
                            this.unlockConcept(id);
                        }
                    });
                }
                
                // Unlock Tier 3 if mastered 3+ Tier 2 concepts  
                if (tier2Mastered >= 3) {
                    Object.entries(this.concepts).forEach(([id, concept]) => {
                        if (concept.tier === 3 && !concept.unlocked) {
                            this.unlockConcept(id);
                        }
                    });
                }
            },
            
            unlockConcept(conceptId) {
                const concept = this.concepts[conceptId];
                if (!concept || concept.unlocked) return;
                
                concept.unlocked = true;
                
                // Show unlock notification
                UI.addAlert(` New concept unlocked: ${concept.kid_friendly_name}!`, 'success');
                console.log(`Unlocked concept: ${concept.kid_friendly_name}`);
            }
        };
        
        // Add inbox button to mentor widget - need to update the widget HTML
        
        // 
        // PRESS CONFERENCE, TRIVIA, REPLAY STORY
        // 

const PressConference = {
    currentQuestion: 0,
    totalQuestions: 3,
    scores: [],
    returnTo: 'outcome',
    
    generateQuestions(outcome, gameState) {
        const questions = [];
        const flags = gameState.flags;
        const decisions = gameState.decisionLog;
        
        // QUESTION 1: Always about the outcome
        if (outcome.outcome === 'Championship') {
            questions.push({
                q: flags.includes('all_in_mode') ? 
                   "You mortgaged the future for this championship. Was the risk worth it?" :
                   flags.includes('rebuild_mode') ?
                   "This championship comes from your rebuild. How does patience feel?" :
                   "You just won the championship! How did you build this winner?",
                answers: [
                    { text: "Every pick, every move, every risk - all worth it for this moment.", effect: { media: 20, owner: 20 }, tone: 'triumphant' },
                    { text: "Credit to the players. They executed the plan perfectly.", effect: { media: 15, trust: 15 }, tone: 'humble' },
                    { text: "This is just the beginning. We're built to win multiple.", effect: { media: 10, owner: 15 }, tone: 'confident' }
                ]
            });
        } else if (outcome.outcome.includes('Exit') || outcome.outcome === 'Play-In Loss') {
            const wasContender = gameState.franchise === 'contender';
            const wentAllIn = flags.includes('all_in_mode');
            questions.push({
                q: wentAllIn ? 
                   "You went all-in. Traded picks, signed big contracts. Now you're out in round one. What went wrong?" :
                   wasContender ?
                   "Expectations were championship. You're eliminated early. What happened?" :
                   "The rebuild continues. Another lottery season. How long will ownership be patient?",
                answers: [
                    { text: "Injuries and bad luck. We were closer than the result shows.", effect: { media: -10, owner: -5 }, tone: 'deflect' },
                    { text: "I take full responsibility. We'll evaluate everything and improve.", effect: { media: 10, trust: 10 }, tone: 'accountable' },
                    { text: "This team overachieved. We'll build on this experience.", effect: { media: -5, owner: 5 }, tone: 'spin' }
                ]
            });
        } else {
            questions.push({
                q: "Another season in the lottery. Fans are frustrated. What's the plan?",
                answers: [
                    { text: "Trust the process. Good things come to those who wait.", effect: { media: -5, owner: 0 }, tone: 'patient' },
                    { text: "We're building the right way. You'll see the results soon.", effect: { media: 5, owner: 10 }, tone: 'optimistic' },
                    { text: "I understand the frustration. We need to do better.", effect: { media: 10, trust: 5 }, tone: 'honest' }
                ]
            });
        }
        
        // QUESTION 2: Based on specific decisions
        if (flags.includes('traded_star')) {
            questions.push({
                q: "You traded your star player mid-journey. Fans are divided. Do you regret it?",
                answers: [
                    { text: "Never look back. That trade positioned us for the future.", effect: { media: 5, owner: 10 }, tone: 'confident' },
                    { text: "It was the hardest decision of my career, but necessary.", effect: { media: 10, trust: 10 }, tone: 'honest' },
                    { text: "The results speak for themselves. Trust the vision.", effect: { media: -5, owner: 15 }, tone: 'defensive' }
                ]
            });
        } else if (flags.includes('max_contract_signed')) {
            questions.push({
                q: "That max contract you handed out - it's consuming your cap space. Second guessing it?",
                answers: [
                    { text: "You pay for stars. That's how you win. No regrets.", effect: { media: 10, owner: 5 }, tone: 'firm' },
                    { text: "Every contract is a bet. We believe in our player.", effect: { media: 5, trust: 10 }, tone: 'supportive' },
                    { text: "Market dictated the price. We had to pay.", effect: { media: 0, owner: -5 }, tone: 'explanatory' }
                ]
            });
        } else if (flags.includes('tax_commitment')) {
            questions.push({
                q: "You're deep in the luxury tax. Ownership is paying millions. Is this sustainable?",
                answers: [
                    { text: "Championships cost money. Ownership understands that.", effect: { media: 5, owner: -10 }, tone: 'bold' },
                    { text: "We'll evaluate the tax situation after we see results.", effect: { media: 5, owner: 5 }, tone: 'measured' },
                    { text: "This window won't last forever. Strike while it's open.", effect: { media: 10, owner: 0 }, tone: 'urgent' }
                ]
            });
        } else if (gameState.rosterQuality < 40) {
            questions.push({
                q: "Your roster quality is near the bottom of the league. When does the rebuild pay off?",
                answers: [
                    { text: "We're accumulating assets. The payoff is coming.", effect: { media: 5, owner: 10 }, tone: 'patient' },
                    { text: "Rome wasn't built in a day. Neither are championships.", effect: { media: 0, owner: 5 }, tone: 'cliche' },
                    { text: "I know it's hard to watch. But we're building something special.", effect: { media: 10, trust: 10 }, tone: 'empathetic' }
                ]
            });
        } else {
            questions.push({
                q: "You've maintained flexibility. But fans want results. When do you cash in the chips?",
                answers: [
                    { text: "Patience wins championships. We won't panic.", effect: { media: 5, owner: 5 }, tone: 'steady' },
                    { text: "The right move is coming. We're not forcing it.", effect: { media: 10, owner: 0 }, tone: 'careful' },
                    { text: "Flexibility IS the asset. It gives us options others don't have.", effect: { media: 0, owner: 10 }, tone: 'philosophical' }
                ]
            });
        }
        
        // QUESTION 3: Future-focused based on current state
        if (outcome.outcome === 'Championship') {
            questions.push({
                q: gameState.optionality < 30 ?
                   "You won, but you're locked in. No cap space, no picks. How do you sustain this?" :
                   "You won with flexibility still intact. What's the plan to repeat?",
                answers: [
                    { text: "This core stays together. We run it back.", effect: { media: 10, trust: 15 }, tone: 'committed' },
                    { text: "We'll make smart tweaks around the edges.", effect: { media: 15, owner: 10 }, tone: 'measured' },
                    { text: "Dynasty mode activated. Get used to this.", effect: { media: 5, owner: 5 }, tone: 'bold' }
                ]
            });
        } else if (gameState.optionality < 30 && gameState.rosterQuality < 60) {
            questions.push({
                q: "You're stuck. No flexibility, no star power, no clear path forward. What now?",
                answers: [
                    { text: "We'll find a way. Good GMs always do.", effect: { media: 0, owner: 5 }, tone: 'vague' },
                    { text: "It's time to blow it up and start over.", effect: { media: 10, owner: -10 }, tone: 'honest' },
                    { text: "This is temporary. Watch us work our way out.", effect: { media: 5, owner: 10 }, tone: 'defiant' }
                ]
            });
        } else {
            questions.push({
                q: "Next season. What's the goal? Realistic expectations?",
                answers: [
                    { text: "Championship or bust. Nothing else matters.", effect: { media: 10, owner: 10 }, tone: 'ambitious' },
                    { text: "Continued growth. We're building toward something.", effect: { media: 5, owner: 5 }, tone: 'developmental' },
                    { text: "Playoffs minimum. This roster is capable.", effect: { media: 10, owner: 10 }, tone: 'realistic' }
                ]
            });
        }
        
        return questions;
    },
    
    show(outcome, returnTo = 'outcome') {
        this.currentQuestion = 0;
        this.scores = [];
        this.returnTo = returnTo;
        this.currentQuestions = this.generateQuestions(outcome, GameState);
        this.showQuestion(0);
        document.getElementById('screen-press').style.display = 'flex';
    },
    
    showQuestion(index) {
        const q = this.currentQuestions[index];
        document.getElementById('press-content').innerHTML = `
            <div style="padding:2rem;">
                <div style="text-align:center;margin-bottom:2rem;">
                    <div style="font-size:3rem;"></div>
                    <h2 style="color:var(--gold);">Post-Season Press Conference</h2>
                    <div style="color:var(--text-secondary);">Question ${index + 1} of ${this.totalQuestions}</div>
                </div>
                <div style="background:rgba(239,68,68,0.1);border-left:3px solid #ef4444;padding:1.5rem;margin-bottom:2rem;">
                    <div style="font-size:1.1rem;font-style:italic;">"${q.q}"</div>
                </div>
                <div style="margin-bottom:1.5rem;">
                    ${q.answers.map((ans, idx) => `
                        <div class="press-answer" onclick="selectAnswer(${index}, ${idx})" 
                             style="padding:1rem;margin-bottom:0.75rem;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:4px;cursor:pointer;">
                            <div style="font-size:1rem;">${ans.text}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">Tone: ${ans.tone}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    },
    
    getMediaTotal() { return this.scores.reduce((sum, s) => sum + (s.media || 0), 0); },
    getOwnerTotal() { return this.scores.reduce((sum, s) => sum + (s.owner || 0), 0); },
    getTrustTotal() { return this.scores.reduce((sum, s) => sum + (s.trust || 0), 0); }
};

function selectAnswer(questionIdx, answerIdx) {
    PressConference.scores.push(PressConference.currentQuestions[questionIdx].answers[answerIdx].effect);
    if (questionIdx < PressConference.totalQuestions - 1) {
        setTimeout(() => PressConference.showQuestion(questionIdx + 1), 300);
    } else {
        setTimeout(showPressResults, 300);
    }
}

function showPressResults() {
    const m = PressConference.getMediaTotal(), o = PressConference.getOwnerTotal(), t = PressConference.getTrustTotal();
    GameState.applyEffects({ mediaNarrative: m, reputationLeague: o, trustIndex: t });
    document.getElementById('press-content').innerHTML = `
        <div style="padding:2rem;text-align:center;">
            <div style="font-size:4rem;"></div>
            <h2 style="color:var(--gold);margin-bottom:2rem;">Press Conference Complete</h2>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:2rem;">
                <div style="padding:1.5rem;background:${m>0?'rgba(16,185,129,0.1)':'rgba(239,68,68,0.1)'};border-radius:4px;">
                    <div style="font-size:0.85rem;color:var(--text-secondary);">Media</div>
                    <div style="font-size:2rem;color:${m>0?'#10b981':'#ef4444'};">${m>0?'+':''}${m}</div>
                </div>
                <div style="padding:1.5rem;background:${o>0?'rgba(16,185,129,0.1)':'rgba(239,68,68,0.1)'};border-radius:4px;">
                    <div style="font-size:0.85rem;color:var(--text-secondary);">Owner</div>
                    <div style="font-size:2rem;color:${o>0?'#10b981':'#ef4444'};">${o>0?'+':''}${o}</div>
                </div>
                <div style="padding:1.5rem;background:${t>0?'rgba(16,185,129,0.1)':'rgba(239,68,68,0.1)'};border-radius:4px;">
                    <div style="font-size:0.85rem;color:var(--text-secondary);">Trust</div>
                    <div style="font-size:2rem;color:${t>0?'#10b981':'#ef4444'};">${t>0?'+':''}${t}</div>
                </div>
            </div>
            <button class="btn-primary" onclick="closePressConference()">Continue</button>
        </div>
    `;
}

function closePressConference() {
    document.getElementById('screen-press').style.display = 'none';
    
    // Return to where we came from
    if (PressConference.returnTo === 'outcome') {
        document.getElementById('screen-outcome').style.display = 'flex';
    } else if (PressConference.returnTo === 'hub') {
        // Already at hub, just update metrics
        UI.updateHubMetrics();
    }
}

const GMTrivia = {
    currentStreak: 0,
    questionsAnswered: 0,
    correctAnswers: 0,
    lastShownTime: 0,
    askedQuestions: [],
    
    questions: [
        // NBA HISTORY (10 questions)
        { q: "Which team won the 2016 NBA Championship coming back from 3-1?", a: ["Warriors", "Cavaliers", "Thunder", "Spurs"], correct: 1, cat: 'history' },
        { q: "Who holds the NBA record for most points in a single game (100)?", a: ["Kobe Bryant", "Michael Jordan", "Wilt Chamberlain", "Kareem Abdul-Jabbar"], correct: 2, cat: 'history' },
        { q: "What year did the NBA introduce the 3-point line?", a: ["1975", "1979", "1983", "1987"], correct: 1, cat: 'history' },
        { q: "Which team had 'The Process' era of tanking?", a: ["Kings", "76ers", "Suns", "Timberwolves"], correct: 1, cat: 'history' },
        { q: "Who was the first overall pick in the 2003 NBA Draft?", a: ["Carmelo Anthony", "Chris Bosh", "LeBron James", "Dwyane Wade"], correct: 2, cat: 'history' },
        { q: "Which team has won the most NBA championships?", a: ["Lakers", "Celtics", "Bulls", "Warriors"], correct: 1, cat: 'history' },
        { q: "What does MVP stand for?", a: ["Most Valuable Player", "Most Victorious Player", "Maximum Value Point", "Main Victory Player"], correct: 0, cat: 'history' },
        { q: "How many teams make the NBA playoffs?", a: ["8", "12", "16", "20"], correct: 2, cat: 'history' },
        { q: "Which player won 11 championships with the Celtics?", a: ["Larry Bird", "Bill Russell", "Bob Cousy", "John Havlicek"], correct: 1, cat: 'history' },
        { q: "What is the maximum number of players on an NBA roster?", a: ["12", "13", "15", "17"], correct: 2, cat: 'history' },
        
        // ECONOMICS (10 questions)
        { q: "What is opportunity cost?", a: ["Monetary cost", "Value of next best alternative", "Total cost", "Cost of mistakes"], correct: 1, cat: 'econ' },
        { q: "What does 'sunk cost' mean?", a: ["Future expenses", "Costs that can't be recovered", "Total budget", "Variable costs"], correct: 1, cat: 'econ' },
        { q: "What is expected value?", a: ["Highest possible outcome", "Average outcome across probabilities", "Most likely outcome", "Guaranteed outcome"], correct: 1, cat: 'econ' },
        { q: "What does variance measure?", a: ["Average result", "Spread of possible outcomes", "Best case", "Worst case"], correct: 1, cat: 'econ' },
        { q: "What is path dependency?", a: ["Walking routes", "Prior choices affecting current options", "Road maps", "Decision trees"], correct: 1, cat: 'econ' },
        { q: "What is information asymmetry?", a: ["Unequal access to information", "Symmetric data", "Perfect knowledge", "No information"], correct: 0, cat: 'econ' },
        { q: "What is constrained optimization?", a: ["No limits", "Maximizing within constraints", "Unlimited resources", "Random choices"], correct: 1, cat: 'econ' },
        { q: "What is the principal-agent problem?", a: ["Main character issue", "Conflict between decision-maker and affected parties", "Agent commission", "Principal's office"], correct: 1, cat: 'econ' },
        { q: "What is time preference?", a: ["Favorite time", "Valuing now vs later", "Clock settings", "Time zones"], correct: 1, cat: 'econ' },
        { q: "What is moral hazard?", a: ["Dangerous morals", "Taking more risk when protected from consequences", "Ethical dilemma", "Hazard pay"], correct: 1, cat: 'econ' },
        
        // SALARY CAP (5 questions)
        { q: "What percentage must salaries match in NBA trades (for over-cap teams)?", a: ["50%", "75%", "80%", "100%"], correct: 2, cat: 'cap' },
        { q: "What is the luxury tax threshold approximately?", a: ["$136M", "$165M", "$171M", "$200M"], correct: 2, cat: 'cap' },
        { q: "What is the salary cap approximately?", a: ["$100M", "$123M", "$140M", "$165M"], correct: 2, cat: 'cap' },
        { q: "What is the mid-level exception?", a: ["Way to sign players while over cap", "Middle salary players", "Average contract", "Exception to rules"], correct: 0, cat: 'cap' },
        { q: "What happens if you exceed the luxury tax?", a: ["Nothing", "Pay penalty to league", "Lose draft picks", "Get fined"], correct: 1, cat: 'cap' },
        
        // FAMOUS GM DECISIONS (10 questions)
        { q: "Was the 2019 Kawhi trade worth it for Toronto?", a: ["No - he left after 1 year", "Yes - won championship", "Too early to tell", "Bad trade"], correct: 1, cat: 'gm' },
        { q: "What did the 76ers 'Process' strategy emphasize?", a: ["Win now", "Tank for high picks", "Trade for stars", "Sign free agents"], correct: 1, cat: 'gm' },
        { q: "Why did the Nets' Pierce/Garnett trade fail?", a: ["Injuries only", "Too old + gave up too many picks", "Bad coaching", "Chemistry"], correct: 1, cat: 'gm' },
        { q: "What made the Warriors' 2016 73-win team possible?", a: ["LeBron trade", "Steph Curry's cheap contract", "Luxury tax", "Draft luck only"], correct: 1, cat: 'gm' },
        { q: "What was the Lakers' strategy in 2019?", a: ["Tank", "Build around LeBron quickly", "Trade everyone", "Develop young core"], correct: 1, cat: 'gm' },
        { q: "Why did OKC trade James Harden in 2012?", a: ["Bad fit", "Avoid luxury tax", "He demanded out", "Got better offer"], correct: 1, cat: 'gm' },
        { q: "What made the 2011 Mavericks championship run special?", a: ["Superteam", "Beat 3 superteams with veterans", "Lucky", "Easy path"], correct: 1, cat: 'gm' },
        { q: "Why did the Heat Big 3 work?", a: ["Best players", "Stars took pay cuts for flexibility", "Weak East", "Coach Spoelstra"], correct: 1, cat: 'gm' },
        { q: "What's the risk of 'win-now' trades?", a: ["Nothing", "Mortgage future for uncertain present", "Always work", "No downside"], correct: 1, cat: 'gm' },
        { q: "What's the value of draft picks?", a: ["Just players", "Optionality and cost control", "Lottery only", "Not valuable"], correct: 1, cat: 'gm' }
    ],
    
    // Smart triggering based on context
    shouldShow(context = 'random') {
        const now = Date.now();
        const timeSinceLastTrivia = now - this.lastShownTime;
        
        // Don't show if shown in last 2 minutes
        if (timeSinceLastTrivia < 120000) return false;
        
        // Don't show if already answered 10+ questions
        if (this.questionsAnswered >= 10) return false;
        
        // Context-based probabilities
        const probabilities = {
            'after_decision': 0.40,  // 40% after making a room decision
            'between_cycles': 0.50,  // 50% between cycles
            'after_outcome': 0.30,   // 30% after seeing season outcome
            'random': 0.10           // 10% random
        };
        
        return Math.random() < (probabilities[context] || 0.10);
    },
    
    getRelevantQuestion(context) {
        // Filter out already asked questions
        const unasked = this.questions.filter(q => !this.askedQuestions.includes(q.q));
        
        if (unasked.length === 0) {
            // Reset if all asked
            this.askedQuestions = [];
            return this.questions[Math.floor(Math.random() * this.questions.length)];
        }
        
        // Prefer economics questions if in teaching mode
        if (GameState.teachingMode) {
            const econQuestions = unasked.filter(q => q.cat === 'econ');
            if (econQuestions.length > 0 && Math.random() < 0.6) {
                return econQuestions[Math.floor(Math.random() * econQuestions.length)];
            }
        }
        
        // Prefer GM decision questions after making decisions
        if (context === 'after_decision') {
            const gmQuestions = unasked.filter(q => q.cat === 'gm');
            if (gmQuestions.length > 0 && Math.random() < 0.5) {
                return gmQuestions[Math.floor(Math.random() * gmQuestions.length)];
            }
        }
        
        // Otherwise random from unasked
        return unasked[Math.floor(Math.random() * unasked.length)];
    },
    
    show(context = 'random') {
        const q = this.getRelevantQuestion(context);
        this.askedQuestions.push(q.q);
        this.lastShownTime = Date.now();
        
        const categoryEmoji = {
            'history': '',
            'econ': '',
            'cap': '',
            'gm': ''
        };
        
        const categoryName = {
            'history': 'NBA History',
            'econ': 'Economics',
            'cap': 'Salary Cap',
            'gm': 'GM Decisions'
        };
        
        document.getElementById('trivia-content').innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                <div>
                    <div style="font-size:1.2rem;font-weight:bold;color:var(--gold);"> Quick Trivia</div>
                    <div style="font-size:0.75rem;color:var(--text-secondary);">
                        ${categoryEmoji[q.cat]} ${categoryName[q.cat]}
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:0.85rem;color:var(--text-secondary);">Streak</div>
                    <div style="font-size:1.2rem;color:var(--gold);"> ${this.currentStreak}</div>
                </div>
            </div>
            
            <div style="background:rgba(255,255,255,0.05);padding:1rem;border-radius:4px;margin-bottom:1rem;">
                <div style="font-size:0.95rem;line-height:1.4;">${q.q}</div>
            </div>
            
            ${q.a.map((answer, idx) => `
                <button class="trivia-answer" onclick="answerTrivia(${idx}, ${q.correct})" 
                        style="width:100%;padding:0.75rem;margin-bottom:0.5rem;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:4px;cursor:pointer;text-align:left;color:white;transition:all 0.2s;">
                    <strong>${String.fromCharCode(65 + idx)}.</strong> ${answer}
                </button>
            `).join('')}
            
            <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                <div style="font-size:0.75rem;color:var(--text-secondary);">
                    ${this.correctAnswers}/${this.questionsAnswered} correct (${this.questionsAnswered > 0 ? Math.round(this.correctAnswers/this.questionsAnswered * 100) : 0}%)
                </div>
                <button onclick="GMTrivia.hide()" style="font-size:0.75rem;color:var(--text-secondary);background:none;border:none;cursor:pointer;text-decoration:underline;">
                    Skip
                </button>
            </div>
            
            <div style="margin-top:0.5rem;height:3px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                <div id="trivia-timer-bar" style="height:100%;background:var(--gold);width:100%;transition:width 30s linear;"></div>
            </div>
        `;
        
        document.getElementById('trivia-popup').style.display = 'block';
        window.triviaQuestion = q;
        
        // Animate timer bar
        setTimeout(() => {
            document.getElementById('trivia-timer-bar').style.width = '0%';
        }, 100);
        
        window.triviaTimeout = setTimeout(() => GMTrivia.hide(), 30000);
    },
    
    hide() {
        document.getElementById('trivia-popup').style.display = 'none';
        if (window.triviaTimeout) clearTimeout(window.triviaTimeout);
    }
};

function answerTrivia(selected, correct) {
    clearTimeout(window.triviaTimeout);
    GMTrivia.questionsAnswered++;
    const isCorrect = selected === correct;
    
    if (isCorrect) {
        GMTrivia.correctAnswers++;
        GMTrivia.currentStreak++;
        if (GMTrivia.currentStreak === 3) {
            GameState.applyEffects({ informationEdge: 5 });
            UI.addAlert(' 3-Streak Bonus: +5 Information Edge!', 'success');
        }
        if (GMTrivia.currentStreak === 5) {
            GameState.applyEffects({ informationEdge: 10 });
            UI.addAlert(' 5-Streak! +10 Information Edge!', 'success');
        }
    } else {
        GMTrivia.currentStreak = 0;
    }
    
    const streakBonus = GMTrivia.currentStreak >= 3 ? ` |  ${GMTrivia.currentStreak}-Streak!` : '';
    
    document.getElementById('trivia-content').innerHTML = `
        <div style="text-align:center;padding:2rem;">
            <div style="font-size:4rem;margin-bottom:1rem;">${isCorrect ? '' : ''}</div>
            <div style="font-size:1.4rem;color:${isCorrect?'#10b981':'#ef4444'};margin-bottom:0.5rem;">
                ${isCorrect ? 'Correct!' : 'Incorrect'}
            </div>
            ${!isCorrect ? `
                <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:1rem;padding:1rem;background:rgba(255,255,255,0.05);border-radius:4px;">
                    <strong>Correct answer:</strong><br>${window.triviaQuestion.a[correct]}
                </div>
            ` : ''}
            <div style="font-size:0.9rem;color:var(--text-secondary);margin-top:1rem;">
                Total: ${GMTrivia.correctAnswers}/${GMTrivia.questionsAnswered} (${Math.round(GMTrivia.correctAnswers/GMTrivia.questionsAnswered * 100)}%)${streakBonus}
            </div>
        </div>
    `;
    
    setTimeout(() => GMTrivia.hide(), 2500);
}

function maybeShowTrivia(context = 'random') {
    if (GMTrivia.shouldShow(context)) {
        setTimeout(() => GMTrivia.show(context), 2000);
    }
}

function showReplayStory() {
    // Analyze the journey for emotional arc
    const keyDecisions = GameState.decisionLog.filter((d, idx) => idx % 3 === 0); // Sample key decisions
    const turningPoint = GameState.seasonOutcomes.findIndex(o => o.outcome === 'Championship') !== -1 ? 
                         GameState.seasonOutcomes.findIndex(o => o.outcome === 'Championship') :
                         GameState.seasonOutcomes.findIndex(o => o.wins > 45);
    
    const wasRisky = GameState.riskExposure > 60;
    const wasPatient = GameState.optionality > 60;
    const wentAllIn = GameState.flags.includes('all_in_mode');
    
    let html = `
        <style>
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(30px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes shimmer {
                0% { background-position: -1000px 0; }
                100% { background-position: 1000px 0; }
            }
            .replay-chapter {
                animation: fadeInUp 0.8s ease backwards;
                animation-delay: calc(var(--chapter-index) * 0.3s);
            }
            .championship-glow {
                background: linear-gradient(90deg, rgba(245,166,35,0.1), rgba(245,166,35,0.3), rgba(245,166,35,0.1));
                background-size: 1000px 100%;
                animation: shimmer 3s infinite;
            }
        </style>
        
        <div style="padding:2rem;max-width:900px;margin:0 auto;min-height:100vh;">
            <!-- OPENING -->
            <div style="text-align:center;margin-bottom:4rem;animation:fadeInUp 0.6s ease;">
                <div style="font-size:5rem;margin-bottom:1rem;"></div>
                <h1 style="color:var(--gold);font-size:3rem;font-weight:700;margin-bottom:0.5rem;">
                    ${GameState.franchiseName}
                </h1>
                <div style="font-size:1.5rem;color:var(--text-secondary);font-style:italic;margin-bottom:1rem;">
                    A ${GameState.franchise === 'contender' ? 'Win-Now' : GameState.franchise === 'young' ? 'Rebuild' : 'Messy Middle'} Story
                </div>
                ${GameState.championships > 0 ? `
                    <div style="font-size:4rem;margin:2rem 0;"></div>
                    <div style="font-size:2.5rem;color:var(--gold);font-weight:bold;">
                        ${GameState.championships} Championship${GameState.championships > 1 ? 's' : ''}
                    </div>
                ` : ''}
            </div>
            
            <!-- THE JOURNEY BEGINS -->
            <div style="background:linear-gradient(135deg,rgba(245,166,35,0.05),rgba(59,130,246,0.05));padding:2rem;border-radius:8px;margin-bottom:3rem;border-left:4px solid var(--gold);">
                <div style="font-size:1.8rem;color:var(--gold);margin-bottom:1rem;font-weight:600;">
                     The Story
                </div>
                <div style="font-size:1.1rem;line-height:1.8;color:var(--text-secondary);">
                    ${wentAllIn ? 'You went all-in from day one. Every chip on the table. No safety net.' :
                      wasPatient ? 'You played the long game. Patient. Strategic. Building toward something bigger.' :
                      'You navigated the middle path. Balancing risk and reward, flexibility and commitment.'}
                    ${GameState.championships > 0 ? ' And it paid off.' : ' The journey was the destination.'}
                </div>
            </div>
    `;
    
    // EACH CYCLE AS A CHAPTER
    GameState.seasonOutcomes.forEach((outcome, idx) => {
        const isTurningPoint = idx === turningPoint;
        const isChampionship = outcome.outcome === 'Championship';
        const isDisaster = outcome.wins < 30;
        
        const chapterTitles = [
            'Act I: The Beginning',
            'Act II: The Test',
            'Act III: The Crucible',
            'Act IV: The Reckoning'
        ];
        
        const chapterEmojis = ['', '', '', isChampionship ? '' : ''];
        const chapterColors = [
            'var(--gold)',
            'var(--info)',
            'var(--success)',
            isChampionship ? 'var(--gold)' : 'var(--danger)'
        ];
        
        // Get key decisions from this cycle
        const cycleDecisions = GameState.decisionLog.filter(d => d.cycleIndex === idx + 1);
        
        html += `
            <div class="replay-chapter" style="--chapter-index:${idx};margin-bottom:3rem;${isChampionship ? 'padding:2rem;' : ''}${isChampionship ? 'class="championship-glow"' : ''}" ${isChampionship ? 'class="championship-glow"' : ''}>
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:2rem;">
                    <div style="font-size:3rem;">${chapterEmojis[idx]}</div>
                    <div>
                        <div style="font-size:2rem;color:${chapterColors[idx]};font-weight:700;">
                            ${chapterTitles[idx]}
                        </div>
                        <div style="font-size:1rem;color:var(--text-secondary);">
                            Cycle ${idx + 1} of 4
                        </div>
                    </div>
                </div>
                
                ${isTurningPoint ? `
                    <div style="background:rgba(245,166,35,0.1);border:2px solid var(--gold);padding:1rem;border-radius:4px;margin-bottom:1.5rem;">
                        <div style="font-weight:bold;color:var(--gold);margin-bottom:0.5rem;"> TURNING POINT</div>
                        <div style="font-size:0.9rem;">This was the moment everything changed.</div>
                    </div>
                ` : ''}
                
                <div style="background:rgba(255,255,255,0.03);padding:1.5rem;border-radius:6px;border-left:4px solid ${chapterColors[idx]};margin-bottom:1.5rem;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1rem;">
                        <div>
                            <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.25rem;">Final Record</div>
                            <div style="font-size:1.8rem;font-weight:bold;color:${isChampionship ? 'var(--gold)' : 'white'};">
                                ${outcome.wins}-${82-outcome.wins}
                            </div>
                        </div>
                        <div>
                            <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.25rem;">Outcome</div>
                            <div style="font-size:1.3rem;font-weight:600;color:${isChampionship ? 'var(--gold)' : isDisaster ? 'var(--danger)' : 'var(--success)'};">
                                ${outcome.outcome}
                            </div>
                        </div>
                    </div>
                    
                    ${cycleDecisions.length > 0 ? `
                        <div style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border);">
                            <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.75rem;font-weight:600;">
                                Key Decisions This Cycle:
                            </div>
                            ${cycleDecisions.slice(0, 2).map(d => `
                                <div style="padding:0.75rem;background:rgba(0,0,0,0.3);border-left:3px solid ${chapterColors[idx]};margin-bottom:0.5rem;border-radius:4px;">
                                    <div style="font-size:0.9rem;font-weight:500;">${d.optionText}</div>
                                    <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem;">
                                        ${d.roomName === 'eval' ? ' War Room' :
                                          d.roomName === 'cap' ? ' Cap Room' :
                                          d.roomName === 'relationships' ? ' Relationships' :
                                          ' Risk Management'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                
                ${isChampionship ? `
                    <div style="text-align:center;padding:2rem;background:linear-gradient(135deg,rgba(245,166,35,0.2),rgba(245,166,35,0.05));border-radius:8px;border:2px solid var(--gold);">
                        <div style="font-size:4rem;margin-bottom:1rem;"></div>
                        <div style="font-size:2rem;color:var(--gold);font-weight:bold;margin-bottom:0.5rem;">
                            CHAMPIONS
                        </div>
                        <div style="font-size:1.1rem;color:var(--text-secondary);">
                            Every decision. Every risk. Every sacrifice. This is why.
                        </div>
                    </div>
                ` : isDisaster ? `
                    <div style="text-align:center;padding:1.5rem;background:rgba(239,68,68,0.1);border-radius:6px;border:1px solid var(--danger);">
                        <div style="font-size:0.9rem;color:var(--danger);">
                            A difficult season. ${outcome.wins} wins. But every struggle builds character.
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    // FINAL STATISTICS
    html += `
        <div style="background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(16,185,129,0.1));padding:2.5rem;border-radius:12px;margin-top:4rem;">
            <div style="font-size:2rem;color:var(--gold);margin-bottom:2rem;text-align:center;font-weight:700;">
                 Final Statistics
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;">
                <div style="background:rgba(0,0,0,0.3);padding:1.5rem;border-radius:8px;text-align:center;">
                    <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">Total Decisions</div>
                    <div style="font-size:2.5rem;font-weight:bold;color:var(--gold);">${GameState.decisionLog.length}</div>
                </div>
                
                <div style="background:rgba(0,0,0,0.3);padding:1.5rem;border-radius:8px;text-align:center;">
                    <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">Total Wins</div>
                    <div style="font-size:2.5rem;font-weight:bold;color:var(--success);">
                        ${GameState.seasonOutcomes.reduce((sum, o) => sum + o.wins, 0)}
                    </div>
                </div>
                
                <div style="background:rgba(0,0,0,0.3);padding:1.5rem;border-radius:8px;text-align:center;">
                    <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">Playoff Appearances</div>
                    <div style="font-size:2.5rem;font-weight:bold;color:var(--info);">
                        ${GameState.playoffAppearances}
                    </div>
                </div>
                
                <div style="background:rgba(0,0,0,0.3);padding:1.5rem;border-radius:8px;text-align:center;">
                    <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">Championships</div>
                    <div style="font-size:2.5rem;font-weight:bold;color:var(--gold);">
                        ${GameState.championships}
                    </div>
                </div>
            </div>
            
            ${GameState.teachingMode ? `
                <div style="margin-top:2rem;padding-top:2rem;border-top:1px solid var(--border);">
                    <div style="font-size:1.2rem;color:var(--gold);margin-bottom:1rem;text-align:center;">
                         Economics Concepts Learned
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:0.75rem;justify-content:center;">
                        ${GameState.conceptsLearned.map(concept => `
                            <div style="background:rgba(245,166,35,0.1);border:1px solid var(--gold);padding:0.5rem 1rem;border-radius:20px;font-size:0.85rem;">
                                ${concept}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
        
        <!-- CLOSING -->
        <div style="text-align:center;margin:4rem 0 2rem;animation:fadeInUp 1.2s ease backwards;animation-delay:1.5s;">
            <div style="font-size:1.5rem;color:var(--gold);margin-bottom:2rem;font-style:italic;">
                ${GameState.championships > 0 ? 
                  '"The best GMs know: It\'s not about one decision. It\'s about the story all your decisions tell."' :
                  '"Not every journey ends in champagne. But every GM learns. Every decision teaches. That\'s the real win."'}
            </div>
            
            <button class="btn-primary" onclick="closeReplay()" style="padding:1rem 3rem;font-size:1.1rem;">
                Return to Dossier
            </button>
            
            <div style="margin-top:1.5rem;">
                <button class="btn-ghost" onclick="downloadStoryTranscript()" style="font-size:0.9rem;">
                     Download Story Transcript
                </button>
            </div>
        </div>
    </div>
    `;
    
    document.getElementById('replay-content').innerHTML = html;
    document.getElementById('screen-replay').style.display = 'flex';
    
    // Scroll to top
    document.getElementById('screen-replay').scrollTop = 0;
}

function downloadStoryTranscript() {
    // Generate text transcript
    let transcript = `${GameState.franchiseName} - GM Journey\n`;
    transcript += `${'='.repeat(50)}\n\n`;
    transcript += `Franchise Type: ${GameState.franchise}\n`;
    transcript += `Championships: ${GameState.championships}\n`;
    transcript += `Playoff Appearances: ${GameState.playoffAppearances}\n\n`;
    
    GameState.seasonOutcomes.forEach((outcome, idx) => {
        transcript += `\nCycle ${idx + 1}:\n`;
        transcript += `  Record: ${outcome.wins}-${82-outcome.wins}\n`;
        transcript += `  Outcome: ${outcome.outcome}\n`;
        
        const cycleDecisions = GameState.decisionLog.filter(d => d.cycleIndex === idx + 1);
        if (cycleDecisions.length > 0) {
            transcript += `  Key Decisions:\n`;
            cycleDecisions.forEach(d => {
                transcript += `    - ${d.optionText}\n`;
            });
        }
    });
    
    transcript += `\n${'='.repeat(50)}\n`;
    transcript += `Total Decisions: ${GameState.decisionLog.length}\n`;
    transcript += `Total Wins: ${GameState.seasonOutcomes.reduce((sum, o) => sum + o.wins, 0)}\n`;
    
    // Download
    const blob = new Blob([transcript], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${GameState.franchiseName}-Story.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function closeReplay() {
    document.getElementById('screen-replay').style.display = 'none';
}

// 
// GM PERFORMANCE ANALYTICS DASHBOARD
// 

function showPerformanceDashboard() {
    // Calculate comprehensive analytics
    const analytics = calculateGMAnalytics();
    
    const html = `
        <div style="padding:3rem;max-width:1200px;margin:0 auto;">
            <div style="text-align:center;margin-bottom:3rem;">
                <div style="font-size:4rem;margin-bottom:1rem;"></div>
                <h1 style="color:var(--gold);font-size:2.5rem;margin-bottom:0.5rem;">
                    GM Performance Analytics
                </h1>
                <div style="font-size:1.2rem;color:var(--text-secondary);">
                    Data-Driven Analysis of Your Journey
                </div>
            </div>
            
            <!-- OVERALL GRADE -->
            <div style="background:linear-gradient(135deg,rgba(245,166,35,0.15),rgba(59,130,246,0.15));padding:3rem;border-radius:12px;margin-bottom:3rem;text-align:center;">
                <div style="font-size:6rem;font-weight:bold;color:var(--gold);line-height:1;">
                    ${analytics.overallGrade}
                </div>
                <div style="font-size:1.5rem;margin-top:1rem;color:var(--text-secondary);">
                    Overall GM Grade
                </div>
                <div style="font-size:1rem;margin-top:0.5rem;color:var(--text-secondary);">
                    ${analytics.gradeExplanation}
                </div>
            </div>
            
            <!-- KEY METRICS GRID -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:3rem;">
                ${generateMetricCard('Decision Efficiency', analytics.decisionEfficiency, '%', 'How often your decisions improved your position')}
                ${generateMetricCard('Risk Management', analytics.riskScore, '/100', 'Balance of risk vs reward across decisions')}
                ${generateMetricCard('Flexibility Maintained', analytics.flexibilityScore, '%', 'How well you preserved optionality')}
                ${generateMetricCard('Win Probability Added', analytics.winProbAdded, '%', 'Expected wins added by your decisions')}
            </div>
            
            <!-- DECISION BREAKDOWN -->
            <div style="background:rgba(255,255,255,0.03);padding:2rem;border-radius:8px;margin-bottom:3rem;">
                <h2 style="color:var(--gold);margin-bottom:2rem;font-size:1.8rem;">Decision Analysis</h2>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem;">
                    <div>
                        <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:1rem;">Decision Types</div>
                        ${generateBarChart(analytics.decisionTypes)}
                    </div>
                    <div>
                        <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:1rem;">Room Focus</div>
                        ${generateBarChart(analytics.roomFocus)}
                    </div>
                </div>
                
                <div style="padding:1.5rem;background:rgba(0,0,0,0.3);border-radius:6px;">
                    <div style="font-weight:bold;margin-bottom:1rem;">Decision Highlights:</div>
                    <ul style="list-style:none;padding:0;margin:0;">
                        ${analytics.highlights.map(h => `
                            <li style="padding:0.75rem 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:1rem;">
                                <span style="font-size:1.5rem;">${h.icon}</span>
                                <span>${h.text}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
            
            <!-- METRICS OVER TIME -->
            <div style="background:rgba(255,255,255,0.03);padding:2rem;border-radius:8px;margin-bottom:3rem;">
                <h2 style="color:var(--gold);margin-bottom:2rem;font-size:1.8rem;">Metrics Over Time</h2>
                ${generateTimelineChart(analytics.metricsOverTime)}
            </div>
            
            <!-- ECONOMICS CONCEPTS MASTERED -->
            ${GameState.teachingMode ? `
                <div style="background:rgba(245,166,35,0.05);border:2px solid var(--gold);padding:2rem;border-radius:8px;margin-bottom:3rem;">
                    <h2 style="color:var(--gold);margin-bottom:2rem;font-size:1.8rem;">
                         Economics Concepts Demonstrated
                    </h2>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;">
                        ${analytics.conceptsMastered.map(concept => `
                            <div style="background:rgba(0,0,0,0.3);padding:1.5rem;border-radius:6px;border-left:4px solid var(--gold);">
                                <div style="font-size:1.1rem;font-weight:bold;margin-bottom:0.5rem;color:var(--gold);">
                                    ${concept.name}
                                </div>
                                <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:1rem;">
                                    ${concept.definition}
                                </div>
                                <div style="font-size:0.85rem;padding:0.75rem;background:rgba(255,255,255,0.05);border-radius:4px;">
                                    <strong>Your Example:</strong> ${concept.yourExample}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- COMPARISON TO ARCHETYPES -->
            <div style="background:rgba(255,255,255,0.03);padding:2rem;border-radius:8px;margin-bottom:3rem;">
                <h2 style="color:var(--gold);margin-bottom:2rem;font-size:1.8rem;">GM Archetype Analysis</h2>
                <div style="font-size:1.2rem;margin-bottom:1.5rem;">
                    You played like: <span style="color:var(--gold);font-weight:bold;">${analytics.archetype}</span>
                </div>
                <div style="margin-bottom:2rem;line-height:1.6;">
                    ${analytics.archetypeDescription}
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
                    ${analytics.archetypeComparison.map(comp => `
                        <div style="padding:1rem;background:rgba(0,0,0,0.3);border-radius:4px;">
                            <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">${comp.trait}</div>
                            <div style="display:flex;align-items:center;gap:0.5rem;">
                                <div style="flex:1;background:rgba(255,255,255,0.1);height:8px;border-radius:4px;overflow:hidden;">
                                    <div style="width:${comp.value}%;height:100%;background:var(--gold);transition:width 0.5s;"></div>
                                </div>
                                <div style="font-size:0.9rem;min-width:40px;">${comp.value}%</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- DOWNLOAD & ACTIONS -->
            <div style="text-align:center;margin-top:3rem;">
                <button class="btn-primary" onclick="downloadPerformanceReport()" style="padding:1rem 2rem;font-size:1.1rem;margin-right:1rem;">
                     Download Full Report (PDF)
                </button>
                <button class="btn-ghost" onclick="closeDashboard()">
                    Return to Dossier
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('replay-content').innerHTML = html;
    document.getElementById('screen-replay').style.display = 'flex';
    document.getElementById('screen-replay').scrollTop = 0;
    
    // Animate progress bars
    setTimeout(() => {
        document.querySelectorAll('[style*="transition"]').forEach(el => {
            if (el.style.width) {
                const width = el.style.width;
                el.style.width = '0%';
                setTimeout(() => el.style.width = width, 100);
            }
        });
    }, 100);
}

function calculateGMAnalytics() {
    const decisions = GameState.decisionLog;
    const outcomes = GameState.seasonOutcomes;
    
    // Decision efficiency - did decisions improve metrics?
    let improvements = 0;
    decisions.forEach((dec, idx) => {
        if (idx > 0 && (
            GameState.rosterQuality > 50 ||
            GameState.optionality > 50 ||
            GameState.trustIndex > 50
        )) improvements++;
    });
    const decisionEfficiency = Math.round((improvements / decisions.length) * 100);
    
    // Risk score
    const avgRisk = GameState.riskExposure;
    const riskScore = avgRisk > 70 ? 40 : avgRisk > 50 ? 60 : avgRisk > 30 ? 80 : 90;
    
    // Flexibility score
    const flexibilityScore = Math.round(GameState.optionality);
    
    // Win probability added
    const totalWins = outcomes.reduce((sum, o) => sum + o.wins, 0);
    const expectedWins = GameState.franchise === 'contender' ? 180 : GameState.franchise === 'young' ? 120 : 140;
    const winProbAdded = Math.round(((totalWins - expectedWins) / expectedWins) * 100);
    
    // Overall grade
    const avgScore = (decisionEfficiency + riskScore + flexibilityScore + Math.max(0, winProbAdded + 50)) / 4;
    const grade = avgScore >= 90 ? 'A+' : avgScore >= 85 ? 'A' : avgScore >= 80 ? 'A-' :
                  avgScore >= 75 ? 'B+' : avgScore >= 70 ? 'B' : avgScore >= 65 ? 'B-' :
                  avgScore >= 60 ? 'C+' : avgScore >= 55 ? 'C' : 'C-';
    
    const gradeExplanation = 
        grade.startsWith('A') ? 'Elite GM performance. Excellent decision-making.' :
        grade.startsWith('B') ? 'Solid GM work. Room for improvement.' :
        'Developing GM. Learn from mistakes.';
    
    // Decision types
    const allInCount = decisions.filter(d => d.optionId.includes('allin') || d.optionId.includes('commit')).length;
    const patientCount = decisions.filter(d => d.optionId.includes('patient') || d.optionId.includes('wait')).length;
    const balancedCount = decisions.length - allInCount - patientCount;
    
    const decisionTypes = [
        { label: 'All-In', value: allInCount, max: decisions.length },
        { label: 'Patient', value: patientCount, max: decisions.length },
        { label: 'Balanced', value: balancedCount, max: decisions.length }
    ];
    
    // Room focus
    const roomCounts = {};
    decisions.forEach(d => {
        const room = d.roomName || 'other';
        roomCounts[room] = (roomCounts[room] || 0) + 1;
    });
    
    const roomLabels = { eval: 'War Room', cap: 'Cap Room', relationships: 'Relationships', risk: 'Risk Management' };
    const roomFocus = Object.entries(roomCounts).map(([room, count]) => ({
        label: roomLabels[room] || room,
        value: count,
        max: decisions.length
    }));
    
    // Highlights
    const highlights = [];
    if (GameState.championships > 0) {
        highlights.push({ icon: '', text: `Won ${GameState.championships} championship${GameState.championships > 1 ? 's' : ''}` });
    }
    if (allInCount > patientCount * 2) {
        highlights.push({ icon: '', text: 'Aggressive decision-maker - went all-in frequently' });
    }
    if (patientCount > allInCount * 2) {
        highlights.push({ icon: '', text: 'Patient strategist - preserved flexibility' });
    }
    if (GameState.flags.includes('completed_trade_puzzle')) {
        highlights.push({ icon: '', text: 'Mastered salary cap optimization puzzle' });
    }
    if (GameState.flags.includes('lottery_pick_1')) {
        highlights.push({ icon: '', text: 'Won #1 overall pick in lottery!' });
    }
    
    // Archetype
    let archetype = '';
    let archetypeDesc = '';
    if (allInCount > decisions.length * 0.6) {
        archetype = 'The Gambler (Daryl Morey Style)';
        archetypeDesc = 'You took big swings and weren\'t afraid of risk. All-in mentality defined your tenure.';
    } else if (patientCount > decisions.length * 0.6) {
        archetype = 'The Process (Sam Presti Style)';
        archetypeDesc = 'Patient, methodical, asset-focused. You played the long game with discipline.';
    } else {
        archetype = 'The Balanced Builder (Masai Ujiri Style)';
        archetypeDesc = 'You mixed aggression with patience, adapting strategy to circumstances.';
    }
    
    const archetypeComparison = [
        { trait: 'Aggression', value: Math.round((allInCount / decisions.length) * 100) },
        { trait: 'Patience', value: Math.round((patientCount / decisions.length) * 100) },
        { trait: 'Risk Tolerance', value: Math.round(avgRisk) },
        { trait: 'Flexibility', value: flexibilityScore }
    ];
    
    // Concepts mastered
    const conceptsMastered = [
        {
            name: 'Opportunity Cost',
            definition: 'The value of the next best alternative foregone',
            yourExample: decisions.length > 0 ? `Chose "${decisions[0].optionText}" which meant giving up alternative paths` : 'N/A'
        },
        {
            name: 'Expected Value',
            definition: 'The average outcome across all probabilities',
            yourExample: outcomes.length > 0 ? `Expected ${expectedWins/4} wins per season, achieved ${Math.round(totalWins/outcomes.length)}` : 'N/A'
        },
        {
            name: 'Path Dependency',
            definition: 'Current options constrained by prior choices',
            yourExample: GameState.flags.length > 0 ? `Flags like "${GameState.flags[0]}" affected later scenarios` : 'Demonstrated through branching scenarios'
        }
    ];
    
    return {
        overallGrade: grade,
        gradeExplanation,
        decisionEfficiency,
        riskScore,
        flexibilityScore,
        winProbAdded,
        decisionTypes,
        roomFocus,
        highlights,
        archetype,
        archetypeDescription: archetypeDesc,
        archetypeComparison,
        conceptsMastered,
        metricsOverTime: generateMetricsTimeline()
    };
}

function generateMetricCard(title, value, unit, description) {
    const color = value >= 75 ? '#10b981' : value >= 50 ? 'var(--gold)' : '#ef4444';
    return `
        <div style="background:rgba(255,255,255,0.03);padding:1.5rem;border-radius:8px;border-top:4px solid ${color};">
            <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">${title}</div>
            <div style="font-size:2.5rem;font-weight:bold;color:${color};margin-bottom:0.5rem;">
                ${value}${unit}
            </div>
            <div style="font-size:0.8rem;color:var(--text-secondary);line-height:1.4;">
                ${description}
            </div>
        </div>
    `;
}

function generateBarChart(data) {
    const total = data.reduce((sum, d) => sum + d.value, 0);
    return `
        <div style="display:flex;flex-direction:column;gap:0.75rem;">
            ${data.map(item => {
                const percentage = Math.round((item.value / total) * 100);
                return `
                    <div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.25rem;font-size:0.85rem;">
                            <span>${item.label}</span>
                            <span style="color:var(--gold);">${item.value} (${percentage}%)</span>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);height:8px;border-radius:4px;overflow:hidden;">
                            <div style="width:${percentage}%;height:100%;background:var(--gold);transition:width 0.5s;"></div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function generateMetricsTimeline() {
    // Would track metrics across cycles - simplified for now
    return [];
}

function generateTimelineChart(metricsData) {
    // Simplified visual timeline
    return `
        <div style="padding:2rem;background:rgba(0,0,0,0.3);border-radius:6px;text-align:center;">
            <div style="display:flex;justify-content:space-between;align-items:center;max-width:800px;margin:0 auto;">
                ${GameState.seasonOutcomes.map((outcome, idx) => `
                    <div style="flex:1;position:relative;">
                        <div style="width:60px;height:60px;margin:0 auto;background:${outcome.outcome === 'Championship' ? 'var(--gold)' : 'var(--info)'};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:bold;border:3px solid rgba(255,255,255,0.2);">
                            ${outcome.wins}
                        </div>
                        <div style="margin-top:0.5rem;font-size:0.75rem;color:var(--text-secondary);">
                            Cycle ${idx + 1}
                        </div>
                        ${idx < GameState.seasonOutcomes.length - 1 ? `
                            <div style="position:absolute;top:30px;left:50%;width:100%;height:2px;background:var(--border);"></div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function downloadPerformanceReport() {
    const analytics = calculateGMAnalytics();
    
    let report = `GM PERFORMANCE ANALYTICS REPORT\n`;
    report += `${'='.repeat(60)}\n\n`;
    report += `Overall Grade: ${analytics.overallGrade}\n`;
    report += `${analytics.gradeExplanation}\n\n`;
    report += `KEY METRICS:\n`;
    report += `- Decision Efficiency: ${analytics.decisionEfficiency}%\n`;
    report += `- Risk Management Score: ${analytics.riskScore}/100\n`;
    report += `- Flexibility Maintained: ${analytics.flexibilityScore}%\n`;
    report += `- Win Probability Added: ${analytics.winProbAdded}%\n\n`;
    report += `ARCHETYPE: ${analytics.archetype}\n`;
    report += `${analytics.archetypeDescription}\n\n`;
    report += `DECISION BREAKDOWN:\n`;
    analytics.decisionTypes.forEach(dt => {
        report += `- ${dt.label}: ${dt.value} decisions\n`;
    });
    report += `\nSEASON RESULTS:\n`;
    GameState.seasonOutcomes.forEach((o, idx) => {
        report += `Cycle ${idx + 1}: ${o.wins} wins - ${o.outcome}\n`;
    });
    report += `\n${'='.repeat(60)}\n`;
    
    const blob = new Blob([report], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${GameState.franchiseName}-Performance-Report.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function closeDashboard() {
    document.getElementById('screen-replay').style.display = 'none';
}

function copyClaimCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        UI.addAlert('Claim code copied to clipboard!', 'success');
    });
}

// 
// MASTERY QUIZ - PERSONALIZED ASSESSMENT (30% OF GRADE)
// 

const MasteryQuiz = {
    questions: [],
    currentQuestion: 0,
    answers: [],
    startTime: null,
    
    generatePersonalizedQuiz() {
        const questions = [];
        const decisions = GameState.decisionLog;
        const outcomes = GameState.seasonOutcomes;
        
        // SECTION 1: DECISION RECALL & CONCEPT IDENTIFICATION (4 questions)
        // Pull from their actual decisions
        
        if (decisions.length > 0) {
            const decision1 = decisions[0];
            questions.push({
                type: 'multiple_choice',
                question: `In ${decision1.roomName === 'eval' ? 'the War Room' : decision1.roomName === 'cap' ? 'the Cap Room' : decision1.roomName === 'relationships' ? 'the Relationships Room' : 'the Risk Room'}, you chose "${decision1.optionText}".\n\nWhich economic concept BEST explains this decision?`,
                options: [
                    'Opportunity Cost - You gave up alternative uses of resources',
                    'Sunk Cost - You avoided past investment fallacy',
                    'Information Asymmetry - You had hidden knowledge',
                    'Moral Hazard - You incentivized risky behavior'
                ],
                correct: 0,
                explanation: `This decision involved Opportunity Cost because when you allocated resources (cap space, picks, or trust) to one option, you gave up the ability to use those resources elsewhere. That's the fundamental definition of opportunity cost.`,
                points: 5
            });
        }
        
        // Question about their franchise choice
        questions.push({
            type: 'multiple_choice', 
            question: `You chose to manage the ${GameState.franchiseName} (${GameState.franchise === 'contender' ? 'Win-Now Contender' : GameState.franchise === 'young' ? 'Young Core' : 'Messy Middle'}).\n\nWhat economic concept is MOST important for this franchise type?`,
            options: [
                GameState.franchise === 'contender' ? 'Time Preference - Win now vs future' : 'Option Value - Preserving flexibility',
                'Sunk Cost - Ignoring past investments',
                'Moral Hazard - Principal-agent problems',
                'Information Asymmetry - Hidden information'
            ],
            correct: 0,
            explanation: GameState.franchise === 'contender' ? 
                `Contenders face TIME PREFERENCE decisions constantly: sacrifice the future for present success? Your aging star forces you to value the present highly.` :
                GameState.franchise === 'young' ?
                `Young cores are all about OPTION VALUE: preserve flexibility, don't commit too early, keep multiple paths open. Patience is key.` :
                `Messy Middle teams struggle with OPTION VALUE: stuck between competing now and building for later, with limited flexibility.`,
            points: 5
        });
        
        // Question about mentor philosophy
        if (GMMentors.currentMentor) {
            questions.push({
                type: 'multiple_choice',
                question: `Your mentor was ${GMMentors.currentMentor.name}, who believes in "${GMMentors.currentMentor.philosophy}".\n\nWhich decision would your mentor MOST approve of?`,
                options: [
                    GMMentors.currentMentor.id === 'jerry_west' ? 'Trading all picks for an All-Star' : 
                    GMMentors.currentMentor.id === 'sam_presti' ? 'Trading an All-Star for multiple picks' :
                    'Building through culture and player development',
                    
                    'Signing mid-level free agents',
                    'Tanking for draft position',
                    'Making no moves at all'
                ],
                correct: 0,
                explanation: `${GMMentors.currentMentor.name}'s philosophy of "${GMMentors.currentMentor.philosophy}" means prioritizing ${
                    GMMentors.currentMentor.id === 'jerry_west' ? 'star acquisition over asset accumulation' :
                    GMMentors.currentMentor.id === 'sam_presti' ? 'long-term assets over short-term wins' :
                    'organizational culture over quick fixes'
                }.`,
                points: 5
            });
        }
        
        // Question about their outcomes
        if (outcomes.length > 0) {
            const totalWins = outcomes.reduce((sum, o) => sum + o.wins, 0);
            questions.push({
                type: 'multiple_choice',
                question: `You won ${totalWins} total games across 4 seasons${GameState.championships > 0 ? ` and ${GameState.championships} championship(s)` : ' with no championships'}.\n\nWhich economic concept explains why outcomes can differ from expectations?`,
                options: [
                    'Variance - Random factors affect results',
                    'Sunk Cost - Past decisions are irrelevant',
                    'Commitment - Escalating investments',
                    'Information Asymmetry - Hidden knowledge'
                ],
                correct: 0,
                explanation: `VARIANCE means that even good decisions can have bad outcomes (and vice versa) due to random factors like injuries, lucky bounces, or unexpected player development. Your actual results reflect both strategy AND luck.`,
                points: 5
            });
        }
        
        // SECTION 2: SCENARIO ANALYSIS (3 questions)
        // Based on actual scenarios they encountered
        
        questions.push({
            type: 'short_answer',
            question: `Explain in 2-3 sentences: What is OPPORTUNITY COST and give a specific example from YOUR simulation.`,
            rubric: {
                definition: 'Must define as "value of next best alternative" or similar',
                example: 'Must reference specific decision they made',
                connection: 'Must explain what they gave up'
            },
            points: 10,
            sampleAnswer: `Opportunity cost is the value of what you give up when making a choice. In Cycle 1, when I committed max cap space to sign a star, the opportunity cost was losing the flexibility to make other moves or sign multiple role players. I gave up optionality for immediate roster improvement.`
        });
        
        questions.push({
            type: 'short_answer',
            question: `The screenshot says "Patterns Show Up" - explain how your earlier decisions affected your later options in the simulation. Give at least ONE specific example.`,
            rubric: {
                understanding: 'Shows understanding of path dependency',
                specific_example: 'References actual decision from their playthrough',
                consequences: 'Explains how earlier choice limited/enabled later choices'
            },
            points: 10,
            sampleAnswer: `This demonstrates PATH DEPENDENCY - how your current options are constrained by past decisions. When I went all-in in Cycle 1 by trading away picks, my Cycle 3 options were limited because I couldn't tank or rebuild - I was committed to competing. Earlier choices locked me into a specific path.`
        });
        
        // SECTION 3: REAL-WORLD APPLICATION (2 questions)
        
        questions.push({
            type: 'short_answer',
            question: `Imagine you're advising a real NBA GM. Their team has a 32-year-old superstar, limited cap space, and no draft picks for 3 years.\n\nWhat strategy would you recommend and which TWO economic concepts support your reasoning?`,
            rubric: {
                clear_strategy: 'States specific approach (all-in or pivot)',
                concept_1: 'Correctly applies first economic concept',
                concept_2: 'Correctly applies second economic concept',
                reasoning: 'Logical connection between concepts and strategy'
            },
            points: 15,
            sampleAnswer: `I'd recommend going all-in because of TIME PREFERENCE - the superstar's championship window is closing, so you must value present wins over future flexibility. This connects to SUNK COST - the picks are already gone, so don't let that past decision prevent you from maximizing your current window. Trade young players for win-now pieces.`
        });
        
        questions.push({
            type: 'essay',
            question: `Reflect on your simulation experience:\n\n1. What was your BIGGEST strategic mistake? (2-3 sentences)\n2. Which economic concept would have helped you avoid it? (2-3 sentences)\n3. How will you think differently about resource allocation in the future? (2-3 sentences)`,
            rubric: {
                identifies_mistake: 'Honest self-assessment of specific decision',
                economic_concept: 'Correctly identifies relevant concept',
                explains_how: 'Shows how concept would have changed thinking',
                future_application: 'Demonstrates learning and transfer'
            },
            points: 20,
            sampleAnswer: `My biggest mistake was trading away all my picks in Cycle 1 to win now, then having my star get injured in Cycle 2. I was stuck with no flexibility and no path forward. OPTION VALUE would have helped - I should have preserved some flexibility instead of committing everything to one uncertain outcome. In the future, I'll always ask "what if this doesn't work?" before making irreversible decisions, and I'll keep multiple paths open when possible.`
        });
        
        // SECTION 4: CONCEPT DEFINITIONS (3 questions)
        
        const concepts = ['Risk-Return Tradeoff', 'Sunk Cost Fallacy', 'Principal-Agent Problem'];
        concepts.forEach(concept => {
            questions.push({
                type: 'definition',
                question: `Define "${concept}" in your own words (2-3 sentences) and explain why it matters in NBA front office decisions.`,
                rubric: {
                    accurate_definition: 'Core concept correctly explained',
                    own_words: 'Not copied from textbook/source',
                    nba_relevance: 'Connects to actual GM decisions'
                },
                points: 5,
                sampleAnswer: concept === 'Risk-Return Tradeoff' ?
                    `Higher risk decisions offer potentially higher rewards but also higher chance of failure. In the NBA, trading all your picks for a superstar (high risk) might win a championship (high reward) or leave you with nothing (high downside). GMs must balance how much risk they're willing to take for potential payoff.` :
                    concept === 'Sunk Cost Fallacy' ?
                    `The mistake of continuing to invest in something because you've already invested a lot, even when it's clearly not working. NBA teams do this when they keep trying to make a failed superteam work just because they already gave up so much to build it. Past costs should not affect future decisions.` :
                    `When the person making decisions (GM/agent) has different interests than the person they represent (owner/principal). A GM might make safe decisions to keep their job rather than risky moves that could win championships. This misalignment creates problems in decision-making.`
            });
        });
        
        // SECTION 5: DATA INTERPRETATION (1 question)
        
        questions.push({
            type: 'data_analysis',
            question: `Review your final metrics:\n Roster Quality: ${GameState.rosterQuality}\n Cap Flexibility: ${GameState.capFlexibility}\n Optionality: ${GameState.optionality}\n Risk Exposure: ${GameState.riskExposure}\n\nAnalyze: Did your final metrics align with your stated strategy? If there's a mismatch, explain why using economic concepts.`,
            rubric: {
                reads_data: 'Correctly interprets metric values',
                identifies_patterns: 'Sees alignment or misalignment',
                economic_reasoning: 'Uses concepts to explain patterns',
                self_awareness: 'Honest about strategy vs execution'
            },
            points: 15,
            sampleAnswer: `My metrics show high roster quality (75) but very low optionality (20), which DOES align with my all-in strategy. I sacrificed flexibility (opportunity cost) to maximize current roster strength. However, my high risk exposure (65) shows I took on more variance than intended - this was partly luck (injuries) and partly poor risk management. The pattern shows I committed fully but maybe took on too much uncertainty.`
        });
        
        this.questions = questions;
        return questions;
    },
    
    startQuiz() {
        this.generatePersonalizedQuiz();
        this.currentQuestion = 0;
        this.answers = [];
        this.startTime = Date.now();
        
        this.showQuestion();
    },
    
    showQuestion() {
        const q = this.questions[this.currentQuestion];
        const modal = document.getElementById('screen-replay');
        const content = document.getElementById('replay-content');
        
        content.innerHTML = `
            <div style="padding:2rem;max-width:900px;margin:0 auto;">
                <div style="text-align:center;margin-bottom:2rem;">
                    <div style="font-size:3rem;margin-bottom:1rem;"></div>
                    <h2 style="color:var(--gold);font-size:2rem;">Economics Mastery Quiz</h2>
                    <div style="color:var(--text-secondary);margin-top:0.5rem;">
                        Question ${this.currentQuestion + 1} of ${this.questions.length}  Worth ${q.points} points
                    </div>
                    <div style="margin-top:0.5rem;">
                        <div style="background:rgba(255,255,255,0.1);height:8px;border-radius:4px;overflow:hidden;">
                            <div style="width:${((this.currentQuestion) / this.questions.length) * 100}%;height:100%;background:var(--gold);transition:width 0.3s;"></div>
                        </div>
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.05);padding:2rem;border-radius:8px;margin-bottom:2rem;">
                    <div style="font-size:1.1rem;line-height:1.6;white-space:pre-line;margin-bottom:2rem;">
                        ${q.question}
                    </div>
                    
                    ${this.renderQuestionType(q)}
                </div>
                
                <div style="display:flex;gap:1rem;justify-content:space-between;">
                    ${this.currentQuestion > 0 ? `
                        <button class="btn-ghost" onclick="MasteryQuiz.previousQuestion()">
                             Previous
                        </button>
                    ` : '<div></div>'}
                    
                    <button class="btn-primary" onclick="MasteryQuiz.submitAnswer()" style="padding:1rem 2rem;">
                        ${this.currentQuestion < this.questions.length - 1 ? 'Next Question ' : 'Submit Quiz '}
                    </button>
                </div>
            </div>
        `;
        
        modal.style.display = 'flex';
    },
    
    renderQuestionType(q) {
        if (q.type === 'multiple_choice') {
            return `
                <div style="display:grid;gap:1rem;">
                    ${q.options.map((opt, idx) => `
                        <label style="padding:1rem;background:rgba(255,255,255,0.03);border:2px solid var(--border);border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:1rem;transition:all 0.2s;"
                               onmouseover="this.style.borderColor='var(--gold)'"
                               onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'"
                               onclick="this.querySelector('input').checked=true; this.style.borderColor='var(--gold)';">
                            <input type="radio" name="answer" value="${idx}" style="width:20px;height:20px;">
                            <span style="flex:1;">${opt}</span>
                        </label>
                    `).join('')}
                </div>
            `;
        } else if (q.type === 'short_answer' || q.type === 'definition' || q.type === 'data_analysis') {
            return `
                <textarea id="quiz-answer" rows="6" 
                          style="width:100%;padding:1rem;background:rgba(255,255,255,0.05);border:2px solid var(--border);
                                 border-radius:6px;color:#fff;font-size:1rem;resize:vertical;"
                          placeholder="Type your answer here... (2-4 sentences recommended)"></textarea>
                <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.5rem;">
                    Graded on: ${Object.keys(q.rubric).join(', ')}
                </div>
            `;
        } else if (q.type === 'essay') {
            return `
                <textarea id="quiz-answer" rows="12" 
                          style="width:100%;padding:1rem;background:rgba(255,255,255,0.05);border:2px solid var(--border);
                                 border-radius:6px;color:#fff;font-size:1rem;resize:vertical;"
                          placeholder="Write your reflection here... (aim for 200-300 words)"></textarea>
                <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.5rem;">
                    This is worth ${q.points} points. Take your time and be thorough.
                </div>
            `;
        }
    },
    
    submitAnswer() {
        const q = this.questions[this.currentQuestion];
        let answer = null;
        
        if (q.type === 'multiple_choice') {
            const selected = document.querySelector('input[name="answer"]:checked');
            if (!selected) {
                UI.addAlert('Please select an answer', 'warning');
                return;
            }
            answer = parseInt(selected.value);
        } else {
            answer = document.getElementById('quiz-answer').value.trim();
            if (!answer) {
                UI.addAlert('Please provide an answer', 'warning');
                return;
            }
        }
        
        this.answers.push({
            questionIndex: this.currentQuestion,
            answer: answer,
            question: q.question,
            type: q.type
        });
        
        if (this.currentQuestion < this.questions.length - 1) {
            this.currentQuestion++;
            this.showQuestion();
        } else {
            this.finishQuiz();
        }
    },
    
    previousQuestion() {
        if (this.currentQuestion > 0) {
            this.currentQuestion--;
            this.showQuestion();
        }
    },
    
    finishQuiz() {
        const timeSpent = Math.round((Date.now() - this.startTime) / 1000 / 60);
        
        const content = document.getElementById('replay-content');
        content.innerHTML = `
            <div style="padding:3rem;max-width:800px;margin:0 auto;text-align:center;">
                <div style="font-size:4rem;margin-bottom:1rem;"></div>
                <h2 style="color:var(--gold);font-size:2.5rem;margin-bottom:1rem;">Quiz Submitted!</h2>
                
                <div style="background:rgba(245,166,35,0.1);padding:2rem;border-radius:8px;margin-bottom:2rem;">
                    <div style="font-size:1.2rem;margin-bottom:1rem;">
                        You completed all ${this.questions.length} questions in ${timeSpent} minutes
                    </div>
                    <div style="font-size:0.9rem;color:var(--text-secondary);">
                        Your answers have been recorded and will be graded by your instructor
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.05);padding:2rem;border-radius:8px;margin-bottom:2rem;text-align:left;">
                    <h3 style="color:var(--gold);margin-bottom:1rem;"> Grade Breakdown:</h3>
                    <div style="display:grid;gap:1rem;">
                        <div style="display:flex;justify-content:space-between;padding:1rem;background:rgba(255,255,255,0.03);border-radius:4px;">
                            <span>Simulation Performance</span>
                            <span style="color:var(--gold);font-weight:bold;">70%</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:1rem;background:rgba(245,166,35,0.2);border-radius:4px;">
                            <span>Mastery Quiz (This!)</span>
                            <span style="color:var(--gold);font-weight:bold;">30%</span>
                        </div>
                    </div>
                </div>
                
                <div style="padding:1.5rem;background:rgba(59,130,246,0.1);border:2px solid var(--info);border-radius:8px;margin-bottom:2rem;">
                    <div style="font-size:0.9rem;margin-bottom:0.5rem;"> Your Claim Code:</div>
                    <div style="font-size:1.8rem;font-weight:bold;color:var(--gold);font-family:monospace;letter-spacing:0.1em;">
                        ${GameState.generateClaimCode()}
                    </div>
                    <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.5rem;">
                        Submit this code to your instructor along with your quiz answers
                    </div>
                </div>
                
                <button class="btn-primary" onclick="downloadQuizAnswers()" style="margin-right:1rem;padding:1rem 2rem;">
                     Download Quiz Answers
                </button>
                <button class="btn-ghost" onclick="document.getElementById('screen-replay').style.display='none'">
                    Return to Dossier
                </button>
            </div>
        `;
    }
};

function startMasteryQuiz() {
    MasteryQuiz.startQuiz();
}

function downloadQuizAnswers() {
    let report = `ECONOMICS MASTERY QUIZ - ANSWER SHEET\n`;
    report += `${'='.repeat(60)}\n\n`;
    report += `Student: ${GameState.franchiseName} GM\n`;
    report += `Claim Code: ${GameState.generateClaimCode()}\n`;
    report += `Mentor: ${GMMentors.currentMentor?.name || 'None'}\n`;
    report += `Date: ${new Date().toLocaleDateString()}\n\n`;
    report += `${'='.repeat(60)}\n\n`;
    
    MasteryQuiz.answers.forEach((ans, idx) => {
        const q = MasteryQuiz.questions[ans.questionIndex];
        report += `QUESTION ${idx + 1} (${q.points} points):\n`;
        report += `${q.question}\n\n`;
        
        if (q.type === 'multiple_choice') {
            report += `ANSWER: ${q.options[ans.answer]}\n`;
        } else {
            report += `ANSWER:\n${ans.answer}\n`;
        }
        
        report += `\n${'='.repeat(60)}\n\n`;
    });
    
    const blob = new Blob([report], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Quiz-Answers-${GameState.generateClaimCode()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

        
        // ================================
        // UI RENDERING ENGINE
        // ================================
        // 
        // TEACHER DASHBOARD SYSTEM
        // 
        
        const TeacherDashboard = {
            classData: [],  // Array of student results
            
            init() {
                // Check localStorage for saved class data
                const saved = localStorage.getItem('teacher_class_data');
                if (saved) {
                    try {
                        this.classData = JSON.parse(saved);
                    } catch (e) {
                        this.classData = [];
                    }
                }
            },
            
            submitStudentData(studentData) {
                // Add student submission to class data
                this.classData.push({
                    ...studentData,
                    submittedAt: Date.now()
                });
                
                // Save to localStorage
                localStorage.setItem('teacher_class_data', JSON.stringify(this.classData));
                
                console.log('Student data submitted:', studentData);
                console.log('Total submissions:', this.classData.length);
            },
            
            showDashboard() {
                const modal = document.getElementById('screen-replay');
                const content = document.getElementById('replay-content');
                
                const stats = this.calculateClassStats();
                
                content.innerHTML = `
                    <div style="padding:2rem;max-width:1200px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:2.5rem;">
                            <h1 style="font-size:2.5rem;margin-bottom:0.5rem;"> Teacher Dashboard</h1>
                            <div style="font-size:1.1rem;color:var(--text-secondary);">
                                Class Performance Overview
                            </div>
                        </div>
                        
                        <!-- Class Stats -->
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:2.5rem;">
                            <div style="padding:1.5rem;background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(59,130,246,0.05));border:2px solid #3b82f6;border-radius:12px;text-align:center;">
                                <div style="font-size:3rem;margin-bottom:0.5rem;"></div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">Total Students</div>
                                <div style="font-size:2.5rem;font-weight:bold;color:#3b82f6;">${stats.totalStudents}</div>
                            </div>
                            
                            <div style="padding:1.5rem;background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(34,197,94,0.05));border:2px solid #22c55e;border-radius:12px;text-align:center;">
                                <div style="font-size:3rem;margin-bottom:0.5rem;"></div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">Avg Final Grade</div>
                                <div style="font-size:2.5rem;font-weight:bold;color:#22c55e;">${stats.avgGrade}%</div>
                            </div>
                            
                            <div style="padding:1.5rem;background:linear-gradient(135deg,rgba(245,166,35,0.2),rgba(245,166,35,0.05));border:2px solid var(--gold);border-radius:12px;text-align:center;">
                                <div style="font-size:3rem;margin-bottom:0.5rem;"></div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">Championships Won</div>
                                <div style="font-size:2.5rem;font-weight:bold;color:var(--gold);">${stats.totalChampionships}</div>
                            </div>
                            
                            <div style="padding:1.5rem;background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(139,92,246,0.05));border:2px solid #8b5cf6;border-radius:12px;text-align:center;">
                                <div style="font-size:3rem;margin-bottom:0.5rem;"></div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">Avg Concepts Mastered</div>
                                <div style="font-size:2.5rem;font-weight:bold;color:#8b5cf6;">${stats.avgConceptsMastered}/11</div>
                            </div>
                        </div>
                        
                        <!-- Grade Distribution -->
                        <div style="background:rgba(255,255,255,0.05);padding:2rem;border-radius:12px;margin-bottom:2.5rem;">
                            <h3 style="margin-bottom:1.5rem;font-size:1.3rem;">Grade Distribution</h3>
                            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;">
                                ${['A (90-100)', 'B (80-89)', 'C (70-79)', 'D (60-69)', 'F (0-59)'].map((grade, idx) => {
                                    const ranges = [[90,100], [80,89], [70,79], [60,69], [0,59]];
                                    const count = stats.gradeDistribution[idx] || 0;
                                    const percentage = stats.totalStudents > 0 ? Math.round((count / stats.totalStudents) * 100) : 0;
                                    return `
                                        <div style="text-align:center;">
                                            <div style="font-size:2rem;font-weight:bold;margin-bottom:0.5rem;">${grade[0]}</div>
                                            <div style="font-size:1.5rem;margin-bottom:0.5rem;">${count}</div>
                                            <div style="font-size:0.85rem;color:var(--text-secondary);">${percentage}%</div>
                                            <div style="background:rgba(0,0,0,0.5);height:8px;border-radius:4px;overflow:hidden;margin-top:0.5rem;">
                                                <div style="width:${percentage}%;height:100%;background:${
                                                    idx === 0 ? '#22c55e' : idx === 1 ? '#3b82f6' : idx === 2 ? '#f59e0b' : '#ef4444'
                                                };"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Student List -->
                        <div style="background:rgba(255,255,255,0.05);padding:2rem;border-radius:12px;margin-bottom:2rem;">
                            <h3 style="margin-bottom:1.5rem;font-size:1.3rem;">Individual Students</h3>
                            ${this.classData.length === 0 ? `
                                <div style="text-align:center;padding:3rem;color:var(--text-secondary);">
                                    <div style="font-size:4rem;margin-bottom:1rem;"></div>
                                    <div style="font-size:1.2rem;">No student submissions yet</div>
                                    <div style="font-size:0.9rem;margin-top:0.5rem;">
                                        Students will appear here when they complete the simulation
                                    </div>
                                </div>
                            ` : `
                                <div style="overflow-x:auto;">
                                    <table style="width:100%;border-collapse:collapse;">
                                        <thead>
                                            <tr style="background:rgba(0,0,0,0.3);border-bottom:2px solid var(--border);">
                                                <th style="padding:1rem;text-align:left;">Student Name</th>
                                                <th style="padding:1rem;text-align:center;">Claim Code</th>
                                                <th style="padding:1rem;text-align:center;">Final Grade</th>
                                                <th style="padding:1rem;text-align:center;">Championships</th>
                                                <th style="padding:1rem;text-align:center;">Concepts Mastered</th>
                                                <th style="padding:1rem;text-align:center;">Submitted</th>
                                                <th style="padding:1rem;text-align:center;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${this.classData.sort((a,b) => b.finalGrade - a.finalGrade).map(student => `
                                                <tr style="border-bottom:1px solid var(--border);">
                                                    <td style="padding:1rem;font-weight:600;">${student.studentName || 'Anonymous'}</td>
                                                    <td style="padding:1rem;text-align:center;font-family:monospace;color:var(--gold);">${student.claimCode}</td>
                                                    <td style="padding:1rem;text-align:center;">
                                                        <span style="font-size:1.2rem;font-weight:bold;color:${
                                                            student.finalGrade >= 90 ? '#22c55e' :
                                                            student.finalGrade >= 80 ? '#3b82f6' :
                                                            student.finalGrade >= 70 ? '#f59e0b' : '#ef4444'
                                                        };">${student.finalGrade}%</span>
                                                    </td>
                                                    <td style="padding:1rem;text-align:center;">${student.championships || 0} </td>
                                                    <td style="padding:1rem;text-align:center;">${student.conceptsMastered || 0}/11</td>
                                                    <td style="padding:1rem;text-align:center;font-size:0.85rem;color:var(--text-secondary);">
                                                        ${new Date(student.submittedAt).toLocaleDateString()}
                                                    </td>
                                                    <td style="padding:1rem;text-align:center;">
                                                        <button onclick="TeacherDashboard.viewStudentDetail('${student.claimCode}')" 
                                                                class="btn-ghost" style="padding:0.5rem 1rem;font-size:0.85rem;">
                                                            View Details
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                        
                        <!-- Export Options -->
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:2rem;">
                            <button onclick="TeacherDashboard.exportToCSV()" class="btn-ghost" style="padding:1rem;">
                                 Export to CSV
                            </button>
                            <button onclick="TeacherDashboard.printReport()" class="btn-ghost" style="padding:1rem;">
                                 Print Report
                            </button>
                            <button onclick="TeacherDashboard.clearAllData()" class="btn-ghost" 
                                    style="padding:1rem;background:rgba(239,68,68,0.1);border-color:#ef4444;">
                                 Clear All Data
                            </button>
                        </div>
                        
                        <button class="btn-primary" onclick="document.getElementById('screen-replay').style.display='none'" 
                                style="width:100%;padding:1rem;">
                            Close Dashboard
                        </button>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },
            
            calculateClassStats() {
                if (this.classData.length === 0) {
                    return {
                        totalStudents: 0,
                        avgGrade: 0,
                        totalChampionships: 0,
                        avgConceptsMastered: 0,
                        gradeDistribution: [0, 0, 0, 0, 0]
                    };
                }
                
                const totalStudents = this.classData.length;
                const avgGrade = Math.round(this.classData.reduce((sum, s) => sum + (s.finalGrade || 0), 0) / totalStudents);
                const totalChampionships = this.classData.reduce((sum, s) => sum + (s.championships || 0), 0);
                const avgConceptsMastered = Math.round(this.classData.reduce((sum, s) => sum + (s.conceptsMastered || 0), 0) / totalStudents);
                
                const gradeDistribution = [0, 0, 0, 0, 0];
                this.classData.forEach(student => {
                    const grade = student.finalGrade || 0;
                    if (grade >= 90) gradeDistribution[0]++;
                    else if (grade >= 80) gradeDistribution[1]++;
                    else if (grade >= 70) gradeDistribution[2]++;
                    else if (grade >= 60) gradeDistribution[3]++;
                    else gradeDistribution[4]++;
                });
                
                return {
                    totalStudents,
                    avgGrade,
                    totalChampionships,
                    avgConceptsMastered,
                    gradeDistribution
                };
            },
            
            viewStudentDetail(claimCode) {
                const student = this.classData.find(s => s.claimCode === claimCode);
                if (!student) return;
                
                const modal = document.getElementById('screen-replay');
                const content = document.getElementById('replay-content');
                
                content.innerHTML = `
                    <div style="padding:2.5rem;max-width:900px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <h2>${student.studentName || 'Student'}'s Performance</h2>
                            <div style="font-family:monospace;color:var(--gold);margin-top:0.5rem;">
                                Claim Code: ${student.claimCode}
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem;">
                            <div style="padding:1.5rem;background:rgba(59,130,246,0.1);border:2px solid #3b82f6;border-radius:12px;">
                                <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">Final Grade</div>
                                <div style="font-size:3rem;font-weight:bold;color:#3b82f6;">${student.finalGrade}%</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.5rem;">
                                    Sim: ${student.simScore}%  Quiz: ${student.quizScore}%
                                </div>
                            </div>
                            
                            <div style="padding:1.5rem;background:rgba(245,166,35,0.1);border:2px solid var(--gold);border-radius:12px;">
                                <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">Game Performance</div>
                                <div style="font-size:2rem;font-weight:bold;color:var(--gold);">${student.championships || 0} </div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.5rem;">
                                    ${student.playoffAppearances || 0} playoff appearances
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:12px;margin-bottom:2rem;">
                            <h4 style="margin-bottom:1rem;">Concepts Mastered: ${student.conceptsMastered || 0}/11</h4>
                            <div style="background:rgba(0,0,0,0.3);height:12px;border-radius:6px;overflow:hidden;">
                                <div style="width:${((student.conceptsMastered || 0) / 11) * 100}%;height:100%;background:#8b5cf6;"></div>
                            </div>
                        </div>
                        
                        <button class="btn-primary" onclick="TeacherDashboard.showDashboard()" style="width:100%;padding:1rem;">
                             Back to Dashboard
                        </button>
                    </div>
                `;
            },
            
            exportToCSV() {
                const headers = ['Student Name', 'Claim Code', 'Final Grade', 'Sim Score', 'Quiz Score', 'Championships', 'Playoffs', 'Concepts Mastered', 'Submitted'];
                const rows = this.classData.map(s => [
                    s.studentName || 'Anonymous',
                    s.claimCode,
                    s.finalGrade || 0,
                    s.simScore || 0,
                    s.quizScore || 0,
                    s.championships || 0,
                    s.playoffAppearances || 0,
                    s.conceptsMastered || 0,
                    new Date(s.submittedAt).toLocaleDateString()
                ]);
                
                const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nba-gm-class-data-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                UI.addAlert(' Class data exported to CSV!', 'success');
            },
            
            printReport() {
                window.print();
            },
            
            clearAllData() {
                if (confirm('Are you sure you want to clear ALL student data? This cannot be undone!')) {
                    this.classData = [];
                    localStorage.removeItem('teacher_class_data');
                    this.showDashboard();
                    UI.addAlert(' All class data cleared', 'warning');
                }
            }
        };
        
        // Initialize teacher dashboard
        TeacherDashboard.init();
        
        // 
        // OWNER PRESSURE SYSTEM
        // 
        
        const OwnerSystem = {
            // Different owner personalities based on franchise
            ownerProfiles: {
                contender: {
                    name: 'Mark Cuban',
                    personality: 'Win-Now Impatient',
                    startExpectation: 'championship',
                    patience: 70,
                    pressureMultiplier: 1.5
                },
                rebuild: {
                    name: 'Sam Hinkie',
                    personality: 'Process Trusting',
                    startExpectation: 'tank',
                    patience: 100,
                    pressureMultiplier: 0.7
                },
                messy: {
                    name: 'James Dolan',
                    personality: 'Chaotic Meddler',
                    startExpectation: 'compete',
                    patience: 50,
                    pressureMultiplier: 1.8
                }
            },
            
            init(franchise) {
                const profile = this.ownerProfiles[franchise];
                GameState.ownerProfile = profile;
                GameState.ownerExpectation = profile.startExpectation;
                GameState.ownerPatience = profile.patience;
                GameState.ownerPressure = 50;
                GameState.ownerMood = 'neutral';
            },
            
            updatePressure(seasonOutcome) {
                const profile = GameState.ownerProfile;
                const outcome = seasonOutcome.outcome;
                const expectation = GameState.ownerExpectation;
                
                // Check if outcome meets expectation
                let pressureChange = 0;
                let patienceChange = 0;
                let moodChange = '';
                
                if (expectation === 'championship') {
                    if (outcome === 'Championship') {
                        pressureChange = -30;
                        patienceChange = 20;
                        moodChange = 'ecstatic';
                    } else if (outcome.includes('Finals')) {
                        pressureChange = -10;
                        patienceChange = 5;
                        moodChange = 'pleased';
                    } else if (outcome.includes('Exit')) {
                        pressureChange = 15;
                        patienceChange = -15;
                        moodChange = 'unhappy';
                    } else {
                        pressureChange = 30;
                        patienceChange = -30;
                        moodChange = 'furious';
                    }
                } else if (expectation === 'playoffs') {
                    if (outcome === 'Championship') {
                        pressureChange = -40;
                        patienceChange = 30;
                        moodChange = 'ecstatic';
                    } else if (outcome.includes('Exit') || outcome.includes('Finals')) {
                        pressureChange = -15;
                        patienceChange = 10;
                        moodChange = 'pleased';
                    } else {
                        pressureChange = 20;
                        patienceChange = -20;
                        moodChange = 'unhappy';
                    }
                } else if (expectation === 'compete') {
                    if (outcome === 'Championship') {
                        pressureChange = -50;
                        moodChange = 'ecstatic';
                    } else if (outcome.includes('Playoff')) {
                        pressureChange = -10;
                        moodChange = 'pleased';
                    } else if (outcome === 'Lottery') {
                        pressureChange = 25;
                        patienceChange = -15;
                        moodChange = 'unhappy';
                    }
                } else if (expectation === 'tank') {
                    if (outcome === 'Lottery') {
                        pressureChange = -20;
                        patienceChange = 10;
                        moodChange = 'pleased';
                    } else if (outcome.includes('Exit')) {
                        pressureChange = 10;
                        moodChange = 'neutral';
                    }
                }
                
                // Apply multiplier
                pressureChange *= profile.pressureMultiplier;
                
                // Update values
                GameState.ownerPressure = Math.max(0, Math.min(100, GameState.ownerPressure + pressureChange));
                GameState.ownerPatience = Math.max(0, Math.min(100, GameState.ownerPatience + patienceChange));
                GameState.ownerMood = moodChange;
                
                // Patience naturally decreases each cycle
                GameState.ownerPatience = Math.max(0, GameState.ownerPatience - 8);
                
                return { pressureChange, patienceChange, moodChange };
            },
            
            generateOwnerMessage(outcome) {
                const mood = GameState.ownerMood;
                const profile = GameState.ownerProfile;
                const cycle = GameState.cycleIndex;
                
                let message = '';
                let subject = '';
                
                if (mood === 'ecstatic') {
                    subject = ' INCREDIBLE WORK!';
                    message = outcome.outcome === 'Championship' ?
                        `${profile.name} here. CHAMPIONSHIP! You did it! This is what I hired you for. Enjoy the parade - you've earned it.` :
                        `${profile.name} here. I'm thrilled with this season. Keep it up and we'll be cutting down nets soon.`;
                } else if (mood === 'pleased') {
                    subject = ' Good Season';
                    message = `${profile.name}. Solid work this year. ${outcome.record} is respectable. Let's take the next step next season.`;
                } else if (mood === 'neutral') {
                    subject = ' Season Review';
                    message = `${profile.name}. We finished ${outcome.record}. Not great, not terrible. I expect more going forward.`;
                } else if (mood === 'unhappy') {
                    subject = ' We Need to Talk';
                    message = `${profile.name}. I'm not happy with ${outcome.outcome}. ${outcome.record} isn't good enough. You're on notice. Make better decisions or there will be consequences.`;
                } else if (mood === 'furious') {
                    subject = ' UNACCEPTABLE';
                    message = `${profile.name}. This is UNACCEPTABLE. ${outcome.outcome}? ${outcome.record}? I brought you here to WIN. You have ONE more chance. Don't blow it.`;
                }
                
                // Add pressure warning if high
                if (GameState.ownerPressure > 75) {
                    message += `\n\nP.S. - The pressure is ON. My patience is wearing thin.`;
                }
                
                GameState.ownerMessages.push({
                    cycle: cycle,
                    subject: subject,
                    message: message,
                    mood: mood,
                    read: false
                });
                
                return { subject, message, mood };
            },
            
            checkFired() {
                // Get fired if:
                // 1. Patience reaches 0
                // 2. 3+ bad seasons in a row
                // 3. Pressure > 90 and patience < 20
                
                if (GameState.ownerPatience <= 0) {
                    return { fired: true, reason: 'Owner ran out of patience' };
                }
                
                if (GameState.ownerPressure > 90 && GameState.ownerPatience < 20) {
                    return { fired: true, reason: 'Owner lost confidence in your ability' };
                }
                
                // Check for 3 bad seasons
                const recent = GameState.seasonOutcomes.slice(-3);
                const badSeasons = recent.filter(s => 
                    s.outcome === 'Lottery' || s.outcome === 'Play-In Loss'
                ).length;
                
                if (badSeasons >= 3 && GameState.ownerExpectation !== 'tank') {
                    return { fired: true, reason: 'Three consecutive disappointing seasons' };
                }
                
                return { fired: false };
            },
            
            showOwnerMeeting(outcome) {
                const ownerMsg = this.generateOwnerMessage(outcome);
                
                const modal = document.getElementById('screen-replay');
                const content = document.getElementById('replay-content');
                
                content.innerHTML = `
                    <div style="padding:2.5rem;max-width:700px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:5rem;margin-bottom:1rem;">
                                ${ownerMsg.mood === 'ecstatic' ? '' :
                                  ownerMsg.mood === 'pleased' ? '' :
                                  ownerMsg.mood === 'neutral' ? '' :
                                  ownerMsg.mood === 'unhappy' ? '' : ''}
                            </div>
                            <h2 style="color:${
                                ownerMsg.mood === 'ecstatic' ? '#22c55e' :
                                ownerMsg.mood === 'pleased' ? '#3b82f6' :
                                ownerMsg.mood === 'neutral' ? 'var(--text-secondary)' :
                                ownerMsg.mood === 'unhappy' ? '#f59e0b' : '#ef4444'
                            };">
                                ${ownerMsg.subject}
                            </h2>
                            <div style="font-size:1.1rem;color:var(--text-secondary);margin-bottom:0.5rem;">
                                From: ${GameState.ownerProfile.name}
                            </div>
                            <div style="font-size:0.9rem;color:var(--text-secondary);">
                                ${GameState.ownerProfile.personality}
                            </div>
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.05);padding:2rem;border-radius:12px;border:2px solid ${
                            ownerMsg.mood === 'ecstatic' ? '#22c55e' :
                            ownerMsg.mood === 'pleased' ? '#3b82f6' :
                            ownerMsg.mood === 'neutral' ? 'var(--border)' :
                            ownerMsg.mood === 'unhappy' ? '#f59e0b' : '#ef4444'
                        };margin-bottom:2rem;">
                            <div style="font-size:1.05rem;line-height:1.8;white-space:pre-line;">
                                ${ownerMsg.message}
                            </div>
                        </div>
                        
                        <!-- Pressure Gauge -->
                        <div style="margin-bottom:2rem;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                                <span style="font-size:0.9rem;color:var(--text-secondary);">Owner Pressure</span>
                                <span style="font-size:1.1rem;font-weight:bold;color:${
                                    GameState.ownerPressure > 75 ? '#ef4444' :
                                    GameState.ownerPressure > 50 ? '#f59e0b' : '#22c55e'
                                };">
                                    ${Math.round(GameState.ownerPressure)}%
                                </span>
                            </div>
                            <div style="background:rgba(0,0,0,0.3);height:12px;border-radius:6px;overflow:hidden;">
                                <div style="width:${GameState.ownerPressure}%;height:100%;background:${
                                    GameState.ownerPressure > 75 ? '#ef4444' :
                                    GameState.ownerPressure > 50 ? '#f59e0b' : '#22c55e'
                                };transition:width 0.5s;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:2rem;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                                <span style="font-size:0.9rem;color:var(--text-secondary);">Owner Patience</span>
                                <span style="font-size:1.1rem;font-weight:bold;color:${
                                    GameState.ownerPatience < 25 ? '#ef4444' :
                                    GameState.ownerPatience < 50 ? '#f59e0b' : '#22c55e'
                                };">
                                    ${Math.round(GameState.ownerPatience)}%
                                </span>
                            </div>
                            <div style="background:rgba(0,0,0,0.3);height:12px;border-radius:6px;overflow:hidden;">
                                <div style="width:${GameState.ownerPatience}%;height:100%;background:${
                                    GameState.ownerPatience < 25 ? '#ef4444' :
                                    GameState.ownerPatience < 50 ? '#f59e0b' : '#22c55e'
                                };transition:width 0.5s;"></div>
                            </div>
                        </div>
                        
                        ${GameState.ownerPatience < 30 ? `
                            <div style="padding:1.5rem;background:rgba(239,68,68,0.1);border:2px solid #ef4444;border-radius:8px;margin-bottom:2rem;">
                                <div style="font-weight:bold;color:#ef4444;margin-bottom:0.5rem;"> WARNING</div>
                                <div style="font-size:0.95rem;">
                                    Owner patience is dangerously low! Another bad season could cost you your job.
                                </div>
                            </div>
                        ` : ''}
                        
                        <button class="btn-primary" onclick="closeOwnerMeetingAndContinue()" 
                                style="width:100%;padding:1rem;">
                            Continue to Next Cycle
                        </button>
                    </div>
                `;
                
                modal.style.display = 'flex';
            }
        };
        
        // 
        // MEDIA SYSTEM
        // 
        
        const MediaSystem = {
            headlines: {
                great: [
                    'GM Genius: {name} Builds Championship Contender',
                    '{name} Proves Doubters Wrong with Smart Moves',
                    'Front Office Excellence: How {name} Changed Everything',
                    'The {name} Effect: Championship Culture Takes Hold'
                ],
                good: [
                    '{name} Making Solid Progress',
                    'Fans Optimistic About {name}\'s Vision',
                    '{name}\'s Steady Approach Paying Off',
                    'Smart Decisions Define {name}\'s Tenure'
                ],
                neutral: [
                    '{name} Stays the Course',
                    'Mixed Results for {name} This Season',
                    '{name}\'s Strategy: Wait and See',
                    'Questions Remain About {name}\'s Direction'
                ],
                bad: [
                    'Hot Seat Watch: Is {name}\'s Time Running Out?',
                    'Fans Growing Impatient with {name}',
                    '{name}\'s Questionable Decisions Under Fire',
                    'Pressure Mounts on Struggling GM {name}'
                ],
                terrible: [
                    'DISASTER: {name} Runs Franchise Into Ground',
                    'Fire {name}! Fans Demand Change',
                    '{name}\'s Terrible Tenure May Be Over Soon',
                    'How Did {name} Get This So Wrong?'
                ]
            },
            
            updateMediaHeat(outcome) {
                const ownerPressure = GameState.ownerPressure;
                const rosterQuality = GameState.rosterQuality;
                
                let heatChange = 0;
                
                // Based on outcome
                if (outcome.outcome === 'Championship') {
                    heatChange = -40;
                } else if (outcome.outcome.includes('Finals')) {
                    heatChange = -20;
                } else if (outcome.outcome.includes('Exit')) {
                    heatChange = -5;
                } else if (outcome.outcome === 'Lottery') {
                    heatChange = 25;
                }
                
                // Modifier based on owner pressure
                if (ownerPressure > 75) {
                    heatChange += 15;
                }
                
                GameState.mediaHeat = Math.max(0, Math.min(100, GameState.mediaHeat + heatChange));
                
                // Determine hot seat level
                if (GameState.mediaHeat >= 80) {
                    GameState.hotSeatLevel = 'scorching';
                } else if (GameState.mediaHeat >= 60) {
                    GameState.hotSeatLevel = 'hot';
                } else if (GameState.mediaHeat >= 40) {
                    GameState.hotSeatLevel = 'warm';
                } else {
                    GameState.hotSeatLevel = 'cold';
                }
                
                return heatChange;
            },
            
            generateHeadline(outcome) {
                const heat = GameState.mediaHeat;
                let category = '';
                
                if (outcome.outcome === 'Championship') {
                    category = 'great';
                } else if (heat >= 80) {
                    category = 'terrible';
                } else if (heat >= 60) {
                    category = 'bad';
                } else if (heat >= 40) {
                    category = 'neutral';
                } else if (heat >= 20) {
                    category = 'good';
                } else {
                    category = 'great';
                }
                
                const templates = this.headlines[category];
                const template = templates[Math.floor(Math.random() * templates.length)];
                const headline = template.replace('{name}', 'You');
                
                GameState.headlines.push({
                    cycle: GameState.cycleIndex,
                    text: headline,
                    category: category
                });
                
                return headline;
            },
            
            showPressConference(outcome, headline) {
                GameState.pressConferences++;
                
                const modal = document.getElementById('screen-replay');
                const content = document.getElementById('replay-content');
                
                const questions = this.generateQuestions(outcome);
                
                content.innerHTML = `
                    <div style="padding:2rem;max-width:800px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:2rem;">
                            <div style="font-size:4rem;margin-bottom:1rem;"></div>
                            <h2>Post-Season Press Conference</h2>
                            <div style="font-size:1.1rem;color:var(--text-secondary);margin:0.5rem 0;">
                                Cycle ${GameState.cycleIndex} - ${GameState.franchiseName}
                            </div>
                        </div>
                        
                        <!-- Today's Headline -->
                        <div style="padding:1.5rem;background:rgba(255,255,255,0.05);border-left:4px solid var(--gold);border-radius:8px;margin-bottom:2rem;">
                            <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.5rem;">TODAY'S HEADLINE</div>
                            <div style="font-size:1.2rem;font-weight:bold;">
                                ${headline}
                            </div>
                        </div>
                        
                        <!-- Questions -->
                        <div style="margin-bottom:2rem;">
                            <h3 style="margin-bottom:1rem;">Media Questions:</h3>
                            ${questions.map((q, idx) => `
                                <div style="padding:1rem;background:rgba(255,255,255,0.03);border-radius:6px;margin-bottom:1rem;">
                                    <div style="font-weight:600;margin-bottom:0.5rem;">
                                        Q${idx + 1}: ${q.question}
                                    </div>
                                    <div style="font-size:0.95rem;color:var(--text-secondary);font-style:italic;">
                                        (Your answer will be determined by your decisions this cycle)
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Hot Seat Meter -->
                        <div style="padding:1.5rem;background:rgba(0,0,0,0.3);border-radius:8px;margin-bottom:2rem;">
                            <h4 style="margin-bottom:1rem;">Hot Seat Meter</h4>
                            <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                                <span>Media Pressure</span>
                                <span style="font-weight:bold;color:${
                                    GameState.mediaHeat > 75 ? '#ef4444' :
                                    GameState.mediaHeat > 50 ? '#f59e0b' : '#22c55e'
                                };">
                                    ${GameState.hotSeatLevel.toUpperCase()}
                                </span>
                            </div>
                            <div style="background:rgba(0,0,0,0.5);height:16px;border-radius:8px;overflow:hidden;">
                                <div style="width:${GameState.mediaHeat}%;height:100%;background:${
                                    GameState.mediaHeat > 75 ? '#ef4444' :
                                    GameState.mediaHeat > 50 ? '#f59e0b' : '#22c55e'
                                };transition:width 0.5s;"></div>
                            </div>
                        </div>
                        
                        <button class="btn-primary" onclick="closePressAndShowOwner()" 
                                style="width:100%;padding:1rem;">
                            Leave Podium  Meet with Owner
                        </button>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },
            
            generateQuestions(outcome) {
                const questions = [];
                
                if (outcome.outcome === 'Championship') {
                    questions.push(
                        { question: 'You just won a championship! How does it feel?' },
                        { question: 'What was the key to building this championship team?' },
                        { question: 'Can you repeat as champions next year?' }
                    );
                } else if (outcome.outcome === 'Lottery') {
                    questions.push(
                        { question: 'Another disappointing season. What went wrong?' },
                        { question: 'Do you feel your job is safe?' },
                        { question: 'What changes will you make in the offseason?' }
                    );
                } else {
                    questions.push(
                        { question: `How do you evaluate a ${outcome.record} season?` },
                        { question: 'What are your goals for next season?' },
                        { question: 'Are you satisfied with this roster?' }
                    );
                }
                
                return questions;
            }
        };
        
        const UI = {
            // Update hub
            updateHubMetrics() {
                this.updateMetric('metric-roster', GameState.getBand(GameState.rosterQuality));
                this.updateMetric('metric-cap', GameState.getBand(GameState.capFlexibility));
                this.updateMetric('metric-trust', GameState.getBand(GameState.trustIndex));
                this.updateMetric('metric-risk', GameState.getInverseBand(GameState.riskExposure));
                this.updateMetric('metric-info', GameState.getBand(GameState.informationEdge));
                this.updateMetric('metric-tax', GameState.getInverseBand(GameState.taxExposure));
                
                const repAvg = (GameState.reputationPlayers + GameState.reputationAgents + GameState.reputationLeague) / 3;
                this.updateMetric('metric-rep', GameState.getBand(repAvg));
                this.updateMetric('metric-option', GameState.getBand(GameState.optionality));
                
                this.updateRoomStatuses();
                this.updateAdvanceButton();
                this.updateConstraintWarnings();
                this.updateMentorWidget();
                this.updateMasteryWidget();
                this.updateOwnerWidget();
                this.updateMediaWidget();
            },
            
            updateMentorWidget() {
                if (!GMMentors.currentMentor) return;
                
                const widget = document.getElementById('mentor-widget');
                const rating = GMMentors.getApprovalRating();
                
                if (widget) {
                    widget.style.display = 'block';
                    document.getElementById('mentor-emoji').textContent = GMMentors.currentMentor.emoji;
                    document.getElementById('mentor-name').textContent = GMMentors.currentMentor.name;
                    document.getElementById('mentor-approval-text').textContent = Math.round(GMMentors.approvalRating) + '%';
                    document.getElementById('mentor-approval-text').style.color = rating.color;
                    
                    // Update level badge
                    const levelBadge = document.getElementById('mentor-level-badge');
                    if (levelBadge) {
                        levelBadge.textContent = GMMentors.mentorLevel;
                    }
                    
                    // Update inbox badge
                    const inboxBadge = document.getElementById('inbox-badge');
                    const unreadCount = GMMentors.inbox.filter(m => !m.read).length;
                    if (inboxBadge && unreadCount > 0) {
                        inboxBadge.style.display = 'block';
                    }
                    
                    const bar = document.getElementById('mentor-approval-bar');
                    bar.style.width = GMMentors.approvalRating + '%';
                    bar.style.background = rating.color;
                    
                    // Update challenge display
                    const challengeDiv = document.getElementById('mentor-challenge-display');
                    if (challengeDiv) {
                        challengeDiv.innerHTML = GMMentors.showChallengeWidget();
                    }
                }
            },
            
            updateMasteryWidget() {
                const progress = EconomicMasteryTree.getMasteryProgress();
                
                const unlockedEl = document.getElementById('mastery-unlocked');
                const masteredEl = document.getElementById('mastery-mastered');
                const percentEl = document.getElementById('mastery-percent');
                const barEl = document.getElementById('mastery-progress-bar');
                
                if (unlockedEl) unlockedEl.textContent = `${progress.unlocked}/${progress.total}`;
                if (masteredEl) masteredEl.textContent = `${progress.mastered}/${progress.total}`;
                if (percentEl) percentEl.textContent = `${progress.masteryPercent}%`;
                if (barEl) barEl.style.width = `${progress.masteryPercent}%`;
            },
            
            updateOwnerWidget() {
                const nameEl = document.getElementById('owner-name');
                const pressureTextEl = document.getElementById('owner-pressure-text');
                const pressureBarEl = document.getElementById('owner-pressure-bar');
                const patienceTextEl = document.getElementById('owner-patience-text');
                const patienceBarEl = document.getElementById('owner-patience-bar');
                const expectationEl = document.getElementById('owner-expectation');
                
                if (GameState.ownerProfile) {
                    if (nameEl) nameEl.textContent = GameState.ownerProfile.name;
                    if (expectationEl) expectationEl.textContent = (GameState.ownerExpectation || 'compete').toUpperCase();
                }
                
                const pressure = Math.round(GameState.ownerPressure || 50);
                const patience = Math.round(GameState.ownerPatience || 100);
                
                if (pressureTextEl) {
                    pressureTextEl.textContent = `${pressure}%`;
                    pressureTextEl.style.color = pressure > 75 ? '#ef4444' : pressure > 50 ? '#f59e0b' : '#22c55e';
                }
                if (pressureBarEl) {
                    pressureBarEl.style.width = `${pressure}%`;
                    pressureBarEl.style.background = pressure > 75 ? '#ef4444' : pressure > 50 ? '#f59e0b' : '#22c55e';
                }
                
                if (patienceTextEl) {
                    patienceTextEl.textContent = `${patience}%`;
                    patienceTextEl.style.color = patience < 25 ? '#ef4444' : patience < 50 ? '#f59e0b' : '#22c55e';
                }
                if (patienceBarEl) {
                    patienceBarEl.style.width = `${patience}%`;
                    patienceBarEl.style.background = patience < 25 ? '#ef4444' : patience < 50 ? '#f59e0b' : '#22c55e';
                }
            },
            
            updateMediaWidget() {
                const heatTextEl = document.getElementById('media-heat-text');
                const heatBarEl = document.getElementById('media-heat-bar');
                const headlineEl = document.getElementById('latest-headline');
                
                const heat = Math.round(GameState.mediaHeat || 50);
                const level = GameState.hotSeatLevel || 'warm';
                
                if (heatTextEl) {
                    heatTextEl.textContent = level.toUpperCase();
                    heatTextEl.style.color = heat > 75 ? '#ef4444' : heat > 50 ? '#f59e0b' : '#22c55e';
                }
                
                if (heatBarEl) {
                    heatBarEl.style.width = `${heat}%`;
                    heatBarEl.style.background = heat > 75 ? '#ef4444' : heat > 50 ? '#f59e0b' : '#22c55e';
                }
                
                if (headlineEl && GameState.headlines && GameState.headlines.length > 0) {
                    const latest = GameState.headlines[GameState.headlines.length - 1];
                    headlineEl.innerHTML = `
                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.25rem;">Latest Headline</div>
                        <div style="font-size:0.9rem;font-style:italic;">${latest.text}</div>
                    `;
                }
            },
            
            updateMetric(id, band) {
                const el = document.getElementById(id);
                if (el) {
                    const oldValue = el.textContent;
                    const newValue = band.label;
                    
                    // Add pulsing animation class
                    el.classList.add('metric-pulse');
                    setTimeout(() => el.classList.remove('metric-pulse'), 600);
                    
                    // Update with smooth transition
                    el.style.transition = 'color 0.3s ease, transform 0.3s ease';
                    el.textContent = newValue;
                    el.style.color = band.color;
                    
                    // Show change indicator if value changed
                    if (oldValue && oldValue !== newValue) {
                        const isIncrease = this.isMetricImprovement(oldValue, newValue);
                        this.showMetricChangeIndicator(el, isIncrease);
                    }
                }
            },
            
            isMetricImprovement(oldLabel, newLabel) {
                const hierarchy = ['Critical', 'Weak', 'Stable', 'Strong', 'Elite', 'Minimal', 'Low', 'Moderate', 'High'];
                const oldIdx = hierarchy.indexOf(oldLabel);
                const newIdx = hierarchy.indexOf(newLabel);
                if (oldIdx === -1 || newIdx === -1) return null;
                return newIdx > oldIdx;
            },
            
            showMetricChangeIndicator(element, isIncrease) {
                if (isIncrease === null) return;
                
                const indicator = document.createElement('span');
                indicator.className = 'metric-change-indicator';
                indicator.textContent = isIncrease ? '' : '';
                indicator.style.color = isIncrease ? '#10b981' : '#ef4444';
                indicator.style.fontSize = '1.2rem';
                indicator.style.marginLeft = '0.5rem';
                indicator.style.animation = 'fadeInOut 1.5s ease';
                
                element.parentElement.style.position = 'relative';
                element.appendChild(indicator);
                
                setTimeout(() => {
                    if (indicator.parentElement) {
                        indicator.remove();
                    }
                }, 1500);
            },
            
            updateRoomStatuses() {
                ['eval', 'cap', 'relationships', 'risk'].forEach(room => {
                    const el = document.getElementById(`status-${room}`);
                    const btn = document.getElementById(`btn-${room}`);
                    const skipBtn = document.getElementById(`btn-skip-${room}`);
                    
                    if (el) {
                        if (GameState.isRoomLocked(room)) {
                            // Check if this room was skipped
                            const wasSkipped = GameState.skippedRooms && GameState.skippedRooms.some(
                                s => s.room === room && s.cycle === GameState.cycleIndex
                            );
                            
                            if (wasSkipped) {
                                el.textContent = 'Skipped';
                                el.classList.add('disabled');
                                el.classList.remove('locked');
                            } else {
                                el.textContent = 'Locked';
                                el.classList.add('locked');
                                el.classList.remove('disabled');
                            }
                            
                            if (btn) btn.disabled = true;
                            if (skipBtn) skipBtn.disabled = true;
                        } else {
                            el.textContent = 'Pending';
                            el.classList.remove('locked', 'disabled');
                            if (btn) btn.disabled = false;
                            if (skipBtn) skipBtn.disabled = false;
                        }
                    }
                });
            },
            
            updateConstraintWarnings() {
                // Show constraint warnings on hub cards
                if (GameState.hasFlag('hard_cap_triggered')) {
                    this.setConstraintWarning('cap', 'Hard cap: No spending room');
                } else {
                    this.clearConstraintWarning('cap');
                }
                
                if (GameState.hasFlag('burned_agent_bridge')) {
                    this.setConstraintWarning('relationships', 'Agent trust damaged');
                } else {
                    this.clearConstraintWarning('relationships');
                }
                
                if (GameState.optionalityCap < 100) {
                    this.setConstraintWarning('eval', `Flexibility capped at ${GameState.optionalityCap}`);
                }
            },
            
            setConstraintWarning(room, message) {
                const container = document.getElementById(`constraint-${room}`);
                if (container) {
                    container.innerHTML = `<div class="constraint-warning">${message}</div>`;
                }
            },
            
            clearConstraintWarning(room) {
                const container = document.getElementById(`constraint-${room}`);
                if (container) container.innerHTML = '';
            },
            
            updateAdvanceButton() {
                const btn = document.getElementById('btn-advance-cycle');
                if (btn) {
                    if (GameState.canAdvanceCycle()) {
                        btn.disabled = false;
                        const locked = GameState.lockedRooms.length;
                        if (locked === 4) {
                            btn.textContent = 'All Decisions Committed  Advance to Next Cycle';
                        } else {
                            btn.textContent = `Ready to Advance (${locked}/4 rooms completed)`;
                        }
                    } else {
                        btn.disabled = true;
                        const locked = GameState.lockedRooms.length;
                        btn.textContent = `Committed: ${locked}/4  Need at least 3 rooms to advance`;
                    }
                }
            },
            
            updateCycle() {
                const el = document.getElementById('current-cycle');
                if (el) el.textContent = GameState.cycleIndex;
                
                // Update pressure indicator
                this.updatePressureIndicator();
            },
            
            updatePressureIndicator() {
                const container = document.getElementById('pressure-indicator');
                if (!container) return;
                
                const cycle = GameState.cycleIndex;
                let pressure = '';
                
                if (cycle === 1) {
                    pressure = '<div class="pressure-banner pressure-low"><div class="pressure-title">Opening Moves</div><div>Establish your strategy. Early decisions set the foundation.</div></div>';
                } else if (cycle === 2) {
                    pressure = '<div class="pressure-banner pressure-moderate"><div class="pressure-title">Rising Stakes</div><div>Consequences begin to manifest. Past choices affect current options.</div></div>';
                } else if (cycle === 3) {
                    pressure = '<div class="pressure-banner"><div class="pressure-title">High Pressure</div><div>Critical juncture. Decisions compound. Limited room for error.</div></div>';
                } else if (cycle === 4) {
                    pressure = '<div class="pressure-banner"><div class="pressure-title">Final Cycle</div><div>Legacy-defining moment. All decisions culminate here.</div></div>';
                }
                
                container.innerHTML = pressure;
            },
            
            setFranchiseName(name) {
                const el = document.getElementById('current-franchise-name');
                if (el) el.textContent = name;
            },
            
            clearAlerts() {
                const container = document.getElementById('alert-container');
                if (container) container.innerHTML = '';
            },
            
            addAlert(message, type = 'default') {
                const container = document.getElementById('alert-container');
                if (container) {
                    const alert = document.createElement('div');
                    alert.className = `alert ${type === 'warning' ? 'alert-warning' : type === 'success' ? 'alert-success' : ''}`;
                    alert.textContent = message;
                    container.appendChild(alert);
                }
            },
            
            // ROOM-SPECIFIC RENDERING
            // Generate room entry narrative based on cycle and room
            getRoomNarrative(roomName, cycle) {
                const narratives = {
                    eval: {
                        1: {
                            title: "The War Room Opens",
                            story: "You walk into the analytics room. Screens show player data and draft picks. Your scouts have done their research, but the information isn't perfect. You never have all the facts. You have to make the best call you can with what you know.",
                            stakes: "Your first pick sets the tone. Pick wrong and you waste valuable resources."
                        },
                        2: {
                            title: "Patterns Show Up",
                            story: "Things are more complicated now. Your earlier choices matterplayers are getting better (or worse), draft picks are valuable (or not). Your team has more data, but also more questions. Other teams see what you're doing.",
                            stakes: "Every choice now builds on your earlier decisions. Past mistakes make this harder."
                        },
                        3: {
                            title: "Time Is Running Out",
                            story: "This is the critical moment. Everyone in the league knows your strategy. Agents know your patterns. Other GMs know what you'll do. The room feels tense. Your scouts are waiting for you to decide.",
                            stakes: "Get this wrong and you waste your shot at winning. Get it right and everything clicks."
                        },
                        4: {
                            title: "The Final Choice",
                            story: "This is it. Everything you've built leads to this. Your whole strategypatient or aggressive, data-driven or relationship-basedis about to pay off or fail. The data is in. The intel is complete. Do you trust what you've built?",
                            stakes: "This choice defines your career. Trust your plan or change direction after years of work."
                        }
                    },
                    cap: {
                        1: {
                            title: "The Money Meeting",
                            story: "You sit with your salary cap expert. Spreadsheets cover the screenscurrent contracts, future costs, tax penalties. Every dollar you spend today limits tomorrow. Every dollar you save keeps options open. The math is harsh and unforgiving.",
                            stakes: "Money decisions are hard to undo. Sign the wrong contract, live with it for years."
                        },
                        2: {
                            title: "The Bill Arrives",
                            story: "Last cycle's contracts are real now. Some look smart. Others look like mistakes. Your cap expert shows you the numbersthey tell the story of your past choices. Can you afford what you want to do?",
                            stakes: "Every dollar counts now. What you spent before limits what you can do today."
                        },
                        3: {
                            title: "Money Gets Tight",
                            story: "The numbers are getting really tight. You're deciding millions now, but thinking about the long-term cost of billions. The luxury tax is looming. Your owner is watching. Every contract affects the next three years.",
                            stakes: "Money is tight. One bad contract and you're stuck with no way forward."
                        },
                        4: {
                            title: "Final Accounting",
                            story: "This is the final money decision. Every contract, every dollar, everything leads here. Your cap expert shows the optionseach one is a different future. The tax line is a hard limit. Your owner's patience has a price.",
                            stakes: "This is where you either win big or bet the future. The numbers are clear."
                        }
                    },
                    relationships: {
                        1: {
                            title: "First Meetings",
                            story: "You meet with key people for the first time in your new job. Agents check you out. Player reps test your limits. Your star's agent wants to talk contract. The tone you set now matters for years. Every handshake sends a message.",
                            stakes: "Relationships matter. Mess one up now and word spreads fast through the agent world."
                        },
                        2: {
                            title: "Building Trust",
                            story: "People remember how you handled things before. Some agents trust you more. Others have warned their clients about you. Your phone rings differently nowsome calls you want, others you don't. Your reputation is being written right now.",
                            stakes: "Trust builds or falls apart. Your earlier relationship choices affect who wants to work with you now."
                        },
                        3: {
                            title: "Word Gets Around",
                            story: "Agents talk to each other. Your reputation comes up before every meeting. When you call an agent, they already know your recorddo you keep your word, do you play fair, are you someone they want to deal with. Relationships matter more now than ever.",
                            stakes: "A bad reputation closes doors forever. Once trust breaks, it rarely comes back."
                        },
                        4: {
                            title: "Your Reputation Is Set",
                            story: "This is the moment that defines you. Agents will remember this for years. Players' careers depend on your honesty. Your wordkept or brokenbecomes NBA history. Some GMs are known for being fair. Others for being ruthless. Which will you be?",
                            stakes: "Your final relationship choice sets your reputation forever. Pick who you want to be."
                        }
                    },
                    risk: {
                        1: {
                            title: "Understanding Risk",
                            story: "You sit with your analytics team looking at risk models. Every choice has different possible outcomeslikely, worst-case, best-case. A trade could win you a title or set you back five years. An injury could ruin everything. You can't avoid risk, only manage it.",
                            stakes: "High risk early can snowball. One bad bet and you're in trouble for years."
                        },
                        2: {
                            title: "Risk Adds Up",
                            story: "Your earlier risky choices are playing out now. Some worked. Others are failing. The problem with risk: it builds up. A risky move last time limits your choices now. You're not starting freshyou're dealing with the consequences of every choice before.",
                            stakes: "Too much risk piles up and limits your options. Too much variance and you lose control."
                        },
                        3: {
                            title: "Risk Is Everywhere",
                            story: "You look at all the riskscontract risk, injury risk, performance risk, team chemistry risk. Everything connects. One thing falls, others follow. Your room for error is tiny. The question isn't if you'll take risksit's which risks are worth it.",
                            stakes: "Your risk appetite meets reality. Take too much risk and you gamble everything. Take too little and you never win."
                        },
                        4: {
                            title: "The Final Bet",
                            story: "All the risk calculations come down to this. You can see all the possible outcomesthe likely path, the disaster scenario, the championship dream. This is the bet that defines your time here. High risk with huge upside? Low risk with guaranteed mediocrity? You must choose.",
                            stakes: "This choice has the biggest range. Highest reward, worst downside. Your legacy depends on this."
                        }
                    }
                };
                
                return narratives[roomName]?.[cycle] || {
                    title: "Decision Time",
                    story: "A key moment in your time as GM.",
                    stakes: "Your choice will have real consequences."
                };
            },
            
            renderEvaluationRoom(scenario, roomName, scenarioId) {
                const narrative = this.getRoomNarrative('eval', GameState.cycleIndex);
                return `
                    <div class="decision-container">
                        <div class="room-entry-narrative">
                            <h3 class="room-entry-title">${narrative.title}</h3>
                            <p class="room-entry-story">${narrative.story}</p>
                            <div class="room-stakes">
                                <span class="room-stakes-label"> Stakes</span>
                                <span class="room-stakes-text">${narrative.stakes}</span>
                            </div>
                        </div>
                        
                        <div class="room-intro">
                            <h3>${scenario.title}</h3>
                            <p>${scenario.context}</p>
                            ${scenario.scenario ? `<div class="scenario-reference"><strong>Real NBA Example:</strong> ${scenario.scenario}</div>` : ''}
                        </div>
                        
                        ${scenario.signals ? `
                            <div class="eval-layout">
                                <div class="signals-panel">
                                    <h4>Intelligence Signals</h4>
                                    ${scenario.signals.map(signal => `
                                        <div class="signal-item">
                                            ${signal.text}
                                            <span class="signal-confidence confidence-${signal.confidence}">${signal.confidence}</span>
                                        </div>
                                    `).join('')}
                                    <div class="incomplete-data"> Incomplete data set  judgment required</div>
                                </div>
                                <div>
                                    <div class="decision-prompt">
                                        <h4>${scenario.question}</h4>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="decision-prompt">
                                <h4>${scenario.question}</h4>
                            </div>
                        `}
                        
                        ${this.renderOptions(scenario, roomName, scenarioId)}
                        ${this.renderEconomicConcepts(scenario)}
                    </div>
                `;
            },
            
            renderCapRoom(scenario, roomName, scenarioId) {
                const narrative = this.getRoomNarrative('cap', GameState.cycleIndex);
                return `
                    <div class="decision-container">
                        <div class="room-entry-narrative">
                            <h3 class="room-entry-title">${narrative.title}</h3>
                            <p class="room-entry-story">${narrative.story}</p>
                            <div class="room-stakes">
                                <span class="room-stakes-label"> Stakes</span>
                                <span class="room-stakes-text">${narrative.stakes}</span>
                            </div>
                        </div>
                        
                        <div class="room-intro">
                            <h3>${scenario.title}</h3>
                            <p>${scenario.context}</p>
                            ${scenario.scenario ? `<div class="scenario-reference"><strong>Real NBA Example:</strong> ${scenario.scenario}</div>` : ''}
                        </div>
                        
                        ${scenario.capSummary ? `
                            <div class="cap-control-panel">
                                <div class="cap-summary">
                                    <div class="cap-stat">
                                        <div class="cap-stat-label">Current Salary</div>
                                        <div class="cap-stat-value">${scenario.capSummary.currentSalary}</div>
                                    </div>
                                    <div class="cap-stat">
                                        <div class="cap-stat-label">Salary Cap</div>
                                        <div class="cap-stat-value">${scenario.capSummary.capLine}</div>
                                    </div>
                                    <div class="cap-stat">
                                        <div class="cap-stat-label">Luxury Tax</div>
                                        <div class="cap-stat-value">${scenario.capSummary.taxLine}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="decision-prompt">
                            <h4>${scenario.question}</h4>
                        </div>
                        
                        ${this.renderOptions(scenario, roomName, scenarioId)}
                        ${this.renderEconomicConcepts(scenario)}
                    </div>
                `;
            },
            
            renderRelationshipsRoom(scenario, roomName, scenarioId) {
                const narrative = this.getRoomNarrative('relationships', GameState.cycleIndex);
                return `
                    <div class="decision-container">
                        <div class="room-entry-narrative">
                            <h3 class="room-entry-title">${narrative.title}</h3>
                            <p class="room-entry-story">${narrative.story}</p>
                            <div class="room-stakes">
                                <span class="room-stakes-label"> Stakes</span>
                                <span class="room-stakes-text">${narrative.stakes}</span>
                            </div>
                        </div>
                        
                        <div class="room-intro">
                            <h3>${scenario.title}</h3>
                            <p>${scenario.context}</p>
                            ${scenario.scenario ? `<div class="scenario-reference"><strong>Real NBA Example:</strong> ${scenario.scenario}</div>` : ''}
                        </div>
                        
                        ${scenario.dialogue ? `
                            <div class="dialogue-frame">
                                <div class="dialogue-speaker">${scenario.dialogue.speaker}</div>
                                <div class="dialogue-text">"${scenario.dialogue.text}"</div>
                                ${scenario.relationshipTemp ? `
                                    <div class="relationship-temperature temp-${scenario.relationshipTemp}">
                                        Relationship: ${scenario.relationshipTemp.charAt(0).toUpperCase() + scenario.relationshipTemp.slice(1)}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="decision-prompt">
                            <h4>${scenario.question}</h4>
                        </div>
                        
                        ${this.renderOptions(scenario, roomName, scenarioId)}
                        ${this.renderEconomicConcepts(scenario)}
                    </div>
                `;
            },
            
            renderRiskRoom(scenario, roomName, scenarioId) {
                const narrative = this.getRoomNarrative('risk', GameState.cycleIndex);
                return `
                    <div class="decision-container">
                        <div class="room-entry-narrative">
                            <h3 class="room-entry-title">${narrative.title}</h3>
                            <p class="room-entry-story">${narrative.story}</p>
                            <div class="room-stakes">
                                <span class="room-stakes-label"> Stakes</span>
                                <span class="room-stakes-text">${narrative.stakes}</span>
                            </div>
                        </div>
                        
                        <div class="room-intro">
                            <h3>${scenario.title}</h3>
                            <p>${scenario.context}</p>
                            ${scenario.scenario ? `<div class="scenario-reference"><strong>Real NBA Example:</strong> ${scenario.scenario}</div>` : ''}
                        </div>
                        
                        ${scenario.outcomeScenarios ? `
                            <div class="outcome-distribution">
                                <div class="outcome-scenario">
                                    <div class="outcome-label likely">${scenario.outcomeScenarios.likely.label}</div>
                                    <div class="outcome-value">${scenario.outcomeScenarios.likely.outcome}</div>
                                    <div class="outcome-desc">${scenario.outcomeScenarios.likely.impact}</div>
                                </div>
                                <div class="outcome-scenario">
                                    <div class="outcome-label worst">${scenario.outcomeScenarios.worst.label}</div>
                                    <div class="outcome-value">${scenario.outcomeScenarios.worst.outcome}</div>
                                    <div class="outcome-desc">${scenario.outcomeScenarios.worst.impact}</div>
                                </div>
                                <div class="outcome-scenario">
                                    <div class="outcome-label best">${scenario.outcomeScenarios.best.label}</div>
                                    <div class="outcome-value">${scenario.outcomeScenarios.best.outcome}</div>
                                    <div class="outcome-desc">${scenario.outcomeScenarios.best.impact}</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${scenario.riskLevel ? `
                            <div class="risk-meter">
                                <div class="risk-meter-label">Current Risk Exposure</div>
                                <div class="risk-meter-bar">
                                    <div class="risk-meter-fill" style="width: ${scenario.riskLevel}%"></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="decision-prompt">
                            <h4>${scenario.question}</h4>
                        </div>
                        
                        ${this.renderOptions(scenario, roomName, scenarioId)}
                        ${this.renderEconomicConcepts(scenario)}
                    </div>
                `;
            },
            
            renderOptions(scenario, roomName, scenarioId) {
                // Check if we have advice for THIS scenario (stored when button clicked)
                const mentorAdvice = (GMMentors.currentScenarioId === scenarioId) ? GMMentors.currentAdvice : null;
                const showCallButton = GMMentors.currentMentor && GMMentors.callsRemaining > 0 && !mentorAdvice;
                
                return `
                    ${showCallButton ? `
                        <div style="text-align:center;margin-bottom:1.5rem;">
                            <button onclick="callMentorForAdvice('${scenarioId}', '${roomName}')" 
                                    class="btn-primary" 
                                    style="padding:1rem 2rem;background:linear-gradient(135deg,var(--gold),#d4af37);font-size:1.1rem;">
                                 Call ${GMMentors.currentMentor.name} for Advice (${GMMentors.callsRemaining} left)
                            </button>
                        </div>
                    ` : ''}
                    
                    ${mentorAdvice ? `
                        <div style="margin-bottom:2rem;padding:1.5rem;background:rgba(245,166,35,0.1);border:2px solid var(--gold);border-radius:8px;">
                            <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                                <div style="font-size:2.5rem;">${GMMentors.currentMentor.emoji}</div>
                                <div>
                                    <div style="font-weight:bold;font-size:1.1rem;">${GMMentors.currentMentor.name}'s Advice</div>
                                    <div style="font-size:0.85rem;color:var(--text-secondary);">
                                        Calls Remaining: ${mentorAdvice.callsLeft}
                                    </div>
                                </div>
                            </div>
                            <div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:6px;margin-bottom:1rem;">
                                <div style="font-style:italic;">"${mentorAdvice.generalAdvice}"</div>
                            </div>
                            <div style="font-size:0.9rem;font-weight:600;margin-bottom:0.5rem;">
                                Option Ratings:
                            </div>
                            <div style="display:grid;gap:0.5rem;">
                                ${mentorAdvice.ratings.map(r => `
                                    <div style="display:flex;align-items:center;gap:1rem;">
                                        <div style="font-size:1.2rem;">${''.repeat(r.stars)}</div>
                                        <div style="flex:1;font-size:0.9rem;">${scenario.options[r.index].text.substring(0, 40)}...</div>
                                        <div style="font-size:0.85rem;font-style:italic;color:var(--text-secondary);">${r.advice}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="options-container">
                        ${scenario.options.map((opt, idx) => {
                            const isAvailable = GameState.isOptionAvailable(opt.id);
                            const disabledReason = GameState.getOptionDisabledReason(opt.id);
                            
                            return `
                                <div class="option-card ${!isAvailable ? 'disabled' : ''}">
                                    ${!isAvailable ? `
                                        <div class="option-disabled-reason">
                                            <strong> Option Unavailable</strong><br>
                                            ${disabledReason}<br>
                                            <span style="font-size:0.85rem;opacity:0.8;">Past decisions have closed this path</span>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="option-header">
                                        <h5>${opt.text}</h5>
                                        <div class="option-rationale">${opt.rationale}</div>
                                    </div>
                                    
                                    ${opt.beforeAfter ? `
                                        <div class="before-after-comparison">
                                            <div class="comparison-value">
                                                <div class="comparison-label">Before</div>
                                                <div class="comparison-number">${opt.beforeAfter.flexibility.before}</div>
                                            </div>
                                            <div class="comparison-arrow"></div>
                                            <div class="comparison-value">
                                                <div class="comparison-label">After</div>
                                                <div class="comparison-number">${opt.beforeAfter.flexibility.after}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="option-preview">
                                        <div class="preview-section">
                                            <strong>Immediate Effects:</strong>
                                            <p>${opt.explanation.immediate}</p>
                                        </div>
                                        <div class="preview-section">
                                            <strong>Delayed Consequences:</strong>
                                            <p>${opt.explanation.delayed}</p>
                                        </div>
                                        <div class="preview-section preview-economic">
                                            <strong>Economic Lesson:</strong>
                                            <p>${opt.explanation.economic}</p>
                                        </div>
                                    </div>
                                    
                                    ${opt.irreversible ? '<div class="irreversible-warning"><strong> Irreversible Decision</strong>  This choice permanently constrains future options.</div>' : ''}
                                    ${opt.varianceWarning ? `<div class="variance-warning"> ${opt.varianceWarning}</div>` : ''}
                                    ${opt.memory ? `<div class="memory-callout"> ${opt.memory}</div>` : ''}
                                    ${opt.delayedWarning ? `<div class="delayed-consequence"><strong> Delayed Impact:</strong> ${opt.delayedWarning}</div>` : ''}
                                    
                                    ${isAvailable ? `
                                        <button class="btn-decision" data-room="${roomName}" data-scenario="${scenarioId}" data-index="${idx}">
                                            ${roomName === 'eval' ? 'Trust This Assessment' :
                                              roomName === 'cap' ? 'Commit Resources' :
                                              roomName === 'relationships' ? 'Negotiate Terms' :
                                              roomName === 'risk' ? 'Accept Exposure' : 'Choose Option'}
                                        </button>
                                    ` : `
                                        <button class="btn-decision" disabled>Option Unavailable</button>
                                    `}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            renderEconomicConcepts(scenario) {
                if (!scenario.economicConcepts) return '';
                
                return `
                    <div class="economic-concepts-box">
                        <h4>Economic Concepts in This Decision</h4>
                        <div class="concepts-list">
                            ${Object.entries(scenario.economicConcepts).map(([term, def]) => `
                                <div class="concept-item">
                                    <div class="concept-term-box">${term}</div>
                                    <div class="concept-def">${def}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        };
        
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            // Show requested screen
            const screen = document.getElementById(`screen-${screenId}`);
            if (screen) {
                screen.classList.add('active');
                console.log('Showing screen:', screenId);
            } else {
                console.error('Screen not found:', screenId);
            }
        }
        
        function showModal(modalId) {
            const modal = document.getElementById(`modal-${modalId}`);
            if (modal) modal.classList.add('active');
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(`modal-${modalId}`);
            if (modal) modal.classList.remove('active');
        }
        
        
        function skipRoom(roomName) {
            if (GameState.isRoomLocked(roomName)) {
                return; // Already completed or skipped
            }
            
            if (confirm(`Skip ${roomName === 'eval' ? 'War Room' : roomName === 'cap' ? 'Cap Room' : roomName === 'relationships' ? 'Relationships' : 'Risk'} for this cycle?\n\nYou can advance with 3 of 4 rooms completed.`)) {
                GameState.skipRoom(roomName);
                UI.updateRoomStatuses();
                UI.updateAdvanceButton();
                UI.addAlert(`Skipped ${roomName} room for Cycle ${GameState.cycleIndex}`, 'default');
            }
        }
        
        function closeRoomModal() {
            document.getElementById('screen-room').style.display = 'none';
            
            // Show mentor advice sometimes
            if (GMMentors.currentMentor) {
                GMMentors.showAdvice();
            }
            
            maybeShowTrivia('after_decision');  // Context-aware trivia trigger
        }
        
        function selectFranchise(type) {
            GameState.initializeFranchise(type);
            UI.setFranchiseName(GameState.franchiseName);
            UI.clearAlerts();
            
            // INITIALIZE OWNER & MEDIA SYSTEMS
            OwnerSystem.init(type);
            GameState.mediaHeat = 50;
            GameState.fanSentiment = 50;
            
            // INITIALIZE ECONOMIC MASTERY TREE
            EconomicMasteryTree.init();
            
            const messages = {
                'contender': [
                    'Ownership expects championship. Star is 34 with 2 years left.',
                    'Cap situation tight. Minimal flexibility.',
                    'Media watching closely. Every decision scrutinized.'
                ],
                'young': [
                    'Promising young core. No proven stars yet.',
                    'Cap flexibility gives options. Fans impatient.',
                    'Agents want commitment before extending clients.'
                ],
                'messy': [
                    'Roster stuck in mediocrity. No clear path.',
                    'Bad contract eating cap space for 3 years.',
                    'Fanbase lost faith. Need to restore credibility.'
                ]
            };
            
            messages[type].forEach(msg => UI.addAlert(msg));
            
            // Add owner intro alert
            UI.addAlert(`Owner ${GameState.ownerProfile.name} (${GameState.ownerProfile.personality}) expects: ${GameState.ownerExpectation.toUpperCase()}`, 'warning');
            
            UI.updateHubMetrics();
            UI.updateCycle();
            
            // Show mentor selection
            setTimeout(() => {
                GMMentors.showMentorSelection();
            }, 1000);
        }
        
        
        // BRANCHING HELPER: Determines which scenario variation to show based on prior decisions
        function getBranchingScenarioId(roomName, cycle, franchise) {
            // PRIORITY 1: Check for event-reactive scenarios (Cycle 3+)
            if (cycle >= 3 && roomName === 'eval') {
                // If star got injured and you tanked
                if (GameState.hasFlag('tanked_after_injury') && GameState.hasFlag('star_injured')) {
                    const eventScenario = 'cycle3_eval_star_return';
                    if (Scenarios[eventScenario]) return eventScenario;
                }
                
                // If star got injured and you competed
                if (GameState.hasFlag('competed_despite_injury') && GameState.hasFlag('star_injured')) {
                    const eventScenario = 'cycle3_eval_injury_aftermath';
                    if (Scenarios[eventScenario]) return eventScenario;
                }
                
                // If you traded demanding star
                if (GameState.hasFlag('traded_demanding_star')) {
                    const eventScenario = 'cycle3_eval_post_trade';
                    if (Scenarios[eventScenario]) return eventScenario;
                }
            }
            
            // PRIORITY 2: Regular branching based on prior decisions (Cycle 2+)
            if (cycle === 1 || (roomName !== 'eval' && roomName !== 'cap')) {
                return `cycle${cycle}_${roomName}_${franchise}`;
            }
            
            // Get prior decision for this room from Cycle 1
            const priorDecision = GameState.decisionLog.find(d => 
                d.cycle === cycle - 1 && d.room === roomName
            );
            
            if (!priorDecision) {
                // Fallback to default if no prior decision found
                return `cycle${cycle}_${roomName}_${franchise}`;
            }
            
            // Extract the decision branch identifier from the option ID
            let branch = '';
            
            // Check for common "all-in" patterns across all franchises
            if (priorDecision.optionId.includes('allin') || 
                priorDecision.optionId.includes('tax') ||
                priorDecision.optionId.includes('extend') ||
                priorDecision.optionId.includes('chase') ||
                priorDecision.optionId.includes('commit')) {
                branch = 'allin';
            } 
            // Check for "patient/wait" patterns
            else if (priorDecision.optionId.includes('patient') || 
                     priorDecision.optionId.includes('avoid') ||
                     priorDecision.optionId.includes('wait')) {
                branch = 'patient';
            } 
            // Check for "balanced/middle" patterns
            else if (priorDecision.optionId.includes('balanced') || 
                     priorDecision.optionId.includes('mle') ||
                     priorDecision.optionId.includes('moderate')) {
                branch = 'balanced';
            }
            
            // If we found a branch pattern, try to load that branching scenario
            if (branch) {
                const branchingId = `cycle${cycle}_${roomName}_${franchise}_${branch}`;
                if (Scenarios[branchingId]) {
                    return branchingId;
                }
            }
            
            // Fallback to default scenario for this cycle/room/franchise
            return `cycle${cycle}_${roomName}_${franchise}`;
        }
        
        function openRoom(roomName) {
            // Clear any previous mentor advice when entering a new room
            GMMentors.currentAdvice = null;
            GMMentors.currentScenarioId = null;
            
            // Special: Trade puzzle for contender in Cycle 1 War Room
            if (GameState.cycleIndex === 1 && 
                GameState.franchise === 'contender' && 
                roomName === 'eval') {
                TradePuzzle.show(GameState.franchise);
                return;
            }
            
            if (GameState.isRoomLocked(roomName)) {
                const content = document.getElementById('room-modal-content');
                content.innerHTML = `
                    <div style="text-align:center;padding:3rem;">
                        <div style="font-size:4rem;color:var(--gold);margin-bottom:1rem;"></div>
                        <h3>Decision Committed</h3>
                        <p class="decision-commitment">Your choice for this room has been locked for this cycle.</p>
                        <button class="btn-primary" onclick="closeRoomModal()" style="margin-top:2rem;">Return to Hub</button>
                    </div>
                `;
                document.getElementById('screen-room').style.display = 'flex';
                return;
            }
            
            const scenarioId = getBranchingScenarioId(roomName, GameState.cycleIndex, GameState.franchise);
            const scenario = Scenarios[scenarioId];
            
            const titles = {
                'eval': 'Evaluation & Analytics Room',
                'cap': 'Cap & Contracts Room',
                'relationships': 'Relationships Room',
                'risk': 'Risk & Portfolio Room'
            };
            
            document.getElementById('room-modal-title').textContent = titles[roomName];
            document.getElementById('room-progress').textContent = `Cycle ${GameState.cycleIndex}  ${titles[roomName]}`;
            
            if (!scenario) {
                const content = document.getElementById('room-modal-content');
                content.innerHTML = `
                    <div style="text-align:center;padding:3rem;">
                        <h3>Content Coming Soon</h3>
                        <p style="color:var(--text-secondary);margin-top:1rem;">
                            Cycle ${GameState.cycleIndex} decisions for this room are in development.
                        </p>
                        <button class="btn-primary" onclick="closeRoomModal()" style="margin-top:2rem;">Return to Hub</button>
                    </div>
                `;
                document.getElementById('screen-room').style.display = 'flex';
                return;
            }
            
            // Render room-specific UI
            const content = document.getElementById('room-modal-content');
            if (roomName === 'eval') {
                content.innerHTML = UI.renderEvaluationRoom(scenario, roomName, scenarioId);
            } else if (roomName === 'cap') {
                content.innerHTML = UI.renderCapRoom(scenario, roomName, scenarioId);
            } else if (roomName === 'relationships') {
                content.innerHTML = UI.renderRelationshipsRoom(scenario, roomName, scenarioId);
            } else if (roomName === 'risk') {
                content.innerHTML = UI.renderRiskRoom(scenario, roomName, scenarioId);
            }
            
            document.getElementById('screen-room').style.display = 'flex';
        }
        
        
        // 
        // CONCEPT IDENTIFICATION SYSTEM
        // 
        
        function identifyConceptsInDecision(option, roomName, scenario) {
            const concepts = [];
            const text = (option.text + ' ' + (option.rationale || '')).toLowerCase();
            const effects = option.effects || {};
            
            // OPPORTUNITY COST - Every decision has opportunity cost!
            concepts.push('opportunity_cost');
            
            // TIME PREFERENCE - Now vs Later decisions
            if (text.match(/now|immediate|quick|all.?in|win.*now|desperate/i) ||
                effects.capFlexibility < -15 || 
                (effects.rosterQuality > 10 && effects.optionality < -10)) {
                concepts.push('time_preference');
            }
            
            // RISK VS RETURN - Risky decisions
            if (text.match(/risk|gamble|uncertain|unknown|young.*player|draft/i) ||
                effects.riskExposure > 15 ||
                effects.injuryFragility > 10) {
                concepts.push('risk_vs_return');
            }
            
            // TRUST & REPUTATION
            if (text.match(/trust|relationship|commitment|promise|word|integrity/i) ||
                effects.trustIndex !== undefined ||
                effects.reputationPlayers !== undefined ||
                effects.reputationAgents !== undefined) {
                concepts.push('trust_reputation');
            }
            
            // SUNK COST FALLACY - Don't chase bad decisions
            if (text.match(/already.*invested|can't.*give.*up|too.*far|double.*down/i) ||
                scenario.situation?.includes('underperforming') ||
                scenario.situation?.includes('not working out')) {
                concepts.push('sunk_cost');
            }
            
            // INFORMATION ADVANTAGE - Knowing more than others
            if (text.match(/scout|intel|information|data|analytics|edge|insider/i) ||
                effects.informationEdge !== undefined) {
                concepts.push('information_advantage');
            }
            
            // PATIENCE VALUE - Good things take time
            if (text.match(/patient|develop|long.?term|build|foundation|future/i) ||
                (effects.optionality > 10 && effects.rosterQuality < 5)) {
                concepts.push('patience_value');
            }
            
            // REPUTATION EFFECTS - What people say matters
            if (text.match(/media|fans|perception|narrative|optics/i) ||
                effects.mediaNarrative !== undefined) {
                concepts.push('reputation_effects');
            }
            
            // OPTION VALUE - Keeping choices open
            if (text.match(/flexibility|option|preserve|diversify|hedge/i) ||
                effects.optionality > 15) {
                concepts.push('option_value');
            }
            
            // PRINCIPAL-AGENT - Different goals
            if (text.match(/owner|agent|player.*wants|interest|alignment/i) ||
                roomName === 'relationships') {
                concepts.push('principal_agent');
            }
            
            // CALCULATED RISK - Smart gambling
            if (text.match(/calculated|strategic.*risk|upside|expected.*value/i) ||
                (effects.riskExposure > 10 && effects.rosterQuality > 10)) {
                concepts.push('calculated_risk');
            }
            
            // Remove duplicates and return only unlocked concepts
            const unique = [...new Set(concepts)];
            return unique.filter(id => {
                const concept = EconomicMasteryTree.concepts[id];
                return concept && concept.unlocked;
            });
        }
        
        function evaluateDecisionSuccess(option, gameState) {
            const effects = option.effects || {};
            
            // Calculate success score (0-100)
            let score = 50; // Base neutral
            
            // Positive effects increase score
            if (effects.rosterQuality > 0) score += effects.rosterQuality * 2;
            if (effects.trustIndex > 0) score += effects.trustIndex * 1.5;
            if (effects.capFlexibility > 0) score += effects.capFlexibility;
            if (effects.optionality > 0) score += effects.optionality;
            
            // Negative effects decrease score
            if (effects.rosterQuality < 0) score += effects.rosterQuality * 2;
            if (effects.trustIndex < 0) score += effects.trustIndex * 1.5;
            if (effects.riskExposure > 15) score -= 10;
            
            // Context matters - different success criteria by game state
            if (gameState.rosterQuality < 40) {
                // Rebuilding: value optionality and future
                if (effects.optionality > 10) score += 15;
                if (effects.capFlexibility > 10) score += 10;
            } else if (gameState.rosterQuality > 70) {
                // Contending: value winning now
                if (effects.rosterQuality > 10) score += 20;
                if (effects.trustIndex > 10) score += 15;
            }
            
            // Owner expectations matter
            if (gameState.ownerExpectation === 'championship' && effects.rosterQuality > 10) score += 15;
            if (gameState.ownerExpectation === 'tank' && effects.optionality > 10) score += 15;
            
            // Success if score >= 60
            return score >= 60;
        }
        
        function selectOption(roomName, scenarioId, optionIndex) {
            const scenario = Scenarios[scenarioId];
            if (!scenario) return;
            
            const option = scenario.options[optionIndex];
            
            console.log('=== DECISION MADE ===');
            console.log('Cycle:', GameState.cycleIndex);
            console.log('Room:', roomName);
            console.log('Option:', option.text);
            console.log('Effects:', option.effects);
            
            // Track the decision
            const decisionRecord = {
                cycle: GameState.cycleIndex,
                room: roomName,
                roomName: roomName,
                scenarioId: scenarioId,
                optionId: option.id,
                optionText: option.text,
                timestamp: Date.now()
            };
            
            GameState.decisionLog.push(decisionRecord);
            
            // 
            // PRIORITY 1: CONCEPT TRACKING - TAG DECISIONS WITH CONCEPTS
            // 
            
            // Determine which concepts this decision uses
            const conceptsUsed = identifyConceptsInDecision(option, roomName, scenario);
            
            // Determine if decision was "successful" based on metrics and context
            const wasSuccessful = evaluateDecisionSuccess(option, GameState);
            
            // Track each concept used
            conceptsUsed.forEach(conceptId => {
                EconomicMasteryTree.trackConceptUse(conceptId, wasSuccessful);
                console.log(` Tracked concept: ${conceptId}, success: ${wasSuccessful}`);
            });
            
            // Show concept notification if any were used
            if (conceptsUsed.length > 0) {
                const conceptNames = conceptsUsed.map(id => {
                    const concept = EconomicMasteryTree.concepts[id];
                    return concept ? concept.kid_friendly_name : id;
                }).join(', ');
                
                setTimeout(() => {
                    UI.addAlert(` Used: ${conceptNames}`, 'info');
                }, 1500);
            }
            
            // 
            
            // Update mentor approval
            if (GMMentors.currentMentor) {
                const approvalChange = GMMentors.updateApproval(decisionRecord);
                
                // Update challenge progress
                GMMentors.updateChallengeProgress(decisionRecord);
                
                // Trigger debate (30% chance)
                setTimeout(() => {
                    GMMentors.triggerDebate(decisionRecord);
                }, 3000);
                
                if (Math.abs(approvalChange) >= 10) {
                    setTimeout(() => {
                        const msg = approvalChange > 0 ? 
                            `${GMMentors.currentMentor.emoji} ${GMMentors.currentMentor.name} approves! (+${approvalChange}%)` :
                            `${GMMentors.currentMentor.emoji} ${GMMentors.currentMentor.name} is concerned... (${approvalChange}%)`;
                        UI.addAlert(msg, approvalChange > 0 ? 'success' : 'warning');
                    }, 2000);
                }
            }
            
            GameState.applyEffects(option.effects);
            GameState.lockRoom(roomName);
            UI.updateHubMetrics();
            
            console.log('Updated GameState:', {
                flags: GameState.flags,
                optionality: GameState.optionality,
                capFlexibility: GameState.capFlexibility,
                riskExposure: GameState.riskExposure
            });
            console.log('=====================');
            
            // Generate narrative explanation of what just happened
            const narrativeExplanation = generateNarrativeExplanation(option, roomName, GameState.cycleIndex);
            
            // Get actual applied effects (with variance)
            const actualEffects = GameState.lastAppliedEffects || {};
            
            const content = document.getElementById('room-modal-content');
            content.innerHTML = `
                <div class="decision-confirmed">
                    <div class="confirmation-icon"></div>
                    <h3>Decision Executed</h3>
                    <p class="decision-choice">${option.text}</p>
                    <p class="decision-commitment">Locked for Cycle ${GameState.cycleIndex}  Cannot be reversed</p>
                    
                    <div class="narrative-explanation">
                        <h4>The Outcome</h4>
                        <p>${narrativeExplanation}</p>
                    </div>
                    
                    <div class="effects-applied">
                        <h4>Actual Impact (with variance)</h4>
                        <p style="font-size:0.9rem;color:var(--text-muted);margin-bottom:1rem;">
                            Decisions rarely go exactly as planned. These are the actual effects:
                        </p>
                        <div class="effects-list">
                            ${Object.entries(actualEffects)
                                .map(([key, value]) => {
                                    const display = key.replace(/([A-Z])/g, ' $1').trim();
                                    const roundedValue = Math.round(value * 10) / 10;
                                    const sign = roundedValue > 0 ? '+' : '';
                                    const color = roundedValue > 0 ? '#10b981' : '#ef4444';
                                    return `
                                        <div class="effect-item">
                                            <span>${display}:</span>
                                            <span style="color:${color};font-weight:700;">${sign}${roundedValue}</span>
                                        </div>
                                    `;
                                }).join('')}
                        </div>
                        ${option.irreversible ? '<p style="margin-top:1rem;color:var(--danger);font-size:0.9rem;"><strong> Irreversible:</strong> This decision has permanently constrained future options.</p>' : ''}
                        <p style="margin-top:1rem;color:var(--text-muted);font-size:0.9rem;font-style:italic;">
                            Future consequences: ${option.explanation.delayed}
                        </p>
                    </div>
                    
                    <button class="btn-primary" onclick="closeRoomModal()" style="margin-top:2rem;">
                        Return to Command Center
                    </button>
                </div>
            `;
        }
        
        function generateNarrativeExplanation(option, roomName, cycle) {
            // Generate contextual narrative based on room and effects
            const effects = option.effects;
            const appliedEffects = GameState.lastAppliedEffects || {};
            const narratives = [];
            
            // Room-specific narratives with more detail
            if (roomName === 'eval') {
                if (effects.rosterQuality && effects.rosterQuality > 15) {
                    narratives.push(`The war room erupts. Your scouting department begins immediate implementation. Player workouts are scheduled. Trade calls are made. This evaluation commits serious organizational resourcesthe kind of bet that defines a front office.`);
                } else if (effects.rosterQuality && effects.rosterQuality > 0) {
                    narratives.push("Your evaluation is on the record. The scouting team proceeds cautiously, implementing your directive while maintaining some flexibility.");
                } else if (effects.optionality && effects.optionality > 0) {
                    narratives.push("You've held firm. No commitments, no burned options. Other GMs notice your patiencesome respect it, others see hesitation. Your draft capital remains untouched, ready for the right opportunity.");
                }
                
                // Add consequence based on previous decisions
                if (cycle >= 2 && GameState.hasFlag('rebuild_mode')) {
                    narratives.push("Your rebuild strategy continues. Young players are developing, but the timeline is long and uncertain.");
                } else if (cycle >= 2 && GameState.hasFlag('all_in_move')) {
                    narratives.push("Your all-in bet compounds. Every evaluation now viewed through the lens of 'championship-or-bust.'");
                }
            } else if (roomName === 'cap') {
                if (effects.capFlexibility && effects.capFlexibility < -15) {
                    narratives.push("The contracts are finalized. Signatures dry. Your cap flexibility just took a significant hit. The salary structure is now locked in for yearsthese commitments will follow you through multiple cycles, constraining every future move.");
                } else if (effects.capFlexibility && effects.capFlexibility < 0) {
                    narratives.push("Financial commitment made. Your cap specialist updates the projections. The numbers are tighter now, but manageable.");
                } else if (effects.taxExposure && effects.taxExposure > 15) {
                    narratives.push("You've crossed deep into luxury tax territory. Your owner receives the updated financial projections. The penalties are steep and will compound each year. The front office feels the pressureevery dollar now carries multiplied cost.");
                } else if (effects.taxExposure && effects.taxExposure > 0) {
                    narratives.push("Tax line crossed. Your CFO sends the cost analysis to ownership. Financial pressure begins mounting.");
                }
                
                // Cap-specific compound effects
                if (cycle >= 3 && GameState.capFlexibility < 30) {
                    narratives.push("Your cap situation is becoming critical. Limited maneuvering room remains.");
                } else if (cycle >= 3 && GameState.hasFlag('tax_payer')) {
                    narratives.push("The tax bill continues compounding. Repeater penalties loom on the horizon.");
                }
            } else if (roomName === 'relationships') {
                if (effects.reputationAgents && effects.reputationAgents > 10) {
                    narratives.push("The agent leaves the meeting satisfied. Within hours, word spreads through the agent communityyou negotiated in good faith, honored your word. Your phone starts ringing differently. Other agents want to work with you. This reputation becomes currency.");
                } else if (effects.reputationAgents && effects.reputationAgents > 0) {
                    narratives.push("A fair outcome. The agent appreciates your professionalism. Neutral reputation maintained in a business that never forgets.");
                } else if (effects.reputationAgents && effects.reputationAgents < -10) {
                    narratives.push("The agent storms out. Your reputation takes a serious hitand in this business, reputation travels fast. Within the day, other agents know what happened. Future negotiations just got harder. Some agents may refuse to work with you entirely.");
                } else if (effects.reputationAgents && effects.reputationAgents < 0) {
                    narratives.push("The relationship is strained. Not burned, but damaged. The agent will remember this.");
                }
                
                // Relationship compound effects
                if (cycle >= 2 && GameState.reputationAgents < 40) {
                    narratives.push("Your damaged reputation with agents is now actively working against you. Star players' reps are hesitant to engage.");
                } else if (cycle >= 3 && GameState.reputationAgents > 75) {
                    narratives.push("Your reputation precedes you. Agents actively seek you out for deals. This social capital is proving invaluable.");
                }
            } else if (roomName === 'risk') {
                if (effects.riskExposure && effects.riskExposure > 20) {
                    narratives.push("You've significantly increased variance. The distribution of possible outcomes is now much widerthe potential for extraordinary success exists, but so does catastrophic failure. You're betting big. The analytics team updates the risk models: high variance, high stakes.");
                } else if (effects.riskExposure && effects.riskExposure > 0) {
                    narratives.push("Risk exposure increased. You've added variance to the portfolio. Outcomes become less predictable.");
                } else if (effects.riskExposure && effects.riskExposure < -15) {
                    narratives.push("You've de-risked substantially. The downside is protected, the portfolio more stable. But with reduced variance comes reduced upsideyou've traded explosive potential for safety. A conservative approach in a business that often rewards risk.");
                } else if (effects.riskExposure && effects.riskExposure < 0) {
                    narratives.push("Risk reduced. Portfolio variance decreased. More predictable outcomes, for better or worse.");
                }
                
                // Risk compound effects
                if (cycle >= 3 && GameState.riskExposure > 70) {
                    narratives.push("Your total risk exposure is now extreme. One bad break could unravel everything. One good break could win a championship.");
                } else if (cycle >= 3 && GameState.riskExposure < 30) {
                    narratives.push("Your conservative risk management has created stabilitybut perhaps at the cost of championship upside.");
                }
            }
            
            // Add flags narrative with more color
            if (effects.flags) {
                if (effects.flags.includes('all_in_move')) {
                    narratives.push(" ALL-IN: You've gone championship-or-bust. The entire organization shifts into win-now mode. Patient strategies are off the table. Every decision from here forward is viewed through this lens. There's no turning backyou either deliver a championship or this gamble becomes your legacy.");
                }
                if (effects.flags.includes('rebuild_mode')) {
                    narratives.push(" REBUILD INITIATED: Multi-year rebuild begins. You're accumulating young assets and draft capital while accepting near-term losses. This is a 3-5 year commitment. Ownership and fans must buy in. The criticism will be loud before any success arrives.");
                }
                if (effects.flags.includes('tax_payer')) {
                    narratives.push(" LUXURY TAX: You've crossed into tax territory. Penalties start immediately and compound annually. Stay above the line for multiple years and repeater penalties kick inexponentially more expensive. Your owner is watching the bottom line closely now.");
                }
                if (effects.flags.includes('burned_agent_bridge')) {
                    narratives.push(" BRIDGE BURNED: Your relationship with this agent (and likely their entire agency) is permanently damaged. Word will spread. Future free agents represented by this agency will be nearly impossible to sign. You've closed doors that won't reopen.");
                }
            }
            
            // Add optionality cap narrative with gravitas
            if (effects.optionalityCap) {
                narratives.push(` FLEXIBILITY CAPPED: Your future optionality is now permanently limited to ${effects.optionalityCap}. Some strategic paths that were theoretically possible are now closed forever. You've traded long-term flexibility for short-term commitment. This constraint will follow you for years.`);
            }
            
            // Add contextual cycle narrative
            if (cycle === 1) {
                narratives.push("Foundation set. These opening moves create the strategic constraints for everything that follows.");
            } else if (cycle === 2) {
                narratives.push("Consequences are real now. Your Cycle 1 choices are actively shaping what's possible today.");
            } else if (cycle === 3) {
                narratives.push("The window is narrowing. Room for error shrinks with each decision. This is where championships are won or lost.");
            } else if (cycle === 4) {
                narratives.push("Final legacy-defining move. Your tenure will be judged by this cycle's outcomes.");
            }
            
            if (narratives.length === 0) {
                narratives.push("Decision implemented. The front office executes immediately. Consequences will emerge in subsequent cycles.");
            }
            
            return narratives.join(' ');
        }
        
        function showCycleTransition(newCycle) {
            const overlay = document.getElementById('cycle-transition-overlay');
            const cycleNumber = document.getElementById('transition-cycle-number');
            const cycleTitle = document.getElementById('transition-cycle-title');
            const cycleNarrative = document.getElementById('transition-cycle-narrative');
            const consequencesList = document.getElementById('transition-consequences-list');
            
            // Set cycle-specific content
            const cycleContent = {
                2: {
                    title: "Your Choices Have Consequences",
                    narrative: "Your early decisions now shape what you can do. Players are signed. Trades are done. The league knows your strategy. Your next moves will either build on what you startedor try to fix your mistakes."
                },
                3: {
                    title: "The Pressure Is On",
                    narrative: "Everyone is watching nowagents, other teams, the media. Your plan is clear to all. Mistakes get harder to fix. This is where titles are won or lost. This is where futures are made or destroyed."
                },
                4: {
                    title: "Final Decision",
                    narrative: "This is it. All your work comes down to this moment. Your job will be judged by what happens next. The team's futureand your reputationdepend on these final choices."
                }
            };
            
            cycleNumber.textContent = newCycle;
            cycleTitle.textContent = cycleContent[newCycle]?.title || `Cycle ${newCycle}`;
            cycleNarrative.textContent = cycleContent[newCycle]?.narrative || "The next phase begins.";
            document.getElementById('transition-cycle-number-btn').textContent = newCycle;
            
            // Generate consequences list from flags and prior decisions
            const consequences = [];
            
            if (GameState.hasFlag('all_in_move')) {
                consequences.push(" Your all-in bet limits slow, patient moves");
            }
            if (GameState.hasFlag('rebuild_mode')) {
                consequences.push(" Young players growing, but it takes time");
            }
            if (GameState.hasFlag('tax_payer')) {
                consequences.push(" Tax bills growing, money pressure building");
            }
            if (GameState.optionalityCap < 100) {
                consequences.push(` Your flexibility is capped at ${GameState.optionalityCap}some moves are now impossible`);
            }
            if (GameState.reputationAgents < 50) {
                consequences.push(" Bad reputation with agents hurts negotiations");
            }
            if (GameState.capFlexibility < 40) {
                consequences.push(" Very tight cap space, hard to make moves");
            }
            if (GameState.riskExposure > 60) {
                consequences.push(" High riskcould go really well or really badly");
            }
            
            if (consequences.length > 0) {
                consequencesList.innerHTML = consequences.map(c => 
                    `<div class="consequence-item">${c}</div>`
                ).join('');
            } else {
                consequencesList.innerHTML = '<div class="consequence-item"> Clean slateno major constraints yet</div>';
            }
            
            // Show overlay with continue button
            overlay.classList.add('active');
        }
        
        function continueToCycle() {
            document.getElementById('cycle-transition-overlay').classList.remove('active');
        }
        
        
        // 
        // PERFORMANCE OUTCOMES CALCULATOR
        // 
        
        function calculateSeasonOutcome() {
            const state = GameState;
            
            // Base win probability from metrics - IMPROVED FORMULA
            let winProbability = 
                (state.rosterQuality * 0.40) +  // WAS 0.35, NOW 0.40 - Talent is MORE important
                (state.trustIndex * 0.20) +     // WAS 0.15, NOW 0.20 - Chemistry matters MORE
                ((100 - state.riskExposure) * 0.15) +  // WAS 0.10, NOW 0.15 - Injury luck matters MORE
                (state.mediaNarrative * 0.10);  // WAS 0.05, NOW 0.10 - Momentum matters MORE
            
            // Apply variance (12 points instead of 15 - less random)
            winProbability += (Math.random() * 24 - 12);
            
            // Clamp to 0-100
            winProbability = Math.max(0, Math.min(100, winProbability));
            
            // Determine outcome - LOWERED THRESHOLDS
            let outcome, record, reaction, ownerSatisfaction;
            
            if (winProbability >= 75) {  // WAS 85, NOW 75 - MUCH EASIER!
                outcome = 'Championship';
                record = `${Math.floor(Math.random() * 5 + 62)}-${Math.floor(Math.random() * 5 + 15)}`;
                reaction = 'PARADE! The city celebrates. You\'re a hero.';
                ownerSatisfaction = 100;
                GameState.championships++;
                GameState.playoffAppearances++;
            } else if (winProbability >= 65) {  // WAS 72, NOW 65
                outcome = 'Conference Finals';
                record = `${Math.floor(Math.random() * 6 + 56)}-${Math.floor(Math.random() * 6 + 20)}`;
                reaction = 'Deep run. Owner pleased but wants more.';
                ownerSatisfaction = 80;
                GameState.playoffAppearances++;
            } else if (winProbability >= 52) {  // WAS 58, NOW 52
                outcome = 'Second Round Exit';
                record = `${Math.floor(Math.random() * 6 + 48)}-${Math.floor(Math.random() * 6 + 28)}`;
                reaction = 'Solid season. Not great, not terrible.';
                ownerSatisfaction = 65;
                GameState.playoffAppearances++;
            } else if (winProbability >= 42) {  // WAS 45, NOW 42
                outcome = 'First Round Exit';
                record = `${Math.floor(Math.random() * 6 + 42)}-${Math.floor(Math.random() * 6 + 34)}`;
                reaction = 'Made playoffs. Fans want more.';
                ownerSatisfaction = 55;
                GameState.playoffAppearances++;
            } else if (winProbability >= 33) {  // WAS 35, NOW 33
                outcome = 'Play-In Loss';
                record = `${Math.floor(Math.random() * 5 + 37)}-${Math.floor(Math.random() * 5 + 40)}`;
                reaction = 'Mediocre. Not good enough.';
                ownerSatisfaction = 40;
            } else {
                outcome = 'Lottery';
                record = `${Math.floor(Math.random() * 10 + 20)}-${Math.floor(Math.random() * 10 + 52)}`;
                reaction = state.hasFlag('rebuild_mode') ? 
                    'Expected. Draft pick incoming.' : 
                    'Disaster. Heads will roll.';
                ownerSatisfaction = state.hasFlag('rebuild_mode') ? 50 : 25;
            }
            
            return {
                outcome,
                record,
                wins: parseInt(record.split('-')[0]) || 0,  // ADD THIS
                playoffs: winProbability >= 42,  // ADD THIS
                championship: outcome === 'Championship',  // ADD THIS
                winProbability: Math.round(winProbability),
                reaction,
                ownerSatisfaction,
                starPerformance: state.rosterQuality > 70 ? 'All-NBA 1st Team' :
                                 state.rosterQuality > 55 ? 'All-NBA 2nd Team' :
                                 state.rosterQuality > 40 ? 'All-Star' : 'Underperformed',
                keyInjuries: state.riskExposure > 60 ? 'Multiple key injuries' : 'Relatively healthy'
            };
        }
        
        function showSeasonOutcome(outcome) {
            const modal = document.getElementById('screen-outcome');
            if (!modal) return;
            
            const content = document.getElementById('outcome-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">
                        ${outcome.outcome === 'Championship' ? '' : 
                          outcome.outcome.includes('Finals') ? '' :
                          outcome.outcome.includes('Exit') ? '' : ''}
                    </div>
                    
                    <h2 style="font-size: 2rem; color: var(--gold); margin-bottom: 1rem;">
                        Season Results: Cycle ${GameState.cycleIndex - 1}
                    </h2>
                    
                    <div style="background: rgba(245, 166, 35, 0.1); border: 1px solid rgba(245, 166, 35, 0.3); padding: 1.5rem; border-radius: 4px; margin: 2rem 0;">
                        <div style="font-size: 2.5rem; color: var(--text-primary); margin-bottom: 0.5rem;">
                            ${outcome.outcome}
                        </div>
                        <div style="font-size: 1.2rem; color: var(--text-secondary);">
                            Record: ${outcome.record}
                        </div>
                    </div>
                    
                    <div style="text-align: left; max-width: 500px; margin: 2rem auto; padding: 1.5rem; background: rgba(255,255,255,0.02); border-radius: 4px;">
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--gold);">Star Performance:</strong> 
                            <span style="color: var(--text-secondary);">${outcome.starPerformance}</span>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--gold);">Season Health:</strong> 
                            <span style="color: var(--text-secondary);">${outcome.keyInjuries}</span>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--gold);">Win Probability:</strong> 
                            <span style="color: var(--text-secondary);">${outcome.winProbability}% (based on your decisions)</span>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--gold);">Owner Satisfaction:</strong> 
                            <span style="color: ${outcome.ownerSatisfaction >= 70 ? '#10b981' : outcome.ownerSatisfaction >= 50 ? '#f5a623' : '#ef4444'};">
                                ${outcome.ownerSatisfaction}/100
                            </span>
                        </div>
                    </div>
                    
                    <div style="padding: 1rem; background: rgba(19, 38, 66, 0.3); border-left: 3px solid var(--gold); margin: 1.5rem 0;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); font-style: italic;">
                            "${outcome.reaction}"
                        </div>
                    </div>
                    
                    ${outcome.outcome === 'Championship' ? `
                        <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(245, 166, 35, 0.2), rgba(245, 166, 35, 0.05)); border: 2px solid var(--gold); border-radius: 4px; margin-top: 2rem;">
                            <div style="font-size: 1.5rem; color: var(--gold); margin-bottom: 0.5rem;"> CHAMPIONSHIP!</div>
                            <div style="color: var(--text-secondary);">Your decisions led to the ultimate success. The banner goes up in the rafters.</div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 4px;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                            <strong>Teaching Moment:</strong> Outcomes have variance! Good decisions can fail. Bad decisions can succeed. 
                            ${outcome.winProbability >= 60 ? 'Your strong foundation gave you high probability - the variance worked out.' : 
                              outcome.winProbability >= 40 ? 'Moderate probability - you had a shot but nothing guaranteed.' :
                              'Low probability - you needed luck to overcome weak foundation.'}
                        </div>
                    </div>
                    
                    <button class="btn-ghost" onclick="startPressConference()" style="margin-top:1rem;">
                         Face the Press
                    </button>
                    
                    <button class="btn-primary" onclick="closeOutcomeModal()" style="margin-top: 2rem; padding: 1rem 2rem;">
                        Continue to Cycle ${GameState.cycleIndex}
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function startPressConference() {
            const lastOutcome = GameState.seasonOutcomes[GameState.seasonOutcomes.length - 1];
            const headline = window._currentHeadline || GameState.headlines[GameState.headlines.length - 1]?.text || "Season Complete";
            
            document.getElementById('screen-outcome').style.display = 'none';
            if (window.InteractivePressConference) { InteractivePressConference.show(lastOutcome); } else { MediaSystem.showPressConference(lastOutcome, headline); }
        }
        
        function closePressAndShowOwner() {
            const lastOutcome = GameState.seasonOutcomes[GameState.seasonOutcomes.length - 1];
            document.getElementById('screen-replay').style.display = 'none';
            
            // Show owner meeting
            OwnerSystem.showOwnerMeeting(lastOutcome);
        }
        
        function closeOwnerMeetingAndContinue() {
            document.getElementById('screen-replay').style.display = 'none';
            
            // Return to hub after owner meeting
            showScreen('hub');
            
            // Continue with normal flow (events, lottery, etc.)
            closeOutcomeModal();
        }
        
        function closeOutcomeModal() {
            const modal = document.getElementById('screen-outcome');
            if (modal) modal.style.display = 'none';
            
            // Check if team qualifies for lottery
            const lastOutcome = GameState.seasonOutcomes[GameState.seasonOutcomes.length - 1];
            const inLottery = lastOutcome && (lastOutcome.outcome === 'Lottery' || 
                              GameState.rosterQuality < 50 ||
                              GameState.hasFlag('tanked_after_injury'));
            
            if (inLottery && GameState.cycleIndex === 2) {
                // Show lottery instead of event check
                DraftLottery.show(GameState);
                return;
            }
            
            // Check for random event
            const event = RandomEvents.getRandomEvent(GameState);
            
            if (event) {
                GameState.currentEvent = event;
                showEventModal(event);
            } else {
                // No event, go straight to cycle transition
                continueToCycleAfterOutcome();
            }
        }
        
        // 
        // RANDOM EVENTS TRIGGER
        // 
        
        function checkForRandomEvent() {
            const event = RandomEvents.getRandomEvent(GameState);
            
            if (event) {
                GameState.currentEvent = event;
                showEventModal(event);
            }
        }
        
        function showEventModal(event) {
            const modal = document.getElementById('screen-event');
            if (!modal) return;
            
            const content = document.getElementById('event-content');
            content.innerHTML = `
                <div style="padding: 2rem;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${event.title.split(' ')[0]}</div>
                        <h2 style="font-size: 1.8rem; color: var(--gold);">${event.title.substring(event.title.indexOf(' ') + 1)}</h2>
                    </div>
                    
                    <div style="padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; margin-bottom: 2rem;">
                        <div style="font-size: 1.1rem; line-height: 1.6; color: var(--text-primary);">
                            ${event.description}
                        </div>
                    </div>
                    
                    <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 2rem;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); font-style: italic;">
                            ${event.flavorText}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: var(--gold); margin-bottom: 1rem;">How do you respond?</h3>
                        
                        ${event.options.map((option, idx) => `
                            <div class="option-card" onclick="handleEventChoice('${event.id}', '${option.id}')" style="margin-bottom: 1rem; cursor: pointer; padding: 1.5rem; background: rgba(255,255,255,0.02); border: 1px solid rgba(245, 166, 35, 0.2); border-radius: 4px; transition: all 0.2s;">
                                <div style="font-size: 1.1rem; color: var(--text-primary); margin-bottom: 0.5rem;">
                                    ${option.text}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                    ${option.rationale}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--gold);">
                                     Teaches: ${option.teaches}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Add hover effect
            setTimeout(() => {
                document.querySelectorAll('.option-card').forEach(card => {
                    card.addEventListener('mouseenter', function() {
                        this.style.background = 'rgba(245, 166, 35, 0.1)';
                        this.style.borderColor = 'var(--gold)';
                    });
                    card.addEventListener('mouseleave', function() {
                        this.style.background = 'rgba(255,255,255,0.02)';
                        this.style.borderColor = 'rgba(245, 166, 35, 0.2)';
                    });
                });
            }, 100);
        }
        
        function handleEventChoice(eventId, choiceId) {
            const event = RandomEvents[eventId];
            const choice = event.options.find(o => o.id === choiceId);
            
            if (!choice) return;
            
            // Apply immediate event effects
            if (event.immediateEffects) {
                GameState.applyEffects(event.immediateEffects);
            }
            
            // Apply choice effects
            if (choice.effects) {
                GameState.applyEffects(choice.effects);
            }
            
            // Log the event
            GameState.eventsHistory.push(eventId);
            GameState.decisionLog.push({
                cycle: GameState.cycleIndex,
                room: 'event',
                optionId: choiceId,
                optionText: choice.text
            });
            
            // Close event modal
            document.getElementById('screen-event').style.display = 'none';
            
            // Show teaching moment if teaching mode is on
            if (GameState.teachingMode && choice.teaches) {
                showTeachingMoment(choice.teaches, choice.explanation, event.title).then(() => {
                    // After teaching moment, go to cycle transition
                    continueToCycleAfterOutcome();
                });
            } else {
                // No teaching mode, go straight to cycle transition
                continueToCycleAfterOutcome();
            }
            
            // Update UI
            UI.updateHubMetrics();
        }
        
        function advanceCycle() {
            const completedRooms = GameState.roomsCompleted.size;
            
            if (!GameState.canAdvanceCycle()) {
                alert(`You must make decisions in at least 3 of 4 rooms before advancing.\n\nRooms completed: ${completedRooms}/4\n\nVisit these rooms:\n Scouting\n Team Chemistry\n Finances\n Community\n\nMake at least one decision in each room you visit.`);
                return;
            }
            
            // Calculate season outcome for the cycle that just ended
            const outcome = calculateSeasonOutcome();
            GameState.seasonOutcomes.push(outcome);
            
            console.log('=== ADVANCING CYCLE ===');
            console.log('From Cycle', GameState.cycleIndex, 'to Cycle', GameState.cycleIndex + 1);
            console.log('Season Outcome:', outcome);
            
            // UPDATE OWNER PRESSURE & MEDIA
            const ownerUpdate = OwnerSystem.updatePressure(outcome);
            const mediaUpdate = MediaSystem.updateMediaHeat(outcome);
            const headline = MediaSystem.generateHeadline(outcome);
            
            // Store headline globally for press conference access
            window._currentHeadline = headline;
            
            console.log('Owner Pressure:', GameState.ownerPressure, 'Change:', ownerUpdate.pressureChange);
            console.log('Media Heat:', GameState.mediaHeat, 'Change:', mediaUpdate);
            console.log('Headline:', headline);
            
            GameState.advanceCycle();
            
            console.log('Cycle advanced to:', GameState.cycleIndex);
            if (window.AuthSystem && !window.AuthSystem.isTeacher) {
                console.log('Updating progress...');
                window.AuthSystem.updateProgress(GameState);
            }
            
            console.log('New Cycle:', GameState.cycleIndex);
            console.log('=======================');
            
            // Check if fired
            const firedCheck = OwnerSystem.checkFired();
            if (firedCheck.fired) {
                showFiredScreen(firedCheck.reason);
                return;
            }
            
            if (GameState.cycleIndex > 4) {
                showDossier();
            } else {
                // Show sequence: Outcome  Press Conference  Owner Meeting  Transition
                showSeasonOutcome(outcome, () => {
                    MediaSystem.showPressConference(outcome, headline, () => {
                        OwnerSystem.showOwnerMeeting(outcome);
                    });
                });
            }
        }
        
        function showFiredScreen(reason) {
            const modal = document.getElementById('screen-replay');
            const content = document.getElementById('replay-content');
            
            content.innerHTML = `
                <div style="padding:3rem;max-width:700px;margin:0 auto;text-align:center;">
                    <div style="font-size:8rem;margin-bottom:2rem;"></div>
                    <h1 style="color:#ef4444;font-size:3rem;margin-bottom:1rem;">YOU'RE FIRED</h1>
                    <div style="font-size:1.3rem;color:var(--text-secondary);margin-bottom:2rem;">
                        ${reason}
                    </div>
                    
                    <div style="padding:2rem;background:rgba(239,68,68,0.1);border:2px solid #ef4444;border-radius:12px;margin-bottom:2rem;">
                        <div style="font-size:1.1rem;line-height:1.8;">
                            ${GameState.ownerProfile.name} has decided to make a change.
                            After ${GameState.cycleIndex - 1} cycles, your tenure as GM has come to an end.
                        </div>
                    </div>
                    
                    <div style="margin-bottom:2rem;">
                        <h3 style="margin-bottom:1rem;">Final Stats:</h3>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;text-align:left;">
                            <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                                <div style="color:var(--text-secondary);font-size:0.9rem;">Championships</div>
                                <div style="font-size:2rem;font-weight:bold;">${GameState.championships || 0}</div>
                            </div>
                            <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                                <div style="color:var(--text-secondary);font-size:0.9rem;">Playoff Appearances</div>
                                <div style="font-size:2rem;font-weight:bold;">${GameState.playoffAppearances || 0}</div>
                            </div>
                            <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                                <div style="color:var(--text-secondary);font-size:0.9rem;">Final Owner Pressure</div>
                                <div style="font-size:2rem;font-weight:bold;color:#ef4444;">${Math.round(GameState.ownerPressure)}%</div>
                            </div>
                            <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                                <div style="color:var(--text-secondary);font-size:0.9rem;">Hot Seat Level</div>
                                <div style="font-size:1.5rem;font-weight:bold;color:#ef4444;">${GameState.hotSeatLevel.toUpperCase()}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding:1.5rem;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:2rem;">
                        <div style="font-size:0.9rem;font-style:italic;opacity:0.8;">
                            "In the NBA, results matter. You didn't deliver. Good luck in your next opportunity."
                        </div>
                        <div style="margin-top:0.5rem;font-size:0.8rem;color:var(--text-secondary);">
                            - ${GameState.ownerProfile.name}
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="location.reload()" style="width:100%;padding:1rem;">
                        Start New Career
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // Update continueToCycle to show transition after outcome/event
        function continueToCycleAfterOutcome() {
            showCycleTransition(GameState.cycleIndex);
            
            setTimeout(() => {
                // Return to hub after transition
                showScreen('hub');
                
                UI.updateCycle();
                UI.updateHubMetrics();
                UI.clearAlerts();
                UI.addAlert(`Cycle ${GameState.cycleIndex} begins. Consequences of previous choices now manifest.`, 'warning');
                
                // Add consequence alerts
                if (GameState.hasFlag('tax_payer') && GameState.cycleIndex === 3) {
                    UI.addAlert('Tax bill compounds. Future cap flexibility reduced.', 'warning');
                }
                if (GameState.hasFlag('rebuild_mode') && GameState.cycleIndex === 3) {
                    UI.addAlert('Young assets developing. Draft capital accumulating.', 'success');
                }
                if (GameState.hasFlag('all_in_move') && GameState.cycleIndex >= 2) {
                    UI.addAlert('All-in commitment active. Patient options unavailable.', 'warning');
                }
                
                // Trivia between cycles
                maybeShowTrivia('between_cycles');
            }, 500);
        }
        
        function showDossier() {
            const band = GameState.getPerformanceBand();
            const claimCode = GameState.generateClaimCode();
            const totalChampionships = GameState.championships || 0;
            const totalPlayoffs = GameState.playoffAppearances || 0;
            const mentorApproval = Math.round(GMMentors.approvalRating || 0);
            const mentorLevel = GMMentors.mentorLevel || 1;
            const masteryProgress = EconomicMasteryTree.getMasteryProgress();
            
            const content = document.getElementById('dossier-content');
            content.innerHTML = `
                <div class="dossier-section">
                    <h2> GM Career Summary</h2>
                    <p style="color:var(--text-secondary);font-size:1.1rem;">
                        You completed all <strong>4 decision cycles</strong> as the <strong>${GameState.franchiseName}</strong>.
                    </p>
                </div>
                
                <!-- CHAMPIONSHIPS SECTION -->
                <div class="dossier-section" style="text-align:center;padding:2rem;background:linear-gradient(135deg,rgba(245,166,35,0.15),rgba(218,165,32,0.05));border:2px solid var(--gold);border-radius:12px;">
                    <div style="font-size:5rem;margin-bottom:1rem;">
                        ${totalChampionships > 0 ? ''.repeat(Math.min(totalChampionships, 3)) : ''}
                    </div>
                    <div style="font-size:3rem;font-weight:bold;color:var(--gold);margin-bottom:0.5rem;">
                        ${totalChampionships}
                    </div>
                    <div style="font-size:1.2rem;color:var(--text-secondary);">
                        Championship${totalChampionships !== 1 ? 's' : ''} Won
                    </div>
                    ${totalChampionships === 0 ? `
                        <div style="margin-top:1rem;font-size:0.9rem;opacity:0.7;">
                            Building takes time. Keep learning!
                        </div>
                    ` : totalChampionships === 1 ? `
                        <div style="margin-top:1rem;font-size:1rem;color:var(--gold);">
                            You're a champion GM! 
                        </div>
                    ` : `
                        <div style="margin-top:1rem;font-size:1rem;color:var(--gold);">
                            DYNASTY BUILDER! Multiple championships! 
                        </div>
                    `}
                </div>
                
                <!-- 6 CYCLE BREAKDOWN -->
                ${GameState.seasonOutcomes.length > 0 ? `
                    <div class="dossier-section">
                        <h3> Season-by-Season Results</h3>
                        <div style="display:grid;gap:1rem;margin-top:1.5rem;">
                            ${GameState.seasonOutcomes.map((outcome, idx) => {
                                const isChampionship = (outcome.championship || outcome.outcome === 'Championship');
                                const isPlayoffs = (outcome.playoffs || outcome.outcome?.includes('Exit') || outcome.outcome?.includes('Finals') || isChampionship);
                                
                                return `
                                <div style="padding:1.5rem;background:${isChampionship ? 'linear-gradient(135deg,rgba(245,166,35,0.2),rgba(218,165,32,0.05))' : 'var(--bg-elevated)'};border-radius:8px;border:2px solid ${isChampionship ? 'var(--gold)' : 'var(--border)'};">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                                        <div style="font-size:1.3rem;font-weight:600;color:${isChampionship ? 'var(--gold)' : '#fff'};">
                                            ${isChampionship ? '' : 
                                              (outcome.outcome || 'Season')?.includes('Finals') ? '' : 
                                              isPlayoffs ? '' : ''} 
                                            Cycle ${idx + 1}: ${outcome.outcome || 'Season Complete'}
                                        </div>
                                        <div style="font-size:1.1rem;color:var(--text-secondary);">${outcome.record || outcome.wins + '-' + (82-outcome.wins) || 'N/A'}</div>
                                    </div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;font-size:0.95rem;">
                                        <div><strong>Star:</strong> ${outcome.starPerformance || 'N/A'}</div>
                                        <div><strong>Health:</strong> ${outcome.keyInjuries || 'N/A'}</div>
                                        <div><strong>Win Prob:</strong> ${outcome.winProbability || 0}%</div>
                                        <div><strong>Owner:</strong> ${outcome.ownerSatisfaction || 50}/100</div>
                                    </div>
                                    ${isChampionship ? `
                                        <div style="margin-top:1rem;padding:0.75rem;background:rgba(245,166,35,0.3);border-radius:6px;text-align:center;font-weight:bold;color:var(--gold);">
                                             CHAMPIONSHIP SEASON! 
                                        </div>
                                    ` : ''}
                                </div>
                            `}).join('')}
                        </div>
                        
                        <!-- CAREER STATS -->
                        <div style="margin-top:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                            <div style="padding:1.5rem;background:rgba(245,166,35,0.1);border-radius:8px;">
                                <div style="font-size:2rem;font-weight:bold;color:var(--gold);">${totalChampionships}</div>
                                <div style="font-size:0.9rem;color:var(--text-secondary);">Championships</div>
                            </div>
                            <div style="padding:1.5rem;background:rgba(59,130,246,0.1);border-radius:8px;">
                                <div style="font-size:2rem;font-weight:bold;color:#3b82f6;">${totalPlayoffs}</div>
                                <div style="font-size:0.9rem;color:var(--text-secondary);">Playoff Appearances</div>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <!-- MENTOR RELATIONSHIP -->
                ${GMMentors.currentMentor ? `
                    <div class="dossier-section">
                        <h3>${GMMentors.currentMentor.emoji} Mentor: ${GMMentors.currentMentor.name}</h3>
                        <div style="margin-top:1rem;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                                <span style="font-size:0.9rem;">Final Approval Rating</span>
                                <span style="font-size:1.3rem;font-weight:bold;color:${mentorApproval >= 80 ? '#22c55e' : mentorApproval >= 60 ? 'var(--gold)' : '#ef4444'};">
                                    ${mentorApproval}%
                                </span>
                            </div>
                            <div style="background:rgba(0,0,0,0.3);height:12px;border-radius:6px;overflow:hidden;">
                                <div style="width:${mentorApproval}%;height:100%;background:${mentorApproval >= 80 ? '#22c55e' : mentorApproval >= 60 ? 'var(--gold)' : '#ef4444'};transition:width 0.5s;"></div>
                            </div>
                            
                            <div style="margin-top:1.5rem;padding:1.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">
                                <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">Mentor Level</div>
                                <div style="font-size:2rem;font-weight:bold;color:var(--gold);">${mentorLevel}</div>
                                
                                <div style="margin-top:1rem;font-size:0.95rem;font-style:italic;padding:1rem;background:rgba(0,0,0,0.3);border-left:3px solid var(--gold);border-radius:4px;">
                                    ${mentorApproval >= 80 ? 
                                        `"You're ready to lead. I'm proud of what you've become. Go build your dynasty." - ${GMMentors.currentMentor.name}` :
                                      mentorApproval >= 60 ?
                                        `"Good progress. Keep learning and you'll get there." - ${GMMentors.currentMentor.name}` :
                                        `"You have potential, but you need more experience." - ${GMMentors.currentMentor.name}`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <!-- ECONOMICS MASTERY -->
                <div class="dossier-section">
                    <h3> Economics Mastery</h3>
                    <div style="margin-top:1rem;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                            <span style="font-size:0.9rem;">Concepts Mastered</span>
                            <span style="font-size:1.3rem;font-weight:bold;color:var(--gold);">
                                ${masteryProgress.mastered} / ${masteryProgress.total}
                            </span>
                        </div>
                        <div style="background:rgba(0,0,0,0.3);height:12px;border-radius:6px;overflow:hidden;">
                            <div style="width:${masteryProgress.masteryPercent}%;height:100%;background:#8b5cf6;transition:width 0.5s;"></div>
                        </div>
                        <div style="margin-top:0.5rem;text-align:right;font-size:0.85rem;color:var(--text-secondary);">
                            ${masteryProgress.masteryPercent}% Complete
                        </div>
                    </div>
                </div>
                
                <!-- FINAL METRICS -->
                <div class="dossier-section">
                    <h3> Final Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Roster Quality</div>
                            <div class="metric-value-large">${GameState.getBand(GameState.rosterQuality || 50).label}</div>
                            <div class="metric-number">${Math.round(GameState.rosterQuality || 50)}/100</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cap Flexibility</div>
                            <div class="metric-value-large">${GameState.getBand(GameState.capFlexibility || 50).label}</div>
                            <div class="metric-number">${Math.round(GameState.capFlexibility || 50)}/100</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Optionality</div>
                            <div class="metric-value-large">${GameState.getBand(GameState.optionality || 50).label}</div>
                            <div class="metric-number">${Math.round(GameState.optionality || 50)}/100</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Trust Index</div>
                            <div class="metric-value-large">${GameState.getBand(GameState.trustIndex || 50).label}</div>
                            <div class="metric-number">${Math.round(GameState.trustIndex || 50)}/100</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Risk Exposure</div>
                            <div class="metric-value-large">${GameState.getInverseBand(GameState.riskExposure || 50).label}</div>
                            <div class="metric-number">${Math.round(GameState.riskExposure || 50)}/100</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Agent Relations</div>
                            <div class="metric-value-large">${GameState.getBand(GameState.reputationAgents).label}</div>
                            <div class="metric-number">${Math.round(GameState.reputationAgents)}/100</div>
                        </div>
                    </div>
                </div>
                
                <div class="dossier-section">
                    <h3>Performance Band</h3>
                    <div class="band-display band-${band.toLowerCase()}">
                        <div class="band-icon">${band === 'GOLD' ? '' : band === 'SILVER' ? '' : ''}</div>
                        <div class="band-name">${band}</div>
                        <div class="band-description">
                            ${band === 'GOLD' ? 'Elite performance. You demonstrated mastery of front-office strategy and economic thinking.' : 
                              band === 'SILVER' ? 'Strong performance with balanced decision-making across competing constraints.' :
                              'You completed all cycles and navigated complex trade-offs throughout.'}
                        </div>
                    </div>
                </div>
                
                ${GameState.flags.length > 0 ? `
                    <div class="dossier-section">
                        <h3>Strategic Path</h3>
                        <p style="color:var(--text-secondary);margin-bottom:1rem;">Your decisions created the following outcomes:</p>
                        <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
                            ${GameState.flags.map(flag => `
                                <span style="padding:0.4rem 0.8rem;background:var(--bg-elevated);border-radius:2px;font-size:0.85rem;border:1px solid var(--border);">
                                    ${flag.replace(/_/g, ' ')}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${GameState.decisionLog.length > 0 ? `
                    <div class="dossier-section">
                        <h3>Decision History</h3>
                        <div style="display:grid;gap:1rem;margin-top:1rem;">
                            ${GameState.decisionLog.map(decision => `
                                <div style="padding:1rem;background:var(--bg-elevated);border-radius:4px;border-left:3px solid var(--gold);">
                                    <div style="font-weight:600;color:var(--gold);margin-bottom:0.5rem;">
                                        Cycle ${decision.cycle}  ${decision.room.charAt(0).toUpperCase() + decision.room.slice(1)}
                                    </div>
                                    <div style="color:var(--text-primary);">${decision.optionText}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="dossier-section">
                    <h3>Journey Summary</h3>
                    <p style="color:var(--text-secondary);">
                        Through 4 cycles and 12+ strategic decisions, you learned about opportunity cost, 
                        irreversibility, social capital, risk management, and the complex trade-offs 
                        that define real NBA front-office work.
                    </p>
                    ${GameState.optionalityCap < 100 ? `<p style="color:var(--gold);margin-top:1rem;">Your flexibility was permanently capped at ${GameState.optionalityCap} due to early all-in decisions.</p>` : ''}
                    ${GameState.agentTrustMultiplier < 1 ? `<p style="color:var(--danger);margin-top:1rem;">Agent relationships damaged. Future trust gains reduced by ${Math.round((1 - GameState.agentTrustMultiplier) * 100)}%.</p>` : ''}
                    
                    <!-- CLAIM CODE DISPLAY -->
                    <div style="margin-top:2rem;padding:1.5rem;background:linear-gradient(135deg,rgba(245,166,35,0.2),rgba(218,165,32,0.1));border:2px solid var(--gold);border-radius:8px;text-align:center;">
                        <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">
                             YOUR CLAIM CODE (Save This!)
                        </div>
                        <div id="claim-code-display" style="font-size:2rem;font-weight:bold;color:var(--gold);letter-spacing:0.1em;font-family:monospace;margin-bottom:0.5rem;">
                            ${claimCode}
                        </div>
                        <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:1rem;">
                            This code represents your simulation (70% of grade)
                        </div>
                        <button onclick="copyClaimCode('${claimCode}')" class="btn-ghost" style="padding:0.5rem 1.5rem;">
                             Copy Code
                        </button>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:2rem;">
                        <button class="btn-primary" onclick="showReplayStory()" style="padding:1rem;">
                             Replay Story
                        </button>
                        <button class="btn-primary" onclick="showPerformanceDashboard()" style="padding:1rem;background:linear-gradient(135deg, var(--info), var(--success));">
                             Analytics
                        </button>
                        <button class="btn-primary" onclick="startMasteryQuiz()" style="padding:1rem;background:linear-gradient(135deg, var(--gold), #d4af37);">
                             Take Quiz (30%)
                        </button>
                        <button class="btn-primary" onclick="StudentSubmit.generatePDF()" style="padding:1rem;background:linear-gradient(135deg, #ef4444, #dc2626);">
                             Download PDF
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('claim-code').textContent = claimCode;
            showScreen('dossier');
        }
        
        function copyClaimCode() {
            const code = document.getElementById('claim-code').textContent;
            navigator.clipboard.writeText(code);
            alert('Claim code copied to clipboard!');
        }
        
        // Make functions globally accessible - MUST BE AFTER ALL FUNCTION DEFINITIONS
        window.showScreen = showScreen;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.closeRoomModal = closeRoomModal;
        window.selectFranchise = selectFranchise;
        window.openRoom = openRoom;
        window.selectOption = selectOption;
        window.advanceCycle = advanceCycle;
        window.showDossier = showDossier;
        window.copyClaimCode = copyClaimCode;
        
        // 
        // TEACHING MODE SYSTEM
        // 
        
        const TeachingContent = {
            'SUNK COST': {
                concept: 'Sunk Cost Fallacy',
                definition: 'Past costs that cannot be recovered should NOT influence future decisions. Yet humans often "throw good money after bad" because they\'ve already invested.',
                nbaExample: `<strong>Real NBA Example: Sacramento Kings & DeMarcus Cousins</strong><br><br>
                The Kings drafted Cousins in 2010 and invested 6+ years trying to build around him. By 2017, it clearly wasn't workingconstant drama, no playoffs, toxic culture.<br><br>
                <strong>The Sunk Cost Trap:</strong> "We've invested so much in Boogie, we can't give up now!"<br><br>
                <strong>What They Did:</strong> Finally traded him in 2017 for mediocre return.<br><br>
                <strong>What They Should've Done:</strong> Traded him 2 years earlier when value was higher. The prior 6 years were already gonethat cost was "sunk."<br><br>
                <strong>The Lesson:</strong> Don't let past investment drive future choices. Evaluate only: "What's the best move FROM THIS POINT FORWARD?"`,
                application: 'When you\'re considering whether to keep investing in a failing strategy, ask: "Would I make this same choice if I hadn\'t already invested?" If no, you\'re in a sunk cost trap.'
            },
            
            'OPPORTUNITY COST': {
                concept: 'Opportunity Cost',
                definition: 'The value of the next best alternative you give up when making a choice. Every decision has a hidden costwhat you DIDN\'T do.',
                nbaExample: `<strong>Real NBA Example: 2010 Miami Heat</strong><br><br>
                Summer 2010: Heat had cap space. They could sign good-but-not-great free agents (David Lee, Carlos Boozer) for $15M/year.<br><br>
                <strong>The Choice:</strong> Use the cap space now, or keep waiting?<br><br>
                <strong>What They Did:</strong> Stayed patient. Kept cap space clear.<br><br>
                <strong>The Opportunity Cost of Waiting:</strong> No playoffs in 2010. Fans angry. Risk that NO star signs.<br><br>
                <strong>The Payoff:</strong> LeBron James and Chris Bosh signed. Three championships.<br><br>
                <strong>The Lesson:</strong> They gave up 2010 competitiveness (opportunity cost) to preserve flexibility for a bigger prize.`,
                application: 'Before using cap space or assets, always ask: "What am I giving up? What else could I do with this resource?" The cost isn\'t just the moneyit\'s the lost opportunities.'
            },
            
            'TIME PREFERENCE': {
                concept: 'Time Preference',
                definition: 'How much you value the present vs the future. Win now (high time preference) or build for later (low time preference)? NBA forces this choice constantly.',
                nbaExample: `<strong>Real NBA Example: Process Sixers vs Win-Now Nets</strong><br><br>
                <strong>76ers (2013-2017):</strong> Extreme patience. Tank for years. Draft Embiid, Simmons. Future over present.<br><br>
                <strong>Nets (2013):</strong> Traded ALL their picks for Pierce, Garnett, old stars. Present over future.<br><br>
                <strong>Results:</strong><br>
                 Sixers: 4 terrible years  became contender<br>
                 Nets: 1 okay year  5 years of misery with no picks<br><br>
                <strong>The Lesson:</strong> Time preference is about YOUR context. Sixers could afford patience (young market, no expectations). Nets felt pressure to win immediately. Both choices were rational for their situationbut one worked, one didn't.`,
                application: 'Ask: How much time do I have? Aging star = favor present. Young core = favor future. Owner pressure = favor present. Rebuild = favor future.'
            },
            
            'COMMITMENT': {
                concept: 'Commitment & Escalation',
                definition: 'Once you commit to a path, you feel pressure to keep investing in iteven when evidence suggests you should stop. Commitment can be powerful OR trap you.',
                nbaExample: `<strong>Real NBA Example: Brooklyn Nets Superteam</strong><br><br>
                2021: Nets trade for Harden to join Durant and Kyrie. All-in. Championship or bust.<br><br>
                2022: It's clearly not working. Kyrie drama. Harden unhappy. Chemistry terrible.<br><br>
                <strong>The Commitment Trap:</strong> "We've already given up everything for this. We HAVE to make it work!"<br><br>
                <strong>What They Did:</strong> Kept going. More moves. More investment.<br><br>
                <strong>What Happened:</strong> Fell apart. All three stars gone within 2 years. Decade of picks gone.<br><br>
                <strong>The Lesson:</strong> Commitment is good when things are working. But escalating commitment to a failing plan is how disasters happen. Know when to cut losses.`,
                application: 'Commitment should be based on current evidence, not past investment. Ask: "Is this STILL the right path?" Not: "Have we already invested too much to quit?"'
            },
            
            'VARIANCE': {
                concept: 'Variance & Expected Value',
                definition: 'Outcomes have a range (variance). High variance = wide range (could be great OR terrible). Low variance = predictable. Expected value = average outcome across many tries.',
                nbaExample: `<strong>Real NBA Example: 2019 Raptors Trade for Kawhi</strong><br><br>
                Trade: Give up DeMar DeRozan (safe, loyal star) for Kawhi Leonard (elite but injury risk, rental).<br><br>
                <strong>Expected Outcomes:</strong><br>
                 50% chance: Kawhi leaves, got 1 year rental<br>
                 30% chance: Decent playoff run, still leaves<br>
                 15% chance: Championship, then leaves<br>
                 5% chance: Championship AND he stays<br><br>
                <strong>What Happened:</strong> The 15% outcomechampionship, then he left.<br><br>
                <strong>The Lesson:</strong> This was HIGH VARIANCE. Most of the time, this exact move fails. But sometimes high variance pays off spectacularly. You can't evaluate decisions solely by outcomesevaluate by the PROCESS.`,
                application: 'High variance strategies can fail even when they\'re the right choice. Good decisions can have bad outcomes. Bad decisions can have good outcomes. Judge your PROCESS, not just results.'
            },
            
            'BARGAINING POWER': {
                concept: 'Bargaining Power',
                definition: 'Your leverage in negotiations. Negotiate from strength = better deals. Negotiate from weakness = get fleeced. Power dynamics matter more than "fair value."',
                nbaExample: `<strong>Real NBA Example: Kawhi Trade Demand from Spurs</strong><br><br>
                2018: Kawhi demands trade from San Antonio. Wants to go to LA. Everyone knows it.<br><br>
                <strong>Spurs\' Bargaining Power:</strong> ZERO. He wants out. Won\'t play. Other teams know he only wants LA.<br><br>
                <strong>The Trade:</strong> Got DeMar DeRozan + Jakob Poeltl. Okay return, not great.<br><br>
                <strong>Compare to: 2017 Paul George trade from Pacers</strong><br>
                Same situationstar wants LA. Pacers got Victor Oladipo + Domantas Sabonis. GREAT return.<br><br>
                <strong>The Difference:</strong> Pacers moved FAST before leverage died. Spurs waited, leverage evaporated.<br><br>
                <strong>The Lesson:</strong> When you have leverage, use it IMMEDIATELY. Leverage decays. Every day you wait in a bad situation, your power shrinks.`,
                application: 'Before negotiating, assess: Do I have leverage or are they leveraging me? If you have no power, getting ANY return may be the best move. If you have power, extract maximum value.'
            },
            
            'INFORMATION': {
                concept: 'Information Asymmetry & Value of Information',
                definition: 'In decisions under uncertainty, more information is valuable. But information has a cost (time, resources). When should you wait for info vs decide now?',
                nbaExample: `<strong>Real NBA Example: Extending Young Players Early</strong><br><br>
                <strong>Scenario:</strong> Your rookie just finished Year 2. He's promising but inconsistent. Do you extend him NOW or wait one more year?<br><br>
                <strong>Extend Now (Less Info):</strong><br>
                 Lock him in cheap if he breaks out<br>
                 Risk: He busts, you're stuck with bad contract<br><br>
                <strong>Wait One Year (More Info):</strong><br>
                 See if he's really good or just okay<br>
                 Risk: If he's great, he costs WAY more next year<br><br>
                <strong>Real Examples:</strong><br>
                 Bucks extended Giannis early (2016): $100M. Turned into INSANE value.<br>
                 Kings waited on De'Aaron Fox: Had to pay $163M. Could've gotten him cheaper earlier.<br><br>
                <strong>The Lesson:</strong> There's a trade-off. More information = better decision. But waiting for information can cost you. Evaluate: "How much will waiting cost vs the value of knowing more?"`,
                application: 'Ask: How much will I learn by waiting? What will waiting cost me? If the cost of waiting is small and the info value is high, wait. If opportunity disappears by waiting, decide now.'
            },
            
            'OPTION VALUE': {
                concept: 'Option Value & Flexibility',
                definition: 'Flexibility itself has value. Keeping options open lets you adapt to changing circumstances. But flexibility unused is wasted opportunity. The key: when to preserve options vs when to USE them.',
                nbaExample: `<strong>Real NBA Example: Warriors "Light Years Ahead"</strong><br><br>
                2015-2016: Warriors have cap space. They could sign good veterans OR keep flexibility for Durant in 2016.<br><br>
                <strong>The Choice:</strong> They kept cap space clear. Stayed flexible. Didn't panic-spend.<br><br>
                <strong>The Risk:</strong> What if Durant doesn't sign? Wasted a year of flexibility.<br><br>
                <strong>What Happened:</strong> Durant signed. Dynasty.<br><br>
                <strong>Counter-Example: Clippers 2019-2020</strong><br>
                Kept flexibility for years. Waited for the right stars. Got Kawhi and PG. Used the flexibility perfectly.<br><br>
                <strong>Counter-Example: Magic 2016</strong><br>
                Kept flexibility, then panic-spent it on Bismack Biyombo ($72M!). Flexibility preserved then WASTED.<br><br>
                <strong>The Lesson:</strong> Flexibility is valuable, but it expires. Have a plan for WHEN you'll use it. "Staying flexible forever" is indecision disguised as strategy.`,
                application: 'Preserving options is smart. But ask: "What am I waiting FOR? When will I know it\'s time to commit?" Without a plan, flexibility becomes paralysis.'
            }
        };
        
        function showTeachingMoment(concept, context, decisionTitle) {
            return new Promise((resolve) => {
                if (!GameState.teachingMode) {
                    resolve();
                    return;
                }
                
                const teaching = TeachingContent[concept];
                if (!teaching) {
                    resolve();
                    return;
                }
                
                // Mark concept as learned
                if (!GameState.conceptsLearned.includes(concept)) {
                    GameState.conceptsLearned.push(concept);
                }
                
                const modal = document.getElementById('screen-teaching');
                const content = document.getElementById('teaching-content');
                
                content.innerHTML = `
                    <div style="padding: 2rem; max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <h2 style="font-size: 1.8rem; color: var(--gold);">Economics Lesson</h2>
                            <div style="font-size: 1.2rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                ${teaching.concept}
                            </div>
                        </div>
                        
                        <div style="padding: 1.5rem; background: rgba(245, 166, 35, 0.1); border-left: 3px solid var(--gold); margin-bottom: 2rem;">
                            <div style="font-size: 1rem; color: var(--text-primary); line-height: 1.6; margin-bottom: 1rem;">
                                <strong>What It Means:</strong><br>
                                ${teaching.definition}
                            </div>
                        </div>
                        
                        <div style="padding: 1.5rem; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; margin-bottom: 2rem;">
                            <div style="font-size: 0.95rem; color: var(--text-primary); line-height: 1.6;">
                                ${teaching.nbaExample}
                            </div>
                        </div>
                        
                        <div style="padding: 1.5rem; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; margin-bottom: 2rem;">
                            <div style="font-size: 0.95rem; color: var(--text-primary); line-height: 1.6;">
                                <strong>How This Applies to Your Decision:</strong><br>
                                ${context || teaching.application}
                            </div>
                        </div>
                        
                        ${decisionTitle ? `
                            <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 2rem;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    <strong>Your Decision:</strong> ${decisionTitle}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="text-align: center; padding: 1rem; background: rgba(245, 166, 35, 0.05); border-radius: 4px; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.9rem; color: var(--gold);">
                                 Concept Learned: ${teaching.concept}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                Progress: ${GameState.conceptsLearned.length}/${Object.keys(TeachingContent).length} concepts mastered
                            </div>
                        </div>
                        
                        <button class="btn-primary" onclick="closeTeachingModal()" style="width: 100%; padding: 1rem;">
                            Continue
                        </button>
                    </div>
                `;
                
                modal.style.display = 'flex';
                
                window.resolveTeaching = resolve;
            });
        }
        
        function closeTeachingModal() {
            document.getElementById('screen-teaching').style.display = 'none';
            if (window.resolveTeaching) {
                window.resolveTeaching();
                window.resolveTeaching = null;
            }
        }
        
        function toggleTeachingMode() {
            GameState.teachingMode = !GameState.teachingMode;
            const btn = document.getElementById('btn-teaching-mode');
            if (btn) {
                btn.textContent = GameState.teachingMode ? ' Teaching: ON' : ' Teaching: OFF';
                btn.style.background = GameState.teachingMode ? 
                    'linear-gradient(135deg, #10b981, #059669)' : 
                    'rgba(255,255,255,0.1)';
            }
            
            UI.addAlert(
                GameState.teachingMode ? 
                'Teaching Mode ON: Economics lessons will appear after decisions' : 
                'Teaching Mode OFF: Playing without lessons',
                GameState.teachingMode ? 'success' : 'default'
            );
        }
        
        window.continueToCycle = continueToCycle;
        window.skipRoom = skipRoom;
        window.closeOutcomeModal = closeOutcomeModal;
        window.closeTeachingModal = closeTeachingModal;
        window.toggleTeachingMode = toggleTeachingMode;
        
        // Mentor Call Modal - contextual advice based on current game state
        function showMentorCallModal() {
            if (!GMMentors.currentMentor) {
                UI.addAlert('No mentor selected yet!', 'warning');
                return;
            }
            
            const mentor = GMMentors.currentMentor;
            const pressure = Math.round(GameState.ownerPressure || 50);
            const roster = Math.round(GameState.rosterQuality || 50);
            const optionality = Math.round(GameState.optionality || 50);
            const cycle = GameState.cycleIndex;
            
            // Generate contextual advice
            let advice = '';
            let urgency = 'normal';
            
            // High pressure situation
            if (pressure > 70) {
                urgency = 'urgent';
                if (mentor.id === 'jerry_west') {
                    advice = `Look, the pressure is real - ${pressure}% is dangerous. You need to make a move that shows results NOW. Ownership isn't patient forever. Find a star or win some games, fast.`;
                } else if (mentor.id === 'sam_presti') {
                    advice = `I see the pressure at ${pressure}%. Here's the thing - don't panic. Desperation trades are how you destroy franchises. Stay disciplined, but communicate your plan to ownership clearly.`;
                } else if (mentor.id === 'pat_riley') {
                    advice = `${pressure}% pressure? Good. Pressure creates diamonds. Use this moment to prove your worth. Make bold moves. Show them Heat Culture.`;
                } else {
                    advice = `The pressure is at ${pressure}%. This is a critical moment. Stay calm, make smart decisions, and remember - one good move can change everything.`;
                }
            } 
            // Low roster quality
            else if (roster < 40) {
                if (mentor.id === 'sam_presti') {
                    advice = `Your roster is at ${roster}%. This is actually an opportunity. Tank properly, accumulate assets, develop young talent. This is exactly how OKC built a dynasty.`;
                } else if (mentor.id === 'jerry_west') {
                    advice = `${roster}% roster quality isn't good enough. You need talent. Period. Find a way to acquire a star - draft, trade, whatever it takes.`;
                } else {
                    advice = `Your roster at ${roster}% needs work. Focus on smart acquisitions and player development. Build a foundation before trying to compete.`;
                }
            }
            // Late game advice
            else if (cycle >= 3) {
                if (mentor.id === 'jerry_west') {
                    advice = `We're in Cycle ${cycle}. This is championship time or bust. If you have the pieces, go all in. If not, accept reality and rebuild smart.`;
                } else if (mentor.id === 'sam_presti') {
                    advice = `Cycle ${cycle} - your earlier decisions are setting up your finish. If you've preserved flexibility, now might be time to strike. If not, start thinking about the next era.`;
                } else {
                    advice = `We're entering the final stretch at Cycle ${cycle}. Every decision matters now. Think about your legacy and what story you want to tell.`;
                }
            }
            // General advice
            else {
                if (mentor.id === 'jerry_west') {
                    advice = `You're in decent shape - ${roster}% roster, ${optionality}% flexibility. My advice? Don't get complacent. Always be looking for the next upgrade. Stars win championships.`;
                } else if (mentor.id === 'sam_presti') {
                    advice = `Roster: ${roster}%, Flexibility: ${optionality}%. The numbers look reasonable. Keep building, stay patient, and don't mortgage the future for short-term gains.`;
                } else if (mentor.id === 'pat_riley') {
                    advice = `You're at ${roster}% roster quality. Acceptable, but not championship level. Excellence requires constant improvement. What's your next move?`;
                } else {
                    advice = `Current state: ${roster}% roster, ${optionality}% flexibility, ${pressure}% owner pressure. You're in a manageable position. Focus on steady improvement.`;
                }
            }
            
            const modal = document.getElementById('screen-replay');
            const content = document.getElementById('replay-content');
            
            const urgencyColor = urgency === 'urgent' ? '#ef4444' : '#8b5cf6';
            const urgencyBg = urgency === 'urgent' ? 'rgba(239,68,68,0.1)' : 'rgba(139,92,246,0.1)';
            
            content.innerHTML = `
                <div style="padding:2rem;max-width:700px;margin:auto;">
                    <div style="text-align:center;margin-bottom:2rem;">
                        <div style="font-size:4rem;margin-bottom:1rem;">${mentor.emoji}</div>
                        <h2 style="color:var(--gold);">Call with ${mentor.name}</h2>
                        <p style="color:var(--text-secondary);">${mentor.philosophy}</p>
                    </div>
                    
                    <div style="padding:1.5rem;background:${urgencyBg};border-left:4px solid ${urgencyColor};border-radius:8px;margin-bottom:2rem;">
                        <div style="font-size:0.85rem;color:${urgencyColor};margin-bottom:0.75rem;font-weight:600;">
                            ${urgency === 'urgent' ? ' URGENT ADVICE' : ' MENTOR ADVICE'}
                        </div>
                        <div style="font-size:1.05rem;line-height:1.7;color:#fff;">
                            "${advice}"
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:2rem;">
                        <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);">Roster</div>
                            <div style="font-size:1.5rem;font-weight:bold;color:${roster > 60 ? '#22c55e' : roster > 40 ? '#f59e0b' : '#ef4444'};">${roster}%</div>
                        </div>
                        <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);">Flexibility</div>
                            <div style="font-size:1.5rem;font-weight:bold;color:${optionality > 60 ? '#22c55e' : optionality > 40 ? '#f59e0b' : '#ef4444'};">${optionality}%</div>
                        </div>
                        <div style="padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);">Pressure</div>
                            <div style="font-size:1.5rem;font-weight:bold;color:${pressure < 40 ? '#22c55e' : pressure < 70 ? '#f59e0b' : '#ef4444'};">${pressure}%</div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="document.getElementById('screen-replay').style.display='none'" style="width:100%;padding:1rem;">
                        Thanks, Coach
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        window.showMentorCallModal = showMentorCallModal;
        
        // Verify functions exist
        console.log('=== FUNCTION CHECK ===');
        console.log('selectOption:', typeof window.selectOption);
        console.log('openRoom:', typeof window.openRoom);
        console.log('selectFranchise:', typeof window.selectFranchise);
        console.log('advanceCycle:', typeof window.advanceCycle);
        console.log('======================');
        
        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== GAME LOADING ===');
            
            if (!window.AuthSystem.init()) {
                console.log('No user found, showing login');
                window.AuthSystem.showLoginScreen();
                return;
            }
            
            // Show game content only after successful auth
            const gameContent = document.getElementById('game-content');
            if (gameContent) gameContent.style.display = 'block';
            
            console.log('User found:', window.AuthSystem.currentUser.name);
            if (window.AuthSystem.isTeacher) {
                console.log('Loading teacher dashboard');
                window.TeacherDashboard.show();
                return;
            }
            console.log('Loading student game');
            
            // Ensure ONLY intro screen is active initially
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const introScreen = document.getElementById('screen-intro');
            if (introScreen) introScreen.classList.add('active');
            
            document.getElementById('btn-start').addEventListener('click', () => showScreen('franchise'));
            document.getElementById('btn-how-it-works').addEventListener('click', () => showModal('how'));
            
            // Event delegation for decision buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-decision') && !e.target.disabled) {
                    const room = e.target.getAttribute('data-room');
                    const scenario = e.target.getAttribute('data-scenario');
                    const index = e.target.getAttribute('data-index');
                    
                    if (room && scenario && index !== null) {
                        console.log('Button clicked via event delegation:', room, scenario, index);
                        selectOption(room, scenario, parseInt(index));
                    }
                }
            });
        });
    </script>
    </div><!-- End game-content -->
</body>
</html>
